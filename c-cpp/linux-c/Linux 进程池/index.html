<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"/><meta name="theme-color" content="#222"/><meta http-equiv="X-UA-COMPATIBLE" content="IE=edge,chrome=1"/><meta name="renderer" content="webkit"/><link rel="icon" type="image/ico" sizes="32x32" href="/assets/favicon.ico"/><link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png"/><link rel="alternate" href="/rss.xml" title="Nana7ha's Café Stella" type="application/rss+xml"><link rel="alternate" href="/atom.xml" title="Nana7ha's Café Stella" type="application/atom+xml"><link rel="alternate" type="application/json" title="Nana7ha's Café Stella" href="http://cwlrin.github.io/feed.json"/><link rel="preconnect" href="https://s4.zstatic.net"/><link rel="preconnect" href="https://at.alicdn.com"/><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Mulish:400,400italic,700,700italic%7CFredericka%20the%20Great:400,400italic,700,700italic%7CNoto%20Serif%20JP:400,400italic,700,700italic%7CNoto%20Serif%20SC:400,400italic,700,700italic%7CInconsolata:400,400italic,700,700italic&display=swap&subset=latin,latin-ext" media="none" onload="this.media&#x3D;&#39;all&#39;"><link rel="stylesheet" href="/css/app.css?v=0.4.14"><link rel="modulepreload" href="/js/chunk-3QGRG5LW.js"></link><link rel="modulepreload" href="/js/chunk-UI4753RE.js"></link><link rel="modulepreload" href="/js/chunk-W4TLJ2OW.js"></link><link rel="modulepreload" href="/js/copy-tex-AOQYTOAX.js"></link><link rel="modulepreload" href="/js/index.esm-CJDJKRJB.js"></link><link rel="modulepreload" href="/js/post-3U5GTE2G.js"></link><link rel="modulepreload" href="/js/quicklink-SMYWLNBX.js"></link><link rel="modulepreload" href="/js/siteInit.js"></link><link rel="preload" href="h" as="image" fetchpriority="high"><link rel="preload" href="t" as="image" fetchpriority="high"><link rel="preload" href="t" as="image" fetchpriority="high"><link rel="preload" href="p" as="image" fetchpriority="high"><link rel="preload" href="s" as="image" fetchpriority="high"><link rel="preload" href=":" as="image" fetchpriority="high"><link rel="preload" href="/" as="image" fetchpriority="high"><link rel="preload" href="/" as="image" fetchpriority="high"><link rel="preload" href="d" as="image" fetchpriority="high"><link rel="preload" href="l" as="image" fetchpriority="high"><link rel="preload" href="i" as="image" fetchpriority="high"><link rel="preload" href="n" as="image" fetchpriority="high"><link rel="preload" href="k" as="image" fetchpriority="high"><link rel="preload" href="." as="image" fetchpriority="high"><link rel="preload" href="h" as="image" fetchpriority="high"><link rel="preload" href="o" as="image" fetchpriority="high"><link rel="preload" href="s" as="image" fetchpriority="high"><link rel="preload" href="t" as="image" fetchpriority="high"><link rel="preload" href="/" as="image" fetchpriority="high"><link rel="preload" href="1" as="image" fetchpriority="high"><link rel="preload" href="d" as="image" fetchpriority="high"><link rel="preload" href="r" as="image" fetchpriority="high"><link rel="preload" href="v" as="image" fetchpriority="high"><link rel="preload" href="/" as="image" fetchpriority="high"><link rel="preload" href="a" as="image" fetchpriority="high"><link rel="preload" href="H" as="image" fetchpriority="high"><link rel="preload" href="R" as="image" fetchpriority="high"><link rel="preload" href="0" as="image" fetchpriority="high"><link rel="preload" href="c" as="image" fetchpriority="high"><link rel="preload" href="H" as="image" fetchpriority="high"><link rel="preload" href="M" as="image" fetchpriority="high"><link rel="preload" href="6" as="image" fetchpriority="high"><link rel="preload" href="L" as="image" fetchpriority="high"><link rel="preload" href="y" as="image" fetchpriority="high"><link rel="preload" href="8" as="image" fetchpriority="high"><link rel="preload" href="x" as="image" fetchpriority="high"><link rel="preload" href="Z" as="image" fetchpriority="high"><link rel="preload" href="H" as="image" fetchpriority="high"><link rel="preload" href="J" as="image" fetchpriority="high"><link rel="preload" href="2" as="image" fetchpriority="high"><link rel="preload" href="L" as="image" fetchpriority="high"><link rel="preload" href="m" as="image" fetchpriority="high"><link rel="preload" href="1" as="image" fetchpriority="high"><link rel="preload" href="z" as="image" fetchpriority="high"><link rel="preload" href="L" as="image" fetchpriority="high"><link rel="preload" href="2" as="image" fetchpriority="high"><link rel="preload" href="k" as="image" fetchpriority="high"><link rel="preload" href="v" as="image" fetchpriority="high"><link rel="preload" href="Y" as="image" fetchpriority="high"><link rel="preload" href="y" as="image" fetchpriority="high"><link rel="preload" href="9" as="image" fetchpriority="high"><link rel="preload" href="i" as="image" fetchpriority="high"><link rel="preload" href="Z" as="image" fetchpriority="high"><link rel="preload" href="G" as="image" fetchpriority="high"><link rel="preload" href="U" as="image" fetchpriority="high"><link rel="preload" href="1" as="image" fetchpriority="high"><link rel="preload" href="M" as="image" fetchpriority="high"><link rel="preload" href="W" as="image" fetchpriority="high"><link rel="preload" href="U" as="image" fetchpriority="high"><link rel="preload" href="2" as="image" fetchpriority="high"><link rel="preload" href="M" as="image" fetchpriority="high"><link rel="preload" href="j" as="image" fetchpriority="high"><link rel="preload" href="V" as="image" fetchpriority="high"><link rel="preload" href="l" as="image" fetchpriority="high"><link rel="preload" href="Z" as="image" fetchpriority="high"><link rel="preload" href="j" as="image" fetchpriority="high"><link rel="preload" href="h" as="image" fetchpriority="high"><link rel="preload" href="m" as="image" fetchpriority="high"><link rel="preload" href="Y" as="image" fetchpriority="high"><link rel="preload" href="2" as="image" fetchpriority="high"><link rel="preload" href="M" as="image" fetchpriority="high"><link rel="preload" href="1" as="image" fetchpriority="high"><link rel="preload" href="L" as="image" fetchpriority="high"><link rel="preload" href="0" as="image" fetchpriority="high"><link rel="preload" href="V" as="image" fetchpriority="high"><link rel="preload" href="T" as="image" fetchpriority="high"><link rel="preload" href="T" as="image" fetchpriority="high"><link rel="preload" href="3" as="image" fetchpriority="high"><link rel="preload" href="p" as="image" fetchpriority="high"><link rel="preload" href="a" as="image" fetchpriority="high"><link rel="preload" href="c" as="image" fetchpriority="high"><link rel="preload" href="H" as="image" fetchpriority="high"><link rel="preload" href="N" as="image" fetchpriority="high"><link rel="preload" href="K" as="image" fetchpriority="high"><link rel="preload" href="e" as="image" fetchpriority="high"><link rel="preload" href="U" as="image" fetchpriority="high"><link rel="preload" href="d" as="image" fetchpriority="high"><link rel="preload" href="w" as="image" fetchpriority="high"><link rel="preload" href="T" as="image" fetchpriority="high"><link rel="preload" href="n" as="image" fetchpriority="high"><link rel="preload" href="N" as="image" fetchpriority="high"><link rel="preload" href="T" as="image" fetchpriority="high"><link rel="preload" href="W" as="image" fetchpriority="high"><link rel="preload" href="m" as="image" fetchpriority="high"><link rel="preload" href="t" as="image" fetchpriority="high"><link rel="preload" href="o" as="image" fetchpriority="high"><link rel="preload" href="e" as="image" fetchpriority="high"><link rel="preload" href="D" as="image" fetchpriority="high"><link rel="preload" href="F" as="image" fetchpriority="high"><link rel="preload" href="F" as="image" fetchpriority="high"><link rel="preload" href="W" as="image" fetchpriority="high"><link rel="preload" href="V" as="image" fetchpriority="high"><link rel="preload" href="J" as="image" fetchpriority="high"><link rel="preload" href="r" as="image" fetchpriority="high"><link rel="preload" href="Q" as="image" fetchpriority="high"><link rel="preload" href="k" as="image" fetchpriority="high"><link rel="preload" href="1" as="image" fetchpriority="high"><link rel="preload" href="O" as="image" fetchpriority="high"><link rel="preload" href="R" as="image" fetchpriority="high"><link rel="preload" href="G" as="image" fetchpriority="high"><link rel="preload" href="p" as="image" fetchpriority="high"><link rel="preload" href="n" as="image" fetchpriority="high"><link rel="preload" href="e" as="image" fetchpriority="high"><link rel="preload" href="U" as="image" fetchpriority="high"><link rel="preload" href="d" as="image" fetchpriority="high"><link rel="preload" href="m" as="image" fetchpriority="high"><link rel="preload" href="W" as="image" fetchpriority="high"><link rel="preload" href="i" as="image" fetchpriority="high"><link rel="preload" href="1" as="image" fetchpriority="high"><link rel="preload" href="H" as="image" fetchpriority="high"><link rel="preload" href="Z" as="image" fetchpriority="high"><link rel="preload" href="D" as="image" fetchpriority="high"><link rel="preload" href="J" as="image" fetchpriority="high"><link rel="preload" href="j" as="image" fetchpriority="high"><link rel="preload" href="Z" as="image" fetchpriority="high"><link rel="preload" href="j" as="image" fetchpriority="high"><link rel="preload" href="Y" as="image" fetchpriority="high"><link rel="preload" href="y" as="image" fetchpriority="high"><link rel="preload" href="M" as="image" fetchpriority="high"><link rel="preload" href="E" as="image" fetchpriority="high"><link rel="preload" href="s" as="image" fetchpriority="high"><link rel="preload" href="3" as="image" fetchpriority="high"><link rel="preload" href="X" as="image" fetchpriority="high"><link rel="preload" href="0" as="image" fetchpriority="high"><link rel="preload" href="E" as="image" fetchpriority="high"><link rel="preload" href="_" as="image" fetchpriority="high"><link rel="preload" href="Z" as="image" fetchpriority="high"><link rel="preload" href="T" as="image" fetchpriority="high"><link rel="preload" href="1" as="image" fetchpriority="high"><link rel="preload" href="y" as="image" fetchpriority="high"><link rel="preload" href="d" as="image" fetchpriority="high"><link rel="preload" href="G" as="image" fetchpriority="high"><link rel="preload" href="1" as="image" fetchpriority="high"><link rel="preload" href="u" as="image" fetchpriority="high"><link rel="preload" href="a" as="image" fetchpriority="high"><link rel="preload" href="V" as="image" fetchpriority="high"><link rel="preload" href="Q" as="image" fetchpriority="high"><link rel="preload" href="." as="image" fetchpriority="high"><link rel="preload" href="p" as="image" fetchpriority="high"><link rel="preload" href="n" as="image" fetchpriority="high"><link rel="preload" href="g" as="image" fetchpriority="high"><meta name="keywords" content="C,"/><meta name="description" content="技术与美日新月异"/><link rel="canonical" href="http://cwlrin.github.io/c-cpp/linux-c/Linux%20%E8%BF%9B%E7%A8%8B%E6%B1%A0/"><title>Linux 进程池</title><meta name="generator" content="Hexo 7.3.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">Linux 进程池</h1><div class="meta"><span class="item" title="创建时间：2020-10-07 11:35:15"><span class="icon"><i class="ic i-calendar"></i></span><span class="text">发表于</span><time itemprop="dateCreated datePublished" datetime="2020-10-07T11:35:15+08:00">2020-10-07</time></span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i></span><span class="text">本文字数</span><span>68k</span><span class="text">字</span></span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i></span><span class="text">阅读时长</span><span>1:02</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span><span class="line"></span><span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">七葉の喫茶ステラ</a></li></ul><ul class="right" id="rightNav"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div class="pjax" id="imgs"><img src="https://dlink.host/1drv/aHR0cHM6Ly8xZHJ2Lm1zL2kvYy9iZGU1MWU2MjVlZjhmY2M1L0VTT3pacHNKeUdwTnNTWmtoeDFFWVJrQk1ORGpneUdmWi1HZDJjZjYyMEs3X0E_ZT1ydG1uaVQ.png" loading="eager" decoding="async" fetchpriority="high" alt="Nana7ha's Café Stella"></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"></path></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"></use><use xlink:href="#gentle-wave" x="48" y="3"></use><use xlink:href="#gentle-wave" x="48" y="5"></use><use xlink:href="#gentle-wave" x="48" y="7"></use></g></svg></div><main><div class="inner"><div class="pjax" id="main"><div class="article wrap"><div class="breadcrumb" itemListElement itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i><span><a href="/">首页</a></span><i class="ic i-angle-right"></i><span itemprop="itemListElement" itemscope="itemscope" itemtype="https://schema.org/ListItem"><a href="/categories/c-cpp/" itemprop="item" rel="index" title="分类于C/C++"><span itemprop="name">C/C++<meta itemprop="position" content="0"/></span></a></span><i class="ic i-angle-right"></i><span class="current" itemprop="itemListElement" itemscope="itemscope" itemtype="https://schema.org/ListItem"><a href="/categories/c-cpp/linux-c/" itemprop="item" rel="index" title="分类于Linux C"><span itemprop="name">Linux C<meta itemprop="position" content="1"/></span></a></span></div><article class="post block" itemscope="itemscope" itemtype="http://schema.org/Article" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://cwlrin.github.io/c-cpp/linux-c/Linux%20%E8%BF%9B%E7%A8%8B%E6%B1%A0/"/><span hidden="hidden" itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="image" content="/assets/avatar.jpg"/><meta itemprop="name" content="樱小路七叶"/><meta itemprop="description" content=", 技术与美日新月异"/></span><span hidden="hidden" itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="Nana7ha's Café Stella"/></span><div class="body md" itemprop="articleBody"><h2 id="需求分析"><a class="anchor" href="#需求分析">#</a> 需求分析</h2>
<p>假设：我们结合学过的文件操作、网络通信、以及进程和线程的知识，实现一个基本的文件下载服务器模型，我们需要做哪些准备工作，或者说我们怎么设计整个数据通信逻辑。</p>
<p>首先，服务器需要能够处理大量连接的频繁接入和断开，这就要求我们不能简单地让一个进程同时处理连接接入和业务逻辑，这样的设计在现代应用领域是低效的。它不仅无法有效解耦，增加了代码书写的复杂性，还增加了并行逻辑设计的难度，并且无法充分利用多核 CPU 的性能，容易导致性能瓶颈。</p>
<p>在设计服务器架构时，我们需要考虑可维护性和性能两个基本要求。可维护性要求应用程序对开发者友好，使得开发和维护人员能够快速理解程序架构并进行后续开发。为了提供可维护性，项目各个部分的功能应当彼此分离。性能则要求应用程序充分利用操作系统资源，并减少资源消耗。在多进程程序中，创建和销毁进程的开销是非常大的。</p>
<p>因此，我们有必要利用多进程或多线程来实现 <strong>业务逻辑</strong> 和 <strong>任务管控逻辑</strong> 的分离。</p>
<p><strong>我们可以维护一个主进程，它只负责接收用户请求，并将接收到的用户请求分配到不同的进程中去处理。</strong> 但是，如果我们不对任务进程进行任何限制和管理，随着任务的到达开始一个进程处理任务，任务处理结束后立即结束这个进程，这样的处理方式是非常不好的，因为进程的频繁创建和销毁会带来很大的软硬件开销。</p>
<p>为了解决这个问题，我们可以采用池化思想。<strong>维护一个包含多个进程的进程池，当有任务到来时，把任务交给空闲的进程执行。当任务执行完毕，并且没有任务可执行时，让进程休眠</strong>。这种池化的思想可以显著减少创建和销毁进程的软硬件开销，进而提高程序的执行效率。</p>
<p><img loading="lazy" data-src="https://dlink.host/1drv/aHR0cHM6Ly8xZHJ2Lm1zL2kvYy9iZGU1MWU2MjVlZjhmY2M1L0VmVkJ3MzAzeHAxTnFEQ2dlUkpjbW5zQnFRaExaQ2RaTFVUSE9waV9Fbm5vU1E_ZT11OWlqQ00.png" alt="_.png" /></p>
<p>在进程池模型中，父进程负责接收用户请求，获得连接的文件描述符，并且维护所有进程池中进程的状态，以便于把文件描述符对象交给空闲的池中进程来和客户端直接交互。进程池中的进程，在被主进程唤醒后，接收到对应的连接文件描述符对象，按照需求读取磁盘文件，并将读取的磁盘文件发送给客户端。客户端建立连接后，就可以接收返回的文件。</p>
<p>在设计服务器时，我们还需要考虑是使用进程池还是线程池。进程池设计中，每个进程有独立的内存空间，增加了进程间的隔离性。一个进程崩溃不会影响到其他进程。进程间存在隔离性，使得业务逻辑方便书写。但是，进程的创建和销毁比线程开销大，占用的内存空间也比线程大，上下文的调度切换时间也长。进程池适合并发量低、业务复杂、任务执行事件长的系统设计。</p>
<p>相比之下，线程池设计中，线程之间共享资源，隔离性差，一个线程极容易影响到另一个线程，需要更多的数据同步和一致性处理。但是，线程间通信比进程间通信要方便，线程较轻量，创建和销毁的开销较小。线程池适合并发量高、内存使用要求高、业务简单、可以大量快速、轻量级任务处理的场景。</p>
<h2 id="第一版"><a class="anchor" href="#第一版">#</a> 第一版</h2>
<h3 id="设计逻辑"><a class="anchor" href="#设计逻辑">#</a> 设计逻辑</h3>
<p>头文件引入和定义 ( <code>head.h</code> )</p>
<ul>
<li>引入所需的头文件</li>
<li>为整个项目提供基础的函数声明、结构体和类型定义。</li>
</ul>
<p>主函数 ( <code>main.c</code> )</p>
<ul>
<li>初始化进程池并启动工作线程。</li>
<li>初始化 TCP 监听，绑定 IP 和端口，准备接收客户端连接。</li>
<li>使用  <code>epoll</code>  监听客户端连接。当客户端连接建立时，将连接分配给进程池中的工作进程，并更新进程状态为忙碌。</li>
<li>监听进程池中的线程，等待它们处理完客户端请求，然后通知主进程将状态从忙碌改为空闲。</li>
</ul>
<p>进程池管理 ( <code>pool.c</code> )</p>
<ul>
<li>根据主进程的要求，启动指定数量的工作进程。</li>
<li>维护一个数组来记录工作进程及其状态，以便主进程监控工作进程何时完成任务。</li>
<li>当主进程接收到客户端连接时，进程池选择一个空闲的工作进程来处理连接。</li>
</ul>
<p>工作进程 ( <code>worker.c</code> )</p>
<ul>
<li>由进程池初始化和启动。</li>
<li>等待接收主进程传递的客户端连接。</li>
<li>接收到客户端连接后，与客户端进行通信，完成文件传输，然后关闭连接。</li>
<li>通信结束后，向主进程发送状态更新，从忙碌状态改为空闲状态。</li>
<li>等待主进程分配新的客户端连接。</li>
</ul>
<p>TCP 初始化 ( <code>tcpInit.c</code> )</p>
<ul>
<li>负责初始化 IP 和端口的监听</li>
<li>避免在主函数中编写大量 TCP 连接代码，实现解耦。</li>
</ul>
<p>Epoll 操作 ( <code>epoll.c</code> )</p>
<ul>
<li>封装  <code>epoll</code>  的相关操作</li>
<li>避免在主函数中编写大量  <code>epoll</code>  添加文件描述符监听的代码，实现解耦。</li>
</ul>
<p>本地 Socket 通信 ( <code>localSocket.c</code> )</p>
<ul>
<li>处理主进程和工作进程之间的进程间通信（IPC），特别是文件描述符的传递。</li>
<li>使用本地 Socket 实现复杂的 IPC，允许在主进程和工作进程之间传递文件描述符，并确保共享文件对象的能力。</li>
</ul>
<h3 id="该项目中需要使用的新函数"><a class="anchor" href="#该项目中需要使用的新函数">#</a> 该项目中需要使用的新函数</h3>
<h4 id="socketpair-创建一对互相连接的全双工通信"><a class="anchor" href="#socketpair-创建一对互相连接的全双工通信">#</a>  <code>socketpair</code>  创建一对互相连接的全双工通信</h4>
<p><code>socketpair</code>  函数用于创建一对已连接的 socket，即两个 socket 彼此相连，可以互相通信。这对 socket 通常用于在本地主机上的进程间通信（IPC）。</p>
<p>函数原型如下：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">int</span> <span class="token function">socketpair</span><span class="token punctuation">(</span><span class="token keyword">int</span> domain<span class="token punctuation">,</span> <span class="token keyword">int</span> type<span class="token punctuation">,</span> <span class="token keyword">int</span> protocol<span class="token punctuation">,</span> <span class="token keyword">int</span> sv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>参数说明：</p>
<ol>
<li>
<p><strong>int domain</strong>: 指定通信协议的家族。常见的值是  <code>AF_UNIX</code> ，用于 Unix 域套接字，或  <code>AF_INET</code>  用于 IPv4 套接字。本项目中使用  <code>AF_LOCAL</code>  用于本地通信。</p>
</li>
<li>
<p><strong>int type</strong>: 指定 socket 的类型，这决定了 socket 支持的通信语义。常见的类型包括：</p>
<ul>
<li><code>SOCK_STREAM</code> : 提供基于连接的、可靠的字节流服务（TCP）。</li>
<li><code>SOCK_DGRAM</code> : 提供无连接的、尽最大努力交付的数据报服务（UDP）。</li>
</ul>
</li>
<li>
<p><strong>int protocol</strong>: 指定使用的具体协议。对于  <code>AF_UNIX</code>  域，通常设置为 0，由系统选择默认协议。对于  <code>AF_INET</code>  域，常用的值是  <code>IPPROTO_TCP</code>  或  <code>IPPROTO_UDP</code> 。默认设置 0 即可</p>
</li>
<li>
<p><strong>int sv [2]</strong>: 这是一个整数数组，用于存储创建的一对 socket 文件描述符。 <code>sv[0]</code>  是第一个 socket 的文件描述符， <code>sv[1]</code>  是第二个 socket 的文件描述符。</p>
</li>
</ol>
<p>返回值：</p>
<ul>
<li>如果调用成功，返回 0，并且  <code>sv</code>  数组被填充为两个 socket 的文件描述符。</li>
<li>如果调用失败，返回 -1，并设置全局变量  <code>errno</code>  以指示错误类型。</li>
</ul>
<p>使用场景：</p>
<ul>
<li>当需要在两个进程之间建立一个可靠的字节流连接或数据报连接时。</li>
<li>当需要创建一个简单的 IPC 通道，用于进程间的数据交换。</li>
</ul>
<p>工作机制：</p>
<ul>
<li><code>socketpair</code>  函数调用操作系统内核，请求创建一对 socket，并确保它们彼此连接。</li>
<li>创建的这对 socket 可以立即用于双向通信，无需使用  <code>connect</code>  或  <code>bind</code>  等函数。</li>
</ul>
<p>示例：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">int</span> sv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">socketpair</span><span class="token punctuation">(</span>AF_UNIX<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> sv<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Failed to create socket pair"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token comment">// 使用 sv [0] 和 sv [1] 进行通信</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token comment">// 写入一些数据到 sv [1]</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>message <span class="token operator">=</span> <span class="token string">"Hello from one side!"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">write</span><span class="token punctuation">(</span>sv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> message<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Failed to write to socket"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token comment">// 从 sv [0] 读取数据</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token keyword">char</span> buffer<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token class-name">ssize_t</span> len <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>sv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Failed to read from socket"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Received message: %s\n"</span><span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token comment">// 关闭 socket</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token function">close</span><span class="token punctuation">(</span>sv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token function">close</span><span class="token punctuation">(</span>sv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这个示例使用了  <code>socketpair</code>  函数创建一对 socket，并使用它们进行简单的通信。我们向一个 socket 写入数据，并从另一个 socket 读取数据，最后关闭这两个 socket。</p>
<p>如果想通过  <code>socketpair</code>  函数 实现两个本地进程间的文件对象描述符的传输，除了需要  <code>socketpair</code>  函数创建通信的端点，还需要借助  <code>sendmsg</code>  函数和  <code>recvmsg</code>  函数 来实现 具体的数据传输。</p>
<h4 id="sendmsg-发送数据"><a class="anchor" href="#sendmsg-发送数据">#</a>  <code>sendmsg</code>  发送数据</h4>
<p><code>sendmsg</code>  函数是一种高级的发送接口，用于通过 socket 发送数据。与  <code>send</code>  或  <code>sendto</code>  函数相比， <code>sendmsg</code>  提供了更多的灵活性和控制，允许发送者指定更多的消息属性，如辅助数据、文件描述符等。</p>
<p>函数原型如下：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">ssize_t</span> <span class="token function">sendmsg</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">msghdr</span> <span class="token operator">*</span>msg<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>参数说明：</p>
<ol>
<li><strong>int sockfd</strong>: 这是 socket 的文件描述符，用于指定要发送数据的 socket。对应  <code>socketpair</code>  中创建的文件描述符  <code>sv[]</code>  数组</li>
<li>*<em>const struct msghdr <em>msg</em></em>: 这是一个指向  <code>msghdr</code>  结构的指针，该结构定义了要发送的消息的元数据和数据部分。 <code>msghdr</code>  结构包含以下主要成员：
<ul>
<li><code>void *msg_name</code> : 指向地址信息的指针，对于  <code>SOCK_DGRAM</code>  类型的 socket，这指定了目的地地址。填充 NULL 交给系统处理。</li>
<li><code>socklen_t msg_namelen</code> : 地址结构的长度，为 NULL 时系统自动填充</li>
<li><code> struct iovec *msg_iov</code> : 指向  <code>iovec</code>  结构数组的指针， <code>iovec</code>  包含了要发送的数据块的指针  <code>void *iov_base</code>  和长度  <code>size_t iov_len</code> 。</li>
<li><code>size_t msg_iovlen</code> :  <code>iovec</code>  数组的长度，即数据块的数量。</li>
<li><code>void* msg_control</code> : 指向辅助数据的指针，可以包含额外的信息，如权限或文件描述符。</li>
<li><code>size_t msg_controllen</code> : 辅助数据的长度。</li>
<li><code>int msg_flags</code> : 用于存储或接收特定于消息的标志。</li>
</ul>
</li>
<li><strong>int flags</strong>: 用于修改发送行为的选项标志。常用的标志包括：
<ul>
<li><code>MSG_OOB</code> : 发送带外数据（out-of-band data）。</li>
<li><code>MSG_DONTROUTE</code> : 不对数据进行路由选择，直接发送。</li>
<li><code>MSG_EOR</code> : 表示记录结束（仅用于  <code>SOCK_SEQPACKET</code>  类型的 socket）。</li>
<li>默认为 0。</li>
</ul>
</li>
</ol>
<p>返回值：</p>
<ul>
<li>如果调用成功，返回已发送的字节总数。</li>
<li>如果调用失败，返回 -1，并设置全局变量  <code>errno</code>  以指示错误类型。</li>
</ul>
<p>使用场景：</p>
<ul>
<li>当需要发送非连续的数据块时， <code>sendmsg</code>  允许将多个数据块一次性发送，而不是先复制到一个连续的缓冲区中。</li>
<li>当需要发送辅助数据或文件描述符时， <code>sendmsg</code>  提供了发送这些附加信息的能力。</li>
</ul>
<p>工作机制：</p>
<ul>
<li><code>sendmsg</code>  函数从  <code>msghdr</code>  结构指定的  <code>iovec</code>  数组中收集数据，并将其发送到  <code>sockfd</code>  指定的 socket。</li>
<li>如果  <code>msg_name</code>  成员不为空，对于  <code>SOCK_DGRAM</code>  类型的 socket，它将指定消息的目的地地址。</li>
</ul>
<p>示例：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">int</span> sockfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>sockfd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Failed to create socket"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token comment">// 绑定、监听、连接的代码...</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>message1 <span class="token operator">=</span> <span class="token string">"Hello, "</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>message2 <span class="token operator">=</span> <span class="token string">"world!"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">struct</span> <span class="token class-name">iovec</span> iov<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token punctuation">&#123;</span> <span class="token punctuation">.</span>iov_base <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>message1<span class="token punctuation">,</span> <span class="token punctuation">.</span>iov_len <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>message1<span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token punctuation">&#123;</span> <span class="token punctuation">.</span>iov_base <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>message2<span class="token punctuation">,</span> <span class="token punctuation">.</span>iov_len <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>message2<span class="token punctuation">)</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">struct</span> <span class="token class-name">msghdr</span> msg <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token punctuation">.</span>msg_iov <span class="token operator">=</span> iov<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token punctuation">.</span>msg_iovlen <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    </pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token class-name">ssize_t</span> sent <span class="token operator">=</span> <span class="token function">sendmsg</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>sent <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Failed to send message"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Sent %zd bytes\n"</span><span class="token punctuation">,</span> sent<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这个示例创建了一个 socket，并使用  <code>sendmsg</code>  函数发送两条数据消息。定义一个  <code>iovec</code>  数组，其中包含了两条消息的指针和长度，并初始化了一个  <code>msghdr</code>  结构来引用这个数组。然后调用了  <code>sendmsg</code>  发送整个消息。如果发送失败则打印错误信息并关闭 socket。</p>
<h4 id="recvmsg-接收数据"><a class="anchor" href="#recvmsg-接收数据">#</a>  <code>recvmsg</code>  接收数据</h4>
<p><code>recvmsg</code>  函数是一种高级的接收接口，用于接收通过 socket 发送的数据。与  <code>recv</code>  函数相比， <code>recvmsg</code>  提供了更多的灵活性和控制，允许接收者获取关于接收数据的详细信息，包括辅助数据、文件描述符等。</p>
<p>函数原型如下：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">ssize_t</span> <span class="token function">recvmsg</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">msghdr</span> <span class="token operator">*</span>msg<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>参数说明：</p>
<ol>
<li>
<p><strong>int sockfd</strong>: 这是 socket 的文件描述符，用于指定要接收数据的 socket。</p>
</li>
<li>
<p>*<em>struct msghdr <em>msg</em></em>: 这是一个指向  <code>msghdr</code>  结构的指针，该结构定义了接收数据的目标缓冲区和辅助数据缓冲区。</p>
</li>
<li>
<p><strong>int flags</strong>: 用于修改接收行为的选项标志。常用的标志包括：</p>
<ul>
<li><code>0</code> : 正常接收数据。</li>
<li><code>MSG_PEEK</code> : 窥视接收数据，即读取数据但不去删除缓冲区中的数据。</li>
<li><code>MSG_WAITALL</code> : 等待直到接收到足够多的数据，至少填满一个  <code>iovec</code>  缓冲区。</li>
</ul>
</li>
</ol>
<p>返回值：</p>
<ul>
<li>如果调用成功，返回接收到的字节总数。</li>
<li>如果调用失败，返回 -1，并设置全局变量  <code>errno</code>  以指示错误类型。</li>
</ul>
<p>使用场景：</p>
<ul>
<li>当需要接收非连续的数据块时， <code>recvmsg</code>  允许将数据直接接收到多个数据块中，而不是先接收到一个连续的缓冲区再复制到各个数据块。</li>
<li>当需要接收辅助数据或文件描述符时， <code>recvmsg</code>  提供了接收这些附加信息的能力。</li>
</ul>
<p>工作机制：</p>
<ul>
<li><code>recvmsg</code>  函数从 socket 中接收数据，并将其存储到  <code>msghdr</code>  结构指定的  <code>iovec</code>  数组中。</li>
<li>如果  <code>msg_name</code>  成员不为空， <code>recvmsg</code>  将填充该缓冲区以包含发送方的地址信息。</li>
</ul>
<p>示例：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">int</span> sockfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>sockfd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Failed to create socket"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token comment">// 连接的代码...</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">char</span> buffer1<span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">char</span> buffer2<span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token keyword">struct</span> <span class="token class-name">iovec</span> iov<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token punctuation">&#123;</span> <span class="token punctuation">.</span>iov_base <span class="token operator">=</span> buffer1<span class="token punctuation">,</span> <span class="token punctuation">.</span>iov_len <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buffer1<span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token punctuation">&#123;</span> <span class="token punctuation">.</span>iov_base <span class="token operator">=</span> buffer2<span class="token punctuation">,</span> <span class="token punctuation">.</span>iov_len <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buffer2<span class="token punctuation">)</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token keyword">struct</span> <span class="token class-name">msghdr</span> msg <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token punctuation">.</span>msg_iov <span class="token operator">=</span> iov<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token punctuation">.</span>msg_iovlen <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token punctuation">.</span>msg_control <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token punctuation">.</span>msg_controllen <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token class-name">ssize_t</span> received <span class="token operator">=</span> <span class="token function">recvmsg</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>received <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Failed to receive message"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>received <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Connection closed by the peer.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Received %zd bytes\n"</span><span class="token punctuation">,</span> received<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>        <span class="token comment">// 处理接收到的数据</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这个示例创建了一个 socket 并连接到一个服务器。然后定义了两个数据接收缓冲区和一个  <code>iovec</code>  数组，以及一个  <code>msghdr</code>  结构来接收数据。使用  <code>recvmsg</code>  函数接收数据，并检查返回值以确定是否成功接收。如果接收到数据，打印出接收到的字节数并处理数据。如果连接被关闭，打印相应的消息。最后关闭 socket。</p>
<h4 id="cmsghdr"><a class="anchor" href="#cmsghdr">#</a>  <code>cmsghdr</code></h4>
<p><code>struct cmsghdr</code>  是 POSIX 系统上的一个 C 结构体，用于定义控制消息（也称为辅助数据）的头部信息，这些控制消息可以与正常的 socket 数据一起发送或接收。 <code>recvmsg</code>  和  <code>sendmsg</code>  函数使用这种结构体来处理与 socket 相关的辅助数据，例如文件描述符、权限设置或其他协议特定的信息。</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">cmsghdr</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token class-name">socklen_t</span>     cmsg_len<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">int</span>           cmsg_level<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">int</span>           cmsg_type<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> cmsg_data<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>结构体成员说明：</p>
<ol>
<li><strong>socklen_t cmsg_len</strong>: 控制消息的长度，以字节为单位。这个长度包括了  <code>cmsghdr</code>  结构本身的整个大小，以及  <code>cmsg_data</code>  数组中数据的长度。</li>
<li><strong>int cmsg_level</strong>: 指定控制消息的协议层。例如， <code>SOL_SOCKET</code>  表示这是一个通用的 socket 选项。</li>
<li><strong>int cmsg_type</strong>: 指定控制消息的类型。类型依赖于  <code>cmsg_level</code> 。例如， <code>SCM_RIGHTS</code>  用于传输文件描述符， <code>SCM_CREDENTIALS</code>  用于传输用户凭证。</li>
<li><strong>unsigned char cmsg_data []</strong>: 一个无符号字符数组，用于存放实际的控制消息数据。数组的长度由  <code>cmsg_len</code>  成员减去  <code>cmsghdr</code>  头部的大小确定。</li>
</ol>
<p>控制消息的使用场景：</p>
<ul>
<li>当需要在 socket 通信中发送或接收额外的元数据时。</li>
<li>当需要在不同的进程间传输文件描述符或用户凭证等信息时。</li>
</ul>
<p>控制消息的工作机制：</p>
<ul>
<li>控制消息被封装在  <code>sendmsg</code>  和  <code>recvmsg</code>  函数的  <code>msg_control</code>  缓冲区中。</li>
<li>发送端使用  <code>cmsghdr</code>  结构来构造控制消息，并将其放入  <code>msg_control</code>  缓冲区。</li>
<li>接收端从  <code>msg_control</code>  缓冲区解析  <code>cmsghdr</code>  结构，以获取控制消息。</li>
</ul>
<p><strong> <code>cmsg_data</code>  数组</strong>： <code>cmsg_data</code>  数组用于存放  <code>cmsghdr</code>  结构中额外的数据，其长度可以根据实际需求变化。例如，当需要传递文件描述符时， <code>cmsg_data</code>  的长度将与  <code>int</code>  类型的大小一致。</p>
<p><strong> <code>CMSG_LEN</code>  宏</strong>： <code>CMSG_LEN</code>  宏用于计算包括  <code>cmsg_data</code>  在内的  <code>cmsghdr</code>  结构的完整长度。使用时，传入  <code>cmsg_data</code>  的长度作为参数。例如，若  <code>cmsg_data</code>  用于存储文件描述符（通常是  <code>int</code>  类型），则  <code>CMSG_LEN(sizeof(int))</code>  将给出整个  <code>cmsghdr</code>  结构的长度。</p>
<p><strong> <code>CMSG_DATA</code>  宏</strong>： <code>CMSG_DATA</code>  宏用于获取指向  <code>cmsghdr</code>  结构中  <code>cmsg_data</code>  部分的指针。这对于访问和修改传输的额外数据非常有用。</p>
<p>示例代码：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">// 假设 netfd 是要传输的文件描述符</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">int</span> <span class="token operator">*</span>netfd <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment">// 分配足够的内存以存储 cmsghdr 结构，包括 cmsg_data</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">cmsghdr</span> <span class="token operator">*</span>pcms <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token function">CMSG_LEN</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pcms<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token comment">// 错误处理</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment">// 设置 cmsghdr 结构</span></pre></td></tr><tr><td data-num="15"></td><td><pre>pcms<span class="token operator">-></span>cmsg_level <span class="token operator">=</span> SOL_SOCKET<span class="token punctuation">;</span> <span class="token comment">// 通常使用 SOL_SOCKET</span></pre></td></tr><tr><td data-num="16"></td><td><pre>pcms<span class="token operator">-></span>cmsg_type <span class="token operator">=</span> SCM_RIGHTS<span class="token punctuation">;</span>  <span class="token comment">// 文件描述符传递类型</span></pre></td></tr><tr><td data-num="17"></td><td><pre>pcms<span class="token operator">-></span>cmsg_len <span class="token operator">=</span> <span class="token function">CMSG_LEN</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token comment">// 获取 cmsg_data 部分的指针并设置文件描述符</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token keyword">void</span> <span class="token operator">*</span>addr <span class="token operator">=</span> <span class="token function">CMSG_DATA</span><span class="token punctuation">(</span>pcms<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token keyword">int</span> <span class="token operator">*</span>p_fd <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span>addr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token operator">*</span>p_fd <span class="token operator">=</span> <span class="token operator">*</span>netfd<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token comment">// 使用 recvmsg 或 sendmsg 函数进行通信时，将 cmsghdr 结构传递给相应的缓冲区</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token comment">// ...</span></pre></td></tr></table></figure><p>在上述代码中，首先使用  <code>malloc</code>  分配了足够的内存来存储  <code>cmsghdr</code>  结构，包括  <code>cmsg_data</code>  部分。然后，使用  <code>CMSG_LEN</code>  宏计算结构的长度，并使用  <code>CMSG_DATA</code>  宏获取指向  <code>cmsg_data</code>  的指针。最后，将文件描述符的值赋给通过指针  <code>p_fd</code>  访问的位置。</p>
<h3 id="makefile"><a class="anchor" href="#makefile">#</a> Makefile</h3>
<figure class="highlight makefile"><figcaption data-lang="makefile"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># makefile</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># 定义一个 srcs 变量，来代指：使用 wildcard 函数获取当前目录下的所有. c 文件</span></pre></td></tr><tr><td data-num="3"></td><td><pre>srcs<span class="token operator">:=</span><span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">wildcard</span> *.c<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 定义一个 objs 变量，来代指：使用 patsubst 函数讲 srcs 中所有的. c 文件拓展名替换成. o 文件</span></pre></td></tr><tr><td data-num="5"></td><td><pre>objs<span class="token operator">:=</span><span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">patsubst</span> %.c,%.o, <span class="token variable">$</span><span class="token punctuation">(</span>srcs<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment"># 编译 '-c $^'(源依赖项. c 文件)  输出到 '-o $@'(目标. o) 文件</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token target symbol">%.o</span><span class="token punctuation">:</span>%.c</pre></td></tr><tr><td data-num="9"></td><td><pre>    gcc -c <span class="token variable">$^</span> -o <span class="token variable">$@</span> -g</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment"># mian 文件依赖于所有的 objs 文件</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment"># 把所有依赖项 ($^) 指定输出到当前目标 (-o $@)(即: main)</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token target symbol">main</span><span class="token punctuation">:</span><span class="token variable">$</span><span class="token punctuation">(</span>objs<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    gcc <span class="token variable">$^</span> -o <span class="token variable">$@</span> -lpthread</pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token comment"># 清理 objs 文件 清理 main 文件</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token target symbol">clean</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token variable">$</span><span class="token punctuation">(</span>RM<span class="token punctuation">)</span> <span class="token variable">$</span><span class="token punctuation">(</span>objs<span class="token punctuation">)</span> main</pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token target symbol">rebuild</span><span class="token punctuation">:</span> clean main</pre></td></tr></table></figure><h3 id="headerh"><a class="anchor" href="#headerh">#</a> header.h</h3>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="2"></td><td><pre> * @file head.h</pre></td></tr><tr><td data-num="3"></td><td><pre> * @brief 头文件，包含整个项目中使用的全局定义、数据结构和函数声明。</pre></td></tr><tr><td data-num="4"></td><td><pre> */</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">HEAD_H</span></span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">HEAD_H</span></span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/epoll.h></span></span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h></span></span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h></span></span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="19"></td><td><pre> * @brief 定义进程的状态。</pre></td></tr><tr><td data-num="20"></td><td><pre> */</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token keyword">enum</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    BUSY<span class="token punctuation">,</span>  <span class="token comment">/**&lt; 子进程当前正忙，正在处理任务。 */</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    FREE   <span class="token comment">/**&lt; 子进程当前空闲，可以接受新任务。 */</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="27"></td><td><pre> * @brief 子进程状态结构体，用于记录子进程的信息。</pre></td></tr><tr><td data-num="28"></td><td><pre> */</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">son_status_s</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token class-name">pid_t</span> pid<span class="token punctuation">;</span>         <span class="token comment">/**&lt; 子进程的进程 ID */</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token keyword">int</span> flag<span class="token punctuation">;</span>          <span class="token comment">/**&lt; 子进程的当前状态，BUSY 或 FREE */</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token keyword">int</span> local_socket<span class="token punctuation">;</span>  <span class="token comment">/**&lt; 子进程与父进程通信的本地 socket 文件描述符 */</span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token punctuation">&#125;</span> son_status_s<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="36"></td><td><pre> * @brief 初始化进程池。</pre></td></tr><tr><td data-num="37"></td><td><pre> * </pre></td></tr><tr><td data-num="38"></td><td><pre> * 根据指定的数量初始化进程池，创建子进程，并设置它们的状态。</pre></td></tr><tr><td data-num="39"></td><td><pre> *</pre></td></tr><tr><td data-num="40"></td><td><pre> * @param list 指向存储子进程状态的数组的指针。</pre></td></tr><tr><td data-num="41"></td><td><pre> * @param num 要初始化的子进程数量。</pre></td></tr><tr><td data-num="42"></td><td><pre> * @return 返回 0 表示初始化成功，-1 表示初始化失败。</pre></td></tr><tr><td data-num="43"></td><td><pre> */</span></pre></td></tr><tr><td data-num="44"></td><td><pre><span class="token keyword">int</span> <span class="token function">initPool</span><span class="token punctuation">(</span>son_status_s <span class="token operator">*</span>list<span class="token punctuation">,</span> <span class="token keyword">int</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre></pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="47"></td><td><pre> * @brief 初始化 socket 服务端。</pre></td></tr><tr><td data-num="48"></td><td><pre> * </pre></td></tr><tr><td data-num="49"></td><td><pre> * 根据提供的端口和 IP 地址创建并配置 socket，使其能够监听网络连接。</pre></td></tr><tr><td data-num="50"></td><td><pre> *</pre></td></tr><tr><td data-num="51"></td><td><pre> * @param socket_fd 指向 socket 文件描述符的指针。</pre></td></tr><tr><td data-num="52"></td><td><pre> * @param port 要监听的端口号。</pre></td></tr><tr><td data-num="53"></td><td><pre> * @param ip 要绑定的 IP 地址。</pre></td></tr><tr><td data-num="54"></td><td><pre> * @return 返回 0 表示初始化成功，-1 表示初始化失败。</pre></td></tr><tr><td data-num="55"></td><td><pre> */</span></pre></td></tr><tr><td data-num="56"></td><td><pre><span class="token keyword">int</span> <span class="token function">initSocket</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span>socket_fd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>port<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre></pre></td></tr><tr><td data-num="58"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="59"></td><td><pre> * @brief 将文件描述符添加到 epoll 实例中。</pre></td></tr><tr><td data-num="60"></td><td><pre> * </pre></td></tr><tr><td data-num="61"></td><td><pre> * 将指定的文件描述符添加到 epoll 实例中，以便进行事件监听。</pre></td></tr><tr><td data-num="62"></td><td><pre> *</pre></td></tr><tr><td data-num="63"></td><td><pre> * @param epoll_fd epoll 实例的文件描述符。</pre></td></tr><tr><td data-num="64"></td><td><pre> * @param fd 要添加的文件描述符。</pre></td></tr><tr><td data-num="65"></td><td><pre> * @return 返回 0 表示添加成功，-1 表示添加失败。</pre></td></tr><tr><td data-num="66"></td><td><pre> */</span></pre></td></tr><tr><td data-num="67"></td><td><pre><span class="token keyword">int</span> <span class="token function">addEpoll</span><span class="token punctuation">(</span><span class="token keyword">int</span> epoll_fd<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre></pre></td></tr><tr><td data-num="69"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="70"></td><td><pre> * @brief 将客户端连接分配给子进程处理。</pre></td></tr><tr><td data-num="71"></td><td><pre> * </pre></td></tr><tr><td data-num="72"></td><td><pre> * 在进程池中找到一个空闲的子进程，并将客户端连接传递给它处理。</pre></td></tr><tr><td data-num="73"></td><td><pre> *</pre></td></tr><tr><td data-num="74"></td><td><pre> * @param list 指向子进程状态数组的指针。</pre></td></tr><tr><td data-num="75"></td><td><pre> * @param num 子进程的数量。</pre></td></tr><tr><td data-num="76"></td><td><pre> * @param net_fd 客户端连接的文件描述符。</pre></td></tr><tr><td data-num="77"></td><td><pre> * @return 返回 0 表示分配成功，-1 表示分配失败。</pre></td></tr><tr><td data-num="78"></td><td><pre> */</span></pre></td></tr><tr><td data-num="79"></td><td><pre><span class="token keyword">int</span> <span class="token function">toSonNetFd</span><span class="token punctuation">(</span>son_status_s <span class="token operator">*</span>list<span class="token punctuation">,</span> <span class="token keyword">int</span> num<span class="token punctuation">,</span> <span class="token keyword">int</span> net_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="80"></td><td><pre></pre></td></tr><tr><td data-num="81"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="82"></td><td><pre> * @brief 子进程的工作函数。</pre></td></tr><tr><td data-num="83"></td><td><pre> * </pre></td></tr><tr><td data-num="84"></td><td><pre> * 子进程在此函数中循环等待接收任务，并处理客户端请求。</pre></td></tr><tr><td data-num="85"></td><td><pre> *</pre></td></tr><tr><td data-num="86"></td><td><pre> * @param local_socket 子进程与父进程通信的本地 socket 文件描述符。</pre></td></tr><tr><td data-num="87"></td><td><pre> * @return 返回 0 表示正常，-1 表示处理过程中出现错误。</pre></td></tr><tr><td data-num="88"></td><td><pre> */</span></pre></td></tr><tr><td data-num="89"></td><td><pre><span class="token keyword">int</span> <span class="token function">doWorker</span><span class="token punctuation">(</span><span class="token keyword">int</span> local_socket<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="90"></td><td><pre></pre></td></tr><tr><td data-num="91"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="92"></td><td><pre> * @brief 通过本地 socket 发送客户端文件描述符给子进程。</pre></td></tr><tr><td data-num="93"></td><td><pre> * </pre></td></tr><tr><td data-num="94"></td><td><pre> * 将客户端连接的文件描述符通过本地 socket 发送给子进程。</pre></td></tr><tr><td data-num="95"></td><td><pre> *</pre></td></tr><tr><td data-num="96"></td><td><pre> * @param local_socket 父进程与子进程通信的本地 socket 文件描述符。</pre></td></tr><tr><td data-num="97"></td><td><pre> * @param net_fd 客户端连接的文件描述符。</pre></td></tr><tr><td data-num="98"></td><td><pre> * @return 返回 0 0 表示成功，-1 表示失败。</pre></td></tr><tr><td data-num="99"></td><td><pre> */</span></pre></td></tr><tr><td data-num="100"></td><td><pre><span class="token keyword">int</span> <span class="token function">sendMsg</span><span class="token punctuation">(</span><span class="token keyword">int</span> local_socket<span class="token punctuation">,</span> <span class="token keyword">int</span> net_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="101"></td><td><pre></pre></td></tr><tr><td data-num="102"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="103"></td><td><pre> * @brief 子进程通过本地 socket 接收客户端文件描述符。</pre></td></tr><tr><td data-num="104"></td><td><pre> * </pre></td></tr><tr><td data-num="105"></td><td><pre> * 子进程在此函数中接收父进程通过本地 socket 发送的客户端连接文件描述符。</pre></td></tr><tr><td data-num="106"></td><td><pre> *</pre></td></tr><tr><td data-num="107"></td><td><pre> * @param local_socket 子进程与父进程通信的本地 socket 文件描述符。</pre></td></tr><tr><td data-num="108"></td><td><pre> * @param net_fd 指向接收到的客户端连接文件描述符的指针。</pre></td></tr><tr><td data-num="109"></td><td><pre> * @return 返回 0 表示成功，-1 表示失败。</pre></td></tr><tr><td data-num="110"></td><td><pre> */</span></pre></td></tr><tr><td data-num="111"></td><td><pre><span class="token keyword">int</span> <span class="token function">recvMsg</span><span class="token punctuation">(</span><span class="token keyword">int</span> local_socket<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>net_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="112"></td><td><pre></pre></td></tr><tr><td data-num="113"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="114"></td><td><pre> * @brief 与客户端进行交互。</pre></td></tr><tr><td data-num="115"></td><td><pre> * </pre></td></tr><tr><td data-num="116"></td><td><pre> * 子进程使用此函数与客户端进行通信，例如发送或接收数据。</pre></td></tr><tr><td data-num="117"></td><td><pre> *</pre></td></tr><tr><td data-num="118"></td><td><pre> * @param net_fd 客户端连接的文件描述符。</pre></td></tr><tr><td data-num="119"></td><td><pre> * @return 返回 0 表示成功，-1 表示通信失败。</pre></td></tr><tr><td data-num="120"></td><td><pre> */</span></pre></td></tr><tr><td data-num="121"></td><td><pre><span class="token keyword">int</span> <span class="token function">toClientFile</span><span class="token punctuation">(</span><span class="token keyword">int</span> net_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="122"></td><td><pre></pre></td></tr><tr><td data-num="123"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">// !HEAD_H</span></span></pre></td></tr></table></figure><h3 id="mainc"><a class="anchor" href="#mainc">#</a> main.c</h3>
<ol>
<li><strong>初始化进程池</strong>：调用  <code>initPool</code>  函数，创建 4 个子进程，并将它们的状态设置为  <code>FREE</code> 。</li>
<li><strong>初始化网络 socket</strong>：调用  <code>initSocket</code>  函数，创建一个 socket 用于监听端口  <code>8080</code>  上的连接请求。</li>
<li><strong>创建 epoll 实例</strong>：调用  <code>epoll_create</code>  函数创建一个 epoll 实例，用于后续的事件监听。</li>
<li><strong>添加监听 socket 到 epoll</strong>：调用  <code>addEpoll</code>  函数，将监听 socket 添加到 epoll 实例中，以便监听新的连接请求。</li>
<li><strong>添加子进程的本地 socket 到 epoll</strong>：遍历进程池，将每个子进程的本地 socket 添加到 epoll 实例中，以便监听子进程的通知。</li>
<li>主事件循环：使用  <code>epoll_wait</code>  函数等待 epoll 事件的发生。对于每个事件：
<ul>
<li>如果事件是由监听 socket 触发的，接受新的客户端连接，然后调用  <code>toSonNetFd</code>  函数将客户端连接分配给一个空闲的子进程处理。</li>
<li>如果事件是由子进程的本地 socket 触发的，读取子进程发送的消息，并更新子进程的状态为  <code>FREE</code> 。</li>
</ul>
</li>
<li><strong>循环结束</strong>：主事件循环无限循环，直到程序被外部中断或终止。</li>
</ol>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="2"></td><td><pre> * @file main.c</pre></td></tr><tr><td data-num="3"></td><td><pre> * @brief 主程序文件，包含程序的入口点和主逻辑。</pre></td></tr><tr><td data-num="4"></td><td><pre> *</pre></td></tr><tr><td data-num="5"></td><td><pre> * 此文件定义了程序的主要入口点 main 函数，负责初始化进程池、网络连接，</pre></td></tr><tr><td data-num="6"></td><td><pre> * epoll 事件循环，并处理客户端请求。</pre></td></tr><tr><td data-num="7"></td><td><pre> */</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"head.h"</span></span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    son_status_s list<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">/**&lt; 定义一个进程池数组，存储子进程的状态信息 */</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token comment">/**</pre></td></tr><tr><td data-num="15"></td><td><pre>   * 初始化进程池。</pre></td></tr><tr><td data-num="16"></td><td><pre>   * 创建一定数量的子进程，并将它们的状态设置为 FREE（空闲）。</pre></td></tr><tr><td data-num="17"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token function">initPool</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token comment">/**</pre></td></tr><tr><td data-num="21"></td><td><pre>   * 初始化网络 socket。</pre></td></tr><tr><td data-num="22"></td><td><pre>   * 创建并配置 socket，使其能够监听指定 IP 地址和端口上的连接请求。</pre></td></tr><tr><td data-num="23"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token keyword">int</span> socket_fd<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token function">initSocket</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>socket_fd<span class="token punctuation">,</span> <span class="token string">"8080"</span><span class="token punctuation">,</span> <span class="token string">"172.16.0.3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token comment">/**</pre></td></tr><tr><td data-num="28"></td><td><pre>   * 创建 epoll 实例，并设置为非阻塞模式。</pre></td></tr><tr><td data-num="29"></td><td><pre>   * epoll 用于高效地处理大量并发连接。</pre></td></tr><tr><td data-num="30"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token keyword">int</span> epoll_fd <span class="token operator">=</span> <span class="token function">epoll_create</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token comment">/**</pre></td></tr><tr><td data-num="34"></td><td><pre>   * 将监听 socket 添加到 epoll 实例中。</pre></td></tr><tr><td data-num="35"></td><td><pre>   * 这样，当有新的连接请求时，epoll 可以通知主进程。</pre></td></tr><tr><td data-num="36"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token function">addEpoll</span><span class="token punctuation">(</span>epoll_fd<span class="token punctuation">,</span> socket_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token comment">/**</pre></td></tr><tr><td data-num="40"></td><td><pre>   * 将进程池中每个子进程的本地 socket 添加到 epoll 实例中。</pre></td></tr><tr><td data-num="41"></td><td><pre>   * 这样，主进程可以接收来自子进程的通知，例如任务完成。</pre></td></tr><tr><td data-num="42"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>        <span class="token function">addEpoll</span><span class="token punctuation">(</span>epoll_fd<span class="token punctuation">,</span> list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>local_socket<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="46"></td><td><pre></pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token comment">/**</pre></td></tr><tr><td data-num="48"></td><td><pre>   * 主事件循环。</pre></td></tr><tr><td data-num="49"></td><td><pre>   * 使用 epoll_wait 等待并处理 I/O 事件。</pre></td></tr><tr><td data-num="50"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="51"></td><td><pre>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>        <span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> events<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">/**&lt; 定义一个事件数组，存储 epoll 事件 */</span></pre></td></tr><tr><td data-num="53"></td><td><pre>        <span class="token function">memset</span><span class="token punctuation">(</span>events<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>events<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/**&lt; 清零事件数组 */</span></pre></td></tr><tr><td data-num="54"></td><td><pre></pre></td></tr><tr><td data-num="55"></td><td><pre>        <span class="token comment">/**</pre></td></tr><tr><td data-num="56"></td><td><pre>     * 等待 epoll 事件。</pre></td></tr><tr><td data-num="57"></td><td><pre>     * -1 表示无限期等待，直到有事件发生。</pre></td></tr><tr><td data-num="58"></td><td><pre>     */</span></pre></td></tr><tr><td data-num="59"></td><td><pre>        <span class="token keyword">int</span> epoll_num <span class="token operator">=</span> <span class="token function">epoll_wait</span><span class="token punctuation">(</span>epoll_fd<span class="token punctuation">,</span> events<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="60"></td><td><pre></pre></td></tr><tr><td data-num="61"></td><td><pre>        <span class="token comment">/**</pre></td></tr><tr><td data-num="62"></td><td><pre>     * 遍历所有事件，处理它们。</pre></td></tr><tr><td data-num="63"></td><td><pre>     */</span></pre></td></tr><tr><td data-num="64"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> epoll_num<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>            <span class="token keyword">int</span> fd <span class="token operator">=</span> events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd<span class="token punctuation">;</span> <span class="token comment">/**&lt; 获取事件对应的文件描述符 */</span></pre></td></tr><tr><td data-num="66"></td><td><pre></pre></td></tr><tr><td data-num="67"></td><td><pre>            <span class="token comment">/**</pre></td></tr><tr><td data-num="68"></td><td><pre>       * 如果事件是由监听 socket 触发的，接受新的客户端连接。</pre></td></tr><tr><td data-num="69"></td><td><pre>       */</span></pre></td></tr><tr><td data-num="70"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">==</span> socket_fd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>                <span class="token keyword">int</span> net_fd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span>net_fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>                    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"accept"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>                    <span class="token keyword">continue</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="76"></td><td><pre></pre></td></tr><tr><td data-num="77"></td><td><pre>                <span class="token comment">/**</pre></td></tr><tr><td data-num="78"></td><td><pre>         * 将新的客户端连接分配给一个空闲的子进程。</pre></td></tr><tr><td data-num="79"></td><td><pre>         */</span></pre></td></tr><tr><td data-num="80"></td><td><pre>                <span class="token function">toSonNetFd</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> net_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="81"></td><td><pre></pre></td></tr><tr><td data-num="82"></td><td><pre>                <span class="token function">close</span><span class="token punctuation">(</span>net_fd<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/**&lt; 关闭新创建的 socket，由子进程处理 */</span></pre></td></tr><tr><td data-num="83"></td><td><pre>                <span class="token keyword">continue</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="84"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="85"></td><td><pre></pre></td></tr><tr><td data-num="86"></td><td><pre>            <span class="token comment">/**</pre></td></tr><tr><td data-num="87"></td><td><pre>       * 如果事件是由子进程的本地 socket 触发的，处理子进程的通知。</pre></td></tr><tr><td data-num="88"></td><td><pre>       */</span></pre></td></tr><tr><td data-num="89"></td><td><pre>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="90"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span>list<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>local_socket <span class="token operator">==</span> fd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="91"></td><td><pre>                    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">60</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="92"></td><td><pre>                    <span class="token function">recv</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/**&lt; 读取子进程发送的消息 */</span></pre></td></tr><tr><td data-num="93"></td><td><pre>                    list<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>flag <span class="token operator">=</span> FREE<span class="token punctuation">;</span> <span class="token comment">/**&lt; 将子进程状态设置为 FREE */</span></pre></td></tr><tr><td data-num="94"></td><td><pre>                    <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="95"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="96"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="97"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="98"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="99"></td><td><pre></pre></td></tr><tr><td data-num="100"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">/**&lt; 程序正常退出 */</span></pre></td></tr><tr><td data-num="101"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="poolc"><a class="anchor" href="#poolc">#</a> pool.c</h3>
<p><strong>初始化进程池 ( <code>initPool</code>  函数)</strong>:</p>
<ul>
<li>定义一个循环，根据传入的  <code>num</code>  参数创建相应数量的子进程。</li>
<li>对于每个子进程：
<ul>
<li>创建一个 socketpair，用于父进程和子进程之间的通信。</li>
<li>使用  <code>fork</code>  创建子进程。</li>
<li>子进程关闭不需要的 socket 端点，然后调用  <code>doWorker</code>  函数进入工作循环。</li>
<li>父进程保存子进程的 PID 和用于通信的 socket 端点，并将子进程的状态设置为  <code>FREE</code> 。</li>
</ul>
</li>
<li>如果创建 socketpair 或者  <code>fork</code>  失败，函数返回 -1 表示错误。</li>
</ul>
<p><strong>分配客户端连接给子进程 ( <code>toSonNetFd</code>  函数)</strong>:</p>
<ul>
<li>遍历进程池，寻找第一个状态为  <code>FREE</code>  的子进程。</li>
<li>使用  <code>sendMsg</code>  函数将客户端的网络文件描述符  <code>net_fd</code>  发送给子进程。</li>
<li>将找到的子进程状态设置为  <code>BUSY</code> 。</li>
<li>如果所有子进程都忙，或者发送消息失败，则函数返回 -1 表示错误。</li>
</ul>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="2"></td><td><pre> * @file pool.c</pre></td></tr><tr><td data-num="3"></td><td><pre> * @brief 进程池管理模块。</pre></td></tr><tr><td data-num="4"></td><td><pre> * </pre></td></tr><tr><td data-num="5"></td><td><pre> * 该文件实现了进程池的初始化和子进程的管理工作。</pre></td></tr><tr><td data-num="6"></td><td><pre> */</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"head.h"</span></span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="11"></td><td><pre> * @brief 初始化进程池。</pre></td></tr><tr><td data-num="12"></td><td><pre> *</pre></td></tr><tr><td data-num="13"></td><td><pre> * 为指定数量的子进程分配资源，并创建 socketpair 用于与子进程通信。</pre></td></tr><tr><td data-num="14"></td><td><pre> * 每个子进程通过 fork 创建，并进入 doWorker 函数循环等待任务。</pre></td></tr><tr><td data-num="15"></td><td><pre> *</pre></td></tr><tr><td data-num="16"></td><td><pre> * @param list 指向 son_status_s 结构体数组的指针，该数组用于存储子进程的状态。</pre></td></tr><tr><td data-num="17"></td><td><pre> * @param num 子进程的数量。</pre></td></tr><tr><td data-num="18"></td><td><pre> * @return 成功返回 0，失败返回 -1。</pre></td></tr><tr><td data-num="19"></td><td><pre> */</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token keyword">int</span> <span class="token function">initPool</span><span class="token punctuation">(</span>son_status_s <span class="token operator">*</span>list<span class="token punctuation">,</span> <span class="token keyword">int</span> num<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token keyword">int</span> socket_fd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">socketpair</span><span class="token punctuation">(</span>AF_LOCAL<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> socket_fd<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>            <span class="token comment">// 处理错误...</span></pre></td></tr><tr><td data-num="25"></td><td><pre>            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token class-name">pid_t</span> son_id <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>son_id <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>            <span class="token comment">// 处理错误...</span></pre></td></tr><tr><td data-num="31"></td><td><pre>            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>son_id <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>            <span class="token comment">// 子进程</span></pre></td></tr><tr><td data-num="34"></td><td><pre>            <span class="token function">close</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 关闭未使用的 socket 端点</span></pre></td></tr><tr><td data-num="35"></td><td><pre>            <span class="token function">doWorker</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 执行子进程任务循环</span></pre></td></tr><tr><td data-num="36"></td><td><pre>            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 子进程结束</span></pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>            <span class="token comment">// 父进程</span></pre></td></tr><tr><td data-num="39"></td><td><pre>            list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>flag <span class="token operator">=</span> FREE<span class="token punctuation">;</span> <span class="token comment">// 设置子进程状态为 FREE</span></pre></td></tr><tr><td data-num="40"></td><td><pre>            list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>local_socket <span class="token operator">=</span> socket_fd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 保存与子进程通信的 socket</span></pre></td></tr><tr><td data-num="41"></td><td><pre>            list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>pid <span class="token operator">=</span> son_id<span class="token punctuation">;</span> <span class="token comment">// 保存子进程的 PID</span></pre></td></tr><tr><td data-num="42"></td><td><pre>            <span class="token function">close</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 关闭子进程未使用的 socket 端点</span></pre></td></tr><tr><td data-num="43"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="47"></td><td><pre></pre></td></tr><tr><td data-num="48"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="49"></td><td><pre> * @brief 将网络文件描述符传递给子进程处理。</pre></td></tr><tr><td data-num="50"></td><td><pre> *</pre></td></tr><tr><td data-num="51"></td><td><pre> * 遍历进程池，寻找第一个标记为 FREE 的子进程，并通过 socketpair 发送网络文件描述符。</pre></td></tr><tr><td data-num="52"></td><td><pre> * 之后，将该子进程的状态标记为 BUSY。</pre></td></tr><tr><td data-num="53"></td><td><pre> *</pre></td></tr><tr><td data-num="54"></td><td><pre> * @param list 指向 son_status_s 结构体数组的指针，包含子进程的状态信息。</pre></td></tr><tr><td data-num="55"></td><td><pre> * @param num 子进程的数量。</pre></td></tr><tr><td data-num="56"></td><td><pre> * @param net_fd 需要传递给子进程的网络文件描述符。</pre></td></tr><tr><td data-num="57"></td><td><pre> * @return 成功返回 0，失败返回 -1。</pre></td></tr><tr><td data-num="58"></td><td><pre> */</span></pre></td></tr><tr><td data-num="59"></td><td><pre><span class="token keyword">int</span> <span class="token function">toSonNetFd</span><span class="token punctuation">(</span>son_status_s <span class="token operator">*</span>list<span class="token punctuation">,</span> <span class="token keyword">int</span> num<span class="token punctuation">,</span> <span class="token keyword">int</span> net_fd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>flag <span class="token operator">==</span> FREE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sendMsg</span><span class="token punctuation">(</span>list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>local_socket<span class="token punctuation">,</span> net_fd<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>                <span class="token comment">// 处理错误...</span></pre></td></tr><tr><td data-num="64"></td><td><pre>                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>            list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>flag <span class="token operator">=</span> BUSY<span class="token punctuation">;</span> <span class="token comment">// 将子进程状态设置为 BUSY</span></pre></td></tr><tr><td data-num="67"></td><td><pre>            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 没有找到空闲的子进程</span></pre></td></tr><tr><td data-num="71"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="workerc"><a class="anchor" href="#workerc">#</a> worker.c</h3>
<ol>
<li><strong>子进程工作循环 ( <code>doWorker</code>  函数)</strong>:
<ul>
<li>子进程进入一个无限循环，持续运行直到程序终止或出现错误。</li>
<li>在循环中，子进程首先调用  <code>recvMsg</code>  函数来接收父进程通过本地 socket 发送的客户端文件描述符  <code>net_fd</code> 。</li>
<li>如果  <code>recvMsg</code>  失败，子进程将退出循环并结束。</li>
</ul>
</li>
<li><strong>处理客户端请求 ( <code>toClientFile</code>  函数)</strong>:
<ul>
<li>接收到客户端文件描述符后，子进程调用  <code>toClientFile</code>  函数来处理客户端请求。</li>
<li>在示例中， <code>toClientFile</code>  函数向客户端发送一个简单的 &quot;hello&quot; 消息。</li>
<li>如果  <code>send</code>  调用失败， <code>toClientFile</code>  函数将返回 -1 表示错误。</li>
</ul>
</li>
<li><strong>关闭客户端连接</strong>:
<ul>
<li>完成与客户端的交互后，子进程关闭客户端 socket。</li>
</ul>
</li>
<li><strong>通知父进程</strong>:
<ul>
<li>子进程通过本地 socket 发送一个特定的消息（例如 &quot;111&quot;）来通知父进程任务已完成。</li>
<li>这允许父进程更新子进程的状态，使其准备接收新的客户端连接。</li>
</ul>
</li>
</ol>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="2"></td><td><pre> * @file worker.c</pre></td></tr><tr><td data-num="3"></td><td><pre> * @brief 子进程工作模块。</pre></td></tr><tr><td data-num="4"></td><td><pre> * </pre></td></tr><tr><td data-num="5"></td><td><pre> * 该文件实现了子进程的工作循环，负责接收父进程发送的任务，</pre></td></tr><tr><td data-num="6"></td><td><pre> * 并执行与客户端的交互。</pre></td></tr><tr><td data-num="7"></td><td><pre> */</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"head.h"</span></span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="12"></td><td><pre> * @brief 子进程的工作函数。</pre></td></tr><tr><td data-num="13"></td><td><pre> *</pre></td></tr><tr><td data-num="14"></td><td><pre> * 子进程在此函数中循环运行，等待父进程通过本地 socket 发送的任务。</pre></td></tr><tr><td data-num="15"></td><td><pre> * 当接收到任务后，子进程将调用 toClientFile 函数来处理客户端请求，</pre></td></tr><tr><td data-num="16"></td><td><pre> * 然后通知父进程任务已完成。</pre></td></tr><tr><td data-num="17"></td><td><pre> *</pre></td></tr><tr><td data-num="18"></td><td><pre> * @param local_socket 子进程与父进程通信的本地 socket 文件描述符。</pre></td></tr><tr><td data-num="19"></td><td><pre> * @return 始终返回 0，表示子进程正常运行。</pre></td></tr><tr><td data-num="20"></td><td><pre> */</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token keyword">int</span> <span class="token function">doWorker</span><span class="token punctuation">(</span><span class="token keyword">int</span> local_socket<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token keyword">int</span> net_fd<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token comment">/**</pre></td></tr><tr><td data-num="25"></td><td><pre>         * 接收父进程发送的客户端文件描述符。</pre></td></tr><tr><td data-num="26"></td><td><pre>         * 如果 recvMsg 失败，子进程将退出循环并结束。</pre></td></tr><tr><td data-num="27"></td><td><pre>         */</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">recvMsg</span><span class="token punctuation">(</span>local_socket<span class="token punctuation">,</span> <span class="token operator">&amp;</span>net_fd<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>            <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token comment">/**</pre></td></tr><tr><td data-num="33"></td><td><pre>         * 处理客户端请求。</pre></td></tr><tr><td data-num="34"></td><td><pre>         * toClientFile 函数负责与客户端的交互，例如发送响应。</pre></td></tr><tr><td data-num="35"></td><td><pre>         */</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">toClientFile</span><span class="token punctuation">(</span>net_fd<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>            <span class="token comment">// 处理错误...</span></pre></td></tr><tr><td data-num="38"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="39"></td><td><pre></pre></td></tr><tr><td data-num="40"></td><td><pre>        <span class="token comment">/**</pre></td></tr><tr><td data-num="41"></td><td><pre>         * 关闭客户端 socket，完成与客户端的交互。</pre></td></tr><tr><td data-num="42"></td><td><pre>         */</span></pre></td></tr><tr><td data-num="43"></td><td><pre>        <span class="token function">close</span><span class="token punctuation">(</span>net_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre></pre></td></tr><tr><td data-num="45"></td><td><pre>        <span class="token comment">/**</pre></td></tr><tr><td data-num="46"></td><td><pre>         * 通知父进程任务已完成，子进程准备接收新任务。</pre></td></tr><tr><td data-num="47"></td><td><pre>         * 发送特定的消息（例如 "111"）作为通知。</pre></td></tr><tr><td data-num="48"></td><td><pre>         */</span></pre></td></tr><tr><td data-num="49"></td><td><pre>        <span class="token function">send</span><span class="token punctuation">(</span>local_socket<span class="token punctuation">,</span> <span class="token string">"111"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="53"></td><td><pre></pre></td></tr><tr><td data-num="54"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="55"></td><td><pre> * @brief 子进程与客户端的交互函数。</pre></td></tr><tr><td data-num="56"></td><td><pre> *</pre></td></tr><tr><td data-num="57"></td><td><pre> * 此函数负责子进程与客户端的交互，例如发送欢迎消息。</pre></td></tr><tr><td data-num="58"></td><td><pre> * 这里仅为示例，实际应用中可能包含更复杂的逻辑。</pre></td></tr><tr><td data-num="59"></td><td><pre> *</pre></td></tr><tr><td data-num="60"></td><td><pre> * @param net_fd 客户端连接的文件描述符。</pre></td></tr><tr><td data-num="61"></td><td><pre> * @return 成功返回 0，失败返回 -1。</pre></td></tr><tr><td data-num="62"></td><td><pre> */</span></pre></td></tr><tr><td data-num="63"></td><td><pre><span class="token keyword">int</span> <span class="token function">toClientFile</span><span class="token punctuation">(</span><span class="token keyword">int</span> net_fd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>message <span class="token operator">=</span> <span class="token string">"hello"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>    <span class="token comment">/**</pre></td></tr><tr><td data-num="66"></td><td><pre>     * 向客户端发送消息。</pre></td></tr><tr><td data-num="67"></td><td><pre>     * 如果 send 调用失败，函数将返回 -1 表示错误。</pre></td></tr><tr><td data-num="68"></td><td><pre>     */</span></pre></td></tr><tr><td data-num="69"></td><td><pre>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">send</span><span class="token punctuation">(</span>net_fd<span class="token punctuation">,</span> message<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="localc"><a class="anchor" href="#localc">#</a> local.c</h3>
<p><strong>发送文件描述符 ( <code>sendMsg</code>  函数)</strong>:</p>
<ul>
<li>初始化  <code>msghdr</code>  结构和相关的  <code>iovec</code>  结构，用于构造消息。</li>
<li>分配控制缓冲区  <code>cmbuf</code>  用于存储控制消息。</li>
<li>创建控制消息  <code>cmsg</code> ，设置其长度、层级、类型，并在数据部分存储要发送的文件描述符  <code>net_fd</code> 。</li>
<li>使用  <code>sendmsg</code>  系统调用发送消息，包括控制消息中的文件描述符。</li>
</ul>
<p><strong>接收文件描述符 ( <code>recvMsg</code>  函数)</strong>:</p>
<ul>
<li>初始化  <code>msghdr</code>  结构和相关的  <code>iovec</code>  结构，用于接收消息。</li>
<li>分配控制缓冲区  <code>cmbuf</code>  用于接收控制消息。</li>
<li>使用  <code>recvmsg</code>  系统调用接收消息，包括控制消息。</li>
<li>遍历接收到的消息的控制消息，找到类型为  <code>SCM_RIGHTS</code>  的控制消息，并从中提取文件描述符。</li>
<li>如果控制消息存在且类型正确，将接收到的文件描述符存储在提供的指针  <code>net_fd</code>  中。</li>
</ul>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="2"></td><td><pre> * @file local.c</pre></td></tr><tr><td data-num="3"></td><td><pre> * @brief 本地通信模块。</pre></td></tr><tr><td data-num="4"></td><td><pre> *</pre></td></tr><tr><td data-num="5"></td><td><pre> * 该文件实现了父子进程间通过本地 socket 进行通信的函数。</pre></td></tr><tr><td data-num="6"></td><td><pre> */</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"head.h"</span></span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="11"></td><td><pre> * @brief 通过本地 socket 发送客户端文件描述符给子进程。</pre></td></tr><tr><td data-num="12"></td><td><pre> *</pre></td></tr><tr><td data-num="13"></td><td><pre> * 使用 sendmsg 系统调用和控制消息（cmsg）来发送一个文件描述符。</pre></td></tr><tr><td data-num="14"></td><td><pre> * 这种方法允许父子进程之间传递打开的文件描述符。</pre></td></tr><tr><td data-num="15"></td><td><pre> *</pre></td></tr><tr><td data-num="16"></td><td><pre> * @param local_socket 父进程与子进程通信的本地 socket 文件描述符。</pre></td></tr><tr><td data-num="17"></td><td><pre> * @param net_fd 要发送给子进程的客户端 socket 文件描述符。</pre></td></tr><tr><td data-num="18"></td><td><pre> * @return 成功返回 0，失败返回 -1。</pre></td></tr><tr><td data-num="19"></td><td><pre> */</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token keyword">int</span> <span class="token function">sendMsg</span><span class="token punctuation">(</span><span class="token keyword">int</span> local_socket<span class="token punctuation">,</span> <span class="token keyword">int</span> net_fd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>  <span class="token keyword">struct</span> <span class="token class-name">msghdr</span> msg<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token function">bzero</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>  <span class="token keyword">char</span> <span class="token operator">*</span>str <span class="token operator">=</span> <span class="token string">"hello"</span><span class="token punctuation">;</span>  <span class="token comment">// 可以忽略的消息体，仅用于构造 msghdr 结构</span></pre></td></tr><tr><td data-num="24"></td><td><pre>  <span class="token keyword">struct</span> <span class="token class-name">iovec</span> vec<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>  vec<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_base <span class="token operator">=</span> str<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>  vec<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_len <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre>  msg<span class="token punctuation">.</span>msg_iov <span class="token operator">=</span> vec<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>  msg<span class="token punctuation">.</span>msg_iovlen <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre>  <span class="token keyword">struct</span> <span class="token class-name">cmsghdr</span> <span class="token operator">*</span>cmsg <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">cmsghdr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token function">CMSG_LEN</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>  cmsg<span class="token operator">-></span>cmsg_len <span class="token operator">=</span> <span class="token function">CMSG_LEN</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>  cmsg<span class="token operator">-></span>cmsg_level <span class="token operator">=</span> SOL_SOCKET<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>  cmsg<span class="token operator">-></span>cmsg_type <span class="token operator">=</span> SCM_RIGHTS<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre>  <span class="token keyword">int</span> <span class="token operator">*</span>fdptr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">CMSG_DATA</span><span class="token punctuation">(</span>cmsg<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>  <span class="token operator">*</span>fdptr <span class="token operator">=</span> net_fd<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre></pre></td></tr><tr><td data-num="40"></td><td><pre>  msg<span class="token punctuation">.</span>msg_control <span class="token operator">=</span> cmsg<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>  msg<span class="token punctuation">.</span>msg_controllen <span class="token operator">=</span> <span class="token function">CMSG_LEN</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre></pre></td></tr><tr><td data-num="43"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sendmsg</span><span class="token punctuation">(</span>local_socket<span class="token punctuation">,</span> <span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="48"></td><td><pre></pre></td></tr><tr><td data-num="49"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="50"></td><td><pre> * @brief 子进程通过本地 socket 接收父进程发送的客户端文件描述符。</pre></td></tr><tr><td data-num="51"></td><td><pre> *</pre></td></tr><tr><td data-num="52"></td><td><pre> * 使用 recvmsg 系统调用接收文件描述符。</pre></td></tr><tr><td data-num="53"></td><td><pre> * 该函数从控制消息中提取文件描述符，并将其存储在提供的参数中。</pre></td></tr><tr><td data-num="54"></td><td><pre> *</pre></td></tr><tr><td data-num="55"></td><td><pre> * @param local_socket 子进程与父进程通信的本地 socket 文件描述符。</pre></td></tr><tr><td data-num="56"></td><td><pre> * @param net_fd 指向用于存储接收到的客户端 socket 文件描述符的变量的指针。</pre></td></tr><tr><td data-num="57"></td><td><pre> * @return 成功返回 0，失败返回 -1。</pre></td></tr><tr><td data-num="58"></td><td><pre> */</span></pre></td></tr><tr><td data-num="59"></td><td><pre><span class="token keyword">int</span> <span class="token function">recvMsg</span><span class="token punctuation">(</span><span class="token keyword">int</span> local_socket<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>net_fd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>  <span class="token keyword">struct</span> <span class="token class-name">msghdr</span> msg<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>  <span class="token function">bzero</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre></pre></td></tr><tr><td data-num="63"></td><td><pre>  <span class="token comment">// 准备正文信息</span></pre></td></tr><tr><td data-num="64"></td><td><pre>  <span class="token keyword">char</span> str<span class="token punctuation">[</span><span class="token number">60</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>  <span class="token keyword">struct</span> <span class="token class-name">iovec</span> vec<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>  vec<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_base <span class="token operator">=</span> str<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>  vec<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_len <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre></pre></td></tr><tr><td data-num="69"></td><td><pre>  msg<span class="token punctuation">.</span>msg_iov <span class="token operator">=</span> vec<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>  msg<span class="token punctuation">.</span>msg_iovlen <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre></pre></td></tr><tr><td data-num="72"></td><td><pre>  <span class="token comment">// 准备控制信息</span></pre></td></tr><tr><td data-num="73"></td><td><pre>  <span class="token keyword">struct</span> <span class="token class-name">cmsghdr</span> <span class="token operator">*</span>cms <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">cmsghdr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token function">CMSG_LEN</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>  cms<span class="token operator">-></span>cmsg_len <span class="token operator">=</span> <span class="token function">CMSG_LEN</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 指明这个结构体的大小</span></pre></td></tr><tr><td data-num="75"></td><td><pre>  cms<span class="token operator">-></span>cmsg_level <span class="token operator">=</span> SOL_SOCKET<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>  cms<span class="token operator">-></span>cmsg_type <span class="token operator">=</span> SCM_RIGHTS<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="77"></td><td><pre></pre></td></tr><tr><td data-num="78"></td><td><pre>  msg<span class="token punctuation">.</span>msg_control <span class="token operator">=</span> cms<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>  msg<span class="token punctuation">.</span>msg_controllen <span class="token operator">=</span> <span class="token function">CMSG_LEN</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="80"></td><td><pre></pre></td></tr><tr><td data-num="81"></td><td><pre>  <span class="token function">recvmsg</span><span class="token punctuation">(</span>local_socket<span class="token punctuation">,</span> <span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="82"></td><td><pre></pre></td></tr><tr><td data-num="83"></td><td><pre>  <span class="token keyword">void</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">CMSG_DATA</span><span class="token punctuation">(</span>cms<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="84"></td><td><pre>  <span class="token keyword">int</span> <span class="token operator">*</span>fd <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span>p<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="85"></td><td><pre></pre></td></tr><tr><td data-num="86"></td><td><pre>  <span class="token operator">*</span>net_fd <span class="token operator">=</span> <span class="token operator">*</span>fd<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="87"></td><td><pre></pre></td></tr><tr><td data-num="88"></td><td><pre>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="89"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="socketc"><a class="anchor" href="#socketc">#</a> socket.c</h3>
<ol>
<li><strong>创建 socket</strong>：使用  <code>socket</code>  系统调用创建一个新的 socket 文件描述符。如果创建失败，函数返回 -1。</li>
<li><strong>设置 socket 选项</strong>：使用  <code>setsockopt</code>  系统调用设置  <code>SO_REUSEADDR</code>  选项，以允许重新使用本地地址和端口。如果设置失败，关闭 socket 并返回 -1。</li>
<li><strong>构建地址结构体</strong>：初始化  <code>sockaddr_in</code>  结构体，设置地址族、端口号和 IP 地址。端口号和 IP 地址由字符串转换为网络字节序。</li>
<li><strong>绑定 IP 地址和端口</strong>：使用  <code>bind</code>  系统调用将 socket 绑定到指定的 IP 地址和端口。如果绑定失败，关闭 socket 并返回 -1。</li>
<li><strong>监听连接</strong>：使用  <code>listen</code>  系统调用设置 socket 为监听模式，最多允许指定数量的客户端连接等待接受。如果监听失败，关闭 socket 并返回 -1。</li>
<li><strong>成功返回</strong>：如果所有步骤都成功完成，函数返回 0，表示 socket 初始化和配置成功。</li>
</ol>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="2"></td><td><pre> * @file socket.c</pre></td></tr><tr><td data-num="3"></td><td><pre> * @brief 网络通信模块。</pre></td></tr><tr><td data-num="4"></td><td><pre> * </pre></td></tr><tr><td data-num="5"></td><td><pre> * 该文件实现了网络 socket 的初始化和配置，用于监听和接受客户端连接。</pre></td></tr><tr><td data-num="6"></td><td><pre> */</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"head.h"</span></span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="11"></td><td><pre> * @brief 初始化并配置 socket 服务端。</pre></td></tr><tr><td data-num="12"></td><td><pre> *</pre></td></tr><tr><td data-num="13"></td><td><pre> * 创建一个 socket，绑定到指定的 IP 地址和端口，设置为监听模式。</pre></td></tr><tr><td data-num="14"></td><td><pre> * 此函数还配置 socket 选项，以避免 TIME_WAIT 状态导致的端口占用问题。</pre></td></tr><tr><td data-num="15"></td><td><pre> *</pre></td></tr><tr><td data-num="16"></td><td><pre> * @param socket_fd 指向整数的指针，用于存储新创建的 socket 文件描述符。</pre></td></tr><tr><td data-num="17"></td><td><pre> * @param port 要监听的端口号的字符串表示。</pre></td></tr><tr><td data-num="18"></td><td><pre> * @param ip 要绑定的 IP 地址的字符串表示。</pre></td></tr><tr><td data-num="19"></td><td><pre> * @return 成功返回 0，失败返回 -1。</pre></td></tr><tr><td data-num="20"></td><td><pre> */</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token keyword">int</span> <span class="token function">initSocket</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span>socket_fd<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>port<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>ip<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token comment">// 创建 socket 文件对象</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token operator">*</span>socket_fd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>socket_fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">// 创建 socket 失败</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token comment">// 解除 TIME_WAIT 等待时：导致端口占用问题</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token keyword">int</span> reuse <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">setsockopt</span><span class="token punctuation">(</span><span class="token operator">*</span>socket_fd<span class="token punctuation">,</span> SOL_SOCKET<span class="token punctuation">,</span> SO_REUSEADDR<span class="token punctuation">,</span> <span class="token operator">&amp;</span>reuse<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>reuse<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token function">close</span><span class="token punctuation">(</span><span class="token operator">*</span>socket_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 设置 socket 选项失败，关闭 socket</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="34"></td><td><pre></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token comment">// 构建 sockaddr_in 结构体</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> addr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    addr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    addr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token function">atoi</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 将端口号从字符串转换为网络字节序</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    addr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">inet_addr</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 将 IP 地址从字符串转换为网络字节序</span></pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token comment">// 绑定端口</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token operator">*</span>socket_fd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>addr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>        <span class="token function">close</span><span class="token punctuation">(</span><span class="token operator">*</span>socket_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 绑定失败，关闭 socket</span></pre></td></tr><tr><td data-num="44"></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="46"></td><td><pre></pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token comment">// 开始监听</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token operator">*</span>socket_fd<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// 最多允许 10 个客户端连接等待接受</span></pre></td></tr><tr><td data-num="49"></td><td><pre>        <span class="token function">close</span><span class="token punctuation">(</span><span class="token operator">*</span>socket_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 监听失败，关闭 socket</span></pre></td></tr><tr><td data-num="50"></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token comment">// 初始化成功</span></pre></td></tr><tr><td data-num="53"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="epollc"><a class="anchor" href="#epollc">#</a> epoll.c</h3>
<ol>
<li><strong>函数声明</strong>：定义了  <code>addEpoll</code>  函数，该函数接受两个参数： <code>epoll_fd</code> （epoll 实例的文件描述符）和  <code>fd</code> （需要监听的文件描述符）。</li>
<li><strong>创建 epoll 事件对象</strong>：声明并初始化了一个  <code>epoll_event</code>  结构体实例，用于设置监听的事件类型和关联的文件描述符。</li>
<li><strong>设置监听事件</strong>：将  <code>event.data.fd</code>  设置为传入的  <code>fd</code> ，表示该事件对象将关联到这个文件描述符。将  <code>event.events</code>  设置为  <code>EPOLLIN</code> ，表示只监听可读事件。</li>
<li><strong>添加到 epoll 实例</strong>：调用  <code>epoll_ctl</code>  函数，传入  <code>epoll_fd</code> 、 <code>EPOLL_CTL_ADD</code> 、 <code>fd</code>  和  <code>event</code>  作为参数，尝试将该事件添加到 epoll 实例中。</li>
<li><strong>错误处理</strong>：如果  <code>epoll_ctl</code>  调用失败（返回 -1），则  <code>addEpoll</code>  函数也返回 -1，表示添加操作失败。</li>
<li><strong>成功返回</strong>：如果添加操作成功，函数返回 0，表示文件描述符已成功添加到 epoll 实例中进行监听。</li>
</ol>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="2"></td><td><pre> * @file epoll.c</pre></td></tr><tr><td data-num="3"></td><td><pre> * @brief 包含 epoll 相关的函数实现。</pre></td></tr><tr><td data-num="4"></td><td><pre> * </pre></td></tr><tr><td data-num="5"></td><td><pre> * 该文件提供了将文件描述符添加到 epoll 实例的函数。</pre></td></tr><tr><td data-num="6"></td><td><pre> */</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"head.h"</span></span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="11"></td><td><pre> * @brief 将文件描述符添加到 epoll 实例中进行事件监听。</pre></td></tr><tr><td data-num="12"></td><td><pre> *</pre></td></tr><tr><td data-num="13"></td><td><pre> * 此函数创建一个 epoll 事件对象，设置其监听的事件类型为 EPOLLIN，</pre></td></tr><tr><td data-num="14"></td><td><pre> * 然后将该事件对象与指定的文件描述符一起添加到 epoll 实例中。</pre></td></tr><tr><td data-num="15"></td><td><pre> * </pre></td></tr><tr><td data-num="16"></td><td><pre> * @param epoll_fd epoll 实例的文件描述符。</pre></td></tr><tr><td data-num="17"></td><td><pre> * @param fd 需要添加到 epoll 实例中监听的文件描述符。</pre></td></tr><tr><td data-num="18"></td><td><pre> * @return 返回 0 表示添加成功，返回 -1 表示添加失败。</pre></td></tr><tr><td data-num="19"></td><td><pre> */</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token keyword">int</span> <span class="token function">addEpoll</span><span class="token punctuation">(</span><span class="token keyword">int</span> epoll_fd<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> event<span class="token punctuation">;</span>  <span class="token comment">/**&lt; epoll 事件对象 */</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    event<span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd <span class="token operator">=</span> fd<span class="token punctuation">;</span>        <span class="token comment">/**&lt; 设置事件对象关联的文件描述符 */</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    event<span class="token punctuation">.</span>events <span class="token operator">=</span> EPOLLIN<span class="token punctuation">;</span>    <span class="token comment">/**&lt; 设置事件类型为可读 */</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">epoll_ctl</span><span class="token punctuation">(</span>epoll_fd<span class="token punctuation">,</span> EPOLL_CTL_ADD<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">/**&lt; 调用 epoll_ctl 执行添加操作 */</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">/**&lt; 如果添加失败，返回 -1 */</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token comment">/**&lt; 添加成功，返回 0 */</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="clientc"><a class="anchor" href="#clientc">#</a> client.c</h3>
<ol>
<li><strong>定义服务器地址</strong>：设置服务器的端口号和 IP 地址。</li>
<li><strong>创建 socket</strong>：使用  <code>socket</code>  系统调用创建一个新的 socket 文件描述符。如果创建失败，打印错误并退出程序。</li>
<li><strong>设置服务器地址结构</strong>：初始化  <code>sockaddr_in</code>  结构体，设置服务器的地址族为  <code>AF_INET</code> ，端口号和 IP 地址转换为网络字节序。</li>
<li><strong>连接到服务器</strong>：使用  <code>connect</code>  系统调用尝试连接到服务器。如果连接失败，打印错误，关闭 socket 并退出程序。</li>
<li><strong>接收消息</strong>：定义一个缓冲区  <code>buf</code>  用于接收服务器发送的消息。使用  <code>recv</code>  系统调用接收消息。如果接收失败，打印错误，关闭 socket 并退出程序。成功接收消息后，打印消息内容。</li>
<li><strong>关闭 socket</strong>：通信完成后，使用  <code>close</code>  系统调用关闭 socket 连接。</li>
</ol>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="2"></td><td><pre> * @file client.c</pre></td></tr><tr><td data-num="3"></td><td><pre> * @brief 客户端程序。</pre></td></tr><tr><td data-num="4"></td><td><pre> * </pre></td></tr><tr><td data-num="5"></td><td><pre> * 该文件实现了一个简单的客户端，用于连接到指定的服务器地址和端口，</pre></td></tr><tr><td data-num="6"></td><td><pre> * 并接收服务器发送的消息。</pre></td></tr><tr><td data-num="7"></td><td><pre> */</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h></span></span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h></span></span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token comment">// 定义服务器的端口和 IP 地址</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">char</span> <span class="token operator">*</span>port <span class="token operator">=</span> <span class="token string">"8080"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token keyword">char</span> <span class="token operator">*</span>ip <span class="token operator">=</span> <span class="token string">"172.16.0.3"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token comment">/**</pre></td></tr><tr><td data-num="23"></td><td><pre>     * 创建 socket。</pre></td></tr><tr><td data-num="24"></td><td><pre>     * 创建一个用于通信的 socket，用于连接到服务器。</pre></td></tr><tr><td data-num="25"></td><td><pre>     */</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token keyword">int</span> socket_fd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>socket_fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token comment">// 处理错误...</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token comment">/**</pre></td></tr><tr><td data-num="33"></td><td><pre>     * 设置服务器地址结构。</pre></td></tr><tr><td data-num="34"></td><td><pre>     * 初始化 sockaddr_in 结构，设置服务器的地址族、端口和 IP 地址。</pre></td></tr><tr><td data-num="35"></td><td><pre>     */</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> addr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    addr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    addr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token function">atoi</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 端口号转换为网络字节序</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    addr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">inet_addr</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// IP 地址转换为网络字节序</span></pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token comment">/**</pre></td></tr><tr><td data-num="42"></td><td><pre>     * 连接到服务器。</pre></td></tr><tr><td data-num="43"></td><td><pre>     * 使用 connect 系统调用建立到服务器的连接。</pre></td></tr><tr><td data-num="44"></td><td><pre>     */</span></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">connect</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>addr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>        <span class="token comment">// 处理错误...</span></pre></td></tr><tr><td data-num="47"></td><td><pre>        <span class="token function">close</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="50"></td><td><pre></pre></td></tr><tr><td data-num="51"></td><td><pre>    <span class="token comment">/**</pre></td></tr><tr><td data-num="52"></td><td><pre>     * 接收服务器消息。</pre></td></tr><tr><td data-num="53"></td><td><pre>     * 从 socket 中接收服务器发送的消息，并存储在缓冲区 buf 中。</pre></td></tr><tr><td data-num="54"></td><td><pre>     */</span></pre></td></tr><tr><td data-num="55"></td><td><pre>    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">60</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">recv</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>        <span class="token comment">// 处理错误...</span></pre></td></tr><tr><td data-num="58"></td><td><pre>        <span class="token function">close</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"buf: %s\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 打印接收到的消息</span></pre></td></tr><tr><td data-num="62"></td><td><pre></pre></td></tr><tr><td data-num="63"></td><td><pre>    <span class="token comment">/**</pre></td></tr><tr><td data-num="64"></td><td><pre>     * 关闭 socket。</pre></td></tr><tr><td data-num="65"></td><td><pre>     * 完成通信后，关闭 socket 连接。</pre></td></tr><tr><td data-num="66"></td><td><pre>     */</span></pre></td></tr><tr><td data-num="67"></td><td><pre>    <span class="token function">close</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="69"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="第二版"><a class="anchor" href="#第二版">#</a> 第二版</h2>
<h3 id="文件传输"><a class="anchor" href="#文件传输">#</a> 文件传输</h3>
<h4 id="clientc-2"><a class="anchor" href="#clientc-2">#</a> client.c</h4>
<ol>
<li><strong>接收文件名称</strong>：客户端首先接收服务器发送的文件名。这是通过调用  <code>recv</code>  函数并指定缓冲区  <code>buf_name</code>  来完成的。接收到的文件名将被用于本地文件的命名。</li>
<li><strong>打开或创建本地文件</strong>：使用  <code>open</code>  函数，客户端尝试打开一个用于保存接收到的文件内容的本地文件。如果文件不存在， <code>open</code>  函数将创建该文件，并根据提供的权限参数  <code>0666</code>  设置文件权限。</li>
<li><strong>循环接收文件内容</strong>：客户端进入一个循环，使用  <code>recv</code>  函数持续接收来自服务器的数据。每次接收到数据后，客户端都会检查返回值以确定是否接收到更多数据。如果  <code>recv</code>  返回大于 0 的值，表示接收到了数据。</li>
<li><strong>写入文件内容</strong>：对于每次接收到的数据，客户端使用  <code>write</code>  函数将其写入到之前打开的本地文件中。 <code>write</code>  函数的参数包括文件描述符、数据缓冲区和接收到的数据大小。</li>
<li><strong>错误处理</strong>：如果在接收或写入过程中发生错误，客户端将执行错误处理逻辑。这可能包括打印错误信息、关闭文件描述符和 socket 连接，并退出程序。</li>
<li><strong>关闭资源</strong>：完成数据接收后，客户端使用  <code>close</code>  函数关闭本地文件描述符，然后关闭与服务器的 socket 连接。这释放了所有相关的系统资源，并确保不会有资源泄露。</li>
<li><strong>退出程序</strong>：在资源关闭后，客户端程序正常退出，返回 0 表示程序成功执行完成。</li>
</ol>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="2"></td><td><pre> * @file client.c</pre></td></tr><tr><td data-num="3"></td><td><pre> * @brief 客户端程序。</pre></td></tr><tr><td data-num="4"></td><td><pre> *</pre></td></tr><tr><td data-num="5"></td><td><pre> * 该文件实现了客户端的主要功能，包括连接到服务器、接收服务器发送的文件名称和内容，</pre></td></tr><tr><td data-num="6"></td><td><pre> * 并将接收到的内容保存到本地文件中。</pre></td></tr><tr><td data-num="7"></td><td><pre> */</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdc.h></span></span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token comment">// 定义服务器的端口和 IP 地址</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token keyword">char</span> <span class="token operator">*</span>port <span class="token operator">=</span> <span class="token string">"8080"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token keyword">char</span> <span class="token operator">*</span>ip <span class="token operator">=</span> <span class="token string">"172.16.0.3"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token comment">/**</pre></td></tr><tr><td data-num="17"></td><td><pre>   * 创建 socket。</pre></td></tr><tr><td data-num="18"></td><td><pre>   * 创建一个用于通信的 socket，用于连接到服务器。</pre></td></tr><tr><td data-num="19"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token keyword">int</span> socket_fd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>socket_fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token comment">// 错误处理，例如打印错误信息并退出程序</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"socket creation failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>  <span class="token comment">/**</pre></td></tr><tr><td data-num="28"></td><td><pre>   * 设置服务器地址结构。</pre></td></tr><tr><td data-num="29"></td><td><pre>   * 初始化 sockaddr_in 结构，设置服务器的地址族、端口和 IP 地址。</pre></td></tr><tr><td data-num="30"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="31"></td><td><pre>  <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> addr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>  addr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>  addr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token function">atoi</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 端口号转换为网络字节序</span></pre></td></tr><tr><td data-num="34"></td><td><pre>  addr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">inet_addr</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// IP 地址转换为网络字节序</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre>  <span class="token comment">/**</pre></td></tr><tr><td data-num="37"></td><td><pre>   * 连接到服务器。</pre></td></tr><tr><td data-num="38"></td><td><pre>   * 使用 connect 系统调用建立到服务器的连接。</pre></td></tr><tr><td data-num="39"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="40"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">connect</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>addr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token comment">// 错误处理，例如关闭 socket_fd 并退出程序</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"connect failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token function">close</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="46"></td><td><pre></pre></td></tr><tr><td data-num="47"></td><td><pre>  <span class="token comment">/**</pre></td></tr><tr><td data-num="48"></td><td><pre>   * 接收服务器发送的文件名称。</pre></td></tr><tr><td data-num="49"></td><td><pre>   * 从 socket 中接收服务器发送的文件名，并存储在缓冲区 buf_name 中。</pre></td></tr><tr><td data-num="50"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="51"></td><td><pre><span class="token operator">+</span> <span class="token keyword">char</span> buf_name<span class="token punctuation">[</span><span class="token number">60</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre><span class="token operator">+</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">recv</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">,</span> buf_name<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf_name<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="53"></td><td><pre><span class="token operator">+</span>   <span class="token comment">// 错误处理</span></pre></td></tr><tr><td data-num="54"></td><td><pre><span class="token operator">+</span>   <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"recv failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre><span class="token operator">+</span>   <span class="token function">close</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre><span class="token operator">+</span>   <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre><span class="token operator">+</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="58"></td><td><pre></pre></td></tr><tr><td data-num="59"></td><td><pre>  <span class="token comment">/**</pre></td></tr><tr><td data-num="60"></td><td><pre>   * 打开或创建用于保存文件内容的本地文件。</pre></td></tr><tr><td data-num="61"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="62"></td><td><pre><span class="token operator">+</span> <span class="token keyword">int</span> file_fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>buf_name<span class="token punctuation">,</span> O_RDWR <span class="token operator">|</span> O_CREAT<span class="token punctuation">,</span> <span class="token number">0666</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="63"></td><td><pre><span class="token operator">+</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>file_fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="64"></td><td><pre><span class="token operator">+</span>   <span class="token comment">// 错误处理</span></pre></td></tr><tr><td data-num="65"></td><td><pre><span class="token operator">+</span>   <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open file failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="66"></td><td><pre><span class="token operator">+</span>   <span class="token function">close</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre><span class="token operator">+</span>   <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre><span class="token operator">+</span>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="69"></td><td><pre></pre></td></tr><tr><td data-num="70"></td><td><pre>  <span class="token comment">/**</pre></td></tr><tr><td data-num="71"></td><td><pre>   * 接收服务器发送的文件内容。</pre></td></tr><tr><td data-num="72"></td><td><pre>   * 循环接收服务器发送的数据，并将其写入到本地文件中。</pre></td></tr><tr><td data-num="73"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="74"></td><td><pre><span class="token operator">+</span> <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="75"></td><td><pre><span class="token operator">+</span> <span class="token class-name">ssize_t</span> res<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="76"></td><td><pre><span class="token operator">+</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>res <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="77"></td><td><pre><span class="token operator">+</span>   <span class="token function">write</span><span class="token punctuation">(</span>file_fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="78"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="79"></td><td><pre></pre></td></tr><tr><td data-num="80"></td><td><pre><span class="token operator">+</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="81"></td><td><pre><span class="token operator">+</span>   <span class="token comment">// 错误处理</span></pre></td></tr><tr><td data-num="82"></td><td><pre><span class="token operator">+</span>   <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"recv failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="83"></td><td><pre><span class="token operator">+</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="84"></td><td><pre></pre></td></tr><tr><td data-num="85"></td><td><pre>  <span class="token comment">/**</pre></td></tr><tr><td data-num="86"></td><td><pre>   * 关闭文件和 socket。</pre></td></tr><tr><td data-num="87"></td><td><pre>   * 完成通信后，关闭文件描述符和 socket 连接。</pre></td></tr><tr><td data-num="88"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="89"></td><td><pre><span class="token operator">+</span> <span class="token function">close</span><span class="token punctuation">(</span>file_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="90"></td><td><pre>  <span class="token function">close</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="91"></td><td><pre>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="92"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="send_filec"><a class="anchor" href="#send_filec">#</a> send_file.c</h4>
<ol>
<li><strong>定义文件名</strong>：设置要发送的文件名。</li>
<li><strong>发送文件名</strong>：使用  <code>send</code>  函数将文件名作为字符串发送给客户端。</li>
<li><strong>打开文件</strong>：使用  <code>open</code>  函数以只读模式打开文件，准备读取文件内容。</li>
<li><strong>读取并发送文件内容</strong>：循环使用  <code>read</code>  函数从文件中读取数据到缓冲区  <code>buf</code> 。
<ul>
<li>使用  <code>send</code>  函数将缓冲区  <code>buf</code>  中的数据发送给客户端。</li>
</ul>
</li>
<li><strong>错误处理</strong>：如果在打开文件或读取文件过程中发生错误，关闭文件描述符并返回错误代码  <code>-1</code> 。</li>
<li><strong>正常结束</strong>：
<ul>
<li>如果读取到文件末尾（ <code>read</code>  返回  <code>0</code> ），循环结束。</li>
<li>关闭文件描述符。</li>
</ul>
</li>
<li><strong>返回结果</strong>：如果所有操作成功完成，函数返回  <code>0</code> 。</li>
</ol>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="2"></td><td><pre> * @file send_file.c</pre></td></tr><tr><td data-num="3"></td><td><pre> * @brief 文件发送模块。</pre></td></tr><tr><td data-num="4"></td><td><pre> * </pre></td></tr><tr><td data-num="5"></td><td><pre> * 该文件实现了子进程发送文件给客户端的功能。</pre></td></tr><tr><td data-num="6"></td><td><pre> */</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"head.h"</span></span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="11"></td><td><pre> * @brief 发送文件给客户端。</pre></td></tr><tr><td data-num="12"></td><td><pre> *</pre></td></tr><tr><td data-num="13"></td><td><pre> * 该函数负责打开指定的文件，并发送文件内容到客户端。</pre></td></tr><tr><td data-num="14"></td><td><pre> * 首先发送文件名，然后打开文件并发送文件内容。</pre></td></tr><tr><td data-num="15"></td><td><pre> *</pre></td></tr><tr><td data-num="16"></td><td><pre> * @param net_fd 客户端连接的文件描述符。</pre></td></tr><tr><td data-num="17"></td><td><pre> * @return 成功返回 0，失败返回 -1。</pre></td></tr><tr><td data-num="18"></td><td><pre> */</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token keyword">int</span> <span class="token function">sendFile</span><span class="token punctuation">(</span><span class="token keyword">int</span> net_fd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token comment">// 文件名，这里只是一个示例，实际使用时应根据情况确定文件名</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">char</span> <span class="token operator">*</span>file_name <span class="token operator">=</span> <span class="token string">"file.txt"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token comment">// 发送文件名给客户端</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token function">send</span><span class="token punctuation">(</span>net_fd<span class="token punctuation">,</span> file_name<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>file_name<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token comment">// 打开文件，准备发送文件内容</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token keyword">int</span> file_fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>file_name<span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>file_fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token comment">// 如果打开文件失败，返回错误</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token comment">// 读取文件内容并发送</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token class-name">ssize_t</span> sret<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sret <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>file_fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token comment">// 发送读取到的数据</span></pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token function">send</span><span class="token punctuation">(</span>net_fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> sret<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="39"></td><td><pre></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token comment">// 检查读取操作是否成功完成</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>sret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>        <span class="token comment">// 如果读取失败，返回错误</span></pre></td></tr><tr><td data-num="43"></td><td><pre>        <span class="token function">close</span><span class="token punctuation">(</span>file_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="46"></td><td><pre></pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token comment">// 关闭文件描述符</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    <span class="token function">close</span><span class="token punctuation">(</span>file_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="粘包问题"><a class="anchor" href="#粘包问题">#</a> 粘包问题</h3>
<p>在 TCP/IP 网络编程中，&quot;粘包问题&quot; 是一个常见的现象，它源于 TCP 协议的流式传输特性。当应用层数据通过 TCP 发送时，这些数据被视为一个连续的字节流，而 TCP 协议本身并不为每个数据包提供明确的边界。这意味着，如果服务器连续发送多个数据包，客户端在接收时可能会发现一次  <code>recv</code>  调用就读取了多个数据包的内容，这种现象称为粘包。</p>
<p>例如，如果服务器首先发送一个文件名，然后发送该文件的内容，客户端可能在一次  <code>recv</code>  调用中同时接收到文件名和文件内容的一部分。这可能导致客户端将文件名和文件内容误认为是同一个数据实体，从而引发错误。</p>
<p>与 TCP 不同，UDP 是一个无连接的协议，它不会在传输层对数据进行拆分和重组。每个 UDP 数据报都是独立的，因此 UDP 不存在粘包问题。在 UDP 中，每个数据报都被视为一个完整的消息单元，由 IP 层负责拆分和重组。</p>
<p>为了解决 TCP 的粘包问题，开发者需要在应用层协议中明确定义数据的边界。</p>
<h4 id="clientc-3"><a class="anchor" href="#clientc-3">#</a> client.c</h4>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="2"></td><td><pre> * @file client.c</pre></td></tr><tr><td data-num="3"></td><td><pre> * @brief 客户端程序。</pre></td></tr><tr><td data-num="4"></td><td><pre> *</pre></td></tr><tr><td data-num="5"></td><td><pre> * 该文件实现了客户端的主要功能，包括连接到服务器、接收服务器发送的文件名称和内容，</pre></td></tr><tr><td data-num="6"></td><td><pre> * 并将接收到的内容保存到本地文件中。</pre></td></tr><tr><td data-num="7"></td><td><pre> */</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdc.h></span></span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token comment">// 定义服务器的端口和 IP 地址</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token keyword">char</span> <span class="token operator">*</span>port <span class="token operator">=</span> <span class="token string">"8080"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token keyword">char</span> <span class="token operator">*</span>ip <span class="token operator">=</span> <span class="token string">"172.16.0.3"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token comment">/**</pre></td></tr><tr><td data-num="17"></td><td><pre>   * 创建 socket。</pre></td></tr><tr><td data-num="18"></td><td><pre>   * 创建一个用于通信的 socket，用于连接到服务器。</pre></td></tr><tr><td data-num="19"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token keyword">int</span> socket_fd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>socket_fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token comment">// 错误处理，例如打印错误信息并退出程序</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"socket creation failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>  <span class="token comment">/**</pre></td></tr><tr><td data-num="28"></td><td><pre>   * 设置服务器地址结构。</pre></td></tr><tr><td data-num="29"></td><td><pre>   * 初始化 sockaddr_in 结构，设置服务器的地址族、端口和 IP 地址。</pre></td></tr><tr><td data-num="30"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="31"></td><td><pre>  <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> addr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>  addr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>  addr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token function">atoi</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 端口号转换为网络字节序</span></pre></td></tr><tr><td data-num="34"></td><td><pre>  addr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">inet_addr</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// IP 地址转换为网络字节序</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre>  <span class="token comment">/**</pre></td></tr><tr><td data-num="37"></td><td><pre>   * 连接到服务器。</pre></td></tr><tr><td data-num="38"></td><td><pre>   * 使用 connect 系统调用建立到服务器的连接。</pre></td></tr><tr><td data-num="39"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="40"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">connect</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>addr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token comment">// 错误处理，例如关闭 socket_fd 并退出程序</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"connect failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token function">close</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="46"></td><td><pre></pre></td></tr><tr><td data-num="47"></td><td><pre>  <span class="token comment">/**</pre></td></tr><tr><td data-num="48"></td><td><pre>   * 接收服务器发送的文件名称长度。</pre></td></tr><tr><td data-num="49"></td><td><pre>   * 首先接收一个表示文件名长度的整数，以便分配合适的缓冲区。</pre></td></tr><tr><td data-num="50"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="51"></td><td><pre>  <span class="token keyword">int</span> file_name_len<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>  <span class="token keyword">int</span> recv_fd <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>file_name_len<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre></pre></td></tr><tr><td data-num="54"></td><td><pre>  <span class="token comment">/**</pre></td></tr><tr><td data-num="55"></td><td><pre>   * 检查接收文件名称长度是否成功。</pre></td></tr><tr><td data-num="56"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="57"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>recv_fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>    <span class="token comment">// 错误处理</span></pre></td></tr><tr><td data-num="59"></td><td><pre>    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"recv failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>    <span class="token function">close</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>  <span class="token comment">/**</pre></td></tr><tr><td data-num="64"></td><td><pre>   * 接收服务器发送的文件名称。</pre></td></tr><tr><td data-num="65"></td><td><pre>   * 根据接收到的长度，接收文件名字符串。</pre></td></tr><tr><td data-num="66"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="67"></td><td><pre>  <span class="token keyword">char</span> buf_name<span class="token punctuation">[</span><span class="token number">60</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>  recv_fd <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">,</span> buf_name<span class="token punctuation">,</span> file_name_len<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="69"></td><td><pre></pre></td></tr><tr><td data-num="70"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>recv_fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>    <span class="token comment">// 错误处理</span></pre></td></tr><tr><td data-num="72"></td><td><pre>    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"recv failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>    <span class="token function">close</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="76"></td><td><pre></pre></td></tr><tr><td data-num="77"></td><td><pre>  <span class="token comment">/**</pre></td></tr><tr><td data-num="78"></td><td><pre>   * 打开或创建用于保存文件内容的本地文件。</pre></td></tr><tr><td data-num="79"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="80"></td><td><pre>  <span class="token keyword">int</span> file_fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>buf_name<span class="token punctuation">,</span> O_RDWR <span class="token operator">|</span> O_CREAT<span class="token punctuation">,</span> <span class="token number">0666</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>file_fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="82"></td><td><pre>    <span class="token comment">// 错误处理</span></pre></td></tr><tr><td data-num="83"></td><td><pre>    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open file failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="84"></td><td><pre>    <span class="token function">close</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="85"></td><td><pre>    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="86"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="87"></td><td><pre></pre></td></tr><tr><td data-num="88"></td><td><pre>  <span class="token comment">/**</pre></td></tr><tr><td data-num="89"></td><td><pre>   * 接收文件内容长度。</pre></td></tr><tr><td data-num="90"></td><td><pre>   * 接收一个表示接下来要接收的文件内容长度的整数。</pre></td></tr><tr><td data-num="91"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="92"></td><td><pre>  <span class="token keyword">int</span> len<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="93"></td><td><pre>  recv_fd <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>len<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="94"></td><td><pre></pre></td></tr><tr><td data-num="95"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>recv_fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="96"></td><td><pre>    <span class="token comment">// 错误处理</span></pre></td></tr><tr><td data-num="97"></td><td><pre>    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"recv failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="98"></td><td><pre>    <span class="token function">close</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="99"></td><td><pre>    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="100"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="101"></td><td><pre>  <span class="token comment">/**</pre></td></tr><tr><td data-num="102"></td><td><pre>   * 接收服务器发送的文件内容。</pre></td></tr><tr><td data-num="103"></td><td><pre>   * 根据接收到的长度，接收文件内容并写入本地文件。</pre></td></tr><tr><td data-num="104"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="105"></td><td><pre>  <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="106"></td><td><pre>  <span class="token class-name">ssize_t</span> res <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> len<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="107"></td><td><pre>  <span class="token function">write</span><span class="token punctuation">(</span>file_fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="108"></td><td><pre></pre></td></tr><tr><td data-num="109"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="110"></td><td><pre>    <span class="token comment">// 错误处理</span></pre></td></tr><tr><td data-num="111"></td><td><pre>    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"recv failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="112"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="113"></td><td><pre></pre></td></tr><tr><td data-num="114"></td><td><pre>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"文件已成功接收！\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="115"></td><td><pre></pre></td></tr><tr><td data-num="116"></td><td><pre>  <span class="token comment">/**</pre></td></tr><tr><td data-num="117"></td><td><pre>   * 关闭文件和 socket。</pre></td></tr><tr><td data-num="118"></td><td><pre>   * 完成通信后，关闭文件描述符和 socket 连接。</pre></td></tr><tr><td data-num="119"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="120"></td><td><pre>  <span class="token function">close</span><span class="token punctuation">(</span>file_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="121"></td><td><pre>  <span class="token function">close</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="122"></td><td><pre>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="123"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><ol>
<li><strong>接收文件名称长度</strong>：客户端首先接收一个整数，该整数表示服务器随后发送的文件名称的长度。</li>
<li><strong>错误检查</strong>：如果接收文件名称长度失败，客户端将打印错误信息，关闭 socket 并退出。</li>
<li><strong>接收文件名称</strong>：客户端根据接收到的长度，接收文件名称字符串，并将其存储在  <code>buf_name</code>  缓冲区中。</li>
<li><strong>错误检查</strong>：如果接收文件名称失败，客户端将执行错误处理。</li>
<li><strong>打开或创建文件</strong>：客户端尝试打开一个文件用于写入，如果文件不存在则创建它。</li>
<li><strong>接收文件内容长度</strong>：客户端接收另一个整数，表示接下来要从服务器接收的文件内容的字节长度。</li>
<li><strong>接收文件内容</strong>：客户端根据接收到的长度，从服务器接收文件内容到缓冲区  <code>buf</code>  中。</li>
<li><strong>写入文件</strong>：接收到的内容被写入到之前打开的本地文件中。</li>
<li><strong>错误检查</strong>：如果在接收文件内容时发生错误，客户端将打印错误信息。</li>
<li><strong>打印成功消息</strong>：如果文件接收成功，打印确认消息。</li>
<li><strong>关闭资源</strong>：最后，客户端关闭文件描述符和 socket，释放资源。</li>
</ol>
<h4 id="send_filec-2"><a class="anchor" href="#send_filec-2">#</a> send_file.c</h4>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="2"></td><td><pre> * @file send_file.c</pre></td></tr><tr><td data-num="3"></td><td><pre> * @brief 文件发送模块。</pre></td></tr><tr><td data-num="4"></td><td><pre> *</pre></td></tr><tr><td data-num="5"></td><td><pre> * 该文件实现了子进程发送文件给客户端的功能。</pre></td></tr><tr><td data-num="6"></td><td><pre> */</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"head.h"</span></span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="11"></td><td><pre> * @brief 结构体用于封装传输的数据和长度。</pre></td></tr><tr><td data-num="12"></td><td><pre> */</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">train_s</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token keyword">int</span> len<span class="token punctuation">;</span>        <span class="token comment">/**&lt; 数据长度 */</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">/**&lt; 数据缓冲区 */</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">&#125;</span> <span class="token class-name">train_t</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="19"></td><td><pre> * @brief 发送文件给客户端。</pre></td></tr><tr><td data-num="20"></td><td><pre> *</pre></td></tr><tr><td data-num="21"></td><td><pre> * 该函数负责打开指定的文件，并发送文件内容到客户端。</pre></td></tr><tr><td data-num="22"></td><td><pre> * 首先发送文件名，然后打开文件并发送文件内容。</pre></td></tr><tr><td data-num="23"></td><td><pre> *</pre></td></tr><tr><td data-num="24"></td><td><pre> * @param net_fd 客户端连接的文件描述符。</pre></td></tr><tr><td data-num="25"></td><td><pre> * @return 成功返回 0，失败返回 -1。</pre></td></tr><tr><td data-num="26"></td><td><pre> */</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token keyword">int</span> <span class="token function">sendFile</span><span class="token punctuation">(</span><span class="token keyword">int</span> net_fd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>  <span class="token comment">// 文件名，这里只是一个示例，实际使用时应根据情况确定文件名</span></pre></td></tr><tr><td data-num="29"></td><td><pre>  <span class="token keyword">char</span> <span class="token operator">*</span>file_name <span class="token operator">=</span> <span class="token string">"file.txt"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>  <span class="token comment">/**</pre></td></tr><tr><td data-num="32"></td><td><pre>   * 初始化传输结构体，设置文件名长度并复制文件名。</pre></td></tr><tr><td data-num="33"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="34"></td><td><pre>  <span class="token class-name">train_t</span> train<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>  <span class="token function">bzero</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>train<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>  train<span class="token punctuation">.</span>len <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>file_name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>  <span class="token function">memcpy</span><span class="token punctuation">(</span>train<span class="token punctuation">.</span>buf<span class="token punctuation">,</span> file_name<span class="token punctuation">,</span> train<span class="token punctuation">.</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre></pre></td></tr><tr><td data-num="39"></td><td><pre>  <span class="token comment">/**</pre></td></tr><tr><td data-num="40"></td><td><pre>   * 发送文件名长度和文件名。</pre></td></tr><tr><td data-num="41"></td><td><pre>   * 将文件名和长度一同发送给客户端，以便客户端申请足够的接收缓冲区。</pre></td></tr><tr><td data-num="42"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="43"></td><td><pre>  <span class="token function">send</span><span class="token punctuation">(</span>net_fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>train<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token operator">+</span> train<span class="token punctuation">.</span>len<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre></pre></td></tr><tr><td data-num="45"></td><td><pre>  <span class="token comment">// 打开文件，准备发送文件内容</span></pre></td></tr><tr><td data-num="46"></td><td><pre>  <span class="token keyword">int</span> file_fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>file_name<span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>file_fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open file error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>    <span class="token comment">// 如果打开文件失败，返回错误</span></pre></td></tr><tr><td data-num="50"></td><td><pre>    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="52"></td><td><pre></pre></td></tr><tr><td data-num="53"></td><td><pre>  <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre></pre></td></tr><tr><td data-num="55"></td><td><pre>  <span class="token keyword">int</span> read_num <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>file_fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre></pre></td></tr><tr><td data-num="57"></td><td><pre>  <span class="token comment">// 发送读取到的数据</span></pre></td></tr><tr><td data-num="58"></td><td><pre>  <span class="token function">send</span><span class="token punctuation">(</span>net_fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>read_num<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>  <span class="token function">send</span><span class="token punctuation">(</span>net_fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> read_num<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="60"></td><td><pre></pre></td></tr><tr><td data-num="61"></td><td><pre>  <span class="token comment">// 检查读取操作是否成功完成</span></pre></td></tr><tr><td data-num="62"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>read_num <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>    <span class="token comment">// 如果读取失败，返回错误</span></pre></td></tr><tr><td data-num="64"></td><td><pre>    <span class="token function">close</span><span class="token punctuation">(</span>file_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="67"></td><td><pre></pre></td></tr><tr><td data-num="68"></td><td><pre>  <span class="token comment">// 关闭文件描述符</span></pre></td></tr><tr><td data-num="69"></td><td><pre>  <span class="token function">close</span><span class="token punctuation">(</span>file_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><ol>
<li><strong>初始化传输结构体</strong>：定义并初始化  <code>train_t</code>  结构体，用于封装数据和长度信息。</li>
<li><strong>设置文件名信息</strong>：将文件名的长度和内容复制到  <code>train_t</code>  结构体的缓冲区中。</li>
<li><strong>发送文件名长度和文件名</strong>：将文件名的长度和文件名本身发送给客户端，这样客户端可以知道接收缓冲区需要多大。</li>
<li><strong>打开文件</strong>：打开要发送的文件，准备读取内容。</li>
<li><strong>读取并发送文件内容</strong>：
<ul>
<li>循环读取文件内容到缓冲区，发送数据长度和数据本身给客户端。</li>
<li>继续读取直到读取操作返回 0，表示文件读取完毕。</li>
</ul>
</li>
<li><strong>错误检查</strong>：如果文件读取失败，打印错误信息，关闭文件描述符，并返回错误代码  <code>-1</code> 。</li>
<li><strong>关闭文件描述符</strong>：完成文件内容发送后，关闭文件描述符以释放资源。</li>
<li><strong>返回结果</strong>：如果所有操作成功完成，函数返回  <code>0</code> 。</li>
</ol>
<h3 id="大文件传输"><a class="anchor" href="#大文件传输">#</a> 大文件传输</h3>
<h4 id="clientc-4"><a class="anchor" href="#clientc-4">#</a> client.c</h4>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="2"></td><td><pre> * @file client.c</pre></td></tr><tr><td data-num="3"></td><td><pre> * @brief 客户端程序。</pre></td></tr><tr><td data-num="4"></td><td><pre> *</pre></td></tr><tr><td data-num="5"></td><td><pre> * 该文件实现了客户端的主要功能，包括连接到服务器、接收服务器发送的文件名称和内容，</pre></td></tr><tr><td data-num="6"></td><td><pre> * 并将接收到的内容保存到本地文件中。</pre></td></tr><tr><td data-num="7"></td><td><pre> */</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdc.h></span></span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token comment">// 定义服务器的端口和 IP 地址</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token keyword">char</span> <span class="token operator">*</span>port <span class="token operator">=</span> <span class="token string">"8080"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token keyword">char</span> <span class="token operator">*</span>ip <span class="token operator">=</span> <span class="token string">"172.16.0.3"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token comment">/**</pre></td></tr><tr><td data-num="17"></td><td><pre>   * 创建 socket。</pre></td></tr><tr><td data-num="18"></td><td><pre>   * 创建一个用于通信的 socket，用于连接到服务器。</pre></td></tr><tr><td data-num="19"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token keyword">int</span> socket_fd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>socket_fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token comment">// 错误处理，例如打印错误信息并退出程序</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"socket creation failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>  <span class="token comment">/**</pre></td></tr><tr><td data-num="28"></td><td><pre>   * 设置服务器地址结构。</pre></td></tr><tr><td data-num="29"></td><td><pre>   * 初始化 sockaddr_in 结构，设置服务器的地址族、端口和 IP 地址。</pre></td></tr><tr><td data-num="30"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="31"></td><td><pre>  <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> addr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>  addr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>  addr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token function">atoi</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 端口号转换为网络字节序</span></pre></td></tr><tr><td data-num="34"></td><td><pre>  addr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">inet_addr</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// IP 地址转换为网络字节序</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre>  <span class="token comment">/**</pre></td></tr><tr><td data-num="37"></td><td><pre>   * 连接到服务器。</pre></td></tr><tr><td data-num="38"></td><td><pre>   * 使用 connect 系统调用建立到服务器的连接。</pre></td></tr><tr><td data-num="39"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="40"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">connect</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>addr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token comment">// 错误处理，例如关闭 socket_fd 并退出程序</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"connect failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token function">close</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="46"></td><td><pre></pre></td></tr><tr><td data-num="47"></td><td><pre>  <span class="token comment">/**</pre></td></tr><tr><td data-num="48"></td><td><pre>   * 接收服务器发送的文件名称长度。</pre></td></tr><tr><td data-num="49"></td><td><pre>   * 首先接收一个表示文件名长度的整数，以便分配合适的缓冲区。</pre></td></tr><tr><td data-num="50"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="51"></td><td><pre>  <span class="token keyword">int</span> file_name_len<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>  <span class="token keyword">int</span> recv_fd <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>file_name_len<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre></pre></td></tr><tr><td data-num="54"></td><td><pre>  <span class="token comment">/**</pre></td></tr><tr><td data-num="55"></td><td><pre>   * 检查接收文件名称长度是否成功。</pre></td></tr><tr><td data-num="56"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="57"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>recv_fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>    <span class="token comment">// 错误处理</span></pre></td></tr><tr><td data-num="59"></td><td><pre>    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"recv failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>    <span class="token function">close</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>  <span class="token comment">/**</pre></td></tr><tr><td data-num="64"></td><td><pre>   * 接收服务器发送的文件名称。</pre></td></tr><tr><td data-num="65"></td><td><pre>   * 接收到文件名称长度后，根据该长度接收实际的文件名。</pre></td></tr><tr><td data-num="66"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="67"></td><td><pre>  <span class="token keyword">char</span> buf_name<span class="token punctuation">[</span><span class="token number">60</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>  recv_fd <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">,</span> buf_name<span class="token punctuation">,</span> file_name_len<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="69"></td><td><pre></pre></td></tr><tr><td data-num="70"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>recv_fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>    <span class="token comment">// 错误处理</span></pre></td></tr><tr><td data-num="72"></td><td><pre>    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"recv failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>    <span class="token function">close</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="76"></td><td><pre></pre></td></tr><tr><td data-num="77"></td><td><pre>  <span class="token comment">/**</pre></td></tr><tr><td data-num="78"></td><td><pre>   * 打开或创建用于保存文件内容的本地文件。</pre></td></tr><tr><td data-num="79"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="80"></td><td><pre>  <span class="token keyword">int</span> file_fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>buf_name<span class="token punctuation">,</span> O_RDWR <span class="token operator">|</span> O_CREAT<span class="token punctuation">,</span> <span class="token number">0666</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>file_fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="82"></td><td><pre>    <span class="token comment">// 错误处理</span></pre></td></tr><tr><td data-num="83"></td><td><pre>    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open file failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="84"></td><td><pre>    <span class="token function">close</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="85"></td><td><pre>    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="86"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="87"></td><td><pre>  <span class="token comment">/**</pre></td></tr><tr><td data-num="88"></td><td><pre>   * 循环接收文件内容。</pre></td></tr><tr><td data-num="89"></td><td><pre>   * 直到从服务器接收完所有文件数据。</pre></td></tr><tr><td data-num="90"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="91"></td><td><pre>  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="92"></td><td><pre>    <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="93"></td><td><pre>    <span class="token comment">/**</pre></td></tr><tr><td data-num="94"></td><td><pre>     * 接收文件块的长度。</pre></td></tr><tr><td data-num="95"></td><td><pre>     * 每次循环首先接收接下来要接收的数据块的长度。</pre></td></tr><tr><td data-num="96"></td><td><pre>     */</span></pre></td></tr><tr><td data-num="97"></td><td><pre>    recv_fd <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>len<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="98"></td><td><pre>    <span class="token comment">/**</pre></td></tr><tr><td data-num="99"></td><td><pre>     * 检查接收长度信息是否成功，并处理接收结束条件。</pre></td></tr><tr><td data-num="100"></td><td><pre>     * 如果接收到的长度为 0，表示文件传输结束。</pre></td></tr><tr><td data-num="101"></td><td><pre>     */</span></pre></td></tr><tr><td data-num="102"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>recv_fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="103"></td><td><pre>      <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"recv failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="104"></td><td><pre>      <span class="token function">close</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="105"></td><td><pre>      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="106"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="107"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="108"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="109"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="110"></td><td><pre>    <span class="token comment">/**</pre></td></tr><tr><td data-num="111"></td><td><pre>     * 接收文件数据块并写入文件。</pre></td></tr><tr><td data-num="112"></td><td><pre>     * 根据接收到的长度，接收数据并写入到之前打开的文件中。</pre></td></tr><tr><td data-num="113"></td><td><pre>     */</span></pre></td></tr><tr><td data-num="114"></td><td><pre>    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1000</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="115"></td><td><pre>    <span class="token class-name">ssize_t</span> recv_len <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> len<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="116"></td><td><pre>    <span class="token function">write</span><span class="token punctuation">(</span>file_fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> recv_len<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="117"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="118"></td><td><pre></pre></td></tr><tr><td data-num="119"></td><td><pre>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"文件已成功接收！\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="120"></td><td><pre></pre></td></tr><tr><td data-num="121"></td><td><pre>  <span class="token comment">/**</pre></td></tr><tr><td data-num="122"></td><td><pre>   * 关闭文件和 socket。</pre></td></tr><tr><td data-num="123"></td><td><pre>   * 完成通信后，关闭文件描述符和 socket 连接。</pre></td></tr><tr><td data-num="124"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="125"></td><td><pre>  <span class="token function">close</span><span class="token punctuation">(</span>file_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="126"></td><td><pre>  <span class="token function">close</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="127"></td><td><pre>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="128"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><ol>
<li><strong>接收文件名称</strong>：根据先前接收到的文件名称长度，客户端接收实际的文件名称。</li>
<li><strong>打开文件</strong>：客户端使用接收到的文件名称打开或创建一个本地文件，准备写入接收到的文件内容。</li>
<li><strong>循环接收文件内容</strong>：客户端进入一个循环，准备接收服务器发送的文件内容。</li>
<li><strong>接收数据块长度</strong>：在循环中，客户端首先接收接下来要接收的数据块的长度。</li>
<li><strong>错误检查</strong>：如果接收长度信息失败，客户端将执行错误处理。</li>
<li><strong>检查接收结束条件</strong>：如果接收到的长度为 0，表示文件内容已经全部接收完毕，客户端将退出循环。</li>
<li><strong>接收数据块并写入文件</strong>：客户端根据接收到的长度接收数据块，并将其写入到本地文件中。</li>
<li><strong>打印成功消息</strong>：接收完毕后，客户端打印一条消息，通知用户文件接收成功。</li>
<li><strong>关闭资源</strong>：最后，客户端关闭文件描述符和 socket 连接，释放所有资源。</li>
</ol>
<h4 id="send_filec-3"><a class="anchor" href="#send_filec-3">#</a> send_file.c</h4>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="2"></td><td><pre> * @file send_file.c</pre></td></tr><tr><td data-num="3"></td><td><pre> * @brief 文件发送模块。</pre></td></tr><tr><td data-num="4"></td><td><pre> *</pre></td></tr><tr><td data-num="5"></td><td><pre> * 该文件实现了子进程发送文件给客户端的功能。</pre></td></tr><tr><td data-num="6"></td><td><pre> */</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"head.h"</span></span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="11"></td><td><pre> * @brief 结构体用于封装传输的数据和长度。</pre></td></tr><tr><td data-num="12"></td><td><pre> */</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">train_s</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token keyword">int</span> len<span class="token punctuation">;</span>        <span class="token comment">/**&lt; 数据长度 */</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">/**&lt; 数据缓冲区 */</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">&#125;</span> <span class="token class-name">train_t</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="19"></td><td><pre> * @brief 发送文件给客户端。</pre></td></tr><tr><td data-num="20"></td><td><pre> *</pre></td></tr><tr><td data-num="21"></td><td><pre> * 该函数负责打开指定的文件，并发送文件内容到客户端。</pre></td></tr><tr><td data-num="22"></td><td><pre> * 首先发送文件名的长度和文件名，然后分块读取并发送文件内容。</pre></td></tr><tr><td data-num="23"></td><td><pre> *</pre></td></tr><tr><td data-num="24"></td><td><pre> * @param net_fd 客户端连接的文件描述符。</pre></td></tr><tr><td data-num="25"></td><td><pre> * @return 成功返回 0，失败返回 -1。</pre></td></tr><tr><td data-num="26"></td><td><pre> */</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token keyword">int</span> <span class="token function">sendFile</span><span class="token punctuation">(</span><span class="token keyword">int</span> net_fd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>  <span class="token comment">// 文件名，这里只是一个示例，实际使用时应根据情况确定文件名</span></pre></td></tr><tr><td data-num="29"></td><td><pre>  <span class="token keyword">char</span> <span class="token operator">*</span>file_name <span class="token operator">=</span> <span class="token string">"斗破苍穹.txt"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>  <span class="token comment">/**</pre></td></tr><tr><td data-num="32"></td><td><pre>   * 定义传输结构体，用于封装文件名和内容。</pre></td></tr><tr><td data-num="33"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="34"></td><td><pre>  <span class="token class-name">train_t</span> train<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>  <span class="token comment">/**</pre></td></tr><tr><td data-num="36"></td><td><pre>   * 初始化传输结构体，设置文件名长度。</pre></td></tr><tr><td data-num="37"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="38"></td><td><pre>  <span class="token function">bzero</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>train<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>  train<span class="token punctuation">.</span>len <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>file_name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>  <span class="token comment">/**</pre></td></tr><tr><td data-num="41"></td><td><pre>   * 复制文件名到传输结构体的缓冲区。</pre></td></tr><tr><td data-num="42"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="43"></td><td><pre>  <span class="token function">memcpy</span><span class="token punctuation">(</span>train<span class="token punctuation">.</span>buf<span class="token punctuation">,</span> file_name<span class="token punctuation">,</span> train<span class="token punctuation">.</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre></pre></td></tr><tr><td data-num="45"></td><td><pre>  <span class="token comment">/**</pre></td></tr><tr><td data-num="46"></td><td><pre>   * 发送文件名长度和文件名。</pre></td></tr><tr><td data-num="47"></td><td><pre>   * 将文件名和长度一同发送给客户端，以便客户端申请足够的接收缓冲区。</pre></td></tr><tr><td data-num="48"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="49"></td><td><pre>  <span class="token function">send</span><span class="token punctuation">(</span>net_fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>train<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token operator">+</span> train<span class="token punctuation">.</span>len<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre></pre></td></tr><tr><td data-num="51"></td><td><pre>  <span class="token comment">// 打开文件，准备发送文件内容</span></pre></td></tr><tr><td data-num="52"></td><td><pre>  <span class="token keyword">int</span> file_fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>file_name<span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>file_fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open file error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>    <span class="token comment">// 如果打开文件失败，返回错误</span></pre></td></tr><tr><td data-num="56"></td><td><pre>    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>  <span class="token comment">/**</pre></td></tr><tr><td data-num="59"></td><td><pre>   * 循环读取文件内容并发送。</pre></td></tr><tr><td data-num="60"></td><td><pre>   * 直到读取完文件的所有内容。</pre></td></tr><tr><td data-num="61"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="62"></td><td><pre>  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>    <span class="token function">bzero</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>train<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>train<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="64"></td><td><pre></pre></td></tr><tr><td data-num="65"></td><td><pre>    <span class="token class-name">ssize_t</span> read_res <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>file_fd<span class="token punctuation">,</span> train<span class="token punctuation">.</span>buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>train<span class="token punctuation">.</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>    train<span class="token punctuation">.</span>len <span class="token operator">=</span> read_res<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>read_res <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>    <span class="token comment">/**</pre></td></tr><tr><td data-num="71"></td><td><pre>     * 发送文件内容长度和内容。</pre></td></tr><tr><td data-num="72"></td><td><pre>     * 读取文件并发送内容长度和内容本身给客户端。</pre></td></tr><tr><td data-num="73"></td><td><pre>     */</span></pre></td></tr><tr><td data-num="74"></td><td><pre>    <span class="token keyword">int</span> net_res <span class="token operator">=</span> <span class="token function">send</span><span class="token punctuation">(</span>net_fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>train<span class="token punctuation">,</span> train<span class="token punctuation">.</span>len <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>train<span class="token punctuation">.</span>len<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="75"></td><td><pre></pre></td></tr><tr><td data-num="76"></td><td><pre>    <span class="token comment">// 检查读取操作是否成功完成</span></pre></td></tr><tr><td data-num="77"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>net_res <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="78"></td><td><pre>      <span class="token comment">// 如果读取失败，返回错误</span></pre></td></tr><tr><td data-num="79"></td><td><pre>      <span class="token function">close</span><span class="token punctuation">(</span>file_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="80"></td><td><pre>      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="82"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="83"></td><td><pre>  <span class="token comment">// 关闭文件描述符</span></pre></td></tr><tr><td data-num="84"></td><td><pre>  <span class="token function">close</span><span class="token punctuation">(</span>file_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="85"></td><td><pre>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="86"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><ol>
<li><strong>定义传输结构体</strong>：定义  <code>train_t</code>  结构体用于封装文件名和内容的传输。</li>
<li><strong>初始化传输结构体</strong>：使用  <code>bzero</code>  函数初始化  <code>train_t</code>  结构体，设置文件名长度。</li>
<li><strong>复制文件名</strong>：将文件名复制到  <code>train_t</code>  结构体的缓冲区中。</li>
<li><strong>发送文件名长度和文件名</strong>：先发送文件名的长度，然后发送文件名本身，以便客户端可以接收并存储文件名。</li>
<li><strong>打开文件</strong>：打开指定的文件以读取内容。</li>
<li><strong>循环读取和发送文件内容</strong>：
<ul>
<li>使用循环读取文件内容到缓冲区，然后发送数据长度和数据本身给客户端。</li>
<li>继续循环直到文件读取完毕。</li>
</ul>
</li>
<li><strong>发送数据长度</strong>：在发送每个数据块之前，先发送该数据块的长度，以便客户端可以分配合适的缓冲区。</li>
<li><strong>发送数据块</strong>：发送从文件中读取的数据块。</li>
<li><strong>错误检查</strong>：如果文件读取或发送过程中发生错误，执行错误处理并返回错误代码。</li>
<li><strong>关闭文件描述符</strong>：发送完毕后，关闭文件描述符以释放资源。</li>
<li><strong>返回结果</strong>：如果所有操作成功完成，函数返回  <code>0</code> 。</li>
</ol>
<h3 id="半包问题"><a class="anchor" href="#半包问题">#</a> 半包问题</h3>
<p>在 TCP/IP 网络编程中，尤其是在处理大文件传输时，可能会遇到所谓的 &quot;半包问题&quot;。这个问题描述了在数据传输过程中，一个数据包（或称为数据段）可能被操作系统只发送了一部分，而剩余部分延迟发送的情况。这种不连续的数据发送可能导致客户端在接收时出现错误，尤其是在客户端期望接收固定长度数据时。</p>
<p>数据的发送是由操作系统的网络栈控制的， <code>send</code>  函数调用只是将数据交给操作系统，而实际的网络传输时机和行为由操作系统决定。操作系统可能会因为多种原因（如网络拥塞、资源调度等）导致数据包的不完整发送。</p>
<p>如果客户端在接收数据时只读取了部分数据，而剩余的数据在之后的某个时刻才到达，这可能导致客户端在处理数据时出现错误。例如，在根据长度前缀接收后续数据时，如果长度不匹配，客户端可能会错误地将部分数据解释为完整消息，导致数据解析错误。</p>
<p>为了解决半包问题，可以在使用  <code>recv</code>  函数接收数据时，使用  <code>MSG_WAITALL</code>  标志位。这个标志位指示  <code>recv</code>  函数在接收到请求的长度  <code>len</code>  的数据之前不会返回，即使数据是分批次到达的。</p>
<h4 id="clientc-5"><a class="anchor" href="#clientc-5">#</a> client.c</h4>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="2"></td><td><pre> * @file client.c</pre></td></tr><tr><td data-num="3"></td><td><pre> * @brief 客户端程序。</pre></td></tr><tr><td data-num="4"></td><td><pre> *</pre></td></tr><tr><td data-num="5"></td><td><pre> * 该文件实现了客户端的主要功能，包括连接到服务器、接收服务器发送的文件名称和内容，</pre></td></tr><tr><td data-num="6"></td><td><pre> * 并将接收到的内容保存到本地文件中。</pre></td></tr><tr><td data-num="7"></td><td><pre> */</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdc.h></span></span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token comment">// 定义服务器的端口和 IP 地址</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token keyword">char</span> <span class="token operator">*</span>port <span class="token operator">=</span> <span class="token string">"8080"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token keyword">char</span> <span class="token operator">*</span>ip <span class="token operator">=</span> <span class="token string">"172.16.0.3"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token comment">/**</pre></td></tr><tr><td data-num="17"></td><td><pre>   * 创建 socket。</pre></td></tr><tr><td data-num="18"></td><td><pre>   * 创建一个用于通信的 socket，用于连接到服务器。</pre></td></tr><tr><td data-num="19"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token keyword">int</span> socket_fd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>socket_fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token comment">// 错误处理，例如打印错误信息并退出程序</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"socket creation failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>  <span class="token comment">/**</pre></td></tr><tr><td data-num="28"></td><td><pre>   * 设置服务器地址结构。</pre></td></tr><tr><td data-num="29"></td><td><pre>   * 初始化 sockaddr_in 结构，设置服务器的地址族、端口和 IP 地址。</pre></td></tr><tr><td data-num="30"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="31"></td><td><pre>  <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> addr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>  addr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>  addr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token function">atoi</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 端口号转换为网络字节序</span></pre></td></tr><tr><td data-num="34"></td><td><pre>  addr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">inet_addr</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// IP 地址转换为网络字节序</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre>  <span class="token comment">/**</pre></td></tr><tr><td data-num="37"></td><td><pre>   * 连接到服务器。</pre></td></tr><tr><td data-num="38"></td><td><pre>   * 使用 connect 系统调用建立到服务器的连接。</pre></td></tr><tr><td data-num="39"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="40"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">connect</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>addr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token comment">// 错误处理，例如关闭 socket_fd 并退出程序</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"connect failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token function">close</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="46"></td><td><pre></pre></td></tr><tr><td data-num="47"></td><td><pre>  <span class="token comment">/**</pre></td></tr><tr><td data-num="48"></td><td><pre>   * 接收服务器发送的文件名称长度。</pre></td></tr><tr><td data-num="49"></td><td><pre>   * 首先接收一个表示文件名长度的整数，以便分配合适的缓冲区。</pre></td></tr><tr><td data-num="50"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="51"></td><td><pre>  <span class="token keyword">int</span> file_name_len<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>  <span class="token keyword">int</span> recv_fd <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>file_name_len<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre></pre></td></tr><tr><td data-num="54"></td><td><pre>  <span class="token comment">/**</pre></td></tr><tr><td data-num="55"></td><td><pre>   * 检查接收文件名称长度是否成功。</pre></td></tr><tr><td data-num="56"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="57"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>recv_fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>    <span class="token comment">// 错误处理</span></pre></td></tr><tr><td data-num="59"></td><td><pre>    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"recv failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>    <span class="token function">close</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>  <span class="token comment">/**</pre></td></tr><tr><td data-num="64"></td><td><pre>   * 接收服务器发送的文件名称。</pre></td></tr><tr><td data-num="65"></td><td><pre>   * 接收到文件名称长度后，根据该长度接收实际的文件名。</pre></td></tr><tr><td data-num="66"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="67"></td><td><pre>  <span class="token keyword">char</span> buf_name<span class="token punctuation">[</span><span class="token number">60</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>  recv_fd <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">,</span> buf_name<span class="token punctuation">,</span> file_name_len<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="69"></td><td><pre></pre></td></tr><tr><td data-num="70"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>recv_fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>    <span class="token comment">// 错误处理</span></pre></td></tr><tr><td data-num="72"></td><td><pre>    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"recv failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>    <span class="token function">close</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="76"></td><td><pre></pre></td></tr><tr><td data-num="77"></td><td><pre>  <span class="token comment">/**</pre></td></tr><tr><td data-num="78"></td><td><pre>   * 打开或创建用于保存文件内容的本地文件。</pre></td></tr><tr><td data-num="79"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="80"></td><td><pre>  <span class="token keyword">int</span> file_fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>buf_name<span class="token punctuation">,</span> O_RDWR <span class="token operator">|</span> O_CREAT<span class="token punctuation">,</span> <span class="token number">0666</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>file_fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="82"></td><td><pre>    <span class="token comment">// 错误处理</span></pre></td></tr><tr><td data-num="83"></td><td><pre>    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open file failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="84"></td><td><pre>    <span class="token function">close</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="85"></td><td><pre>    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="86"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="87"></td><td><pre>  <span class="token comment">/**</pre></td></tr><tr><td data-num="88"></td><td><pre>   * 循环接收文件内容。</pre></td></tr><tr><td data-num="89"></td><td><pre>   * 直到从服务器接收完所有文件数据。</pre></td></tr><tr><td data-num="90"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="91"></td><td><pre>  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="92"></td><td><pre>    <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="93"></td><td><pre>    <span class="token comment">/**</pre></td></tr><tr><td data-num="94"></td><td><pre>     * 接收文件块的长度。</pre></td></tr><tr><td data-num="95"></td><td><pre>     * 每次循环首先接收接下来要接收的数据块的长度。</pre></td></tr><tr><td data-num="96"></td><td><pre>     * 使用带有 MSG_WAITALL 标志的 recv 调用确保接收到完整的长度信息</pre></td></tr><tr><td data-num="97"></td><td><pre>     */</span></pre></td></tr><tr><td data-num="98"></td><td><pre>    recv_fd <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>len<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">,</span> MSG_WAITALL<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="99"></td><td><pre>    <span class="token comment">/**</pre></td></tr><tr><td data-num="100"></td><td><pre>     * 检查接收长度信息是否成功，并处理接收结束条件。</pre></td></tr><tr><td data-num="101"></td><td><pre>     * 如果接收到的长度为 0，表示文件传输结束。</pre></td></tr><tr><td data-num="102"></td><td><pre>     */</span></pre></td></tr><tr><td data-num="103"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>recv_fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="104"></td><td><pre>      <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"recv failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="105"></td><td><pre>      <span class="token function">close</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="106"></td><td><pre>      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="107"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="108"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="109"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="110"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="111"></td><td><pre>    <span class="token comment">/**</pre></td></tr><tr><td data-num="112"></td><td><pre>     * 接收文件数据块并写入文件。</pre></td></tr><tr><td data-num="113"></td><td><pre>     * 根据接收到的长度，接收数据并写入到之前打开的文件中。</pre></td></tr><tr><td data-num="114"></td><td><pre>     * 使用带有 MSG_WAITALL 标志的 recv 调用确保接收到完整的长度信息</pre></td></tr><tr><td data-num="115"></td><td><pre>     */</span></pre></td></tr><tr><td data-num="116"></td><td><pre>    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1000</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="117"></td><td><pre>    <span class="token class-name">ssize_t</span> recv_len <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> len<span class="token punctuation">,</span> MSG_WAITALL<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="118"></td><td><pre>    <span class="token function">write</span><span class="token punctuation">(</span>file_fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> recv_len<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="119"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="120"></td><td><pre></pre></td></tr><tr><td data-num="121"></td><td><pre>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"文件已成功接收！\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="122"></td><td><pre></pre></td></tr><tr><td data-num="123"></td><td><pre>  <span class="token comment">/**</pre></td></tr><tr><td data-num="124"></td><td><pre>   * 关闭文件和 socket。</pre></td></tr><tr><td data-num="125"></td><td><pre>   * 完成通信后，关闭文件描述符和 socket 连接。</pre></td></tr><tr><td data-num="126"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="127"></td><td><pre>  <span class="token function">close</span><span class="token punctuation">(</span>file_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="128"></td><td><pre>  <span class="token function">close</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="129"></td><td><pre>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="130"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="抛出异常信号终止问题"><a class="anchor" href="#抛出异常信号终止问题">#</a> 抛出异常信号终止问题</h3>
<p>当 TCP 连接的对端关闭连接时，发送端如果尝试向该连接发送数据，操作系统会发送一个  <code>SIGPIPE</code>  信号给发送进程。在默认情况下，这可能导致进程异常终止。</p>
<p>为了防止因  <code>SIGPIPE</code>  信号而导致的进程终止，可以在调用  <code>send</code>  函数时使用  <code>MSG_NOSIGNAL</code>  标志位。 <code>MSG_NOSIGNAL</code>  指示  <code>send</code>  函数在对方关闭连接时不抛出  <code>SIGPIPE</code>  信号，而是返回一个错误码（通常是 - 1），并将  <code>errno</code>  设置为  <code>EPIPE</code> 。</p>
<h4 id="send_filec-4"><a class="anchor" href="#send_filec-4">#</a> send_file.c</h4>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="2"></td><td><pre> * @file send_file.c</pre></td></tr><tr><td data-num="3"></td><td><pre> * @brief 文件发送模块。</pre></td></tr><tr><td data-num="4"></td><td><pre> *</pre></td></tr><tr><td data-num="5"></td><td><pre> * 该文件实现了子进程发送文件给客户端的功能。</pre></td></tr><tr><td data-num="6"></td><td><pre> */</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"head.h"</span></span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="11"></td><td><pre> * @brief 结构体用于封装传输的数据和长度。</pre></td></tr><tr><td data-num="12"></td><td><pre> */</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">train_s</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token keyword">int</span> len<span class="token punctuation">;</span>        <span class="token comment">/**&lt; 数据长度 */</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">/**&lt; 数据缓冲区 */</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">&#125;</span> <span class="token class-name">train_t</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="19"></td><td><pre> * @brief 处理 SIGPIPE 信号的函数。</pre></td></tr><tr><td data-num="20"></td><td><pre> * 当发生管道破裂时（例如对方关闭了连接），此函数会被调用。</pre></td></tr><tr><td data-num="21"></td><td><pre> * @param num 信号的编号</pre></td></tr><tr><td data-num="22"></td><td><pre> */</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token keyword">void</span> <span class="token function">fun</span> <span class="token punctuation">(</span><span class="token keyword">int</span> num<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"sigpeipe %d\n"</span><span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="28"></td><td><pre> * @brief 发送文件给客户端。</pre></td></tr><tr><td data-num="29"></td><td><pre> *</pre></td></tr><tr><td data-num="30"></td><td><pre> * 该函数负责打开指定的文件，并发送文件内容到客户端。</pre></td></tr><tr><td data-num="31"></td><td><pre> * 首先发送文件名的长度和文件名，然后分块读取并发送文件内容。</pre></td></tr><tr><td data-num="32"></td><td><pre> *</pre></td></tr><tr><td data-num="33"></td><td><pre> * @param net_fd 客户端连接的文件描述符。</pre></td></tr><tr><td data-num="34"></td><td><pre> * @return 成功返回 0，失败返回 -1。</pre></td></tr><tr><td data-num="35"></td><td><pre> */</span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token keyword">int</span> <span class="token function">sendFile</span><span class="token punctuation">(</span><span class="token keyword">int</span> net_fd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>  <span class="token comment">/**</pre></td></tr><tr><td data-num="38"></td><td><pre>   * 设置当发生 SIGPIPE 信号时，调用 fun 函数。</pre></td></tr><tr><td data-num="39"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="40"></td><td><pre>  <span class="token function">signal</span><span class="token punctuation">(</span>SIGPIPE<span class="token punctuation">,</span> fun<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre></pre></td></tr><tr><td data-num="42"></td><td><pre>  <span class="token comment">// 文件名，这里只是一个示例，实际使用时应根据情况确定文件名</span></pre></td></tr><tr><td data-num="43"></td><td><pre>  <span class="token keyword">char</span> <span class="token operator">*</span>file_name <span class="token operator">=</span> <span class="token string">"斗破苍穹.txt"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre></pre></td></tr><tr><td data-num="45"></td><td><pre>  <span class="token comment">/**</pre></td></tr><tr><td data-num="46"></td><td><pre>   * 定义传输结构体，用于封装文件名和内容。</pre></td></tr><tr><td data-num="47"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="48"></td><td><pre>  <span class="token class-name">train_t</span> train<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>  <span class="token comment">/**</pre></td></tr><tr><td data-num="50"></td><td><pre>   * 初始化传输结构体，设置文件名长度。</pre></td></tr><tr><td data-num="51"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="52"></td><td><pre>  <span class="token function">bzero</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>train<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>  train<span class="token punctuation">.</span>len <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>file_name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>  <span class="token comment">/**</pre></td></tr><tr><td data-num="55"></td><td><pre>   * 复制文件名到传输结构体的缓冲区。</pre></td></tr><tr><td data-num="56"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="57"></td><td><pre>  <span class="token function">memcpy</span><span class="token punctuation">(</span>train<span class="token punctuation">.</span>buf<span class="token punctuation">,</span> file_name<span class="token punctuation">,</span> train<span class="token punctuation">.</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre></pre></td></tr><tr><td data-num="59"></td><td><pre>  <span class="token comment">/**</pre></td></tr><tr><td data-num="60"></td><td><pre>   * 发送文件名长度和文件名。</pre></td></tr><tr><td data-num="61"></td><td><pre>   * 将文件名和长度一同发送给客户端，以便客户端申请足够的接收缓冲区。</pre></td></tr><tr><td data-num="62"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="63"></td><td><pre>  <span class="token function">send</span><span class="token punctuation">(</span>net_fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>train<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token operator">+</span> train<span class="token punctuation">.</span>len<span class="token punctuation">,</span> MSG_NOSIGNAL<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="64"></td><td><pre></pre></td></tr><tr><td data-num="65"></td><td><pre>  <span class="token comment">// 打开文件，准备发送文件内容</span></pre></td></tr><tr><td data-num="66"></td><td><pre>  <span class="token keyword">int</span> file_fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>file_name<span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>file_fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open file error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>    <span class="token comment">// 如果打开文件失败，返回错误</span></pre></td></tr><tr><td data-num="70"></td><td><pre>    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>  <span class="token comment">/**</pre></td></tr><tr><td data-num="73"></td><td><pre>   * 循环读取文件内容并发送。</pre></td></tr><tr><td data-num="74"></td><td><pre>   * 直到读取完文件的所有内容。</pre></td></tr><tr><td data-num="75"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="76"></td><td><pre>  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>    <span class="token function">bzero</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>train<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>train<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="78"></td><td><pre></pre></td></tr><tr><td data-num="79"></td><td><pre>    <span class="token keyword">int</span> read_res <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>file_fd<span class="token punctuation">,</span> train<span class="token punctuation">.</span>buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>train<span class="token punctuation">.</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="80"></td><td><pre>    train<span class="token punctuation">.</span>len <span class="token operator">=</span> read_res<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>read_res <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="82"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="83"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="84"></td><td><pre>    <span class="token comment">/**</pre></td></tr><tr><td data-num="85"></td><td><pre>     * 发送文件内容长度和内容。</pre></td></tr><tr><td data-num="86"></td><td><pre>     * 发送前先发送长度，然后发送内容，使用 MSG_NOSIGNAL 标志防止 SIGPIPE。</pre></td></tr><tr><td data-num="87"></td><td><pre>     */</span></pre></td></tr><tr><td data-num="88"></td><td><pre>    <span class="token keyword">int</span> net_res <span class="token operator">=</span> <span class="token function">send</span><span class="token punctuation">(</span>net_fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>train<span class="token punctuation">,</span> train<span class="token punctuation">.</span>len <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>train<span class="token punctuation">.</span>len<span class="token punctuation">)</span><span class="token punctuation">,</span> MSG_NOSIGNAL<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="89"></td><td><pre></pre></td></tr><tr><td data-num="90"></td><td><pre>    <span class="token comment">// 检查读取操作是否成功完成</span></pre></td></tr><tr><td data-num="91"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>net_res <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="92"></td><td><pre>      <span class="token comment">// 如果读取失败，返回错误</span></pre></td></tr><tr><td data-num="93"></td><td><pre>      <span class="token function">close</span><span class="token punctuation">(</span>file_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="94"></td><td><pre>      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="95"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="96"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="97"></td><td><pre>  <span class="token comment">// 关闭文件描述符</span></pre></td></tr><tr><td data-num="98"></td><td><pre>  <span class="token function">close</span><span class="token punctuation">(</span>file_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="99"></td><td><pre>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="100"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="进度条"><a class="anchor" href="#进度条">#</a> 进度条</h3>
<p>如果要模拟日常下载文件时的进度条显示效果，可以采取以下步骤：在文件传输开始之前，首先将文件的总大小信息发送至客户端。随后，在文件传输过程中，客户端可以依据已接收的文件数据量与文件总大小的比例，动态更新并展示进度条。</p>
<p>实现这一功能需利用  <code>fstat</code>  函数来获取文件的状态信息。</p>
<h4 id="fstat-获取文件描述符元数据"><a class="anchor" href="#fstat-获取文件描述符元数据">#</a>  <code>fstat</code>  获取文件描述符元数据</h4>
<p><code>fstat</code>  函数用于获取一个文件描述符（file descriptor）的元数据（metadata），并将这些信息存储在一个  <code>stat</code>  结构体中。这个函数是 POSIX 标准的一部分，通常用于获取文件或文件系统的状态信息。</p>
<p>函数原型如下：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">int</span> <span class="token function">fstat</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">stat</span> <span class="token operator">*</span>statbuf<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>参数说明：</p>
<ol>
<li><strong>int fd</strong>: 这是要获取状态信息的文件描述符。这个文件描述符可以是任何打开的文件、socket、管道或其他特殊文件的描述符。</li>
<li><strong>struct stat *statbuf</strong>: 这是一个指向  <code>stat</code>  结构的指针，用于接收文件描述符的状态信息。 <code>stat</code>  结构包含了广泛的信息，例如文件大小、块大小、总块数、访问权限、所有者、组、访问时间、修改时间等。</li>
</ol>
<p>返回值：</p>
<ul>
<li>如果调用成功，返回 0。</li>
<li>如果调用失败，返回 -1，并设置全局变量  <code>errno</code>  以指示错误类型。</li>
</ul>
<p>使用场景：</p>
<ul>
<li>当需要获取有关文件或文件系统的状态信息时。</li>
<li>当需要检查文件的访问权限、所有者、组或其他属性时。</li>
</ul>
<p>工作机制：</p>
<ul>
<li><code>fstat</code>  函数调用操作系统内核，请求获取与给定文件描述符关联的文件的状态信息。</li>
<li>内核将这些信息填充到  <code>statbuf</code>  指向的结构中。</li>
</ul>
<h4 id="clientc-6"><a class="anchor" href="#clientc-6">#</a> client.c</h4>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="2"></td><td><pre> * @file client.c</pre></td></tr><tr><td data-num="3"></td><td><pre> * @brief 客户端程序。</pre></td></tr><tr><td data-num="4"></td><td><pre> *</pre></td></tr><tr><td data-num="5"></td><td><pre> * 该文件实现了客户端的主要功能，包括连接到服务器、接收服务器发送的文件名称和内容，</pre></td></tr><tr><td data-num="6"></td><td><pre> * 并将接收到的内容保存到本地文件中。</pre></td></tr><tr><td data-num="7"></td><td><pre> */</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdc.h></span></span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token comment">// 定义服务器的端口和 IP 地址</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token keyword">char</span> <span class="token operator">*</span>port <span class="token operator">=</span> <span class="token string">"8080"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token keyword">char</span> <span class="token operator">*</span>ip <span class="token operator">=</span> <span class="token string">"172.16.0.3"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token comment">/**</pre></td></tr><tr><td data-num="17"></td><td><pre>   * 创建 socket。</pre></td></tr><tr><td data-num="18"></td><td><pre>   * 创建一个用于通信的 socket，用于连接到服务器。</pre></td></tr><tr><td data-num="19"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token keyword">int</span> socket_fd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>socket_fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token comment">// 错误处理，例如打印错误信息并退出程序</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"socket creation failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>  <span class="token comment">/**</pre></td></tr><tr><td data-num="28"></td><td><pre>   * 设置服务器地址结构。</pre></td></tr><tr><td data-num="29"></td><td><pre>   * 初始化 sockaddr_in 结构，设置服务器的地址族、端口和 IP 地址。</pre></td></tr><tr><td data-num="30"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="31"></td><td><pre>  <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> addr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>  addr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>  addr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token function">atoi</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 端口号转换为网络字节序</span></pre></td></tr><tr><td data-num="34"></td><td><pre>  addr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">inet_addr</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// IP 地址转换为网络字节序</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre>  <span class="token comment">/**</pre></td></tr><tr><td data-num="37"></td><td><pre>   * 连接到服务器。</pre></td></tr><tr><td data-num="38"></td><td><pre>   * 使用 connect 系统调用建立到服务器的连接。</pre></td></tr><tr><td data-num="39"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="40"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">connect</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>addr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token comment">// 错误处理，例如关闭 socket_fd 并退出程序</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"connect failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token function">close</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>  <span class="token comment">// 接收文件大小</span></pre></td></tr><tr><td data-num="47"></td><td><pre>  <span class="token comment">// 在接收文件之前，先接收文件的总大小，用于后续显示接收进度</span></pre></td></tr><tr><td data-num="48"></td><td><pre>  <span class="token class-name">off_t</span> file_size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>  <span class="token function">recv</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>file_size<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">off_t</span><span class="token punctuation">)</span><span class="token punctuation">,</span> MSG_WAITALL<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"文件大小为：%ld\n"</span><span class="token punctuation">,</span> file_size<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre></pre></td></tr><tr><td data-num="52"></td><td><pre>  <span class="token comment">/**</pre></td></tr><tr><td data-num="53"></td><td><pre>   * 接收服务器发送的文件名称长度。</pre></td></tr><tr><td data-num="54"></td><td><pre>   * 首先接收一个表示文件名长度的整数，以便分配合适的缓冲区。</pre></td></tr><tr><td data-num="55"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="56"></td><td><pre>  <span class="token keyword">int</span> file_name_len<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>  <span class="token keyword">int</span> recv_fd <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>file_name_len<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre></pre></td></tr><tr><td data-num="59"></td><td><pre>  <span class="token comment">/**</pre></td></tr><tr><td data-num="60"></td><td><pre>   * 检查接收文件名称长度是否成功。</pre></td></tr><tr><td data-num="61"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="62"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>recv_fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>    <span class="token comment">// 错误处理</span></pre></td></tr><tr><td data-num="64"></td><td><pre>    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"recv failed3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>    <span class="token function">close</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>  <span class="token comment">/**</pre></td></tr><tr><td data-num="69"></td><td><pre>   * 接收服务器发送的文件名称。</pre></td></tr><tr><td data-num="70"></td><td><pre>   * 接收到文件名称长度后，根据该长度接收实际的文件名。</pre></td></tr><tr><td data-num="71"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="72"></td><td><pre>  <span class="token keyword">char</span> buf_name<span class="token punctuation">[</span><span class="token number">60</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>  recv_fd <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">,</span> buf_name<span class="token punctuation">,</span> file_name_len<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre></pre></td></tr><tr><td data-num="75"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>recv_fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>    <span class="token comment">// 错误处理</span></pre></td></tr><tr><td data-num="77"></td><td><pre>    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"recv failed 1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="78"></td><td><pre>    <span class="token function">close</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="80"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="81"></td><td><pre></pre></td></tr><tr><td data-num="82"></td><td><pre>  <span class="token comment">/**</pre></td></tr><tr><td data-num="83"></td><td><pre>   * 打开或创建用于保存文件内容的本地文件。</pre></td></tr><tr><td data-num="84"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="85"></td><td><pre>  <span class="token keyword">int</span> file_fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>buf_name<span class="token punctuation">,</span> O_RDWR <span class="token operator">|</span> O_CREAT<span class="token punctuation">,</span> <span class="token number">0666</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="86"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>file_fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="87"></td><td><pre>    <span class="token comment">// 错误处理</span></pre></td></tr><tr><td data-num="88"></td><td><pre>    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open file failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="89"></td><td><pre>    <span class="token function">close</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="90"></td><td><pre>    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="91"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="92"></td><td><pre></pre></td></tr><tr><td data-num="93"></td><td><pre>  <span class="token class-name">off_t</span> cursize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="94"></td><td><pre>  <span class="token class-name">off_t</span> last_update_size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="95"></td><td><pre></pre></td></tr><tr><td data-num="96"></td><td><pre>  <span class="token comment">/**</pre></td></tr><tr><td data-num="97"></td><td><pre>   * 循环接收文件内容。</pre></td></tr><tr><td data-num="98"></td><td><pre>   * 直到从服务器接收完所有文件数据。</pre></td></tr><tr><td data-num="99"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="100"></td><td><pre>  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="101"></td><td><pre>    <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="102"></td><td><pre>    <span class="token comment">/**</pre></td></tr><tr><td data-num="103"></td><td><pre>     * 接收文件块的长度。</pre></td></tr><tr><td data-num="104"></td><td><pre>     * 每次循环首先接收接下来要接收的数据块的长度。</pre></td></tr><tr><td data-num="105"></td><td><pre>     * 使用带有 MSG_WAITALL 标志的 recv 调用确保接收到完整的长度信息</pre></td></tr><tr><td data-num="106"></td><td><pre>     */</span></pre></td></tr><tr><td data-num="107"></td><td><pre>    recv_fd <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>len<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">,</span> MSG_WAITALL<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="108"></td><td><pre>    <span class="token comment">/**</pre></td></tr><tr><td data-num="109"></td><td><pre>     * 检查接收长度信息是否成功，并处理接收结束条件。</pre></td></tr><tr><td data-num="110"></td><td><pre>     * 如果接收到的长度为 0，表示文件传输结束。</pre></td></tr><tr><td data-num="111"></td><td><pre>     */</span></pre></td></tr><tr><td data-num="112"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>recv_fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="113"></td><td><pre>      <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"recv failed 2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="114"></td><td><pre>      <span class="token function">close</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="115"></td><td><pre>      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="116"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="117"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="118"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="119"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="120"></td><td><pre>    <span class="token comment">/**</pre></td></tr><tr><td data-num="121"></td><td><pre>     * 接收文件数据块并写入文件。</pre></td></tr><tr><td data-num="122"></td><td><pre>     * 根据接收到的长度，接收数据并写入到之前打开的文件中。</pre></td></tr><tr><td data-num="123"></td><td><pre>     * 使用带有 MSG_WAITALL 标志的 recv 调用确保接收到完整的长度信息</pre></td></tr><tr><td data-num="124"></td><td><pre>     */</span></pre></td></tr><tr><td data-num="125"></td><td><pre>    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1000</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="126"></td><td><pre>    <span class="token class-name">ssize_t</span> recv_len <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> len<span class="token punctuation">,</span> MSG_WAITALL<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="127"></td><td><pre>    <span class="token function">write</span><span class="token punctuation">(</span>file_fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> recv_len<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="128"></td><td><pre></pre></td></tr><tr><td data-num="129"></td><td><pre>    cursize <span class="token operator">+=</span> recv_len<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="130"></td><td><pre></pre></td></tr><tr><td data-num="131"></td><td><pre>    <span class="token comment">/**</pre></td></tr><tr><td data-num="132"></td><td><pre>     * 打印接收进度。</pre></td></tr><tr><td data-num="133"></td><td><pre>     * 每接收到一定量的数据，打印接收进度。</pre></td></tr><tr><td data-num="134"></td><td><pre>     */</span></pre></td></tr><tr><td data-num="135"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>cursize <span class="token operator">-</span> last_update_size <span class="token operator">>=</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="136"></td><td><pre>      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"接收进度：%.2f%%\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span>cursize <span class="token operator">/</span> file_size <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="137"></td><td><pre>      last_update_size <span class="token operator">=</span> cursize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="138"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="139"></td><td><pre></pre></td></tr><tr><td data-num="140"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="141"></td><td><pre></pre></td></tr><tr><td data-num="142"></td><td><pre>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"文件已成功接收！\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="143"></td><td><pre></pre></td></tr><tr><td data-num="144"></td><td><pre>  <span class="token comment">/**</pre></td></tr><tr><td data-num="145"></td><td><pre>   * 关闭文件和 socket。</pre></td></tr><tr><td data-num="146"></td><td><pre>   * 完成通信后，关闭文件描述符和 socket 连接。</pre></td></tr><tr><td data-num="147"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="148"></td><td><pre>  <span class="token function">close</span><span class="token punctuation">(</span>file_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="149"></td><td><pre>  <span class="token function">close</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="150"></td><td><pre>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="151"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><ol>
<li><strong>接收文件大小</strong>：在开始接收文件之前，客户端首先接收并打印出文件的总大小，这有助于计算和显示接收进度。</li>
<li><strong>接收文件名称长度和名称</strong>：客户端接收文件名称的长度和名称，以便知道保存文件的名称。</li>
<li><strong>打开或创建文件</strong>：客户端根据接收到的文件名称打开或创建文件，准备写入接收到的数据。</li>
<li><strong>初始化接收进度</strong>：初始化当前接收大小和上次更新的接收大小。</li>
<li><strong>循环接收文件内容</strong>：客户端进入循环，使用  <code>recv</code>  函数接收服务器发送的数据块。</li>
<li><strong>接收数据块长度</strong>：在循环中，客户端首先接收数据块的长度。</li>
<li><strong>接收数据块并写入文件</strong>：客户端根据接收到的长度接收数据块，并将其写入到本地文件中。</li>
<li><strong>更新接收进度</strong>：每次接收到一定量的数据后，客户端更新当前接收大小，并根据当前大小与上次更新大小的差值决定是否打印当前接收进度。</li>
<li><strong>检查接收结束条件</strong>：如果接收到的长度为 0，表示文件传输结束，客户端退出循环。</li>
<li><strong>打印成功消息</strong>：接收完毕后，客户端打印一条消息，通知用户文件接收成功。</li>
<li><strong>关闭资源</strong>：最后，客户端关闭文件描述符和 socket 连接，释放所有资源。</li>
</ol>
<h4 id="send_filec-5"><a class="anchor" href="#send_filec-5">#</a> send_file.c</h4>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="2"></td><td><pre> * @file send_file.c</pre></td></tr><tr><td data-num="3"></td><td><pre> * @brief 文件发送模块。</pre></td></tr><tr><td data-num="4"></td><td><pre> *</pre></td></tr><tr><td data-num="5"></td><td><pre> * 该文件实现了子进程发送文件给客户端的功能。</pre></td></tr><tr><td data-num="6"></td><td><pre> */</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"head.h"</span></span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="11"></td><td><pre> * @brief 结构体用于封装传输的数据和长度。</pre></td></tr><tr><td data-num="12"></td><td><pre> */</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">train_s</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token keyword">int</span> len<span class="token punctuation">;</span>        <span class="token comment">/**&lt; 数据长度 */</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">/**&lt; 数据缓冲区 */</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">&#125;</span> <span class="token class-name">train_t</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="19"></td><td><pre> * @brief 处理 SIGPIPE 信号的函数。</pre></td></tr><tr><td data-num="20"></td><td><pre> * 当发生管道破裂时（例如对方关闭了连接），此函数会被调用。</pre></td></tr><tr><td data-num="21"></td><td><pre> * @param num 信号的编号</pre></td></tr><tr><td data-num="22"></td><td><pre> */</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token keyword">void</span> <span class="token function">fun</span><span class="token punctuation">(</span><span class="token keyword">int</span> num<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"sigpeipe %d\n"</span><span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="26"></td><td><pre> * @brief 发送文件给客户端。</pre></td></tr><tr><td data-num="27"></td><td><pre> *</pre></td></tr><tr><td data-num="28"></td><td><pre> * 该函数负责打开指定的文件，并发送文件内容到客户端。</pre></td></tr><tr><td data-num="29"></td><td><pre> * 首先发送文件名的长度和文件名，然后分块读取并发送文件内容。</pre></td></tr><tr><td data-num="30"></td><td><pre> *</pre></td></tr><tr><td data-num="31"></td><td><pre> * @param net_fd 客户端连接的文件描述符。</pre></td></tr><tr><td data-num="32"></td><td><pre> * @return 成功返回 0，失败返回 -1。</pre></td></tr><tr><td data-num="33"></td><td><pre> */</span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token keyword">int</span> <span class="token function">sendFile</span><span class="token punctuation">(</span><span class="token keyword">int</span> net_fd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>  <span class="token comment">// 设置当发生 SIGPIPE 信号时，调用 fun 函数。</span></pre></td></tr><tr><td data-num="36"></td><td><pre>  <span class="token function">signal</span><span class="token punctuation">(</span>SIGPIPE<span class="token punctuation">,</span> fun<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre></pre></td></tr><tr><td data-num="38"></td><td><pre>  <span class="token comment">// 文件名，这里只是一个示例，实际使用时应根据情况确定文件名</span></pre></td></tr><tr><td data-num="39"></td><td><pre>  <span class="token keyword">char</span> <span class="token operator">*</span>file_name <span class="token operator">=</span> <span class="token string">"斗破苍穹.txt"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre>  <span class="token comment">// 打开文件，准备发送文件内容</span></pre></td></tr><tr><td data-num="42"></td><td><pre>  <span class="token keyword">int</span> file_fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>file_name<span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>file_fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open file error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token comment">// 如果打开文件失败，返回错误</span></pre></td></tr><tr><td data-num="46"></td><td><pre>    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="48"></td><td><pre></pre></td></tr><tr><td data-num="49"></td><td><pre>  <span class="token comment">// 定义传输结构体，用于封装文件名和内容。</span></pre></td></tr><tr><td data-num="50"></td><td><pre>  <span class="token class-name">train_t</span> train<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>  <span class="token comment">// 获取文件信息</span></pre></td></tr><tr><td data-num="52"></td><td><pre>  <span class="token keyword">struct</span> <span class="token class-name">stat</span> stat_file<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>  <span class="token function">fstat</span><span class="token punctuation">(</span>file_fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>stat_file<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>  <span class="token comment">// 发送文件长度</span></pre></td></tr><tr><td data-num="55"></td><td><pre>  <span class="token function">send</span><span class="token punctuation">(</span>net_fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>stat_file<span class="token punctuation">.</span>st_size<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">off_t</span><span class="token punctuation">)</span><span class="token punctuation">,</span> MSG_NOSIGNAL<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre></pre></td></tr><tr><td data-num="57"></td><td><pre>  <span class="token comment">// 初始化传输结构体，设置文件名长度。</span></pre></td></tr><tr><td data-num="58"></td><td><pre>  <span class="token function">bzero</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>train<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>  train<span class="token punctuation">.</span>len <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>file_name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>  <span class="token comment">// 复制文件名到传输结构体的缓冲区。</span></pre></td></tr><tr><td data-num="61"></td><td><pre>  <span class="token function">memcpy</span><span class="token punctuation">(</span>train<span class="token punctuation">.</span>buf<span class="token punctuation">,</span> file_name<span class="token punctuation">,</span> train<span class="token punctuation">.</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre></pre></td></tr><tr><td data-num="63"></td><td><pre>  <span class="token comment">/**</pre></td></tr><tr><td data-num="64"></td><td><pre>   * 发送文件名长度和文件名。</pre></td></tr><tr><td data-num="65"></td><td><pre>   * 将文件名和长度一同发送给客户端，以便客户端申请足够的接收缓冲区。</pre></td></tr><tr><td data-num="66"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="67"></td><td><pre>  <span class="token function">send</span><span class="token punctuation">(</span>net_fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>train<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token operator">+</span> train<span class="token punctuation">.</span>len<span class="token punctuation">,</span> MSG_NOSIGNAL<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre></pre></td></tr><tr><td data-num="69"></td><td><pre>  <span class="token comment">/**</pre></td></tr><tr><td data-num="70"></td><td><pre>   * 循环读取文件内容并发送。</pre></td></tr><tr><td data-num="71"></td><td><pre>   * 直到读取完文件的所有内容。</pre></td></tr><tr><td data-num="72"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="73"></td><td><pre>  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>    <span class="token function">bzero</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>train<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>train<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="75"></td><td><pre></pre></td></tr><tr><td data-num="76"></td><td><pre>    <span class="token keyword">int</span> read_res <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>file_fd<span class="token punctuation">,</span> train<span class="token punctuation">.</span>buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>train<span class="token punctuation">.</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>    train<span class="token punctuation">.</span>len <span class="token operator">=</span> read_res<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="78"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>read_res <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="80"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>    <span class="token comment">/**</pre></td></tr><tr><td data-num="82"></td><td><pre>     * 发送文件内容长度和内容。</pre></td></tr><tr><td data-num="83"></td><td><pre>     * 发送前先发送长度，然后发送内容，使用 MSG_NOSIGNAL 标志防止 SIGPIPE。</pre></td></tr><tr><td data-num="84"></td><td><pre>     */</span></pre></td></tr><tr><td data-num="85"></td><td><pre>    <span class="token keyword">int</span> net_res <span class="token operator">=</span></pre></td></tr><tr><td data-num="86"></td><td><pre>        <span class="token function">send</span><span class="token punctuation">(</span>net_fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>train<span class="token punctuation">,</span> train<span class="token punctuation">.</span>len <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>train<span class="token punctuation">.</span>len<span class="token punctuation">)</span><span class="token punctuation">,</span> MSG_NOSIGNAL<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="87"></td><td><pre></pre></td></tr><tr><td data-num="88"></td><td><pre>    <span class="token comment">// 检查读取操作是否成功完成</span></pre></td></tr><tr><td data-num="89"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>net_res <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="90"></td><td><pre>      <span class="token comment">// 如果读取失败，返回错误</span></pre></td></tr><tr><td data-num="91"></td><td><pre>      <span class="token function">close</span><span class="token punctuation">(</span>file_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="92"></td><td><pre>      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="93"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="94"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="95"></td><td><pre>  <span class="token comment">// 关闭文件描述符</span></pre></td></tr><tr><td data-num="96"></td><td><pre>  <span class="token function">close</span><span class="token punctuation">(</span>file_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="97"></td><td><pre>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="98"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="零拷贝"><a class="anchor" href="#零拷贝">#</a> 零拷贝</h3>
<p>在传统的文件传输过程中，服务端首先需要从磁盘读取文件数据到内核缓冲区，然后将数据从内核缓冲区拷贝到用户空间的应用程序缓冲区，最后再次将数据从用户空间拷贝到内核空间的套接字缓冲区，以便发送。这个过程中的两次数据拷贝可能导致效率低下。</p>
<p>零拷贝技术旨在减少或消除这种不必要的数据拷贝。通过直接在内核空间操作数据，零拷贝避免了数据在用户空间和内核空间之间的来回拷贝，从而提高了数据传输的效率。</p>
<p><code>mmap</code>  函数创建了文件内容的内存映射，它允许程序像访问普通内存一样访问文件内容。虽然  <code>mmap</code>  本身并不直接实现零拷贝，但它可以作为实现零拷贝技术的一部分。当使用  <code>mmap</code>  映射文件后，数据传输可以通过直接操作内存映射来完成，避免了从内核到用户空间的第一次数据拷贝。</p>
<h4 id="mmap-映射文件到进程的地址空间"><a class="anchor" href="#mmap-映射文件到进程的地址空间">#</a>  <code>mmap</code>  映射文件到进程的地址空间</h4>
<p><code>mmap</code>  函数是一种在 POSIX 兼容的操作系统中使用的内存映射方法，它允许程序员将一个文件或者其他对象映射到进程的地址空间中。这样，文件内容就可以像访问内存一样被访问，这通常用于提高文件访问的效率。</p>
<p>函数原型如下：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/mman.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">mmap</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>addr<span class="token punctuation">,</span> <span class="token class-name">size_t</span> length<span class="token punctuation">,</span> <span class="token keyword">int</span> prot<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token class-name">off_t</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>参数说明：</p>
<ol>
<li><strong>void *addr</strong>: 期望的映射区域的起始地址。如果为  <code>NULL</code> ，则由系统选择映射区域的地址。</li>
<li><strong>size_t length</strong>: 映射区域的长度，必须是非负整数，并且通常是页面大小的整数倍。</li>
<li><strong>int prot</strong>: 期望的内存保护选项，可以是以下选项的组合：
<ul>
<li><code>PROT_EXEC</code> : 允许执行内存内容。</li>
<li><code>PROT_READ</code> : 允许读取内存内容。</li>
<li><code>PROT_WRITE</code> : 允许写入内存内容。</li>
<li><code>PROT_NONE</code> : 不允许访问内存。</li>
</ul>
</li>
<li><strong>int flags</strong>: 控制映射区域的选项，常用的标志包括：
<ul>
<li><code>MAP_SHARED</code> : 映射区域的修改会反映到文件上，多个映射可以共享数据。</li>
<li><code>MAP_PRIVATE</code> : 映射区域是私有的，对它的修改不会反映到文件上。</li>
<li><code>MAP_ANONYMOUS</code> : 匿名映射，不与任何文件关联。</li>
<li><code>MAP_FIXED</code> : 强制将映射放在  <code>addr</code>  指定的位置。</li>
</ul>
</li>
<li><strong>int fd</strong>: 被映射文件的文件描述符。如果是匿名映射，这个值通常是  <code>-1</code> 。</li>
<li><strong>off_t offset</strong>: 文件映射的起始位置偏移量，通常应该是文件系统页大小的整数倍。</li>
</ol>
<p>返回值：</p>
<ul>
<li>如果调用成功， <code>mmap</code>  返回指向映射区域的指针。</li>
<li>如果调用失败，返回  <code>MAP_FAILED</code> （通常是  <code>(void *)-1</code> ），并设置全局变量  <code>errno</code>  以指示错误类型。</li>
</ul>
<p>使用场景：</p>
<ul>
<li>当需要高效地访问大型文件时。</li>
<li>当需要创建或修改一块可以被多个进程共享的内存区域时。</li>
</ul>
<p>工作机制：</p>
<ul>
<li><code>mmap</code>  将文件内容映射到进程的地址空间，使得文件可以像访问内存一样被访问。</li>
<li>对映射区域的修改可能会影响到文件本身，这取决于  <code>flags</code>  参数。</li>
</ul>
<h4 id="clientc-7"><a class="anchor" href="#clientc-7">#</a> client.c</h4>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="2"></td><td><pre> * @file client.c</pre></td></tr><tr><td data-num="3"></td><td><pre> * @brief 客户端程序。</pre></td></tr><tr><td data-num="4"></td><td><pre> *</pre></td></tr><tr><td data-num="5"></td><td><pre> * 该文件实现了客户端的主要功能，包括连接到服务器、接收服务器发送的文件名称和内容，</pre></td></tr><tr><td data-num="6"></td><td><pre> * 并将接收到的内容保存到本地文件中。</pre></td></tr><tr><td data-num="7"></td><td><pre> */</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdc.h></span></span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token comment">// 定义服务器的端口和 IP 地址</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token keyword">char</span> <span class="token operator">*</span>port <span class="token operator">=</span> <span class="token string">"8080"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token keyword">char</span> <span class="token operator">*</span>ip <span class="token operator">=</span> <span class="token string">"172.16.0.3"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token comment">/**</pre></td></tr><tr><td data-num="17"></td><td><pre>   * 创建 socket。</pre></td></tr><tr><td data-num="18"></td><td><pre>   * 创建一个用于通信的 socket，用于连接到服务器。</pre></td></tr><tr><td data-num="19"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token keyword">int</span> socket_fd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>socket_fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token comment">// 错误处理，例如打印错误信息并退出程序</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"socket creation failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>  <span class="token comment">/**</pre></td></tr><tr><td data-num="28"></td><td><pre>   * 设置服务器地址结构。</pre></td></tr><tr><td data-num="29"></td><td><pre>   * 初始化 sockaddr_in 结构，设置服务器的地址族、端口和 IP 地址。</pre></td></tr><tr><td data-num="30"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="31"></td><td><pre>  <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> addr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>  addr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>  addr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token function">atoi</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 端口号转换为网络字节序</span></pre></td></tr><tr><td data-num="34"></td><td><pre>  addr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">inet_addr</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// IP 地址转换为网络字节序</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre>  <span class="token comment">/**</pre></td></tr><tr><td data-num="37"></td><td><pre>   * 连接到服务器。</pre></td></tr><tr><td data-num="38"></td><td><pre>   * 使用 connect 系统调用建立到服务器的连接。</pre></td></tr><tr><td data-num="39"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="40"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">connect</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>addr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token comment">// 错误处理，例如关闭 socket_fd 并退出程序</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"connect failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token function">close</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>  <span class="token comment">// 接收文件大小</span></pre></td></tr><tr><td data-num="47"></td><td><pre>  <span class="token comment">// 在接收文件之前，先接收文件的总大小，用于后续显示接收进度</span></pre></td></tr><tr><td data-num="48"></td><td><pre>  <span class="token class-name">off_t</span> file_size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>  <span class="token function">recv</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>file_size<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">off_t</span><span class="token punctuation">)</span><span class="token punctuation">,</span> MSG_WAITALL<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"文件大小为：%ld\n"</span><span class="token punctuation">,</span> file_size<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre></pre></td></tr><tr><td data-num="52"></td><td><pre>  <span class="token comment">/**</pre></td></tr><tr><td data-num="53"></td><td><pre>   * 接收服务器发送的文件名称长度。</pre></td></tr><tr><td data-num="54"></td><td><pre>   * 首先接收一个表示文件名长度的整数，以便分配合适的缓冲区。</pre></td></tr><tr><td data-num="55"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="56"></td><td><pre>  <span class="token keyword">int</span> file_name_len<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>  <span class="token keyword">int</span> recv_fd <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>file_name_len<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre></pre></td></tr><tr><td data-num="59"></td><td><pre>  <span class="token comment">/**</pre></td></tr><tr><td data-num="60"></td><td><pre>   * 检查接收文件名称长度是否成功。</pre></td></tr><tr><td data-num="61"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="62"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>recv_fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>    <span class="token comment">// 错误处理</span></pre></td></tr><tr><td data-num="64"></td><td><pre>    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"recv failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>    <span class="token function">close</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>  <span class="token comment">/**</pre></td></tr><tr><td data-num="69"></td><td><pre>   * 接收服务器发送的文件名称。</pre></td></tr><tr><td data-num="70"></td><td><pre>   * 接收到文件名称长度后，根据该长度接收实际的文件名。</pre></td></tr><tr><td data-num="71"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="72"></td><td><pre>  <span class="token keyword">char</span> buf_name<span class="token punctuation">[</span><span class="token number">60</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>  recv_fd <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">,</span> buf_name<span class="token punctuation">,</span> file_name_len<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre></pre></td></tr><tr><td data-num="75"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>recv_fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>    <span class="token comment">// 错误处理</span></pre></td></tr><tr><td data-num="77"></td><td><pre>    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"recv failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="78"></td><td><pre>    <span class="token function">close</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="80"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="81"></td><td><pre></pre></td></tr><tr><td data-num="82"></td><td><pre>  <span class="token comment">/**</pre></td></tr><tr><td data-num="83"></td><td><pre>   * 打开或创建用于保存文件内容的本地文件。</pre></td></tr><tr><td data-num="84"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="85"></td><td><pre>  <span class="token keyword">int</span> file_fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>buf_name<span class="token punctuation">,</span> O_RDWR <span class="token operator">|</span> O_CREAT<span class="token punctuation">,</span> <span class="token number">0666</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="86"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>file_fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="87"></td><td><pre>    <span class="token comment">// 错误处理</span></pre></td></tr><tr><td data-num="88"></td><td><pre>    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open file failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="89"></td><td><pre>    <span class="token function">close</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="90"></td><td><pre>    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="91"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="92"></td><td><pre></pre></td></tr><tr><td data-num="93"></td><td><pre>  <span class="token comment">// 预分配文件空间</span></pre></td></tr><tr><td data-num="94"></td><td><pre>  <span class="token function">ftruncate</span><span class="token punctuation">(</span>file_fd<span class="token punctuation">,</span> file_size<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="95"></td><td><pre></pre></td></tr><tr><td data-num="96"></td><td><pre>  <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="97"></td><td><pre>  <span class="token comment">// 创建内存映射，允许整个文件一次性读入内存，提高传输效率。</span></pre></td></tr><tr><td data-num="98"></td><td><pre>  <span class="token keyword">char</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">mmap</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> file_size<span class="token punctuation">,</span> PROT_READ <span class="token operator">|</span> PROT_WRITE<span class="token punctuation">,</span> MAP_SHARED<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="99"></td><td><pre>                         file_fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="100"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> MAP_FAILED<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="101"></td><td><pre>    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"mmap failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="102"></td><td><pre>    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="103"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="104"></td><td><pre>  <span class="token comment">// 接收文件内容到内存映射区域</span></pre></td></tr><tr><td data-num="105"></td><td><pre>  <span class="token comment">// 一次性接收整个文件的内容到通过 mmap 创建的内存映射区域</span></pre></td></tr><tr><td data-num="106"></td><td><pre>  <span class="token function">recv</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">,</span> p<span class="token punctuation">,</span> file_size<span class="token punctuation">,</span> MSG_WAITALL<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="107"></td><td><pre></pre></td></tr><tr><td data-num="108"></td><td><pre>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"文件已成功接收！\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="109"></td><td><pre>  <span class="token comment">// 使用 munmap 释放之前创建的内存映射区域</span></pre></td></tr><tr><td data-num="110"></td><td><pre>  <span class="token function">munmap</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> file_size<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="111"></td><td><pre></pre></td></tr><tr><td data-num="112"></td><td><pre>  <span class="token comment">/**</pre></td></tr><tr><td data-num="113"></td><td><pre>   * 关闭文件和 socket。</pre></td></tr><tr><td data-num="114"></td><td><pre>   * 完成通信后，关闭文件描述符和 socket 连接。</pre></td></tr><tr><td data-num="115"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="116"></td><td><pre>  <span class="token function">close</span><span class="token punctuation">(</span>file_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="117"></td><td><pre>  <span class="token function">close</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="118"></td><td><pre>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="119"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><ol>
<li><strong>接收文件大小</strong>：客户端首先接收服务器发送的文件大小，这用于后续操作中的进度显示和文件空间预分配。</li>
<li><strong>接收文件名称</strong>：客户端接收服务器发送的文件名称。</li>
<li><strong>打开或创建文件</strong>：客户端根据接收到的文件名称打开或创建文件。</li>
<li><strong>预分配文件空间</strong>：使用  <code>ftruncate</code>  系统调用预分配文件大小，为使用  <code>mmap</code>  映射整个文件做准备。</li>
<li><strong>使用 mmap 映射文件</strong>：客户端创建内存映射，将文件一次性读入内存，这可以提高大文件传输的效率。</li>
<li><strong>接收文件内容</strong>：客户端通过 socket 接收文件内容，直接写入到内存映射区域。</li>
<li><strong>打印接收成功消息</strong>：文件内容接收完成后，客户端打印成功消息。</li>
<li><strong>内存映射释放</strong>：客户端使用  <code>munmap</code>  函数释放之前创建的内存映射区域。</li>
<li><strong>关闭资源</strong>：客户端关闭文件描述符和 socket 连接，释放所有资源。</li>
</ol>
<h4 id="send_filec-6"><a class="anchor" href="#send_filec-6">#</a> send_file.c</h4>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="2"></td><td><pre> * @file send_file.c</pre></td></tr><tr><td data-num="3"></td><td><pre> * @brief 文件发送模块。</pre></td></tr><tr><td data-num="4"></td><td><pre> *</pre></td></tr><tr><td data-num="5"></td><td><pre> * 该文件实现了子进程发送文件给客户端的功能。</pre></td></tr><tr><td data-num="6"></td><td><pre> */</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"head.h"</span></span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="11"></td><td><pre> * @brief 结构体用于封装传输的数据和长度。</pre></td></tr><tr><td data-num="12"></td><td><pre> */</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">train_s</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token keyword">int</span> len<span class="token punctuation">;</span>        <span class="token comment">/**&lt; 数据长度 */</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">/**&lt; 数据缓冲区 */</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">&#125;</span> <span class="token class-name">train_t</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="19"></td><td><pre> * @brief 处理 SIGPIPE 信号的函数。</pre></td></tr><tr><td data-num="20"></td><td><pre> * 当发生管道破裂时（例如对方关闭了连接），此函数会被调用。</pre></td></tr><tr><td data-num="21"></td><td><pre> * @param num 信号的编号</pre></td></tr><tr><td data-num="22"></td><td><pre> */</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token keyword">void</span> <span class="token function">fun</span><span class="token punctuation">(</span><span class="token keyword">int</span> num<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"sigpeipe %d\n"</span><span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="26"></td><td><pre> * @brief 发送文件给客户端。</pre></td></tr><tr><td data-num="27"></td><td><pre> *</pre></td></tr><tr><td data-num="28"></td><td><pre> * 该函数负责打开指定的文件，并发送文件内容到客户端。</pre></td></tr><tr><td data-num="29"></td><td><pre> * 首先发送文件名的长度和文件名，然后分块读取并发送文件内容。</pre></td></tr><tr><td data-num="30"></td><td><pre> *</pre></td></tr><tr><td data-num="31"></td><td><pre> * @param net_fd 客户端连接的文件描述符。</pre></td></tr><tr><td data-num="32"></td><td><pre> * @return 成功返回 0，失败返回 -1。</pre></td></tr><tr><td data-num="33"></td><td><pre> */</span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token keyword">int</span> <span class="token function">sendFile</span><span class="token punctuation">(</span><span class="token keyword">int</span> net_fd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>  <span class="token comment">// 设置当发生 SIGPIPE 信号时，调用 fun 函数。</span></pre></td></tr><tr><td data-num="36"></td><td><pre>  <span class="token function">signal</span><span class="token punctuation">(</span>SIGPIPE<span class="token punctuation">,</span> fun<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre></pre></td></tr><tr><td data-num="38"></td><td><pre>  <span class="token comment">// 文件名，这里只是一个示例，实际使用时应根据情况确定文件名</span></pre></td></tr><tr><td data-num="39"></td><td><pre>  <span class="token keyword">char</span> <span class="token operator">*</span>file_name <span class="token operator">=</span> <span class="token string">"斗破苍穹.txt"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre>  <span class="token comment">// 打开文件，准备发送文件内容</span></pre></td></tr><tr><td data-num="42"></td><td><pre>  <span class="token keyword">int</span> file_fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>file_name<span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>file_fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open file error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token comment">// 如果打开文件失败，返回错误</span></pre></td></tr><tr><td data-num="46"></td><td><pre>    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="48"></td><td><pre></pre></td></tr><tr><td data-num="49"></td><td><pre>  <span class="token comment">// 定义传输结构体，用于封装文件名和内容。</span></pre></td></tr><tr><td data-num="50"></td><td><pre>  <span class="token class-name">train_t</span> train<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>  <span class="token comment">// 获取文件信息</span></pre></td></tr><tr><td data-num="52"></td><td><pre>  <span class="token keyword">struct</span> <span class="token class-name">stat</span> stat_file<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>  <span class="token function">fstat</span><span class="token punctuation">(</span>file_fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>stat_file<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>  <span class="token comment">// 发送文件长度</span></pre></td></tr><tr><td data-num="55"></td><td><pre>  <span class="token function">send</span><span class="token punctuation">(</span>net_fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>stat_file<span class="token punctuation">.</span>st_size<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">off_t</span><span class="token punctuation">)</span><span class="token punctuation">,</span> MSG_NOSIGNAL<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre></pre></td></tr><tr><td data-num="57"></td><td><pre>  <span class="token comment">// 初始化传输结构体，设置文件名长度。</span></pre></td></tr><tr><td data-num="58"></td><td><pre>  <span class="token function">bzero</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>train<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>  train<span class="token punctuation">.</span>len <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>file_name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>  <span class="token comment">// 复制文件名到传输结构体的缓冲区。</span></pre></td></tr><tr><td data-num="61"></td><td><pre>  <span class="token function">memcpy</span><span class="token punctuation">(</span>train<span class="token punctuation">.</span>buf<span class="token punctuation">,</span> file_name<span class="token punctuation">,</span> train<span class="token punctuation">.</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre></pre></td></tr><tr><td data-num="63"></td><td><pre>  <span class="token comment">// 发送文件名长度和文件名</span></pre></td></tr><tr><td data-num="64"></td><td><pre>  <span class="token function">send</span><span class="token punctuation">(</span>net_fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>train<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token operator">+</span> train<span class="token punctuation">.</span>len<span class="token punctuation">,</span> MSG_NOSIGNAL<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>  <span class="token comment">// 使用内存映射发送文件内容</span></pre></td></tr><tr><td data-num="66"></td><td><pre>  <span class="token keyword">char</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">mmap</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> stat_file<span class="token punctuation">.</span>st_size<span class="token punctuation">,</span> PROT_READ <span class="token operator">|</span> PROT_WRITE<span class="token punctuation">,</span> MAP_SHARED<span class="token punctuation">,</span> file_fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> MAP_FAILED<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="68"></td><td><pre>  <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"mmap error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>  <span class="token function">send</span><span class="token punctuation">(</span>net_fd<span class="token punctuation">,</span> p<span class="token punctuation">,</span> stat_file<span class="token punctuation">.</span>st_size<span class="token punctuation">,</span> MSG_NOSIGNAL<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="73"></td><td><pre></pre></td></tr><tr><td data-num="74"></td><td><pre>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"传输完成！\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="75"></td><td><pre></pre></td></tr><tr><td data-num="76"></td><td><pre>  <span class="token function">munmap</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> stat_file<span class="token punctuation">.</span>st_size<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>  <span class="token comment">// 关闭文件描述符</span></pre></td></tr><tr><td data-num="78"></td><td><pre>  <span class="token function">close</span><span class="token punctuation">(</span>file_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="80"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><ol>
<li><strong>设置 SIGPIPE 信号处理器</strong>：使用  <code>signal</code>  函数设置当 SIGPIPE 信号发生时调用  <code>fun</code>  函数，以处理客户端突然断开连接的情况。</li>
<li><strong>打开文件</strong>：打开要发送的文件，如果文件打开失败，打印错误信息并返回错误代码。</li>
<li><strong>获取文件信息</strong>：使用  <code>fstat</code>  函数获取文件的大小和其他信息。</li>
<li><strong>发送文件大小</strong>：将文件的大小发送给客户端，以便客户端可以预先知道文件的大小。</li>
<li><strong>发送文件名</strong>：发送文件名的长度和文件名本身给客户端。</li>
<li><strong>内存映射文件</strong>：使用  <code>mmap</code>  将文件内容映射到内存中，这样可以高效地发送大文件。</li>
<li><strong>发送文件内容</strong>：通过内存映射，一次性发送整个文件的内容给客户端。</li>
<li><strong>打印传输完成信息</strong>：文件发送完成后，打印传输完成的信息。</li>
<li><strong>清理资源</strong>：使用  <code>munmap</code>  解除内存映射，并关闭文件描述符，释放所有资源。</li>
<li><strong>返回结果</strong>：如果所有操作成功完成，函数返回  <code>0</code> 。</li>
</ol>
<h4 id="sendfile"><a class="anchor" href="#sendfile">#</a> sendfile</h4>
<p><code>sendfile</code>  函数允许数据直接在内核空间内进行传输，这意味着数据可以从文件系统的缓冲区直接发送到网络接口，而无需先拷贝到应用程序的用户空间缓冲区，再由用户空间拷贝到内核的套接字缓冲区。这种机制减少了数据拷贝的次数，从而提高了文件传输的效率。`</p>
<p>使用  <code>sendfile</code>  时，数据的传输路径是：磁盘文件 -&gt; 内核文件缓冲区 -&gt; 网卡。这个过程中，数据避免了进入用户空间，减少了上下文切换和数据拷贝的开销。</p>
<p>虽然  <code>mmap</code>  可以减少从磁盘到用户空间的数据拷贝，但在使用  <code>sendfile</code>  的情况下，可以进一步减少从用户空间到内核空间的套接字缓冲区的数据拷贝。 <code>sendfile</code>  直接在内核中处理数据传输，避免了额外的数据拷贝步骤。</p>
<h4 id="send_filec-7"><a class="anchor" href="#send_filec-7">#</a> send_file.c</h4>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="2"></td><td><pre> * @file send_file.c</pre></td></tr><tr><td data-num="3"></td><td><pre> * @brief 文件发送模块。</pre></td></tr><tr><td data-num="4"></td><td><pre> *</pre></td></tr><tr><td data-num="5"></td><td><pre> * 该文件实现了子进程发送文件给客户端的功能。</pre></td></tr><tr><td data-num="6"></td><td><pre> */</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"head.h"</span></span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="11"></td><td><pre> * @brief 结构体用于封装传输的数据和长度。</pre></td></tr><tr><td data-num="12"></td><td><pre> */</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">train_s</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token keyword">int</span> len<span class="token punctuation">;</span>        <span class="token comment">/**&lt; 数据长度 */</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">/**&lt; 数据缓冲区 */</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">&#125;</span> <span class="token class-name">train_t</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="19"></td><td><pre> * @brief 处理 SIGPIPE 信号的函数。</pre></td></tr><tr><td data-num="20"></td><td><pre> * 当发生管道破裂时（例如对方关闭了连接），此函数会被调用。</pre></td></tr><tr><td data-num="21"></td><td><pre> * @param num 信号的编号</pre></td></tr><tr><td data-num="22"></td><td><pre> */</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token keyword">void</span> <span class="token function">fun</span><span class="token punctuation">(</span><span class="token keyword">int</span> num<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"sigpeipe %d\n"</span><span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="26"></td><td><pre> * @brief 发送文件给客户端。</pre></td></tr><tr><td data-num="27"></td><td><pre> *</pre></td></tr><tr><td data-num="28"></td><td><pre> * 该函数负责打开指定的文件，并发送文件内容到客户端。</pre></td></tr><tr><td data-num="29"></td><td><pre> * 首先发送文件名的长度和文件名，然后分块读取并发送文件内容。</pre></td></tr><tr><td data-num="30"></td><td><pre> *</pre></td></tr><tr><td data-num="31"></td><td><pre> * @param net_fd 客户端连接的文件描述符。</pre></td></tr><tr><td data-num="32"></td><td><pre> * @return 成功返回 0，失败返回 -1。</pre></td></tr><tr><td data-num="33"></td><td><pre> */</span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token keyword">int</span> <span class="token function">sendFile</span><span class="token punctuation">(</span><span class="token keyword">int</span> net_fd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>  <span class="token comment">// 设置当发生 SIGPIPE 信号时，调用 fun 函数。</span></pre></td></tr><tr><td data-num="36"></td><td><pre>  <span class="token function">signal</span><span class="token punctuation">(</span>SIGPIPE<span class="token punctuation">,</span> fun<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre></pre></td></tr><tr><td data-num="38"></td><td><pre>  <span class="token comment">// 文件名，这里只是一个示例，实际使用时应根据情况确定文件名</span></pre></td></tr><tr><td data-num="39"></td><td><pre>  <span class="token keyword">char</span> <span class="token operator">*</span>file_name <span class="token operator">=</span> <span class="token string">"file.txt"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre>  <span class="token comment">// 打开文件，准备发送文件内容</span></pre></td></tr><tr><td data-num="42"></td><td><pre>  <span class="token keyword">int</span> file_fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>file_name<span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>file_fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open file error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token comment">// 如果打开文件失败，返回错误</span></pre></td></tr><tr><td data-num="46"></td><td><pre>    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="48"></td><td><pre></pre></td></tr><tr><td data-num="49"></td><td><pre>  <span class="token comment">// 定义传输结构体，用于封装文件名和内容。</span></pre></td></tr><tr><td data-num="50"></td><td><pre>  <span class="token class-name">train_t</span> train<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>  <span class="token function">bzero</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>train<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>  <span class="token comment">// 获取文件信息</span></pre></td></tr><tr><td data-num="53"></td><td><pre>  <span class="token keyword">struct</span> <span class="token class-name">stat</span> stat_file<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>  <span class="token function">fstat</span><span class="token punctuation">(</span>file_fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>stat_file<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>  <span class="token comment">// 发送文件长度</span></pre></td></tr><tr><td data-num="56"></td><td><pre>  <span class="token function">send</span><span class="token punctuation">(</span>net_fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>stat_file<span class="token punctuation">.</span>st_size<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">off_t</span><span class="token punctuation">)</span><span class="token punctuation">,</span> MSG_NOSIGNAL<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre></pre></td></tr><tr><td data-num="58"></td><td><pre>  <span class="token comment">// 初始化传输结构体，设置文件名长度。</span></pre></td></tr><tr><td data-num="59"></td><td><pre>  <span class="token function">bzero</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>train<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>  train<span class="token punctuation">.</span>len <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>file_name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>  <span class="token comment">// 复制文件名到传输结构体的缓冲区。</span></pre></td></tr><tr><td data-num="62"></td><td><pre>  <span class="token function">memcpy</span><span class="token punctuation">(</span>train<span class="token punctuation">.</span>buf<span class="token punctuation">,</span> file_name<span class="token punctuation">,</span> train<span class="token punctuation">.</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="63"></td><td><pre></pre></td></tr><tr><td data-num="64"></td><td><pre>  <span class="token comment">// 发送文件名长度和文件名</span></pre></td></tr><tr><td data-num="65"></td><td><pre>  <span class="token function">send</span><span class="token punctuation">(</span>net_fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>train<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token operator">+</span> train<span class="token punctuation">.</span>len<span class="token punctuation">,</span> MSG_NOSIGNAL<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="66"></td><td><pre></pre></td></tr><tr><td data-num="67"></td><td><pre>  <span class="token function">sendfile</span><span class="token punctuation">(</span>net_fd<span class="token punctuation">,</span> file_fd<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> stat_file<span class="token punctuation">.</span>st_size<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre></pre></td></tr><tr><td data-num="69"></td><td><pre>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"传输完成！\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre></pre></td></tr><tr><td data-num="71"></td><td><pre>  <span class="token comment">// 关闭文件描述符</span></pre></td></tr><tr><td data-num="72"></td><td><pre>  <span class="token function">close</span><span class="token punctuation">(</span>file_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="第三版"><a class="anchor" href="#第三版">#</a> 第三版</h2>
<p>在多进程程序中，确保主进程退出时子进程也能随之退出是一个重要的编程实践，这有助于防止孤儿进程的产生并确保资源得到适当的清理。为了实现这一目标，可以通过监听信号并相应地处理这些信号来控制子进程的行为。</p>
<p>首主进程可以设置一个信号处理函数来监听特定的信号，如  <code>SIGTERM</code>  或  <code>SIGINT</code> 。当这些信号被触发时，例如用户按下 Ctrl+C 或向主进程发送终止信号，信号处理函数将被调用。在这个函数中，主进程可以向所有子进程发送退出的信号或消息，指示它们进行清理并退出。这可以通过发送特定的系统调用，如  <code>kill</code> ，或者使用进程间通信机制，如管道、共享内存或消息队列来实现。</p>
<p>一旦子进程接收到退出信号或消息，它们应该执行必要的清理工作，如关闭打开的文件描述符、释放分配的内存和注销注册的信号处理函数。完成这些清理工作后，子进程通过调用  <code>exit</code>  函数来终止自身。</p>
<p>在子进程开始退出流程后，主进程需要等待它们的退出。这可以通过使用  <code>wait</code>  或  <code>waitpid</code>  系统调用来实现，这些调用将阻塞主进程，直到所有子进程都已经退出。在子进程全部退出后，主进程可以继续执行任何剩余的清理工作，如关闭它自己的文件描述符和注销信号处理函数，然后退出。</p>
<h3 id="mainc-2"><a class="anchor" href="#mainc-2">#</a> main.c</h3>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="2"></td><td><pre> * @file main.c</pre></td></tr><tr><td data-num="3"></td><td><pre> * @brief 主程序文件，包含程序的入口点和主逻辑。</pre></td></tr><tr><td data-num="4"></td><td><pre> *</pre></td></tr><tr><td data-num="5"></td><td><pre> * 此文件定义了程序的主要入口点 main 函数，负责初始化进程池、网络连接，</pre></td></tr><tr><td data-num="6"></td><td><pre> * epoll 事件循环，并处理客户端请求。</pre></td></tr><tr><td data-num="7"></td><td><pre> */</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"head.h"</span></span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="12"></td><td><pre> * 初始化信号处理和管道。</pre></td></tr><tr><td data-num="13"></td><td><pre> * 创建一个管道用于信号处理，当接收到特定信号时，向管道写入数据。</pre></td></tr><tr><td data-num="14"></td><td><pre> */</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token keyword">int</span> pipe_fd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token keyword">void</span> <span class="token function">fun</span><span class="token punctuation">(</span><span class="token keyword">int</span> num<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token function">write</span><span class="token punctuation">(</span>pipe_fd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>  son_status_s list<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">/**&lt; 定义一个进程池数组，存储子进程的状态信息 */</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>  <span class="token comment">/**</pre></td></tr><tr><td data-num="22"></td><td><pre>   * 初始化进程池。</pre></td></tr><tr><td data-num="23"></td><td><pre>   * 创建一定数量的子进程，并将它们的状态设置为 FREE（空闲）。</pre></td></tr><tr><td data-num="24"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="25"></td><td><pre>  <span class="token function">initPool</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>  <span class="token comment">/**</pre></td></tr><tr><td data-num="27"></td><td><pre>   * 创建管道并设置信号处理函数。</pre></td></tr><tr><td data-num="28"></td><td><pre>   * 当接收到 SIGINT (信号 2) 时，向管道写入一个字符。</pre></td></tr><tr><td data-num="29"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="30"></td><td><pre>  <span class="token function">pipe</span><span class="token punctuation">(</span>pipe_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>  <span class="token function">signal</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> fun<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre>  <span class="token comment">/**</pre></td></tr><tr><td data-num="34"></td><td><pre>   * 初始化网络 socket。</pre></td></tr><tr><td data-num="35"></td><td><pre>   * 创建并配置 socket，使其能够监听指定 IP 地址和端口上的连接请求。</pre></td></tr><tr><td data-num="36"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="37"></td><td><pre>  <span class="token keyword">int</span> socket_fd<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>  <span class="token function">initSocket</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>socket_fd<span class="token punctuation">,</span> <span class="token string">"8080"</span><span class="token punctuation">,</span> <span class="token string">"172.16.0.3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre></pre></td></tr><tr><td data-num="40"></td><td><pre>  <span class="token comment">/**</pre></td></tr><tr><td data-num="41"></td><td><pre>   * 创建 epoll 实例，并设置为非阻塞模式。</pre></td></tr><tr><td data-num="42"></td><td><pre>   * epoll 用于高效地处理大量并发连接。</pre></td></tr><tr><td data-num="43"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="44"></td><td><pre>  <span class="token keyword">int</span> epoll_fd <span class="token operator">=</span> <span class="token function">epoll_create</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre></pre></td></tr><tr><td data-num="46"></td><td><pre>  <span class="token comment">/**</pre></td></tr><tr><td data-num="47"></td><td><pre>   * 将监听 socket 添加到 epoll 实例中。</pre></td></tr><tr><td data-num="48"></td><td><pre>   * 这样，当有新的连接请求时，epoll 可以通知主进程。</pre></td></tr><tr><td data-num="49"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="50"></td><td><pre>  <span class="token function">addEpoll</span><span class="token punctuation">(</span>epoll_fd<span class="token punctuation">,</span> socket_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre></pre></td></tr><tr><td data-num="52"></td><td><pre>  <span class="token comment">/**</pre></td></tr><tr><td data-num="53"></td><td><pre>   * 将进程池中每个子进程的本地 socket 添加到 epoll 实例中。</pre></td></tr><tr><td data-num="54"></td><td><pre>   * 这样，主进程可以接收来自子进程的通知，例如任务完成。</pre></td></tr><tr><td data-num="55"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="56"></td><td><pre>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>    <span class="token function">addEpoll</span><span class="token punctuation">(</span>epoll_fd<span class="token punctuation">,</span> list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>local_socket<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>  <span class="token comment">/**</pre></td></tr><tr><td data-num="60"></td><td><pre>   * 将管道读端添加到 epoll 监听中。</pre></td></tr><tr><td data-num="61"></td><td><pre>   * 这样，当信号处理函数向管道写入数据时，epoll 可以捕捉到事件。</pre></td></tr><tr><td data-num="62"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="63"></td><td><pre>  <span class="token function">addEpoll</span><span class="token punctuation">(</span>epoll_fd<span class="token punctuation">,</span> pipe_fd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="64"></td><td><pre></pre></td></tr><tr><td data-num="65"></td><td><pre>  <span class="token comment">/**</pre></td></tr><tr><td data-num="66"></td><td><pre>   * 主事件循环。</pre></td></tr><tr><td data-num="67"></td><td><pre>   * 使用 epoll_wait 等待并处理 I/O 事件。</pre></td></tr><tr><td data-num="68"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="69"></td><td><pre>  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>    <span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> events<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">/**&lt; 定义一个事件数组，存储 epoll 事件 */</span></pre></td></tr><tr><td data-num="71"></td><td><pre>    <span class="token function">memset</span><span class="token punctuation">(</span>events<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>events<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/**&lt; 清零事件数组 */</span></pre></td></tr><tr><td data-num="72"></td><td><pre></pre></td></tr><tr><td data-num="73"></td><td><pre>    <span class="token comment">/**</pre></td></tr><tr><td data-num="74"></td><td><pre>     * 等待 epoll 事件。</pre></td></tr><tr><td data-num="75"></td><td><pre>     * -1 表示无限期等待，直到有事件发生。</pre></td></tr><tr><td data-num="76"></td><td><pre>     */</span></pre></td></tr><tr><td data-num="77"></td><td><pre>    <span class="token keyword">int</span> epoll_num <span class="token operator">=</span> <span class="token function">epoll_wait</span><span class="token punctuation">(</span>epoll_fd<span class="token punctuation">,</span> events<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="78"></td><td><pre></pre></td></tr><tr><td data-num="79"></td><td><pre>    <span class="token comment">/**</pre></td></tr><tr><td data-num="80"></td><td><pre>     * 遍历所有事件，处理它们。</pre></td></tr><tr><td data-num="81"></td><td><pre>     */</span></pre></td></tr><tr><td data-num="82"></td><td><pre>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> epoll_num<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="83"></td><td><pre>      <span class="token keyword">int</span> fd <span class="token operator">=</span> events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd<span class="token punctuation">;</span> <span class="token comment">/**&lt; 获取事件对应的文件描述符 */</span></pre></td></tr><tr><td data-num="84"></td><td><pre></pre></td></tr><tr><td data-num="85"></td><td><pre>      <span class="token comment">/**</pre></td></tr><tr><td data-num="86"></td><td><pre>       * 如果事件是由监听 socket 触发的，接受新的客户端连接。</pre></td></tr><tr><td data-num="87"></td><td><pre>       */</span></pre></td></tr><tr><td data-num="88"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">==</span> socket_fd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="89"></td><td><pre>        <span class="token keyword">int</span> net_fd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="90"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>net_fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="91"></td><td><pre>          <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"accept"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="92"></td><td><pre>          <span class="token keyword">continue</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="93"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="94"></td><td><pre></pre></td></tr><tr><td data-num="95"></td><td><pre>        <span class="token comment">/**</pre></td></tr><tr><td data-num="96"></td><td><pre>         * 将新的客户端连接分配给一个空闲的子进程。</pre></td></tr><tr><td data-num="97"></td><td><pre>         */</span></pre></td></tr><tr><td data-num="98"></td><td><pre>        <span class="token function">toSonNetFd</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> net_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="99"></td><td><pre></pre></td></tr><tr><td data-num="100"></td><td><pre>        <span class="token function">close</span><span class="token punctuation">(</span>net_fd<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/**&lt; 关闭新创建的 socket，由子进程处理 */</span></pre></td></tr><tr><td data-num="101"></td><td><pre>        <span class="token keyword">continue</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="102"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="103"></td><td><pre>      <span class="token comment">/**</pre></td></tr><tr><td data-num="104"></td><td><pre>       * 处理管道事件。</pre></td></tr><tr><td data-num="105"></td><td><pre>       * 当从管道读取数据时，意味着接收到了 SIGINT 信号。</pre></td></tr><tr><td data-num="106"></td><td><pre>       * 通知所有子进程退出，并等待它们结束，然后主进程也退出。</pre></td></tr><tr><td data-num="107"></td><td><pre>       */</span></pre></td></tr><tr><td data-num="108"></td><td><pre>      <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">==</span> pipe_fd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="109"></td><td><pre>        <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">60</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="110"></td><td><pre>        <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="111"></td><td><pre></pre></td></tr><tr><td data-num="112"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="113"></td><td><pre>          <span class="token function">sendMsg</span><span class="token punctuation">(</span>list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>local_socket<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="114"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="115"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="116"></td><td><pre>          <span class="token function">wait</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="117"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="118"></td><td><pre></pre></td></tr><tr><td data-num="119"></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"子进程全部退出, 主进程也退出 \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="120"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="121"></td><td><pre></pre></td></tr><tr><td data-num="122"></td><td><pre>      <span class="token comment">/**</pre></td></tr><tr><td data-num="123"></td><td><pre>       * 如果事件是由子进程的本地 socket 触发的，处理子进程的通知。</pre></td></tr><tr><td data-num="124"></td><td><pre>       */</span></pre></td></tr><tr><td data-num="125"></td><td><pre>      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="126"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>list<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>local_socket <span class="token operator">==</span> fd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="127"></td><td><pre>          <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">60</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="128"></td><td><pre>          <span class="token function">recv</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/**&lt; 读取子进程发送的消息 */</span></pre></td></tr><tr><td data-num="129"></td><td><pre>          list<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>flag <span class="token operator">=</span> FREE<span class="token punctuation">;</span> <span class="token comment">/**&lt; 将子进程状态设置为 FREE */</span></pre></td></tr><tr><td data-num="130"></td><td><pre>          <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="131"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="132"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="133"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="134"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="135"></td><td><pre></pre></td></tr><tr><td data-num="136"></td><td><pre>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">/**&lt; 程序正常退出 */</span></pre></td></tr><tr><td data-num="137"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><ol>
<li><strong>初始化管道和信号处理</strong>：
<ul>
<li>创建一个管道  <code>pipe_fd</code>  用于信号处理。</li>
<li>设置信号处理函数  <code>fun</code> ，当接收到 SIGINT 信号时，向管道写入一个字符。</li>
</ul>
</li>
<li><strong>添加管道读端到 epoll 监听</strong>：将管道读端添加到 epoll 实例中，以便能够监听到信号事件。</li>
<li><strong>主事件循环</strong>：在 epoll 事件循环中，除了监听网络连接和子进程通知外，还监听管道事件。</li>
<li><strong>处理管道事件</strong>：
<ul>
<li>当从管道读取数据时，意味着接收到了 SIGINT 信号。</li>
<li>遍历进程池，向每个子进程发送退出信号。</li>
</ul>
</li>
<li><strong>等待子进程退出</strong>：使用  <code>wait</code>  函数等待所有子进程结束。</li>
<li><strong>主进程退出</strong>：所有子进程结束后，主进程打印退出信息并退出。</li>
</ol>
<h3 id="localc-2"><a class="anchor" href="#localc-2">#</a> local.c</h3>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="2"></td><td><pre> * @file local.c</pre></td></tr><tr><td data-num="3"></td><td><pre> * @brief 本地通信模块。</pre></td></tr><tr><td data-num="4"></td><td><pre> *</pre></td></tr><tr><td data-num="5"></td><td><pre> * 该文件实现了父子进程间通过本地 socket 进行通信的函数。</pre></td></tr><tr><td data-num="6"></td><td><pre> */</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"head.h"</span></span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="11"></td><td><pre> * @brief 通过本地 socket 发送客户端文件描述符给子进程。</pre></td></tr><tr><td data-num="12"></td><td><pre> *</pre></td></tr><tr><td data-num="13"></td><td><pre> * 使用 sendmsg 系统调用和控制消息（cmsg）来发送一个文件描述符。</pre></td></tr><tr><td data-num="14"></td><td><pre> * 这种方法允许父子进程之间传递打开的文件描述符。</pre></td></tr><tr><td data-num="15"></td><td><pre> *</pre></td></tr><tr><td data-num="16"></td><td><pre> * @param local_socket 父进程与子进程通信的本地 socket 文件描述符。</pre></td></tr><tr><td data-num="17"></td><td><pre> * @param net_fd 要发送给子进程的客户端 socket 文件描述符。</pre></td></tr><tr><td data-num="18"></td><td><pre> * @param flag 附加的标志，可以用于控制子进程的行为。</pre></td></tr><tr><td data-num="19"></td><td><pre> * @return 成功返回 0，失败返回 -1。</pre></td></tr><tr><td data-num="20"></td><td><pre> */</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token keyword">int</span> <span class="token function">sendMsg</span><span class="token punctuation">(</span><span class="token keyword">int</span> local_socket<span class="token punctuation">,</span> <span class="token keyword">int</span> net_fd<span class="token punctuation">,</span> <span class="token keyword">int</span> flag<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token keyword">struct</span> <span class="token class-name">msghdr</span> msg<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>  <span class="token function">bzero</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre>  <span class="token keyword">struct</span> <span class="token class-name">iovec</span> vec<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>  vec<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_base <span class="token operator">=</span> <span class="token operator">&amp;</span>flag<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>  vec<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_len <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre>  msg<span class="token punctuation">.</span>msg_iov <span class="token operator">=</span> vec<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>  msg<span class="token punctuation">.</span>msg_iovlen <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre>  <span class="token keyword">struct</span> <span class="token class-name">cmsghdr</span> <span class="token operator">*</span>cmsg <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">cmsghdr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token function">CMSG_LEN</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>  cmsg<span class="token operator">-></span>cmsg_len <span class="token operator">=</span> <span class="token function">CMSG_LEN</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>  cmsg<span class="token operator">-></span>cmsg_level <span class="token operator">=</span> SOL_SOCKET<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>  cmsg<span class="token operator">-></span>cmsg_type <span class="token operator">=</span> SCM_RIGHTS<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre></pre></td></tr><tr><td data-num="38"></td><td><pre>  msg<span class="token punctuation">.</span>msg_control <span class="token operator">=</span> cmsg<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>  msg<span class="token punctuation">.</span>msg_controllen <span class="token operator">=</span> <span class="token function">CMSG_LEN</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre>  <span class="token keyword">void</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">CMSG_DATA</span><span class="token punctuation">(</span>cms<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>  <span class="token keyword">int</span> <span class="token operator">*</span>fd <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span>p<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>  <span class="token operator">*</span>fd <span class="token operator">=</span> net_fd<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre></pre></td></tr><tr><td data-num="45"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sendmsg</span><span class="token punctuation">(</span>local_socket<span class="token punctuation">,</span> <span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="50"></td><td><pre></pre></td></tr><tr><td data-num="51"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="52"></td><td><pre> * @brief 子进程通过本地 socket 接收父进程发送的客户端文件描述符。</pre></td></tr><tr><td data-num="53"></td><td><pre> *</pre></td></tr><tr><td data-num="54"></td><td><pre> * 使用 recvmsg 系统调用接收文件描述符。</pre></td></tr><tr><td data-num="55"></td><td><pre> * 该函数从控制消息中提取文件描述符，并将其存储在提供的参数中。</pre></td></tr><tr><td data-num="56"></td><td><pre> *</pre></td></tr><tr><td data-num="57"></td><td><pre> * @param local_socket 子进程与父进程通信的本地 socket 文件描述符。</pre></td></tr><tr><td data-num="58"></td><td><pre> * @param net_fd 指向用于存储接收到的客户端 socket 文件描述符的变量的指针。</pre></td></tr><tr><td data-num="59"></td><td><pre> * @param flag 指向用于存储接收到的标志的变量的指针。</pre></td></tr><tr><td data-num="60"></td><td><pre> * @return 成功返回 0，失败返回 -1。</pre></td></tr><tr><td data-num="61"></td><td><pre> */</span></pre></td></tr><tr><td data-num="62"></td><td><pre><span class="token keyword">int</span> <span class="token function">recvMsg</span><span class="token punctuation">(</span><span class="token keyword">int</span> local_socket<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>net_fd<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>flag<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>  <span class="token keyword">struct</span> <span class="token class-name">msghdr</span> msg<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>  <span class="token function">bzero</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="65"></td><td><pre></pre></td></tr><tr><td data-num="66"></td><td><pre>  <span class="token comment">// 准备正文信息</span></pre></td></tr><tr><td data-num="67"></td><td><pre>  <span class="token keyword">int</span> <span class="token operator">*</span>num <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>  <span class="token keyword">struct</span> <span class="token class-name">iovec</span> vec<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>  vec<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_base <span class="token operator">=</span> num<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>  vec<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_len <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre></pre></td></tr><tr><td data-num="72"></td><td><pre>  msg<span class="token punctuation">.</span>msg_iov <span class="token operator">=</span> vec<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>  msg<span class="token punctuation">.</span>msg_iovlen <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre></pre></td></tr><tr><td data-num="75"></td><td><pre>  <span class="token comment">// 准备控制信息</span></pre></td></tr><tr><td data-num="76"></td><td><pre>  <span class="token keyword">struct</span> <span class="token class-name">cmsghdr</span> <span class="token operator">*</span>cms <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">cmsghdr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token function">CMSG_LEN</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>  cms<span class="token operator">-></span>cmsg_len <span class="token operator">=</span> <span class="token function">CMSG_LEN</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 指明这个结构体的大小</span></pre></td></tr><tr><td data-num="78"></td><td><pre>  cms<span class="token operator">-></span>cmsg_level <span class="token operator">=</span> SOL_SOCKET<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>  cms<span class="token operator">-></span>cmsg_type <span class="token operator">=</span> SCM_RIGHTS<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="80"></td><td><pre></pre></td></tr><tr><td data-num="81"></td><td><pre>  msg<span class="token punctuation">.</span>msg_control <span class="token operator">=</span> cms<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="82"></td><td><pre>  msg<span class="token punctuation">.</span>msg_controllen <span class="token operator">=</span> <span class="token function">CMSG_LEN</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="83"></td><td><pre></pre></td></tr><tr><td data-num="84"></td><td><pre>  <span class="token function">recvmsg</span><span class="token punctuation">(</span>local_socket<span class="token punctuation">,</span> <span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="85"></td><td><pre></pre></td></tr><tr><td data-num="86"></td><td><pre>  <span class="token keyword">void</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">CMSG_DATA</span><span class="token punctuation">(</span>cms<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="87"></td><td><pre>  <span class="token keyword">int</span> <span class="token operator">*</span>fd <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span>p<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="88"></td><td><pre></pre></td></tr><tr><td data-num="89"></td><td><pre>  <span class="token operator">*</span>net_fd <span class="token operator">=</span> <span class="token operator">*</span>fd<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="90"></td><td><pre></pre></td></tr><tr><td data-num="91"></td><td><pre>  <span class="token operator">*</span>flag <span class="token operator">=</span> <span class="token operator">*</span>num<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="92"></td><td><pre></pre></td></tr><tr><td data-num="93"></td><td><pre>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="94"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="workerc-2"><a class="anchor" href="#workerc-2">#</a> worker.c</h3>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="2"></td><td><pre> * @file worker.c</pre></td></tr><tr><td data-num="3"></td><td><pre> * @brief 子进程工作模块。</pre></td></tr><tr><td data-num="4"></td><td><pre> *</pre></td></tr><tr><td data-num="5"></td><td><pre> * 该文件实现了子进程的工作循环，负责接收父进程发送的任务，</pre></td></tr><tr><td data-num="6"></td><td><pre> * 并执行与客户端的交互。</pre></td></tr><tr><td data-num="7"></td><td><pre> */</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"head.h"</span></span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="12"></td><td><pre> * @brief 子进程的工作函数。</pre></td></tr><tr><td data-num="13"></td><td><pre> *</pre></td></tr><tr><td data-num="14"></td><td><pre> * 子进程在此函数中循环运行，等待父进程通过本地 socket 发送的任务。</pre></td></tr><tr><td data-num="15"></td><td><pre> * 当接收到任务后，子进程将调用 toClientFile 函数来处理客户端请求，</pre></td></tr><tr><td data-num="16"></td><td><pre> * 然后通知父进程任务已完成。如果接收到退出信号，则子进程将退出。</pre></td></tr><tr><td data-num="17"></td><td><pre> *</pre></td></tr><tr><td data-num="18"></td><td><pre> * @param local_socket 子进程与父进程通信的本地 socket 文件描述符。</pre></td></tr><tr><td data-num="19"></td><td><pre> * @return 始终返回 0，表示子进程正常运行。</pre></td></tr><tr><td data-num="20"></td><td><pre> */</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token keyword">int</span> <span class="token function">doWorker</span><span class="token punctuation">(</span><span class="token keyword">int</span> local_socket<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token keyword">int</span> net_fd<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token keyword">int</span> flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token comment">/**</pre></td></tr><tr><td data-num="26"></td><td><pre>     * 接收父进程发送的客户端文件描述符。</pre></td></tr><tr><td data-num="27"></td><td><pre>     * 如果 recvMsg 失败，子进程将退出循环并结束。</pre></td></tr><tr><td data-num="28"></td><td><pre>     */</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">recvMsg</span><span class="token punctuation">(</span>local_socket<span class="token punctuation">,</span> <span class="token operator">&amp;</span>net_fd<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token comment">/**</pre></td></tr><tr><td data-num="33"></td><td><pre>     * 检查标志是否指示子进程退出。</pre></td></tr><tr><td data-num="34"></td><td><pre>     * 如果标志为 -1，表示父进程发送了退出信号。</pre></td></tr><tr><td data-num="35"></td><td><pre>     */</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>flag <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"收到父进程的通知, 要求退出的通知 \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>      <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token comment">/**</pre></td></tr><tr><td data-num="42"></td><td><pre>     * 处理客户端请求。</pre></td></tr><tr><td data-num="43"></td><td><pre>     * toClientFile 函数负责与客户端的交互，例如发送响应。</pre></td></tr><tr><td data-num="44"></td><td><pre>     */</span></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">toClientFile</span><span class="token punctuation">(</span>net_fd<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>      <span class="token comment">// 处理错误...</span></pre></td></tr><tr><td data-num="47"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="49"></td><td><pre></pre></td></tr><tr><td data-num="50"></td><td><pre>    <span class="token comment">/**</pre></td></tr><tr><td data-num="51"></td><td><pre>     * 关闭客户端 socket，完成与客户端的交互。</pre></td></tr><tr><td data-num="52"></td><td><pre>     */</span></pre></td></tr><tr><td data-num="53"></td><td><pre>    <span class="token function">close</span><span class="token punctuation">(</span>net_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre></pre></td></tr><tr><td data-num="55"></td><td><pre>    <span class="token comment">/**</pre></td></tr><tr><td data-num="56"></td><td><pre>     * 通知父进程任务已完成，子进程准备接收新任务。</pre></td></tr><tr><td data-num="57"></td><td><pre>     * 发送特定的消息（例如 "111"）作为通知。</pre></td></tr><tr><td data-num="58"></td><td><pre>     */</span></pre></td></tr><tr><td data-num="59"></td><td><pre>    <span class="token function">send</span><span class="token punctuation">(</span>local_socket<span class="token punctuation">,</span> <span class="token string">"任务完成"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="63"></td><td><pre></pre></td></tr><tr><td data-num="64"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="65"></td><td><pre> * @brief 子进程与客户端的交互函数。</pre></td></tr><tr><td data-num="66"></td><td><pre> *</pre></td></tr><tr><td data-num="67"></td><td><pre> * 此函数负责子进程与客户端的交互，例如发送欢迎消息。</pre></td></tr><tr><td data-num="68"></td><td><pre> * 这里仅为示例，实际应用中可能包含更复杂的逻辑。</pre></td></tr><tr><td data-num="69"></td><td><pre> *</pre></td></tr><tr><td data-num="70"></td><td><pre> * @param net_fd 客户端连接的文件描述符。</pre></td></tr><tr><td data-num="71"></td><td><pre> * @return 成功返回 0，失败返回 -1。</pre></td></tr><tr><td data-num="72"></td><td><pre> */</span></pre></td></tr><tr><td data-num="73"></td><td><pre><span class="token keyword">int</span> <span class="token function">toClientFile</span><span class="token punctuation">(</span><span class="token keyword">int</span> net_fd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>  <span class="token comment">/**</pre></td></tr><tr><td data-num="75"></td><td><pre>   * 向客户端发送消息。</pre></td></tr><tr><td data-num="76"></td><td><pre>   * 如果 send 调用失败，函数将返回 -1 表示错误。</pre></td></tr><tr><td data-num="77"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="78"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sendFile</span><span class="token punctuation">(</span>net_fd<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="80"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="82"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><div class="tags"><a href="/tags/c/" rel="tag"><i class="ic i-tag"></i>C</a><a href="/tags/linux/" rel="tag"><i class="ic i-tag"></i>Linux</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i></span><span class="text">更新于</span><time title="修改时间：2024-12-14 16:46:07" itemprop="dateModified" datetime="2024-12-14T16:46:07+08:00">2024-12-14</time></span></div><div id="copyright"><ul><li class="author"><strong>本文作者：</strong>樱小路七叶<i class="ic i-at"><em>@</em></i>Nana7ha's Café Stella</li><li class="link"><strong>本文链接：</strong><a href="http://cwlrin.github.io/c-cpp/linux-c/Linux%20%E8%BF%9B%E7%A8%8B%E6%B1%A0/" title="Linux 进程池">http://cwlrin.github.io/c-cpp/linux-c/Linux 进程池/</a></li><li class="license"><strong>版权声明：</strong>本站所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/c-cpp/linux-c/Linux%20%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/" rel="prev" itemprop="url" title="Linux 网络编程" style="background-image: linear-gradient(to bottom right, #8ebed9, #e3d385);"><span class="type">上一篇</span><span class="category"><i class="ic i-flag"></i>Linux C</span><h3>Linux 网络编程</h3></a></div><div class="item right"><a href="/c-cpp/cpp-base/%E4%BB%8E%20C%20%E5%88%B0%20C++/" rel="next" itemprop="url" title="从 C 到 C++" style="background-image: linear-gradient(to bottom right, #a4b9cd, #af89e8);"><span class="type">下一篇</span><span class="category"><i class="ic i-flag"></i>C++ 基础</span><h3>从 C 到 C++</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="toc-number">1.</span> <span class="toc-text"> 需求分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E7%89%88"><span class="toc-number">2.</span> <span class="toc-text"> 第一版</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E8%AE%A1%E9%80%BB%E8%BE%91"><span class="toc-number">2.1.</span> <span class="toc-text"> 设计逻辑</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%A5%E9%A1%B9%E7%9B%AE%E4%B8%AD%E9%9C%80%E8%A6%81%E4%BD%BF%E7%94%A8%E7%9A%84%E6%96%B0%E5%87%BD%E6%95%B0"><span class="toc-number">2.2.</span> <span class="toc-text"> 该项目中需要使用的新函数</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#socketpair-%E5%88%9B%E5%BB%BA%E4%B8%80%E5%AF%B9%E4%BA%92%E7%9B%B8%E8%BF%9E%E6%8E%A5%E7%9A%84%E5%85%A8%E5%8F%8C%E5%B7%A5%E9%80%9A%E4%BF%A1"><span class="toc-number">2.2.1.</span> <span class="toc-text">  socketpair  创建一对互相连接的全双工通信</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#sendmsg-%E5%8F%91%E9%80%81%E6%95%B0%E6%8D%AE"><span class="toc-number">2.2.2.</span> <span class="toc-text">  sendmsg  发送数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#recvmsg-%E6%8E%A5%E6%94%B6%E6%95%B0%E6%8D%AE"><span class="toc-number">2.2.3.</span> <span class="toc-text">  recvmsg  接收数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#cmsghdr"><span class="toc-number">2.2.4.</span> <span class="toc-text">  cmsghdr</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#makefile"><span class="toc-number">2.3.</span> <span class="toc-text"> Makefile</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#headerh"><span class="toc-number">2.4.</span> <span class="toc-text"> header.h</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mainc"><span class="toc-number">2.5.</span> <span class="toc-text"> main.c</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#poolc"><span class="toc-number">2.6.</span> <span class="toc-text"> pool.c</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#workerc"><span class="toc-number">2.7.</span> <span class="toc-text"> worker.c</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#localc"><span class="toc-number">2.8.</span> <span class="toc-text"> local.c</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#socketc"><span class="toc-number">2.9.</span> <span class="toc-text"> socket.c</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#epollc"><span class="toc-number">2.10.</span> <span class="toc-text"> epoll.c</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#clientc"><span class="toc-number">2.11.</span> <span class="toc-text"> client.c</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E7%89%88"><span class="toc-number">3.</span> <span class="toc-text"> 第二版</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E4%BC%A0%E8%BE%93"><span class="toc-number">3.1.</span> <span class="toc-text"> 文件传输</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#clientc-2"><span class="toc-number">3.1.1.</span> <span class="toc-text"> client.c</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#send_filec"><span class="toc-number">3.1.2.</span> <span class="toc-text"> send_file.c</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B2%98%E5%8C%85%E9%97%AE%E9%A2%98"><span class="toc-number">3.2.</span> <span class="toc-text"> 粘包问题</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#clientc-3"><span class="toc-number">3.2.1.</span> <span class="toc-text"> client.c</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#send_filec-2"><span class="toc-number">3.2.2.</span> <span class="toc-text"> send_file.c</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%A7%E6%96%87%E4%BB%B6%E4%BC%A0%E8%BE%93"><span class="toc-number">3.3.</span> <span class="toc-text"> 大文件传输</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#clientc-4"><span class="toc-number">3.3.1.</span> <span class="toc-text"> client.c</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#send_filec-3"><span class="toc-number">3.3.2.</span> <span class="toc-text"> send_file.c</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%8A%E5%8C%85%E9%97%AE%E9%A2%98"><span class="toc-number">3.4.</span> <span class="toc-text"> 半包问题</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#clientc-5"><span class="toc-number">3.4.1.</span> <span class="toc-text"> client.c</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8A%9B%E5%87%BA%E5%BC%82%E5%B8%B8%E4%BF%A1%E5%8F%B7%E7%BB%88%E6%AD%A2%E9%97%AE%E9%A2%98"><span class="toc-number">3.5.</span> <span class="toc-text"> 抛出异常信号终止问题</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#send_filec-4"><span class="toc-number">3.5.1.</span> <span class="toc-text"> send_file.c</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9B%E5%BA%A6%E6%9D%A1"><span class="toc-number">3.6.</span> <span class="toc-text"> 进度条</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#fstat-%E8%8E%B7%E5%8F%96%E6%96%87%E4%BB%B6%E6%8F%8F%E8%BF%B0%E7%AC%A6%E5%85%83%E6%95%B0%E6%8D%AE"><span class="toc-number">3.6.1.</span> <span class="toc-text">  fstat  获取文件描述符元数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#clientc-6"><span class="toc-number">3.6.2.</span> <span class="toc-text"> client.c</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#send_filec-5"><span class="toc-number">3.6.3.</span> <span class="toc-text"> send_file.c</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%B6%E6%8B%B7%E8%B4%9D"><span class="toc-number">3.7.</span> <span class="toc-text"> 零拷贝</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#mmap-%E6%98%A0%E5%B0%84%E6%96%87%E4%BB%B6%E5%88%B0%E8%BF%9B%E7%A8%8B%E7%9A%84%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4"><span class="toc-number">3.7.1.</span> <span class="toc-text">  mmap  映射文件到进程的地址空间</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#clientc-7"><span class="toc-number">3.7.2.</span> <span class="toc-text"> client.c</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#send_filec-6"><span class="toc-number">3.7.3.</span> <span class="toc-text"> send_file.c</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#sendfile"><span class="toc-number">3.7.4.</span> <span class="toc-text"> sendfile</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#send_filec-7"><span class="toc-number">3.7.5.</span> <span class="toc-text"> send_file.c</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E7%89%88"><span class="toc-number">4.</span> <span class="toc-text"> 第三版</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#mainc-2"><span class="toc-number">4.1.</span> <span class="toc-text"> main.c</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#localc-2"><span class="toc-number">4.2.</span> <span class="toc-text"> local.c</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#workerc-2"><span class="toc-number">4.3.</span> <span class="toc-text"> worker.c</span></a></li></ol></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li ><a href="/c-cpp/linux-c/Linux%20C%20%E5%9F%BA%E7%A1%80/" rel="bookmark" title="Linux C 基础">Linux C 基础</a></li><li ><a href="/c-cpp/linux-c/Linux%20%E6%9D%82%E9%A1%B9/" rel="bookmark" title="Linux 杂项">Linux 杂项</a></li><li ><a href="/c-cpp/linux-c/Linux%20%E7%9B%AE%E5%BD%95%E6%B5%81/" rel="bookmark" title="Linux 目录流">Linux 目录流</a></li><li ><a href="/c-cpp/linux-c/Linux%20%E6%96%87%E4%BB%B6%E6%B5%81/" rel="bookmark" title="Linux 文件流">Linux 文件流</a></li><li ><a href="/c-cpp/linux-c/Linux%20%E7%AE%A1%E9%81%93%E5%92%8C%20IO%20%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8/" rel="bookmark" title="Linux 管道和 IO 多路复用">Linux 管道和 IO 多路复用</a></li><li ><a href="/c-cpp/linux-c/Linux%20%E8%BF%9B%E7%A8%8B%EF%BC%88%E4%B8%8A%EF%BC%89/" rel="bookmark" title="Linux 进程（上）">Linux 进程（上）</a></li><li ><a href="/c-cpp/linux-c/Linux%20%E8%BF%9B%E7%A8%8B%EF%BC%88%E4%B8%8B%EF%BC%89/" rel="bookmark" title="Linux 进程（下）">Linux 进程（下）</a></li><li ><a href="/c-cpp/linux-c/Linux%20%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/" rel="bookmark" title="Linux 进程间通信">Linux 进程间通信</a></li><li ><a href="/c-cpp/linux-c/Linux%20%E4%BF%A1%E5%8F%B7/" rel="bookmark" title="Linux 信号">Linux 信号</a></li><li ><a href="/c-cpp/linux-c/Linux%20%E7%BA%BF%E7%A8%8B/" rel="bookmark" title="Linux 线程">Linux 线程</a></li><li ><a href="/c-cpp/linux-c/Linux%20%E7%BA%BF%E7%A8%8B%E7%9A%84%E5%90%8C%E6%AD%A5%E5%92%8C%E4%BA%92%E6%96%A5/" rel="bookmark" title="Linux 线程的同步和互斥.md">Linux 线程的同步和互斥.md</a></li><li ><a href="/c-cpp/linux-c/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE/" rel="bookmark" title="网络协议">网络协议</a></li><li ><a href="/c-cpp/linux-c/Linux%20%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/" rel="bookmark" title="Linux 网络编程">Linux 网络编程</a></li><li  class="active"><a href="/c-cpp/linux-c/Linux%20%E8%BF%9B%E7%A8%8B%E6%B1%A0/" rel="bookmark" title="Linux 进程池">Linux 进程池</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><img class="image" loading="lazy" decoding="async" itemprop="image" alt="樱小路七叶" src="/assets/avatar.jpg"/><p class="name" itemprop="name">樱小路七叶</p><div class="description" itemprop="description">技术与美日新月异</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">97</span><span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">12</span><span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">15</span><span class="name">标签</span></a></div></nav><div class="social"><a target="_blank" rel="noopener" href="https://github.com/cwlrin" class="item github" title="https:&#x2F;&#x2F;github.com&#x2F;cwlrin"><i class="ic i-github"></i></a><a target="_blank" rel="noopener" href="https://www.zhihu.com/people/ying-xiao-lu-qi-ye" class="item zhihu" title="https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;ying-xiao-lu-qi-ye"><i class="ic i-zhihu"></i></a><a target="_blank" rel="noopener" href="https://music.163.com/#/user/home?id=411590211" class="item music" title="https:&#x2F;&#x2F;music.163.com&#x2F;#&#x2F;user&#x2F;home?id&#x3D;411590211"><i class="ic i-cloud-music"></i></a><a target="_blank" rel="noopener" href="https://space.bilibili.com/8013992" class="item bilibili" title="https:&#x2F;&#x2F;space.bilibili.com&#x2F;8013992"><i class="ic i-bilibili"></i></a></div><div class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item dropdown"><a href="#" onclick="return false;"><i class="ic i-user"></i>关于</a><ul class="submenu"><li class="item"><a href="/about/" rel="section"><i class="ic i-user"></i>关于本站</a></li><li class="item"><a href="/admiration/" rel="section"><i class="ic i-coffee"></i>赞赏博主</a></li></ul></li><li class="item dropdown"><a href="#" onclick="return false;"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li><li class="item"><a href="/friends/" rel="section"><i class="ic i-heart"></i>友链</a></li></div></div></div></div><ul id="quick"><li class="prev pjax"><a href="/c-cpp/cpp-base/%E4%BB%8E%20C%20%E5%88%B0%20C++/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/c-cpp/linux-c/Linux%20%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"></div><div class="status"><div class="copyright">&copy; 2020 -<span itemprop="copyrightYear">2024</span><span class="with-love"><i class="ic i-sakura rotate"></i></span><span class="author" itemprop="copyrightHolder">樱小路七叶 @ 七葉の喫茶ステラ</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i></span><span title="站点总字数">1.5m 字</span><span class="post-meta-divider"> | </span><span class="post-meta-item-icon"><i class="ic i-coffee"></i></span><span title="站点阅读时长">22:36</span></div><div class="powered-by">基于 <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a> & Theme.<a target="_blank" rel="noopener" href="https://github.com/theme-shoka-x/hexo-theme-shokaX/">ShokaX</a></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL = {
    ispost: true,
        path: `c-cpp/linux-c/Linux 进程池/`,
        favicon: {
        show: `（●´3｀●）やれやれだぜ`,
        hide: `(´Д｀)大変だ！`
    },
    search: {
        placeholder: "文章搜索",
        empty: "关于 「 ${query} 」，什么也没搜到",
        stats: "${time} ms 内找到 ${hits} 条结果"
    },
    copy_tex: false,
    katex: false,
    mermaid: false,
    audio: undefined,
    fancybox: true,
    nocopy: false,
    outime: true,
    template: `<div class="note warning"><p><span class="label warning">文章时效性提示</span><br>这是一篇发布于 {{publish}} 天前，最后一次更新在 {{updated}} 天前的文章，部分信息可能已经发生改变，请注意甄别。</p></div>`,
    quiz: {
        choice: `单选题`,
        multiple: `多选题`,
        true_false: `判断题`,
        essay: `问答题`,
        gap_fill: `填空题`,
        mistake: `错题备注`
    },
    ignores: [
        (uri) => uri.includes('#'),
        (uri) => new RegExp(LOCAL.path + '$').test(uri),
            []
    ]
};
</script><script src="https://s4.zstatic.net/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha384-k6YtvFUEIuEFBdrLKJ3YAUbBki333tj1CSUisai5Cswsg9wcLNaPzsTHDswp4Az8" crossorigin="anonymous" fetchpriority="high"></script><script src="https://s4.zstatic.net/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha384-ZvpUoO&#x2F;+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn&#x2F;6Z&#x2F;hRTt8+pR6L4N2" crossorigin="anonymous" fetchpriority="high"></script><script src="/js/siteInit.js?v=0.4.14" type="module" fetchpriority="high" defer></script></body></html>