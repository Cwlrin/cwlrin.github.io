<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"/><meta name="theme-color" content="#222"/><meta http-equiv="X-UA-COMPATIBLE" content="IE=edge,chrome=1"/><meta name="renderer" content="webkit"/><link rel="icon" type="image/ico" sizes="32x32" href="/assets/favicon.ico"/><link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png"/><link rel="alternate" href="/rss.xml" title="Nana7ha's Café Stella" type="application/rss+xml"><link rel="alternate" href="/atom.xml" title="Nana7ha's Café Stella" type="application/atom+xml"><link rel="alternate" type="application/json" title="Nana7ha's Café Stella" href="http://cwlrin.github.io/feed.json"/><link rel="preconnect" href="https://s4.zstatic.net"/><link rel="preconnect" href="https://at.alicdn.com"/><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Mulish:400,400italic,700,700italic%7CFredericka%20the%20Great:400,400italic,700,700italic%7CNoto%20Serif%20JP:400,400italic,700,700italic%7CNoto%20Serif%20SC:400,400italic,700,700italic%7CInconsolata:400,400italic,700,700italic&display=swap&subset=latin,latin-ext" media="none" onload="this.media&#x3D;&#39;all&#39;"><link rel="stylesheet" href="/css/app.css?v=0.4.14"><link rel="modulepreload" href="/js/chunk-3QGRG5LW.js"></link><link rel="modulepreload" href="/js/chunk-UI4753RE.js"></link><link rel="modulepreload" href="/js/chunk-W4TLJ2OW.js"></link><link rel="modulepreload" href="/js/copy-tex-AOQYTOAX.js"></link><link rel="modulepreload" href="/js/index.esm-CJDJKRJB.js"></link><link rel="modulepreload" href="/js/post-3U5GTE2G.js"></link><link rel="modulepreload" href="/js/quicklink-SMYWLNBX.js"></link><link rel="modulepreload" href="/js/siteInit.js"></link><link rel="preload" href="h" as="image" fetchpriority="high"><link rel="preload" href="t" as="image" fetchpriority="high"><link rel="preload" href="t" as="image" fetchpriority="high"><link rel="preload" href="p" as="image" fetchpriority="high"><link rel="preload" href="s" as="image" fetchpriority="high"><link rel="preload" href=":" as="image" fetchpriority="high"><link rel="preload" href="/" as="image" fetchpriority="high"><link rel="preload" href="/" as="image" fetchpriority="high"><link rel="preload" href="d" as="image" fetchpriority="high"><link rel="preload" href="l" as="image" fetchpriority="high"><link rel="preload" href="i" as="image" fetchpriority="high"><link rel="preload" href="n" as="image" fetchpriority="high"><link rel="preload" href="k" as="image" fetchpriority="high"><link rel="preload" href="." as="image" fetchpriority="high"><link rel="preload" href="h" as="image" fetchpriority="high"><link rel="preload" href="o" as="image" fetchpriority="high"><link rel="preload" href="s" as="image" fetchpriority="high"><link rel="preload" href="t" as="image" fetchpriority="high"><link rel="preload" href="/" as="image" fetchpriority="high"><link rel="preload" href="1" as="image" fetchpriority="high"><link rel="preload" href="d" as="image" fetchpriority="high"><link rel="preload" href="r" as="image" fetchpriority="high"><link rel="preload" href="v" as="image" fetchpriority="high"><link rel="preload" href="/" as="image" fetchpriority="high"><link rel="preload" href="a" as="image" fetchpriority="high"><link rel="preload" href="H" as="image" fetchpriority="high"><link rel="preload" href="R" as="image" fetchpriority="high"><link rel="preload" href="0" as="image" fetchpriority="high"><link rel="preload" href="c" as="image" fetchpriority="high"><link rel="preload" href="H" as="image" fetchpriority="high"><link rel="preload" href="M" as="image" fetchpriority="high"><link rel="preload" href="6" as="image" fetchpriority="high"><link rel="preload" href="L" as="image" fetchpriority="high"><link rel="preload" href="y" as="image" fetchpriority="high"><link rel="preload" href="8" as="image" fetchpriority="high"><link rel="preload" href="x" as="image" fetchpriority="high"><link rel="preload" href="Z" as="image" fetchpriority="high"><link rel="preload" href="H" as="image" fetchpriority="high"><link rel="preload" href="J" as="image" fetchpriority="high"><link rel="preload" href="2" as="image" fetchpriority="high"><link rel="preload" href="L" as="image" fetchpriority="high"><link rel="preload" href="m" as="image" fetchpriority="high"><link rel="preload" href="1" as="image" fetchpriority="high"><link rel="preload" href="z" as="image" fetchpriority="high"><link rel="preload" href="L" as="image" fetchpriority="high"><link rel="preload" href="2" as="image" fetchpriority="high"><link rel="preload" href="k" as="image" fetchpriority="high"><link rel="preload" href="v" as="image" fetchpriority="high"><link rel="preload" href="Y" as="image" fetchpriority="high"><link rel="preload" href="y" as="image" fetchpriority="high"><link rel="preload" href="9" as="image" fetchpriority="high"><link rel="preload" href="i" as="image" fetchpriority="high"><link rel="preload" href="Z" as="image" fetchpriority="high"><link rel="preload" href="G" as="image" fetchpriority="high"><link rel="preload" href="U" as="image" fetchpriority="high"><link rel="preload" href="1" as="image" fetchpriority="high"><link rel="preload" href="M" as="image" fetchpriority="high"><link rel="preload" href="W" as="image" fetchpriority="high"><link rel="preload" href="U" as="image" fetchpriority="high"><link rel="preload" href="2" as="image" fetchpriority="high"><link rel="preload" href="M" as="image" fetchpriority="high"><link rel="preload" href="j" as="image" fetchpriority="high"><link rel="preload" href="V" as="image" fetchpriority="high"><link rel="preload" href="l" as="image" fetchpriority="high"><link rel="preload" href="Z" as="image" fetchpriority="high"><link rel="preload" href="j" as="image" fetchpriority="high"><link rel="preload" href="h" as="image" fetchpriority="high"><link rel="preload" href="m" as="image" fetchpriority="high"><link rel="preload" href="Y" as="image" fetchpriority="high"><link rel="preload" href="2" as="image" fetchpriority="high"><link rel="preload" href="M" as="image" fetchpriority="high"><link rel="preload" href="1" as="image" fetchpriority="high"><link rel="preload" href="L" as="image" fetchpriority="high"><link rel="preload" href="0" as="image" fetchpriority="high"><link rel="preload" href="V" as="image" fetchpriority="high"><link rel="preload" href="h" as="image" fetchpriority="high"><link rel="preload" href="Z" as="image" fetchpriority="high"><link rel="preload" href="k" as="image" fetchpriority="high"><link rel="preload" href="t" as="image" fetchpriority="high"><link rel="preload" href="O" as="image" fetchpriority="high"><link rel="preload" href="S" as="image" fetchpriority="high"><link rel="preload" href="k" as="image" fetchpriority="high"><link rel="preload" href="8" as="image" fetchpriority="high"><link rel="preload" href="2" as="image" fetchpriority="high"><link rel="preload" href="Z" as="image" fetchpriority="high"><link rel="preload" href="G" as="image" fetchpriority="high"><link rel="preload" href="d" as="image" fetchpriority="high"><link rel="preload" href="w" as="image" fetchpriority="high"><link rel="preload" href="T" as="image" fetchpriority="high"><link rel="preload" href="m" as="image" fetchpriority="high"><link rel="preload" href="h" as="image" fetchpriority="high"><link rel="preload" href="B" as="image" fetchpriority="high"><link rel="preload" href="T" as="image" fetchpriority="high"><link rel="preload" href="F" as="image" fetchpriority="high"><link rel="preload" href="J" as="image" fetchpriority="high"><link rel="preload" href="O" as="image" fetchpriority="high"><link rel="preload" href="O" as="image" fetchpriority="high"><link rel="preload" href="H" as="image" fetchpriority="high"><link rel="preload" href="M" as="image" fetchpriority="high"><link rel="preload" href="2" as="image" fetchpriority="high"><link rel="preload" href="U" as="image" fetchpriority="high"><link rel="preload" href="1" as="image" fetchpriority="high"><link rel="preload" href="E" as="image" fetchpriority="high"><link rel="preload" href="0" as="image" fetchpriority="high"><link rel="preload" href="Q" as="image" fetchpriority="high"><link rel="preload" href="k" as="image" fetchpriority="high"><link rel="preload" href="h" as="image" fetchpriority="high"><link rel="preload" href="B" as="image" fetchpriority="high"><link rel="preload" href="c" as="image" fetchpriority="high"><link rel="preload" href="1" as="image" fetchpriority="high"><link rel="preload" href="B" as="image" fetchpriority="high"><link rel="preload" href="x" as="image" fetchpriority="high"><link rel="preload" href="b" as="image" fetchpriority="high"><link rel="preload" href="D" as="image" fetchpriority="high"><link rel="preload" href="N" as="image" fetchpriority="high"><link rel="preload" href="m" as="image" fetchpriority="high"><link rel="preload" href="T" as="image" fetchpriority="high"><link rel="preload" href="y" as="image" fetchpriority="high"><link rel="preload" href="1" as="image" fetchpriority="high"><link rel="preload" href="o" as="image" fetchpriority="high"><link rel="preload" href="W" as="image" fetchpriority="high"><link rel="preload" href="j" as="image" fetchpriority="high"><link rel="preload" href="Z" as="image" fetchpriority="high"><link rel="preload" href="L" as="image" fetchpriority="high"><link rel="preload" href="V" as="image" fetchpriority="high"><link rel="preload" href="V" as="image" fetchpriority="high"><link rel="preload" href="9" as="image" fetchpriority="high"><link rel="preload" href="H" as="image" fetchpriority="high"><link rel="preload" href="e" as="image" fetchpriority="high"><link rel="preload" href="H" as="image" fetchpriority="high"><link rel="preload" href="V" as="image" fetchpriority="high"><link rel="preload" href="N" as="image" fetchpriority="high"><link rel="preload" href="e" as="image" fetchpriority="high"><link rel="preload" href="k" as="image" fetchpriority="high"><link rel="preload" href="E" as="image" fetchpriority="high"><link rel="preload" href="_" as="image" fetchpriority="high"><link rel="preload" href="Z" as="image" fetchpriority="high"><link rel="preload" href="T" as="image" fetchpriority="high"><link rel="preload" href="0" as="image" fetchpriority="high"><link rel="preload" href="y" as="image" fetchpriority="high"><link rel="preload" href="N" as="image" fetchpriority="high"><link rel="preload" href="m" as="image" fetchpriority="high"><link rel="preload" href="d" as="image" fetchpriority="high"><link rel="preload" href="V" as="image" fetchpriority="high"><link rel="preload" href="U" as="image" fetchpriority="high"><link rel="preload" href="k" as="image" fetchpriority="high"><link rel="preload" href="U" as="image" fetchpriority="high"><link rel="preload" href="." as="image" fetchpriority="high"><link rel="preload" href="p" as="image" fetchpriority="high"><link rel="preload" href="n" as="image" fetchpriority="high"><link rel="preload" href="g" as="image" fetchpriority="high"><meta name="keywords" content="C,计算机网络"/><meta name="description" content="技术与美日新月异"/><link rel="canonical" href="http://cwlrin.github.io/c-cpp/linux-c/Linux%20%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/"><title>Linux 网络编程</title><meta name="generator" content="Hexo 7.3.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">Linux 网络编程</h1><div class="meta"><span class="item" title="创建时间：2020-10-01 21:42:28"><span class="icon"><i class="ic i-calendar"></i></span><span class="text">发表于</span><time itemprop="dateCreated datePublished" datetime="2020-10-01T21:42:28+08:00">2020-10-01</time></span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i></span><span class="text">本文字数</span><span>53k</span><span class="text">字</span></span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i></span><span class="text">阅读时长</span><span>49 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span><span class="line"></span><span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">七葉の喫茶ステラ</a></li></ul><ul class="right" id="rightNav"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div class="pjax" id="imgs"><img src="https://dlink.host/1drv/aHR0cHM6Ly8xZHJ2Lm1zL2kvYy9iZGU1MWU2MjVlZjhmY2M1L0VhZktOSk82ZGdwTmhBTFJOOHM2U1E0QkhBc1BxbDNmTy1oWjZLVV9HeHVNekE_ZT0yNmdVUkU.png" loading="eager" decoding="async" fetchpriority="high" alt="Nana7ha's Café Stella"></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"></path></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"></use><use xlink:href="#gentle-wave" x="48" y="3"></use><use xlink:href="#gentle-wave" x="48" y="5"></use><use xlink:href="#gentle-wave" x="48" y="7"></use></g></svg></div><main><div class="inner"><div class="pjax" id="main"><div class="article wrap"><div class="breadcrumb" itemListElement itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i><span><a href="/">首页</a></span><i class="ic i-angle-right"></i><span itemprop="itemListElement" itemscope="itemscope" itemtype="https://schema.org/ListItem"><a href="/categories/c-cpp/" itemprop="item" rel="index" title="分类于C/C++"><span itemprop="name">C/C++<meta itemprop="position" content="0"/></span></a></span><i class="ic i-angle-right"></i><span class="current" itemprop="itemListElement" itemscope="itemscope" itemtype="https://schema.org/ListItem"><a href="/categories/c-cpp/linux-c/" itemprop="item" rel="index" title="分类于Linux C"><span itemprop="name">Linux C<meta itemprop="position" content="1"/></span></a></span></div><article class="post block" itemscope="itemscope" itemtype="http://schema.org/Article" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://cwlrin.github.io/c-cpp/linux-c/Linux%20%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/"/><span hidden="hidden" itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="image" content="/assets/avatar.jpg"/><meta itemprop="name" content="樱小路七叶"/><meta itemprop="description" content=", 技术与美日新月异"/></span><span hidden="hidden" itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="Nana7ha's Café Stella"/></span><div class="body md" itemprop="articleBody"><h2 id="地址处理"><a class="anchor" href="#地址处理">#</a> 地址处理</h2>
<h3 id="大端地址和小端地址"><a class="anchor" href="#大端地址和小端地址">#</a> 大端地址和小端地址</h3>
<h4 id="大端法和小端法"><a class="anchor" href="#大端法和小端法">#</a> 大端法和小端法</h4>
<p><strong>大端法（Big-Endian）</strong></p>
<p>在大端法中，一个多字节值的高位字节（即 “大端”）存储在内存的低地址端，而低位字节（即 “小端”）存储在高地址端。这种存储顺序使得大端法在字节对齐的内存访问中更为直观。</p>
<p><strong>小端法（Little-Endian）</strong></p>
<p>小端法与大端法相反，低位字节存储在内存的低地址端，而高位字节存储在高地址端。这种存储顺序在某些处理器架构中更为常见，如 x86 和 x64 架构。</p>
<p><strong>TCP/IP 协议中的字节序</strong></p>
<p>根据 TCP/IP 协议，当数据在网络上传输时，统一使用网络字节序，即大端法。这确保了不同主机间数据交换的一致性和兼容性。</p>
<p><strong>主机字节序</strong></p>
<p>大多数现代主机，尤其是使用 x86 和 x64 架构的个人电脑和服务器，包括 Intel 和 AMD 的处理器，通常使用小端法存储数据。这意味着在进行网络通信时，主机需要将数据从主机字节序转换为网络字节序。</p>
<h3 id="大小端转换"><a class="anchor" href="#大小端转换">#</a> 大小端转换</h3>
<h4 id="htonl-转换为大端序"><a class="anchor" href="#htonl-转换为大端序">#</a>  <code>htonl</code>  转换为大端序</h4>
<p><code>htonl</code>  是一个网络编程中常用的函数，用于将主机字节序（host byte order）的无符号整数转换为网络字节序（big-endian 字节序）。网络字节序总是大端序（big-endian），即最高位字节（most significant byte）在前。这个函数特别适用于在发送数据到网络或从网络接收数据时，确保数据的字节序一致性。</p>
<p>函数原型如下：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">uint32_t</span> <span class="token function">htonl</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> hostlong<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>参数说明： <code>uint32_t hostlong</code> : 这是需要转换的主机字节序的 32 位无符号整数。</p>
<p>返回值：返回转换后的网络字节序的 32 位无符号整数。</p>
<p>使用场景：</p>
<ul>
<li>当需要将数据发送到网络时，使用  <code>htonl</code>  将主机字节序的整数转换为网络字节序。</li>
<li>当从网络接收数据时，使用  <code>ntohl</code>  将接收到的网络字节序整数转换回主机字节序。</li>
</ul>
<p>工作机制： <code>htonl</code>  通过重新排列字节来转换整数的字节序。在小端序（little-endian）系统中，字节重新排列以形成大端序格式；在大端序系统中，整数保持不变。</p>
<p>示例：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token class-name">uint32_t</span> host_long <span class="token operator">=</span> <span class="token number">0x12345678</span><span class="token punctuation">;</span> <span class="token comment">// 示例主机字节序整数</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token class-name">uint32_t</span> net_long <span class="token operator">=</span> <span class="token function">htonl</span><span class="token punctuation">(</span>host_long<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 转换为网络字节序</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Host byte order: 0x%08X\n"</span><span class="token punctuation">,</span> host_long<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Network byte order: 0x%08X\n"</span><span class="token punctuation">,</span> net_long<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这个示例中定义了一个主机字节序的整数  <code>host_long</code> ，然后使用  <code>htonl</code>  函数将其转换为网络字节序的整数  <code>net_long</code> ，并打印出这两个整数。</p>
<h4 id="htons-转换为大端序"><a class="anchor" href="#htons-转换为大端序">#</a>  <code>htons</code>  转换为大端序</h4>
<p><code>htons</code>  是一个网络编程中用于字节序转换的函数，它将主机字节序（host byte order）的无符号短整数（ <code>uint16_t</code> ）转换为网络字节序（big-endian 字节序）。网络字节序是一种标准，用于确保在不同计算机架构之间通过网络传输数据时，多字节数据的字节序保持一致。</p>
<p>函数原型如下：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">uint16_t</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> hostshort<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>参数说明： <code>uint16_t hostshort</code> : 这是需要转换的主机字节序的 16 位无符号整数。</p>
<p>返回值：返回转换后的网络字节序的 16 位无符号整数。</p>
<p>使用场景：</p>
<ul>
<li>当需要将 16 位的整数发送到网络时，使用  <code>htons</code>  将主机字节序的整数转换为网络字节序。</li>
<li>当从网络接收 16 位的整数时，使用  <code>ntohs</code>  将接收到的网络字节序整数转换回主机字节序。</li>
</ul>
<p>工作机制： <code>htons</code>  通过交换整数的高位字节和低位字节来转换字节序。在小端序（little-endian）系统中，这个交换是必需的，以确保网络传输的数据具有统一的字节序。</p>
<p>示例：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token class-name">uint16_t</span> host_short <span class="token operator">=</span> <span class="token number">0x1234</span><span class="token punctuation">;</span> <span class="token comment">// 示例主机字节序短整数</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token class-name">uint16_t</span> net_short <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>host_short<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 转换为网络字节序</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Host byte order: 0x%04X\n"</span><span class="token punctuation">,</span> host_short<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Network byte order: 0x%04X\n"</span><span class="token punctuation">,</span> net_short<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这个示例中定义了一个主机字节序的短整数  <code>host_short</code> ，然后使用  <code>htons</code>  函数将其转换为网络字节序的短整数  <code>net_short</code> ，并打印出这两个整数。</p>
<h4 id="ntohl-转换为小端序"><a class="anchor" href="#ntohl-转换为小端序">#</a>  <code>ntohl</code>  转换为小端序</h4>
<p>是一个网络编程中用于将网络字节序（big-endian 字节序）的无符号整数转换回主机字节序的函数。这个函数与  <code>htonl</code>  相对应， <code>htonl</code>  用于将主机字节序的整数转换为网络字节序，而  <code>ntohl</code>  则用于完成相反的转换。</p>
<p>函数原型如下：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">uint32_t</span> <span class="token function">ntohl</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> netlong<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>参数说明： <code>uint32_t netlong</code> : 这是需要转换的网络字节序的 32 位无符号整数。</p>
<p>返回值：返回转换后的主机字节序的 32 位无符号整数。</p>
<p>使用场景：当从网络接收到一个 32 位整数数据时，使用  <code>ntohl</code>  将网络字节序的整数转换为主机字节序，以确保数据在主机上能够正确解释和使用。</p>
<p>工作机制： <code>ntohl</code>  执行的转换操作与  <code>htonl</code>  相反。它通过重新排列字节来将大端序格式的整数转换为主机字节序。在小端序（little-endian）的主机上，这涉及到交换字节；在大端序（big-endian）的主机上，整数保持不变。</p>
<p>示例：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token class-name">uint32_t</span> net_long <span class="token operator">=</span> <span class="token number">0x12345678</span><span class="token punctuation">;</span> <span class="token comment">// 示例网络字节序整数</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token class-name">uint32_t</span> host_long <span class="token operator">=</span> <span class="token function">ntohl</span><span class="token punctuation">(</span>net_long<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 转换为主机字节序</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Network byte order: 0x%08X\n"</span><span class="token punctuation">,</span> net_long<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Host byte order: 0x%08X\n"</span><span class="token punctuation">,</span> host_long<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这个示例中定义了一个网络字节序的整数  <code>net_long</code> ，然后使用  <code>ntohl</code>  函数将其转换为主机字节序的整数  <code>host_long</code> ，并打印出这两个整数。</p>
<h4 id="ntohs-转换为小端序"><a class="anchor" href="#ntohs-转换为小端序">#</a>  <code>ntohs</code>  转换为小端序</h4>
<p><code>ntohs</code>  是一个网络编程中用于将网络字节序（big-endian 字节序）的无符号短整数（ <code>uint16_t</code>  类型）转换回主机字节序的函数。这个函数与  <code>htons</code>  对应， <code>htons</code>  用于将主机字节序的短整数转换为网络字节序，而  <code>ntohs</code>  则用于完成相反的转换。</p>
<p>函数原型如下：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">uint16_t</span> <span class="token function">ntohs</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> netshort<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>参数说明： <code>uint16_t netshort</code> : 这是需要转换的网络字节序的 16 位无符号整数。</p>
<p>返回值：返回转换后的主机字节序的 16 位无符号整数。</p>
<p>使用场景：当从网络接收到一个 16 位整数数据时，使用  <code>ntohs</code>  将网络字节序的整数转换为主机字节序，以确保数据在主机上能够正确解释和使用。</p>
<p>工作机制： <code>ntohs</code>  执行的转换操作与  <code>htons</code>  相反。它通过交换整数的高位字节和低位字节来转换字节序。在小端序（little-endian）的主机上，这个交换是必需的，以确保网络传输的数据在主机上具有正确的字节序。</p>
<p>示例：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token class-name">uint16_t</span> net_short <span class="token operator">=</span> <span class="token number">0x1234</span><span class="token punctuation">;</span> <span class="token comment">// 示例网络字节序短整数</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token class-name">uint16_t</span> host_short <span class="token operator">=</span> <span class="token function">ntohs</span><span class="token punctuation">(</span>net_short<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 转换为主机字节序</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Network byte order: 0x%04X\n"</span><span class="token punctuation">,</span> net_short<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Host byte order: 0x%04X\n"</span><span class="token punctuation">,</span> host_short<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>在这个示例中，我们定义了一个网络字节序的短整数  <code>net_short</code> ，然后使用  <code>ntohs</code>  函数将其转换为主机字节序的短整数  <code>host_short</code> ，并打印出这两个整数。</p>
<h3 id="点分十进制转化"><a class="anchor" href="#点分十进制转化">#</a> 点分十进制转化</h3>
<h4 id="ip-结构体"><a class="anchor" href="#ip-结构体">#</a> IP 结构体</h4>
<p><code>sockaddr</code>  是一种通用的网络地址结构体，设计用于兼容 IPv4 和 IPv6 地址。由于其通用性， <code>sockaddr</code>  类型被广泛用作参数在各种网络接口中，如  <code>addrinfo</code>  结构体中的  <code>ai_addr</code>  成员。</p>
<p>尽管  <code>sockaddr</code>  足够通用，但它将 IP 地址和端口信息混合在一起，使用起来不够直观。因此，POSIX 标准进一步定义了  <code>sockaddr_in</code>  用于 IPv4 地址， <code>sockaddr_in6</code>  用于 IPv6 地址，提供了更具体的地址描述。</p>
<p>在需要通用地址参数的函数调用中，如  <code>bind()</code> 、 <code>connect()</code> 、 <code>accept()</code>  等，这些函数通常接受  <code>sockaddr</code>  类型的参数。在这种情况下，可以直接将  <code>sockaddr_in</code>  或  <code>sockaddr_in6</code>  结构体的指针转换为  <code>sockaddr</code>  类型，这种转换是安全的，因为  <code>sockaddr_in</code>  和  <code>sockaddr_in6</code>  是  <code>sockaddr</code>  的特定版本。</p>
<p><strong>IPv4 地址结构体</strong><br />
 <code>in_addr</code>  结构体用于存储 IPv4 地址，它包含一个  <code>s_addr</code>  成员，这是一个  <code>in_addr_t</code>  类型的无符号整数，用于表示 32 位的 IPv4 地址。</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">in_addr</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token class-name">in_addr_t</span> s_addr<span class="token punctuation">;</span>  <span class="token comment">// 存储 IPv4 地址的 32 位无符号整数</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p><strong>IPv4 套接字地址结构体</strong><br />
 <code>sockaddr_in</code>  结构体用于表示 IPv4 套接字地址，它包含地址族、端口号和 IPv4 地址。</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token class-name">sa_family_t</span> sin_family<span class="token punctuation">;</span>   <span class="token comment">// 地址族，对于 IPv4 是 AF_INET</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token class-name">in_port_t</span> sin_port<span class="token punctuation">;</span>       <span class="token comment">// 端口号，使用网络字节序</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">struct</span> <span class="token class-name">in_addr</span> sin_addr<span class="token punctuation">;</span>   <span class="token comment">// IPv4 地址</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p><strong>IPv6 地址结构体</strong><br />
对于 IPv6， <code>in6_addr</code>  结构体用于存储 128 位的 IPv6 地址。</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">in6_addr</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token class-name">uint8_t</span> s6_addr<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// 存储 IPv6 地址的 16 个字节</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h4 id="ip-地址转换函数"><a class="anchor" href="#ip-地址转换函数">#</a> <strong>IP 地址转换函数</strong></h4>
<p>POSIX 提供了一组函数来转换点分十进制的 IP 地址字符串和无符号整数表示的 IP 地址：</p>
<h5 id="inet_addr"><a class="anchor" href="#inet_addr">#</a>  <code>inet_addr</code></h5>
<p><code>inet_addr</code>   是一个 C 语言标准库函数，用于将一个以点分十进制表示的 IPv4 地址字符串转换为相应的 32 位网络字节序整数格式。这个函数是网络编程中常见的工具，用于处理和解析 IP 地址。</p>
<p>函数原型如下：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">in_addr_t</span> <span class="token function">inet_addr</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>cp<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>参数说明： <code>const char *cp</code> : 这是一个指向以 null 结尾的字符串的指针，该字符串包含了以点分十进制格式表示的 IPv4 地址，例如  <code>&quot;192.168.1.1&quot;</code> 。</p>
<p>返回值：</p>
<ul>
<li>如果转换成功，返回一个  <code>in_addr_t</code>  类型的值，这是 IPv4 地址的网络字节序表示。</li>
<li>如果字符串不是有效的 IP 地址，返回  <code>INADDR_NONE</code>  宏指定的特殊值，其通常定义为  <code>-1</code> 。</li>
</ul>
<p>使用场景：当需要将用户输入的 IP 地址或配置文件中的 IP 地址字符串转换为可用于网络操作的格式时。</p>
<p>工作机制： <code>inet_addr</code>  函数解析传入的字符串，将其分割为四个十进制数，并按照字符串中的顺序将这些数转换成一个 32 位的整数。这个整数是网络字节序格式，即大端序。</p>
<p>示例一：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h></span> <span class="token comment">// 应包含 inet_addr 函数的头文件</span></span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">char</span> <span class="token operator">*</span>ip <span class="token operator">=</span> <span class="token string">"116.162.172.51"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"IP address in dotted decimal notation: %s\n"</span><span class="token punctuation">,</span> ip<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token comment">// 使用 inet_addr 将点分十进制 IP 地址转换为网络字节序的整型数</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token class-name">in_addr_t</span> ip_int <span class="token operator">=</span> <span class="token function">inet_addr</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"IP address in network byte order (big-endian): %d\n"</span><span class="token punctuation">,</span> ip_int<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token comment">// 在小端存储的主机上，内存中的字节序与大端序不同</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token comment">// 因此，直接解引用 ip_int 的地址可能得到错误的字节</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">char</span> <span class="token operator">*</span>chr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>ip_int<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"First byte in memory (little-endian host): %c\n"</span><span class="token punctuation">,</span> <span class="token operator">*</span>chr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><ul>
<li><code>inet_addr</code>  函数接受一个点分十进制的 IP 地址字符串，并将其转换为网络字节序的整型数。网络字节序始终是大端序，即最高有效字节（MSB）存储在最低的内存地址处。</li>
<li>在小端存储的主机上，内存中的字节序与网络字节序不同。因此，直接访问  <code>ip_int</code>  的地址可能会得到错误的字节。在您的示例中，解引用  <code>ip_int</code>  的第一个字节作为字符输出，这在小端主机上将输出 IP 地址的最后一个字节对应的 ASCII 字符。</li>
<li>该代码演示了如何在小端主机上观察到这种差异，并且展示了如何将 IP 地址的整数表示转换回其原始的点分十进制形式。</li>
</ul>
<p><img loading="lazy" data-src="https://dlink.host/1drv/aHR0cHM6Ly8xZHJ2Lm1zL2kvYy9iZGU1MWU2MjVlZjhmY2M1L0VUV1E5a1c5bHVkRXNRVHhLakNfdjRBQktvVkdDSHFWVjl6VHgtOENTMEtCU3c_ZT1JRGZjZmk.png" alt="" /></p>
<h5 id="inet_aton"><a class="anchor" href="#inet_aton">#</a>  <code>inet_aton</code></h5>
<p><code>inet_aton</code>  是一个用于将 IPv4 地址的字符串表示形式转换为其二进制形式的函数。这个函数接受一个点分十进制的 IP 地址字符串，并尝试将其转换为一个  <code>in_addr</code>  结构，该结构内部使用网络字节序存储 IPv4 地址。</p>
<p>函数原型如下：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">int</span> <span class="token function">inet_aton</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>cp<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">in_addr</span> <span class="token operator">*</span>inp<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>参数说明：</p>
<ol>
<li>
<p><code>const char *cp</code> : 这是一个指向包含 IPv4 地址的字符串的指针，格式为点分十进制，例如  <code>&quot;192.168.1.1&quot;</code> 。</p>
</li>
<li>
<p><code>struct in_addr *inp</code> : 这是一个指向  <code>in_addr</code>  结构的指针，该结构用于接收转换后的 IPv4 地址。 <code>in_addr</code>  结构通常定义为包含一个  <code>s_addr</code>  成员，这是一个  <code>uint32_t</code>  类型的值，存储网络字节序的 IPv4 地址。</p>
</li>
</ol>
<p>返回值：</p>
<ul>
<li>如果转换成功，返回一个非零值（通常是 1）。</li>
<li>如果字符串不是有效的 IPv4 地址，返回 0。</li>
</ul>
<p>使用场景：当需要将表示为字符串的 IP 地址转换为二进制形式，以便于网络通信或进一步处理时。</p>
<p>工作机制： <code>inet_aton</code>  函数解析传入的字符串，验证它是否是有效的 IPv4 地址格式，并将其转换为网络字节序的 32 位整数。</p>
<p>示例：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h></span> <span class="token comment">// 应包含 inet_aton 函数的头文件</span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">char</span> <span class="token operator">*</span>ip <span class="token operator">=</span> <span class="token string">"116.162.172.51"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"IP address in dotted decimal notation: %s\n"</span><span class="token punctuation">,</span> ip<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token comment">// 使用 inet_aton 将点分十进制 IP 地址转换为 in_addr 结构体</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">struct</span> <span class="token class-name">in_addr</span> inp<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">inet_aton</span><span class="token punctuation">(</span>ip<span class="token punctuation">,</span> <span class="token operator">&amp;</span>inp<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Invalid IP address format.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"IP address in network byte order: %u\n"</span><span class="token punctuation">,</span> inp<span class="token punctuation">.</span>s_addr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token comment">// 在小端存储的主机上，第一个字节将是最低有效字节</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">char</span> <span class="token operator">*</span>chr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>inp<span class="token punctuation">.</span>s_addr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"First byte in memory (little-endian host): %c\n"</span><span class="token punctuation">,</span> <span class="token operator">*</span>chr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><ul>
<li><code>inet_aton</code>  函数接受一个点分十进制的 IP 地址字符串和一个  <code>in_addr</code>  结构体的指针。如果转换成功，它将 IP 地址转换为网络字节序的整型数并存储在  <code>in_addr</code>  结构体的  <code>s_addr</code>  成员中，函数返回非零值；如果转换失败，返回零。</li>
<li><code>inp.s_addr</code>  以网络字节序（大端序）存储 IP 地址。在网络通信中，这是标准形式。</li>
<li>在小端存储的主机上，当我们通过  <code>&amp;inp.s_addr</code>  获取  <code>s_addr</code>  的地址并将其作为字符解引用时，我们得到的是 IP 地址的最低有效字节对应的 ASCII 字符。在您的示例中，输出的是字符  <code>'t'</code> ，它是 IP 地址最后一个字节的 ASCII 表示。</li>
</ul>
<h5 id="inet_ntoa"><a class="anchor" href="#inet_ntoa">#</a>  <code>inet_ntoa</code></h5>
<p><code>inet_ntoa</code>  是一个将 IPv4 地址从其二进制形式转换回它的点分十进制字符串形式的函数。这个函数广泛用于网络编程，尤其是在需要将 IP 地址以人类可读的格式显示或记录到日志中时。</p>
<p>函数原型如下：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">inet_ntoa</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">in_addr</span> in<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>参数说明： <code>struct in_addr in</code> : 这是一个  <code>in_addr</code>  结构，包含了要转换的 IPv4 地址。这个地址必须以网络字节序存储，即大端序。</p>
<p>返回值：函数返回一个指向字符数组的指针，该数组包含了转换后的点分十进制格式的 IPv4 地址字符串。例如，对于给定的二进制 IPv4 地址，它可能返回  <code>&quot;192.168.1.1&quot;</code> 。</p>
<p>使用场景：当你有一个以二进制形式存储的 IPv4 地址，并且需要将其转换为字符串形式以进行显示或记录。</p>
<p>工作机制： <code>inet_ntoa</code>  函数接受一个  <code>in_addr</code>  结构作为参数，并将其中的网络字节序的 IPv4 地址转换为一个 null 结尾的字符串。</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h></span> <span class="token comment">// 应包含 inet_aton 和 inet_ntoa 函数的头文件</span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">char</span> <span class="token operator">*</span>ip1 <span class="token operator">=</span> <span class="token string">"192.168.10.1"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">struct</span> <span class="token class-name">in_addr</span> inp<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token comment">// 使用 inet_aton 将点分十进制 IP 地址转换为网络字节序的 IP 地址</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">inet_aton</span><span class="token punctuation">(</span>ip1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>inp<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Invalid IP address format.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token comment">// 使用 inet_ntoa 将网络字节序的 IP 地址转换回点分十进制 IP 地址的字符串形式</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">char</span> <span class="token operator">*</span>ipStr <span class="token operator">=</span> <span class="token function">inet_ntoa</span><span class="token punctuation">(</span>inp<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"IP address in dotted decimal notation: %s\n"</span><span class="token punctuation">,</span> ipStr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><ul>
<li><code>inet_aton</code>  函数将点分十进制格式的 IP 地址字符串转换为网络字节序的整型数，并存储在  <code>in_addr</code>  结构体中。如果输入的字符串不是有效的 IP 地址， <code>inet_aton</code>  将返回 0。</li>
<li><code>inet_ntoa</code>  函数执行相反的操作，它将  <code>in_addr</code>  结构体中的网络字节序 IP 地址转换为点分十进制格式的字符串。这个字符串是通过动态分配内存创建的，因此程序员需要确保在使用完毕后释放它。</li>
</ul>
<h3 id="dns"><a class="anchor" href="#dns">#</a> DNS</h3>
<p>在网络通信中，域名和 IP 地址之间的映射至关重要。DNS 协议作为核心机制，通过全球分布的 DNS 服务器来维护这一映射关系。虽然可以通过修改本地  <code>hosts</code>  文件来实现简单的映射，但面对广泛的互联网访问，DNS 提供了一种更为通用和强大的解决方案。</p>
<p>在编程实践中，可以使用  <code>getaddrinfo</code>  函数来执行域名解析，获取主机的 IP 地址信息。这个函数支持 IPv4 和 IPv6，并且能够返回与给定域名相关的所有 IP 地址。相比之下， <code>gethostbyname</code>  函数由于其局限性，已逐渐被新的 API 所取代。</p>
<h2 id="tcp"><a class="anchor" href="#tcp">#</a> TCP</h2>
<h3 id="基于-tcp-的-socket-通信流程"><a class="anchor" href="#基于-tcp-的-socket-通信流程">#</a> 基于 TCP 的 Socket 通信流程</h3>
<p><img loading="lazy" data-src="https://dlink.host/1drv/aHR0cHM6Ly8xZHJ2Lm1zL2kvYy9iZGU1MWU2MjVlZjhmY2M1L0VZYW8tLURXWnpaS2xvVFhaTy1QSVVnQm5TVnFuVlAyM0hDQ0F2UzN2eVEyUEE_ZT1hdkplZXM.png" alt="TCPSocket.png" /></p>
<h3 id="socket-创建通信端点"><a class="anchor" href="#socket-创建通信端点">#</a>  <code>socket</code>  创建通信端点</h3>
<p><code>socket</code>  函数是网络编程中的一个基础函数，用于创建一个端点（endpoint），即 socket。在 POSIX 兼容的操作系统中，几乎所有的网络通信都是通过 socket 进行的。</p>
<p>函数原型如下：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">int</span> <span class="token function">socket</span><span class="token punctuation">(</span><span class="token keyword">int</span> domain<span class="token punctuation">,</span> <span class="token keyword">int</span> type<span class="token punctuation">,</span> <span class="token keyword">int</span> protocol<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>参数说明：</p>
<ol>
<li>
<p><code>int domain</code> : 指定通信协议的家族。最常见的值是  <code>AF_INET</code>  用于 IPv4 通信， <code>AF_INET6</code>  用于 IPv6 通信，还有  <code>AF_UNIX</code>  用于 Unix 域套接字等。</p>
</li>
<li>
<p><code>int type</code> : 指定 socket 的类型，这决定了 socket 支持的通信语义。常见的类型包括：</p>
<ul>
<li><code>SOCK_STREAM</code> ：提供基于连接的、可靠的字节流服务，通常用于 TCP 连接。</li>
<li><code>SOCK_DGRAM</code> ：提供无连接的、尽最大努力交付的数据报服务，通常用于 UDP 通信。</li>
<li><code>SOCK_SEQPACKET</code> ：提供有序、可靠的、固定长度的包服务。</li>
</ul>
</li>
<li>
<p><code>int protocol</code> : 指定使用的具体协议。对于  <code>AF_INET</code>  域，常用的值是  <code>IPPROTO_TCP</code>  和  <code>IPPROTO_UDP</code> 。如果设置为 0，系统会自动选择一个合适的协议。</p>
</li>
</ol>
<p>返回值：</p>
<ul>
<li>如果创建成功，返回一个新的 socket 文件描述符。</li>
<li>如果创建失败，返回 -1，并设置全局变量  <code>errno</code>  以指示错误类型。</li>
</ul>
<p>使用场景：</p>
<ul>
<li>当需要建立网络连接，无论是客户端还是服务器端。</li>
<li>当需要使用高级网络特性，如多播、广播或其他特定的网络协议。</li>
</ul>
<p>工作机制：</p>
<ul>
<li><code>socket</code>  函数调用操作系统内核，请求创建一个 socket 结构，并分配一个文件描述符用于后续操作。</li>
<li>创建的 socket 可以用于绑定（ <code>bind</code> ）、监听（ <code>listen</code> ）、接受连接（ <code>accept</code> ）、连接（ <code>connect</code> ）、发送数据（ <code>send</code> 、 <code>recv</code> ）等操作。</li>
</ul>
<p>示例：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">int</span> sockfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>sockfd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Failed to create socket"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Socket created successfully, sockfd: %d\n"</span><span class="token punctuation">,</span> sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token comment">// 接下来可以对 socket 进行其他操作，如 bind、listen 等</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token comment">// 最后关闭 socket</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>在这个示例中，我们创建了一个基于 IPv4 的 TCP socket。如果 socket 创建成功，我们打印出 socket 文件描述符。在实际使用中，接下来会对这个 socket 进行绑定端口、监听连接等操作。最后，使用  <code>close</code>  函数关闭 socket。</p>
<p><img loading="lazy" data-src="https://dlink.host/1drv/aHR0cHM6Ly8xZHJ2Lm1zL2kvYy9iZGU1MWU2MjVlZjhmY2M1L0VaVGVMRTZsV0cxUG5mOHRzdzFNVE8wQlczNUhuUGZNZWhKUDFhdnJvRm1QTmc_ZT1XOXZ1RVU.png" alt="socket.png" /></p>
<p><strong>socket 函数的作用</strong>：  <code>socket</code>  函数在内核中创建了一个用于网络通信的对象。尽管它返回一个文件描述符来标识这个对象，但这个对象并不是传统意义上的文件对象。它是一个特殊的内核对象，用于管理和维护网络连接的状态和信息。</p>
<p><strong>socket 对象包含的信息</strong>： socket 对象中包含了进行网络通信所需的各种信息和状态，例如：</p>
<ul>
<li>地址族（Address Family，如 AF_INET 用于 IPv4 或 AF_INET6 用于 IPv6）</li>
<li>类型（Type，如 SOCK_STREAM 用于 TCP 或 SOCK_DGRAM 用于 UDP）</li>
<li>协议（Protocol，指定使用的传输协议，如 IPPROTO_TCP 或 IPPROTO_UDP）</li>
<li>地址（Socket Address，包含 IP 地址和端口号）</li>
</ul>
<p><strong>缓冲区的重要性</strong>： 除了上述信息，socket 对象还维护了两个极其重要的缓冲区：</p>
<ul>
<li>输入缓冲区（SO_RCVBUF）：用于临时存储从网络接收的数据。当数据到达时，首先被存储在这个缓冲区中，直到应用程序准备好读取它们。</li>
<li>输出缓冲区（SO_SNDBUF）：用于存储待发送到网络的数据。应用程序写入数据后，数据会被放入这个缓冲区，并在适当的时候被发送出去。</li>
</ul>
<p>这两个缓冲区对于流量控制和避免数据丢失至关重要。它们的默认大小可以在系统级别进行配置，通过读取和修改  <code>/proc/sys/net/core/rmem_default</code>  和  <code>/proc/sys/net/core/wmem_default</code>  文件来实现。</p>
<h3 id="bind-绑定-socket-到网络地址和端口"><a class="anchor" href="#bind-绑定-socket-到网络地址和端口">#</a>  <code>bind</code>  绑定 socket 到网络地址和端口</h3>
<p><code>bind</code>  函数在网络编程中用于将一个 socket 绑定到一个特定的网络地址和端口上。这个函数允许 socket 监听特定地址上的连接请求或数据报。</p>
<p>函数原型如下：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">int</span> <span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>addr<span class="token punctuation">,</span> <span class="token class-name">socklen_t</span> addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>参数说明：</p>
<ol>
<li>
<p><code>int sockfd</code> : 这是由  <code>socket</code>  函数创建的 socket 的文件描述符。</p>
</li>
<li>
<p><code>const struct sockaddr *addr</code> : 这是一个指向  <code>sockaddr</code>  结构的指针，该结构包含了要绑定到 socket 上的地址信息。 <code>sockaddr</code>  是一个通用的结构，对于不同的地址族（如  <code>AF_INET</code> 、 <code>AF_INET6</code>  等），它可能包含不同的具体结构（如  <code>sockaddr_in</code> 、 <code>sockaddr_in6</code>  等）。</p>
</li>
<li>
<p><code>socklen_t addrlen</code> : 这是  <code>addr</code>  参数指向的地址结构的大小（以字节为单位）。这个参数应该准确设置，以便  <code>bind</code>  函数知道结构的长度。</p>
</li>
</ol>
<p>返回值：</p>
<ul>
<li>如果绑定成功，返回 0。</li>
<li>如果绑定失败，返回 -1，并设置全局变量  <code>errno</code>  以指示错误类型。</li>
</ul>
<p>使用场景：</p>
<ul>
<li>当服务器应用程序需要在特定的端口上监听客户端的连接请求时。</li>
<li>当需要在特定的网络接口上接收数据报时。</li>
</ul>
<p>工作机制：</p>
<ul>
<li><code>bind</code>  函数将 socket 关联到  <code>addr</code>  指定的地址和端口上。这通常用于服务器应用程序，它们需要在固定的端口上监听。</li>
<li>一旦绑定，socket 就可以使用  <code>listen</code>  和  <code>accept</code>  函数来接受传入的连接请求，或者使用  <code>recvfrom</code>  和  <code>sendto</code>  函数来接收和发送数据报。</li>
</ul>
<p>示例：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">int</span> sockfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>sockfd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Failed to create socket"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Socket created successfully, sockfd: %d\n"</span><span class="token punctuation">,</span> sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    </pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> server_addr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>server_addr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>server_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    server_addr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    server_addr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">8080</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 绑定到 8080 端口</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    server_addr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">htonl</span><span class="token punctuation">(</span>INADDR_ANY<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 绑定到所有可用接口</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">bind</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>server_addr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>server_addr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Failed to bind"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Server bound to port 8080\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token comment">// 接下来可以对 socket 进行监听等操作</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token comment">// 最后关闭 socket</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>在这个示例中，我们首先创建了一个 socket，然后初始化了一个  <code>sockaddr_in</code>  结构，设置为监听所有接口上的 8080 端口。我们使用  <code>bind</code>  函数将 socket 绑定到这个地址和端口上。如果绑定成功，我们可以继续使用  <code>listen</code>  和  <code>accept</code>  函数来接受客户端连接。最后，我们关闭 socket。</p>
<p>在网络编程实践中，合理选择端口号并正确使用  <code>bind</code>  函数对于网络服务的配置至关重要。知名端口通常被保留给标准服务使用，因此建议新应用程序使用 1024 以上的端口号以避免冲突。</p>
<p>使用  <code>bind</code>  函数时，需要确保提供的地址信息采用大端法表示，这可能涉及到适当的类型转换。服务器在设置监听地址时，可以选择使用特殊 IP 地址，如  <code>0.0.0.0</code>  表示接受所有接口的连接，或者  <code>127.0.0.1</code>  用于仅限本机的回环连接。</p>
<p>对于客户端，通常不需要显式执行  <code>bind</code>  操作，因为操作系统会自动分配一个临时端口。但在需要指定通信接口时，客户端也可以执行  <code>bind</code>  操作。服务端则必须执行  <code>bind</code>  操作以监听并接受进入的连接，不执行  <code>bind</code>  的服务端在逻辑上没有意义，也不符合网络服务的常规操作。</p>
<h3 id="listen-转换-socket-为被动监听模式"><a class="anchor" href="#listen-转换-socket-为被动监听模式">#</a>  <code>listen</code>  转换 socket 为被动监听模式</h3>
<p><code>listen</code>  函数在网络编程中用于将一个 socket 从主动连接模式转换为被动监听模式。也就是说，它使得 socket 准备好接受来自其他 socket 的连接请求。通常在服务器端的 socket 初始化过程中使用。</p>
<p>函数原型如下：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">int</span> <span class="token function">listen</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">int</span> backlog<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>参数说明：</p>
<ol>
<li>
<p><code>int sockfd</code> : 这是由  <code>socket</code>  函数创建并由  <code>bind</code>  函数绑定到特定地址和端口的 socket 的文件描述符。</p>
</li>
<li>
<p><code>int backlog</code> : 这个参数指定了操作系统可以挂起的未完成连接请求的最大数量。当新的连接到来时，如果服务器还没有接受这个连接，那么这个连接会被放入一个队列中，队列的最大长度由  <code>backlog</code>  参数决定。</p>
</li>
</ol>
<p>返回值：</p>
<ul>
<li>如果调用成功，返回 0。</li>
<li>如果调用失败，返回 -1，并设置全局变量  <code>errno</code>  以指示错误类型。</li>
</ul>
<p>使用场景：当服务器应用程序准备就绪，可以开始接受客户端的连接请求时。</p>
<p>工作机制：</p>
<ul>
<li><code>listen</code>  函数使得 socket 进入监听状态，准备好接受传入的连接请求。</li>
<li>一旦调用  <code>listen</code>  函数，socket 就不能再用于发起连接，而只能用于接受连接。</li>
</ul>
<p>示例：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">int</span> sockfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>sockfd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Failed to create socket"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Socket created successfully, sockfd: %d\n"</span><span class="token punctuation">,</span> sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    </pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> server_addr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>server_addr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>server_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    server_addr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    server_addr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">8080</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 绑定到 8080 端口</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    server_addr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">htonl</span><span class="token punctuation">(</span>INADDR_ANY<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 绑定到所有可用接口</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">bind</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>server_addr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>server_addr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Failed to bind"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Server bound to port 8080\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token comment">// 将 socket 设置为监听模式</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">listen</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 例如，设置 backlog 为 5</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Failed to listen"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Server is listening for connections...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token comment">// 接下来可以使用 accept 函数来接受客户端连接</span></pre></td></tr><tr><td data-num="39"></td><td><pre></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token comment">// 最后关闭 socket</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>在这个示例中，我们首先创建了一个 socket，然后调用  <code>listen</code>  函数将其设置为监听模式，并指定了 backlog 参数。如果  <code>listen</code>  调用成功，服务器就准备好接受连接请求了。我们使用  <code>accept</code>  函数来接受客户端的连接。</p>
<p><img loading="lazy" data-src="https://dlink.host/1drv/aHR0cHM6Ly8xZHJ2Lm1zL2kvYy9iZGU1MWU2MjVlZjhmY2M1L0VhQWxyUXRxX2hKT3RXWk9WdGhLSVNjQm5KdC03MzFMbG82Zk5SSWdESW9ZOEE_ZT1QbmFpZlo.png" alt="listensocket.png" /></p>
<p>启用  <code>listen</code>  函数后，服务端套接字在操作系统内核中的行为发生变化，内核将不再使用该套接字的发送和接收缓冲区，而是开始维护两个关键队列：半连接队列和全连接队列。</p>
<ul>
<li><strong>半连接队列</strong>：管理那些已经通过 TCP 三次握手的第一次握手的连接请求。这通常发生在客户端发送 SYN 报文后，服务端收到并准备响应。</li>
<li><strong>全连接队列</strong>：管理已经完成 TCP 三次握手的连接。这意味着客户端和服务器端已经交换了 SYN 和 ACK 报文，连接已建立。</li>
</ul>
<p><code>backlog</code>  参数定义了全连接队列的最大长度。在一些系统中，它可能影响半连接队列的长度或两者的总长度。如果全连接队列已满，新的连接请求将被服务端丢弃，且通常不会有任何响应发送给客户端，这促使客户端根据 TCP 的重传机制进行重传。通常设置一个合理的正数值即可。</p>
<p>可以使用  <code>netstat -an</code>  命令来检查特定端口的监听状态，通过结合  <code>grep</code>  工具可以快速过滤出特定端口的相关信息，从而监控和诊断网络服务的状态。例如，通过管道命令  <code>netstat -an | grep 12345</code>  可以过滤并查看端口 12345 的监听状态。</p>
<h3 id="connect-初始化连接到指定服务器的-socket"><a class="anchor" href="#connect-初始化连接到指定服务器的-socket">#</a>  <code>connect</code>  初始化连接到指定服务器的 socket</h3>
<p><code>connect</code>  函数在网络编程中用于初始化一个连接到指定的服务器 socket。对于客户端应用程序来说， <code>connect</code>  函数是建立到服务器的主动连接的关键步骤。</p>
<p>函数原型如下：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">int</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>addr<span class="token punctuation">,</span> <span class="token class-name">socklen_t</span> addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>参数说明：</p>
<ol>
<li>
<p><code>int sockfd</code> : 这是由  <code>socket</code>  函数创建的 socket 的文件描述符。</p>
</li>
<li>
<p><code>const struct sockaddr *addr</code> : 这是一个指向  <code>sockaddr</code>  结构的指针，该结构包含了要连接到的服务器的地址信息。这通常包括服务器的 IP 地址和端口号。</p>
</li>
<li>
<p><code>socklen_t addrlen</code> : 这是  <code>addr</code>  参数指向的地址结构的大小（以字节为单位）。这个参数应该准确设置，以便  <code>connect</code>  函数知道结构的长度。</p>
</li>
</ol>
<p>返回值：</p>
<ul>
<li>如果连接建立成功，返回 0。</li>
<li>如果连接建立失败，返回 -1，并设置全局变量  <code>errno</code>  以指示错误类型。</li>
</ul>
<p>使用场景：当客户端应用程序需要与服务器建立 TCP 或 UDP 连接时。</p>
<p>工作机制：</p>
<ul>
<li><code>connect</code>  函数尝试将 socket 连接到  <code>addr</code>  指定的远程地址和端口。</li>
<li>对于非阻塞 socket，如果连接正在进行中， <code>connect</code>  函数会立即返回，此时可以通过选择机制（使用  <code>select</code>  或  <code>poll</code> ）来检测 socket 是否已连接。</li>
</ul>
<p>示例：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">int</span> sockfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>sockfd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Failed to create socket"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Socket created successfully, sockfd: %d\n"</span><span class="token punctuation">,</span> sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> server_addr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>server_addr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>server_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    server_addr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    server_addr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">8080</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 连接到端口 8080</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    server_addr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">inet_addr</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 连接到本地地址</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token comment">// 尝试连接到服务器</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">connect</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>server_addr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>server_addr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Failed to connect"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Connected to server\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token comment">// 接下来可以进行数据传输等操作</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token comment">// 最后关闭 socket</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>在这个示例中，我们首先创建了一个 socket，然后初始化了一个  <code>sockaddr_in</code>  结构，设置为连接到本地主机的 8080 端口。我们使用  <code>connect</code>  函数尝试建立到服务器的连接。如果连接成功，我们可以进行数据传输等操作。最后，我们关闭 socket。</p>
<p>在 TCP/IP 网络通信中，客户端通过调用  <code>connect</code>  函数来尝试与服务端建立连接。如果客户端在调用  <code>connect</code>  之前没有使用  <code>bind</code>  函数来明确指定本地端口，操作系统将自动为客户端选择一个临时端口号作为源端口。</p>
<p><code>connect</code>  函数的目标是完成 TCP 协议中的三次握手过程，这是建立一个可靠连接的必要步骤。然而，如果服务端没有在目标端口上监听，或者端口号未被正确配置，客户端将收到一个重置（RST）报文。这种情况下，客户端的  <code>connect</code>  调用将失败，并报告 &quot;Connection refused&quot; 错误。</p>
<h3 id="accept-接受一个连接请求"><a class="anchor" href="#accept-接受一个连接请求">#</a>  <code>accept</code>  接受一个连接请求</h3>
<p><code>accept</code>  函数在网络编程中用于接受一个连接请求。当服务器 socket 通过  <code>listen</code>  函数设置为监听模式后，它会等待客户端的连接请求。当一个连接请求到达时，服务器可以使用  <code>accept</code>  函数来接受这个连接，从而创建一个新的连接 socket。</p>
<p>函数原型如下：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">int</span> <span class="token function">accept</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>addr<span class="token punctuation">,</span> <span class="token class-name">socklen_t</span> <span class="token operator">*</span>addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>参数说明：</p>
<ol>
<li>
<p><code>int sockfd</code> : 这是服务器端的 socket 文件描述符，该 socket 已经通过  <code>listen</code>  函数设置为监听模式。</p>
</li>
<li>
<p><code>struct sockaddr *addr</code> : 这是一个指向  <code>sockaddr</code>  结构的指针，用于接收连接客户端的地址信息。如果不需要客户端地址，可以传递  <code>NULL</code> 。</p>
</li>
<li>
<p><code>socklen_t *addrlen</code> : 这是一个指向  <code>socklen_t</code>  类型的指针，指定  <code>addr</code>  参数指向的地址结构的大小。在调用  <code>accept</code>  时，这个值应该设置为地址结构的最大期望大小。调用成功后， <code>accept</code>  函数会更新这个值为实际的地址结构大小。</p>
</li>
</ol>
<p>返回值：</p>
<ul>
<li>如果连接被成功接受，返回一个新的 socket 文件描述符，用于与连接的客户端进行通信。</li>
<li>如果连接请求被拒绝或等待队列为空， <code>accept</code>  函数会阻塞，直到有新的连接请求到达（对于阻塞 socket）。</li>
<li>如果出现错误，返回 -1，并设置全局变量  <code>errno</code>  以指示错误类型。</li>
</ul>
<p>使用场景：当服务器应用程序需要接受客户端的连接请求时。</p>
<p>工作机制：</p>
<ul>
<li><code>accept</code>  函数从服务器 socket 的连接请求队列中取出第一个请求，并创建一个新的 socket 用于与客户端通信。</li>
<li>如果  <code>addr</code>  参数不是  <code>NULL</code> ， <code>accept</code>  函数会填充该参数指向的结构，包含连接客户端的地址信息。</li>
</ul>
<p>示例：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">int</span> sockfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>sockfd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Failed to create socket"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token comment">// 绑定 socket 到地址和端口的代码 ...</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> server_addr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>server_addr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>server_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    server_addr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    server_addr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">8080</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    server_addr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">htonl</span><span class="token punctuation">(</span>INADDR_ANY<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">bind</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>server_addr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>server_addr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Failed to bind"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token comment">// 将 socket 设置为监听模式</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">listen</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Failed to listen"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="33"></td><td><pre></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> client_addr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token class-name">socklen_t</span> client_addrlen <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>client_addr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token comment">// 接受客户端连接</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token keyword">int</span> client_sockfd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>client_addr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>client_addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>client_sockfd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Failed to accept connection"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>        <span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="44"></td><td><pre></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Accepted connection from client\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre></pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token comment">// 使用 client_sockfd 与客户端进行通信</span></pre></td></tr><tr><td data-num="48"></td><td><pre></pre></td></tr><tr><td data-num="49"></td><td><pre>    <span class="token comment">// 最后关闭 socket</span></pre></td></tr><tr><td data-num="50"></td><td><pre>    <span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>在这个示例中，我们首先创建了一个 socket 并将其设置为监听模式。然后我们使用  <code>accept</code>  函数接受客户端的连接请求。如果连接成功， <code>accept</code>  函数返回一个新的 socket 文件描述符  <code>client_sockfd</code> ，我们可以使用这个新的 socket 来与客户端进行通信。如果连接失败，我们打印错误信息并关闭 socket。</p>
<p>在使用  <code>accept</code>  函数时，需要注意  <code>addrlen</code>  参数是一个传入传出参数，需要调用者预先分配足够的内存空间，以存储客户端的地址信息。通常使用  <code>sizeof(addr)</code>  来确定所需空间。</p>
<p><code>accept</code>  函数是服务端用来从全连接队列中提取已完成 TCP 三次握手的连接的。如果队列为空， <code>accept</code>  将阻塞，等待新的连接请求。当有新连接到达时， <code>accept</code>  变得 “读就绪”，允许服务端接受连接。</p>
<p>一旦  <code>accept</code>  被调用并执行，内核将为新的 TCP 连接创建一个新的套接字文件对象，其文件描述符由  <code>accept</code>  返回。这个新套接字拥有独立的发送和接收缓冲区，专门用于这条 TCP 连接上的数据传输。</p>
<p><img loading="lazy" data-src="https://dlink.host/1drv/aHR0cHM6Ly8xZHJ2Lm1zL2kvYy9iZGU1MWU2MjVlZjhmY2M1L0VhQWxyUXRxX2hKT3RXWk9WdGhLSVNjQm5KdC03MzFMbG82Zk5SSWdESW9ZOEE_ZT1QbmFpZlo.png" alt="accept.png" /></p>
<p>服务端通常使用两个套接字对象：监听套接字和已连接套接字。</p>
<ul>
<li><strong>监听套接字</strong>：用于管理连接队列，负责建立新的 TCP 连接。只要源 IP、源端口、目的 IP、目的端口四元组中任意字段有区别，就认为是一个新的 TCP 连接。</li>
<li><strong>已连接套接字</strong>：用于特定 TCP 连接的数据通信。服务端通过这个套接字与客户端进行数据的发送和接收。</li>
</ul>
<h3 id="send-向已连接的-socket-发送数据"><a class="anchor" href="#send-向已连接的-socket-发送数据">#</a>  <code>send</code>  向已连接的 socket 发送数据</h3>
<p><code>send</code>  函数在网络编程中用于向已连接的 socket 发送数据。对于基于连接的通信协议（如 TCP）， <code>send</code>  函数用于发送数据到与 socket 已建立连接的远程 socket。对于无连接的通信协议（如 UDP）， <code>send</code>  函数用于向指定的地址和端口发送数据。</p>
<p>函数原型如下：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">ssize_t</span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> len<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>参数说明：</p>
<ol>
<li>
<p><code>int sockfd</code> : 这是 socket 的文件描述符，该 socket 可以是已连接的也可以是无连接的，取决于使用的通信协议。</p>
</li>
<li>
<p><code>const void *buf</code> : 这是一个指向要发送数据缓冲区的指针。数据将从这个缓冲区中取得并发送。</p>
</li>
<li>
<p><code>size_t len</code> : 这是要发送数据的长度（以字节为单位）。</p>
</li>
<li>
<p><code>int flags</code> : 这是一组选项标志，用于修改发送行为。常用的标志包括：</p>
<ul>
<li><code>MSG_OOB</code> : 发送带外数据（out-of-band data）。</li>
<li><code>MSG_DONTROUTE</code> : 不要对数据执行路由查找，直接发送。</li>
<li><code>MSG_EOR</code> : 表示记录结束（仅用于 SOCK_SEQPACKET 类型的 socket）。</li>
<li>大多数情况下设置为 0。</li>
</ul>
</li>
</ol>
<p>返回值：</p>
<ul>
<li>如果调用成功，返回已发送的字节数。</li>
<li>如果调用失败，返回 -1，并设置全局变量  <code>errno</code>  以指示错误类型。</li>
</ul>
<p>使用场景：</p>
<ul>
<li>当需要向已建立连接的远程 socket 发送数据时。</li>
<li>当需要向特定地址发送无连接的数据报时。</li>
</ul>
<p>工作机制：</p>
<ul>
<li><code>send</code>  函数从  <code>buf</code>  指向的缓冲区中取得数据，并尝试发送  <code>len</code>  字节的数据。</li>
<li>对于非阻塞 socket，如果数据不能立即发送， <code>send</code>  函数会返回已经发送的字节数，剩余的数据可以稍后再发送。</li>
</ul>
<p>示例：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">int</span> sockfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>sockfd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Failed to create socket"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token comment">// 连接到服务器的代码 ...</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>message <span class="token operator">=</span> <span class="token string">"Hello, server!"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token class-name">ssize_t</span> sent <span class="token operator">=</span> <span class="token function">send</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> message<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>sent <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Failed to send message"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Sent %zd bytes to server\n"</span><span class="token punctuation">,</span> sent<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token comment">// 关闭 socket</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>在这个示例中，我们首先创建了一个 socket，然后使用  <code>send</code>  函数向已连接的服务器发送一条消息。如果消息成功发送，我们打印出发送的字节数。如果发送失败，我们打印错误信息并关闭 socket。</p>
<h3 id="recv-从-socket-接收数据"><a class="anchor" href="#recv-从-socket-接收数据">#</a>  <code>recv</code>  从 socket 接收数据</h3>
<p><code>recv</code>  函数在网络编程中用于从 socket 接收数据。这个函数可以用于阻塞和非阻塞 socket，并且支持多种通信协议，包括 TCP 和 UDP。</p>
<p>函数原型如下：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">ssize_t</span> <span class="token function">recv</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> len<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>参数说明：</p>
<ol>
<li>
<p><code>int sockfd</code> : 这是 socket 的文件描述符，用于指定从哪个 socket 接收数据。</p>
</li>
<li>
<p><code>void *buf</code> : 这是一个指向缓冲区的指针， <code>recv</code>  函数将把接收到的数据存储在这个缓冲区。</p>
</li>
<li>
<p><code>size_t len</code> : 这是缓冲区的大小，即可以接收的数据的最大字节数。</p>
</li>
<li>
<p><code>int flags</code> : 这是一个选项标志，用于修改接收行为。常用的标志包括：</p>
<ul>
<li><code>0</code> : 正常接收数据。</li>
<li><code>MSG_OOB</code> : 接收带外数据（out-of-band data）。</li>
<li><code>MSG_PEEK</code> : 窥视接收数据，即读取数据但不去删除缓冲区中的数据。</li>
</ul>
</li>
</ol>
<p>返回值：</p>
<ul>
<li>如果调用成功，返回接收到的字节数，这个值可能会小于  <code>len</code> ，表示接收到的数据量。</li>
<li>如果连接已关闭并且没有更多数据可接收，返回 0。</li>
<li>如果调用失败，返回 -1，并设置全局变量  <code>errno</code>  以指示错误类型。</li>
</ul>
<p>使用场景：</p>
<ul>
<li>当需要从已连接的 socket 或无连接的 socket 接收数据时。</li>
</ul>
<p>工作机制：</p>
<ul>
<li><code>recv</code>  函数从 socket 的接收缓冲区中提取数据，并将其存储到  <code>buf</code>  指向的缓冲区。</li>
<li>对于非阻塞 socket，如果缓冲区中没有数据可接收， <code>recv</code>  函数会立即返回，而不是等待数据到达。</li>
</ul>
<p>示例：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">int</span> sockfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>sockfd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Failed to create socket"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token comment">// 连接到服务器的代码 ...</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">char</span> buffer<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token class-name">ssize_t</span> received <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>received <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Failed to receive data"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>received <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Connection closed by the server.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Received %zd bytes from server\n"</span><span class="token punctuation">,</span> received<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token comment">// 处理接收到的数据</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token comment">// 关闭 socket</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>在这个示例中，我们首先创建了一个 socket，然后使用  <code>recv</code>  函数从服务器接收数据。如果数据成功接收，我们打印出接收到的字节数。如果接收到的数据为 0，表示连接已被关闭。如果接收失败，我们打印错误信息并关闭 socket。</p>
<h3 id="close-关闭文件描述符"><a class="anchor" href="#close-关闭文件描述符">#</a>  <code>close</code>   关闭文件描述符</h3>
<p><code>close</code>  函数用于关闭一个文件描述符（file descriptor），释放与该描述符关联的所有资源。在 UNIX 和类 UNIX 系统（包括 POSIX 兼容的系统）中，文件描述符不仅用于文件 I/O，也用于网络通信、管道等其他 I/O 操作。</p>
<p>函数原型如下：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">int</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>参数说明： <code>int fd</code> : 这是要关闭的文件描述符的整数标识符。</p>
<p>返回值：</p>
<ul>
<li>如果函数调用成功，返回 0。</li>
<li>如果调用失败，返回 -1，并设置全局变量  <code>errno</code>  以指示错误类型。</li>
</ul>
<p>使用场景：</p>
<ul>
<li>当文件或 socket 等资源不再需要时，应当关闭它们以释放系统资源。</li>
<li>在完成 I/O 操作后，确保不会有数据丢失或资源泄露。</li>
</ul>
<p>工作机制：</p>
<ul>
<li><code>close</code>  函数通知操作系统关闭指定的文件描述符，操作系统随后会释放与该描述符关联的所有资源，包括内存、内核缓冲区等。</li>
<li>如果文件描述符关联的是文件， <code>close</code>  函数还会触发任何必要的数据同步操作，确保所有缓冲区中的数据被写入到磁盘。</li>
</ul>
<h3 id="tcp-通信代码示例"><a class="anchor" href="#tcp-通信代码示例">#</a> TCP 通信代码示例</h3>
<h4 id="客户端"><a class="anchor" href="#客户端">#</a> 客户端</h4>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdc.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token keyword">char</span> <span class="token operator">*</span>sourceIP <span class="token operator">=</span> <span class="token string">"172.16.0.3"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token keyword">char</span> <span class="token operator">*</span>sourcePort <span class="token operator">=</span> <span class="token string">"8080"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token keyword">int</span> socketFd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>socketFd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Failed to create socket"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token function">close</span><span class="token punctuation">(</span>socketFd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token comment">// 方式一: inet_addr</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token comment">// 把点分十进制，转成 in_addr_t 类型 (网络 IP),  把其存储到结构体 in_addr</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token comment">// 类型中 in_addr_t addrTIP = inet_addr (sourceIP); struct in_addr inAddr;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token comment">// inAddr.s_addr = addrTIP;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token comment">// 方式二: inet_aton</span></pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token keyword">struct</span> <span class="token class-name">in_addr</span> inAddr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>  <span class="token function">inet_aton</span><span class="token punctuation">(</span>sourceIP<span class="token punctuation">,</span> <span class="token operator">&amp;</span>inAddr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>  <span class="token comment">// 把端口转为 int 类型</span></pre></td></tr><tr><td data-num="24"></td><td><pre>  <span class="token keyword">int</span> sourcePortInt <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>sourcePort<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>  <span class="token comment">// 把端口号：有主机字节序，转为网络字节序</span></pre></td></tr><tr><td data-num="26"></td><td><pre>  <span class="token keyword">int</span> sourcePortNet <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>sourcePortInt<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre>  <span class="token comment">// 构建 "struct sockaddr" 类型</span></pre></td></tr><tr><td data-num="29"></td><td><pre>  <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> socketAddr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>  socketAddr<span class="token punctuation">.</span>sin_addr <span class="token operator">=</span> inAddr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>  socketAddr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> sourcePortNet<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>  socketAddr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre></pre></td></tr><tr><td data-num="34"></td><td><pre>  <span class="token comment">// 客户端向服务器发起建立连接请求</span></pre></td></tr><tr><td data-num="35"></td><td><pre>  <span class="token keyword">int</span> res_connet <span class="token operator">=</span> <span class="token function">connect</span><span class="token punctuation">(</span>socketFd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>socketAddr<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="36"></td><td><pre>                           <span class="token keyword">sizeof</span><span class="token punctuation">(</span>socketAddr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>res_connet <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Failed to connet socket"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token function">close</span><span class="token punctuation">(</span>socketFd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="42"></td><td><pre></pre></td></tr><tr><td data-num="43"></td><td><pre>  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token comment">// 读取标准输入</span></pre></td></tr><tr><td data-num="46"></td><td><pre>    <span class="token function">read</span><span class="token punctuation">(</span>STDIN_FILENO<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token comment">// 把标准输入，发送给服务器</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    <span class="token keyword">int</span> res_send <span class="token operator">=</span> <span class="token function">send</span><span class="token punctuation">(</span>socketFd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>res_send <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>      <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Failed to send socket"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>      <span class="token function">close</span><span class="token punctuation">(</span>socketFd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>      <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="54"></td><td><pre></pre></td></tr><tr><td data-num="55"></td><td><pre>    <span class="token keyword">char</span> buf2<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>    <span class="token comment">// 读取对方输入</span></pre></td></tr><tr><td data-num="57"></td><td><pre>    <span class="token keyword">int</span> ret_recv <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>socketFd<span class="token punctuation">,</span> buf2<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf2<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret_recv <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>      <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Failed to recv socket"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>      <span class="token function">close</span><span class="token punctuation">(</span>socketFd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>      <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ret_recv <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>      <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"other close"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>      <span class="token function">close</span><span class="token punctuation">(</span>socketFd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>      <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>    <span class="token comment">// 打印到标准输出</span></pre></td></tr><tr><td data-num="68"></td><td><pre>    <span class="token function">write</span><span class="token punctuation">(</span>STDOUT_FILENO<span class="token punctuation">,</span> buf2<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="70"></td><td><pre></pre></td></tr><tr><td data-num="71"></td><td><pre>  <span class="token function">close</span><span class="token punctuation">(</span>socketFd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="73"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="服务端"><a class="anchor" href="#服务端">#</a> 服务端</h4>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdc.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token keyword">char</span> <span class="token operator">*</span>sourceIP <span class="token operator">=</span> <span class="token string">"172.16.0.3"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token keyword">char</span> <span class="token operator">*</span>sourcePort <span class="token operator">=</span> <span class="token string">"8080"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token keyword">int</span> socketFd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>socketFd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Failed to create socket"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token function">close</span><span class="token punctuation">(</span>socketFd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token comment">// 方式一: inet_addr</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token comment">// 把 点分十进制，转成 in_addr_t 类型 (网络 IP),  把其存储到结构体 in_addr 类型中</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token comment">// in_addr_t addrTIP = inet_addr(sourceIP);</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token comment">// struct in_addr inAddr;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token comment">// inAddr.s_addr = addrTIP;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token comment">// 方式二: inet_aton</span></pre></td></tr><tr><td data-num="21"></td><td><pre>  <span class="token keyword">struct</span> <span class="token class-name">in_addr</span> inAddr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token function">inet_aton</span><span class="token punctuation">(</span>sourceIP<span class="token punctuation">,</span> <span class="token operator">&amp;</span>inAddr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre>  <span class="token comment">// 把端口转为 int 类型</span></pre></td></tr><tr><td data-num="25"></td><td><pre>  <span class="token keyword">int</span> sourcePortInt <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>sourcePort<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>  <span class="token comment">// 把端口号：有主机字节序，转为网络字节序</span></pre></td></tr><tr><td data-num="27"></td><td><pre>  <span class="token keyword">int</span> sourcePoreNet <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>sourcePortInt<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre>  <span class="token comment">// 构建 "struct sockaddr" 类型</span></pre></td></tr><tr><td data-num="30"></td><td><pre>  <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> socketAddr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>  socketAddr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>  socketAddr<span class="token punctuation">.</span>sin_addr <span class="token operator">=</span> inAddr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>  socketAddr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> sourcePoreNet<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre></pre></td></tr><tr><td data-num="35"></td><td><pre>  <span class="token comment">//bind: 绑定端口</span></pre></td></tr><tr><td data-num="36"></td><td><pre>  <span class="token keyword">int</span> res_bind <span class="token operator">=</span></pre></td></tr><tr><td data-num="37"></td><td><pre>      <span class="token function">bind</span><span class="token punctuation">(</span>socketFd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>socketAddr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>socketAddr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>res_bind <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Faild to bind socket"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token function">close</span><span class="token punctuation">(</span>socketFd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="43"></td><td><pre></pre></td></tr><tr><td data-num="44"></td><td><pre>  <span class="token comment">//listen: 监听端口</span></pre></td></tr><tr><td data-num="45"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">listen</span><span class="token punctuation">(</span>socketFd<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Failed to listen socket"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token function">close</span><span class="token punctuation">(</span>socketFd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="50"></td><td><pre></pre></td></tr><tr><td data-num="51"></td><td><pre>  <span class="token comment">//accept: 获取连接</span></pre></td></tr><tr><td data-num="52"></td><td><pre>  <span class="token keyword">int</span> connectFd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>socketFd<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>connectFd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Failed to accept socket"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>    <span class="token function">close</span><span class="token punctuation">(</span>socketFd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>    <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="58"></td><td><pre></pre></td></tr><tr><td data-num="59"></td><td><pre>  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>    <span class="token keyword">char</span> buf2<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>    <span class="token comment">// 读取对方输入</span></pre></td></tr><tr><td data-num="62"></td><td><pre>    <span class="token keyword">int</span> res_recv <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>connectFd<span class="token punctuation">,</span> buf2<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf2<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>res_recv <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>      <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Failed to recv socket"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>      <span class="token function">close</span><span class="token punctuation">(</span>socketFd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>      <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>res_recv <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>      <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Other close"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>      <span class="token function">close</span><span class="token punctuation">(</span>socketFd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>      <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>    <span class="token comment">// 打印到标准输出</span></pre></td></tr><tr><td data-num="73"></td><td><pre>    <span class="token function">write</span><span class="token punctuation">(</span>STDOUT_FILENO<span class="token punctuation">,</span> buf2<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre></pre></td></tr><tr><td data-num="75"></td><td><pre>    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>    <span class="token comment">// 读取标准输入</span></pre></td></tr><tr><td data-num="77"></td><td><pre>    <span class="token function">read</span><span class="token punctuation">(</span>STDIN_FILENO<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="78"></td><td><pre></pre></td></tr><tr><td data-num="79"></td><td><pre>    <span class="token comment">// 把标准输入，发送给服务器</span></pre></td></tr><tr><td data-num="80"></td><td><pre>    <span class="token keyword">int</span> res_send <span class="token operator">=</span> <span class="token function">send</span><span class="token punctuation">(</span>connectFd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>res_send <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="82"></td><td><pre>      <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Failed to send socket"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="83"></td><td><pre>      <span class="token function">close</span><span class="token punctuation">(</span>socketFd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="84"></td><td><pre>      <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="85"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="86"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="87"></td><td><pre>  <span class="token function">close</span><span class="token punctuation">(</span>socketFd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="88"></td><td><pre></pre></td></tr><tr><td data-num="89"></td><td><pre>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="90"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="结合-select-通信"><a class="anchor" href="#结合-select-通信">#</a> 结合  <code>Select</code>  通信</h3>
<h4 id="客户端-2"><a class="anchor" href="#客户端-2">#</a> 客户端</h4>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdc.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token keyword">char</span> <span class="token operator">*</span>sourceIP <span class="token operator">=</span> <span class="token string">"172.16.0.3"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token keyword">char</span> <span class="token operator">*</span>sourcePort <span class="token operator">=</span> <span class="token string">"8080"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token keyword">int</span> socketFd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>socketFd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Failed to create socket"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token function">close</span><span class="token punctuation">(</span>socketFd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token comment">// 方式一: inet_addr</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token comment">// 把 点分十进制，转成 in_addr_t 类型 (网络 IP),  把其存储到结构体 in_addr</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token comment">// 类型中 in_addr_t addrTIP = inet_addr (sourceIP); struct in_addr inAddr;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token comment">// inAddr.s_addr = addrTIP;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token comment">// 方式二: inet_aton</span></pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token keyword">struct</span> <span class="token class-name">in_addr</span> inAddr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>  <span class="token function">inet_aton</span><span class="token punctuation">(</span>sourceIP<span class="token punctuation">,</span> <span class="token operator">&amp;</span>inAddr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>  <span class="token comment">// 把端口转为 int 类型</span></pre></td></tr><tr><td data-num="24"></td><td><pre>  <span class="token keyword">int</span> sourcePortInt <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>sourcePort<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>  <span class="token comment">// 把端口号：有主机字节序，转为网络字节序</span></pre></td></tr><tr><td data-num="26"></td><td><pre>  <span class="token keyword">int</span> sourcePortNet <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>sourcePortInt<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre>  <span class="token comment">// 构建 "struct sockaddr" 类型</span></pre></td></tr><tr><td data-num="29"></td><td><pre>  <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> socketAddr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>  socketAddr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>  socketAddr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> sourcePortInt<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>  socketAddr<span class="token punctuation">.</span>sin_addr <span class="token operator">=</span> inAddr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre></pre></td></tr><tr><td data-num="34"></td><td><pre>  <span class="token comment">// 客户端向服务器发起建立连接请求</span></pre></td></tr><tr><td data-num="35"></td><td><pre>  <span class="token keyword">int</span> res_connect <span class="token operator">=</span></pre></td></tr><tr><td data-num="36"></td><td><pre>      <span class="token function">connect</span><span class="token punctuation">(</span>socketFd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>socketAddr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>socketAddr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>res_connect<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Failed to connect socket"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token function">close</span><span class="token punctuation">(</span>socketFd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="42"></td><td><pre></pre></td></tr><tr><td data-num="43"></td><td><pre>  fd_set read_fd_set<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token function">FD_ZERO</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>read_fd_set<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>    <span class="token function">FD_SET</span><span class="token punctuation">(</span>socketFd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>read_fd_set<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token function">FD_SET</span><span class="token punctuation">(</span>STDIN_FILENO<span class="token punctuation">,</span> <span class="token operator">&amp;</span>read_fd_set<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre></pre></td></tr><tr><td data-num="49"></td><td><pre>    <span class="token function">select</span><span class="token punctuation">(</span>socketFd <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>read_fd_set<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre></pre></td></tr><tr><td data-num="51"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">FD_ISSET</span><span class="token punctuation">(</span>STDIN_FILENO<span class="token punctuation">,</span> <span class="token operator">&amp;</span>read_fd_set<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>      <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">60</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>      <span class="token comment">// 读取标准输入</span></pre></td></tr><tr><td data-num="54"></td><td><pre>      <span class="token keyword">int</span> res_read <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>STDIN_FILENO<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>res_read <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>        <span class="token comment">// 用户输入了 EOF 字符：在大多数 UNIX 和 Linux 系统上，EOF 字符默认是</span></pre></td></tr><tr><td data-num="57"></td><td><pre>        <span class="token comment">// Ctrl+D</span></pre></td></tr><tr><td data-num="58"></td><td><pre>        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>      <span class="token comment">// 把标准输入，发送给服务器</span></pre></td></tr><tr><td data-num="61"></td><td><pre>      <span class="token keyword">int</span> res_send <span class="token operator">=</span> <span class="token function">send</span><span class="token punctuation">(</span>socketFd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>res_send <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Failed to send socket"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>        <span class="token function">close</span><span class="token punctuation">(</span>socketFd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="68"></td><td><pre></pre></td></tr><tr><td data-num="69"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">FD_ISSET</span><span class="token punctuation">(</span>socketFd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>read_fd_set<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>      <span class="token keyword">char</span> buf2<span class="token punctuation">[</span><span class="token number">60</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>      <span class="token comment">// 读取对方输入</span></pre></td></tr><tr><td data-num="72"></td><td><pre>      <span class="token keyword">int</span> res_recv <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>socketFd<span class="token punctuation">,</span> buf2<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf2<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>res_recv <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Failed to recv socket"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>        <span class="token function">close</span><span class="token punctuation">(</span>socketFd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="78"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>res_recv <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"对方已断开连接 \ n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="80"></td><td><pre>        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="82"></td><td><pre>      <span class="token comment">// 打印到标准输出</span></pre></td></tr><tr><td data-num="83"></td><td><pre>      <span class="token function">write</span><span class="token punctuation">(</span>STDOUT_FILENO<span class="token punctuation">,</span> buf2<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="84"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="85"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="86"></td><td><pre>  <span class="token function">close</span><span class="token punctuation">(</span>socketFd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="87"></td><td><pre>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="88"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="服务端-2"><a class="anchor" href="#服务端-2">#</a> 服务端</h4>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdc.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token keyword">char</span> <span class="token operator">*</span>sourceIP <span class="token operator">=</span> <span class="token string">"172.16.0.3"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token keyword">char</span> <span class="token operator">*</span>sourcePort <span class="token operator">=</span> <span class="token string">"8080"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token keyword">int</span> socketFd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>socketFd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Failed to create socket"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token function">close</span><span class="token punctuation">(</span>socketFd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token comment">// 方式一: inet_addr</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token comment">// 把 点分十进制，转成 in_addr_t 类型 (网络 IP),  把其存储到结构体 in_addr 类型中</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token comment">// in_addr_t addrTIP = inet_addr(sourceIP);</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token comment">// struct in_addr inAddr;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token comment">// inAddr.s_addr = addrTIP;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token comment">// 方式二: inet_aton</span></pre></td></tr><tr><td data-num="21"></td><td><pre>  <span class="token keyword">struct</span> <span class="token class-name">in_addr</span> inAddr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token function">inet_aton</span><span class="token punctuation">(</span>sourceIP<span class="token punctuation">,</span> <span class="token operator">&amp;</span>inAddr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>  <span class="token comment">// 把端口转为 int 类型</span></pre></td></tr><tr><td data-num="24"></td><td><pre>  <span class="token keyword">int</span> sourcePortInt <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>sourcePort<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>  <span class="token comment">// 把端口号：有主机字节序，转为网络字节序</span></pre></td></tr><tr><td data-num="26"></td><td><pre>  <span class="token keyword">int</span> sourcePortNet <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>sourcePortInt<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>  <span class="token comment">// 构建 "struct sockaddr" 类型</span></pre></td></tr><tr><td data-num="28"></td><td><pre>  <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> socketAddr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>  socketAddr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>  socketAddr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> sourcePortInt<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>  socketAddr<span class="token punctuation">.</span>sin_addr <span class="token operator">=</span> inAddr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>  <span class="token comment">//bind: 绑定端口</span></pre></td></tr><tr><td data-num="33"></td><td><pre>  <span class="token keyword">int</span> res_bind <span class="token operator">=</span></pre></td></tr><tr><td data-num="34"></td><td><pre>      <span class="token function">bind</span><span class="token punctuation">(</span>socketFd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>socketAddr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>socketAddr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>res_bind<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Failed to bind socket"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token function">close</span><span class="token punctuation">(</span>socketFd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>  <span class="token comment">//listen: 监听端口</span></pre></td></tr><tr><td data-num="41"></td><td><pre>  <span class="token function">listen</span><span class="token punctuation">(</span>socketFd<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>  <span class="token comment">//accept: 获取连接</span></pre></td></tr><tr><td data-num="43"></td><td><pre>  <span class="token keyword">int</span> connectFd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>socketFd<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre></pre></td></tr><tr><td data-num="45"></td><td><pre>  fd_set read_fd_set<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token function">FD_ZERO</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>read_fd_set<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    <span class="token function">FD_SET</span><span class="token punctuation">(</span>connectFd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>read_fd_set<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>    <span class="token function">FD_SET</span><span class="token punctuation">(</span>STDIN_FILENO<span class="token punctuation">,</span> <span class="token operator">&amp;</span>read_fd_set<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>    <span class="token function">select</span><span class="token punctuation">(</span>connectFd <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>read_fd_set<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre></pre></td></tr><tr><td data-num="52"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">FD_ISSET</span><span class="token punctuation">(</span>connectFd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>read_fd_set<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>      <span class="token keyword">char</span> buf2<span class="token punctuation">[</span><span class="token number">60</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>      <span class="token comment">// 读取对方输入</span></pre></td></tr><tr><td data-num="55"></td><td><pre>      <span class="token keyword">int</span> res_recv <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>connectFd<span class="token punctuation">,</span> buf2<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf2<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>res_recv <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Failed to recv socket"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>        <span class="token function">close</span><span class="token punctuation">(</span>socketFd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>res_recv <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>        <span class="token comment">// 判断对方是否已经关闭连接</span></pre></td></tr><tr><td data-num="62"></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"對方斷開連接 \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>      <span class="token comment">// 打印到标准输出</span></pre></td></tr><tr><td data-num="66"></td><td><pre>      <span class="token function">write</span><span class="token punctuation">(</span>STDOUT_FILENO<span class="token punctuation">,</span> buf2<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="68"></td><td><pre></pre></td></tr><tr><td data-num="69"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">FD_ISSET</span><span class="token punctuation">(</span>STDIN_FILENO<span class="token punctuation">,</span> <span class="token operator">&amp;</span>read_fd_set<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>      <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">60</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>      <span class="token comment">// 读取标准输入</span></pre></td></tr><tr><td data-num="72"></td><td><pre>      <span class="token keyword">int</span> res_read <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>STDIN_FILENO<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>res_read <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Failed to read socket"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>        <span class="token function">close</span><span class="token punctuation">(</span>socketFd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>res_read <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="78"></td><td><pre>        <span class="token comment">// 用户输入了 EOF 字符：在大多数 UNIX 和 Linux 系统上，EOF 字符默认是 Ctrl+D</span></pre></td></tr><tr><td data-num="79"></td><td><pre>        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="80"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>      <span class="token comment">// 把标准输入，发送给服务器</span></pre></td></tr><tr><td data-num="82"></td><td><pre>      <span class="token keyword">int</span> res_send <span class="token operator">=</span> <span class="token function">send</span><span class="token punctuation">(</span>connectFd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="83"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>res_send <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="84"></td><td><pre>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Failed to send socket"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="85"></td><td><pre>        <span class="token function">close</span><span class="token punctuation">(</span>socketFd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="86"></td><td><pre>        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="87"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="88"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="89"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="90"></td><td><pre>  <span class="token function">close</span><span class="token punctuation">(</span>connectFd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="91"></td><td><pre>  <span class="token function">close</span><span class="token punctuation">(</span>socketFd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="92"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="select-断开重连"><a class="anchor" href="#select-断开重连">#</a> Select 断开重连</h4>
<p>在现代网络通信中，客户端与服务器之间的连接可能会由于多种不可预测的因素而中断。为了确保会话的持续性并提供连贯的服务体验，当客户端尝试重新建立连接时，服务器端必须具备有效的重连策略。</p>
<p>每次在重新调用 Select 函数之前，必须重置文件描述符集合。Select 函数在执行后，会更新集合以仅包含那些已经准备好进行 IO 操作的文件描述符。为了确保所有可能的连接请求都能被检测到，需要在每次调用前重置集合。</p>
<p>Select 函数的第一个参数，即最大文件描述符加 1 的值，应该设置得足够大。这样做可以避免因文件描述符范围限制而错过对新连接套接字的监听。</p>
<p>通过 Socket 的全连接队列获取新连接的过程，本质上是一种读操作的就绪状态。这意味着可以使用 Select 来监听 Socket 的状态，当检测到读操作就绪时，即表示有新的连接请求到达，此时应调用 accept 函数来接受这一连接。</p>
<h3 id="ddos"><a class="anchor" href="#ddos">#</a> DDoS</h3>
<p>在网络通信中，半连接队列的设计初衷是为了处理并发连接请求，但这一机制也可能被恶意利用。攻击者通过发送伪造的 SYN 请求，却无意完成 TCP 三次握手过程，从而发起所谓的 &quot;半开放连接&quot; 攻击。这些请求的源地址可能是随机生成的，或者通过感染其他计算机来发起，导致服务器端必须维护一个庞大的半连接队列。</p>
<p>当半连接数量积累到一定程度时，服务器的资源将被大量占用，从而无法及时响应新的正常连接请求。这种现象被称为分布式拒绝服务攻击（DDoS）。</p>
<p>为了防御 DDoS 攻击，可以采取多种措施，包括减少 SYN+ACK 的重传次数、增加半连接队列的长度，以及启用 SYN Cookies。SYN Cookies 是一种在 TCP 连接建立过程中，服务器不立即为请求分配存储空间，而是通过生成一个带有签名的序列号来验证请求的合法性，从而有效过滤掉伪造的连接请求。</p>
<p>然而，在面对高强度的 DDoS 攻击时，仅仅调整  <code>tcp_syn_retries</code> （SYN 重传次数）和  <code>tcp_max_syn_backlog</code> （半连接队列的最大长度）并不能从根本上解决问题。更有效的防御策略是启用  <code>tcp_syncookies</code> 。该机制允许服务器在确认连接请求的合法性之前，不分配资源来存储连接状态，从而减轻服务器的负担并提高对伪造请求的抵抗力。</p>
<h3 id="tcpdump"><a class="anchor" href="#tcpdump">#</a> tcpdump</h3>
<p><strong>tcpdump</strong> 是一款强大的网络分析工具，它能够捕获并分析网络上的数据包。在网络问题诊断过程中， <code>tcpdump</code>  可以提供实时的网络流量信息，帮助我们理解连接的状态。</p>
<p><strong>观察连接状态</strong>：</p>
<ul>
<li>使用  <code>ss -tn</code>  命令可以查看 TCP 连接的状态，其中  <code>-t</code>  表示显示 TCP 连接， <code>-n</code>  表示不解析服务名称，直接显示端口号。</li>
<li><code>netstat -tn</code>  命令同样可以提供 TCP 连接的统计信息，包括端口号和连接状态。</li>
</ul>
<p><strong>使用 tcpdump 捕获数据包</strong>：</p>
<ul>
<li><code>tcpdump</code>  命令可以捕获经过网络接口的数据包。为了保存捕获的数据包以供后续分析，可以使用  <code>-w</code>  选项指定输出文件。</li>
<li>示例命令： <code>sudo tcpdump -w a.txt</code> ，该命令会将捕获的数据包保存到  <code>a.txt</code>  文件中。</li>
</ul>
<p><strong>数据包分析</strong>：</p>
<ul>
<li>捕获的数据包可以使用  <code>Wireshark</code>  或其他网络分析工具打开和分析。这有助于进一步诊断网络问题，如连接中断、数据包丢失等。</li>
</ul>
<h2 id="udp"><a class="anchor" href="#udp">#</a> UDP</h2>
<p><img loading="lazy" data-src="https://dlink.host/1drv/aHR0cHM6Ly8xZHJ2Lm1zL2kvYy9iZGU1MWU2MjVlZjhmY2M1L0VaWk1mYmNEZnlwRGdMQjN5ZGh0MEkwQnMxUWhSd3o4ajR1RVh3d2Y4TlM3dEE_ZT1lYVUxcWQ.png" alt="UDP.png" /></p>
<h3 id="socket-创建通信端点-2"><a class="anchor" href="#socket-创建通信端点-2">#</a>  <code>socket</code>  创建通信端点</h3>
<p>函数定义同 2.2</p>
<h3 id="bind-绑定-socket-到网络地址和端口-2"><a class="anchor" href="#bind-绑定-socket-到网络地址和端口-2">#</a>  <code>bind</code>  绑定 socket 到网络地址和端口</h3>
<p>函数定义同 2.3</p>
<h3 id="sendto-发送数据"><a class="anchor" href="#sendto-发送数据">#</a>  <code>sendto</code>  发送数据</h3>
<p><code>sendto</code>  函数用于在数据报（无连接）socket 上发送数据。与  <code>send</code>  函数不同， <code>sendto</code>  需要显式指定目标地址，因为数据报 socket 是无连接的，所以每次发送数据时都需要指明接收方的地址。</p>
<p>函数原型如下：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">ssize_t</span> <span class="token function">sendto</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> len<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>                <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>dest_addr<span class="token punctuation">,</span> <span class="token class-name">socklen_t</span> addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>参数说明：</p>
<ol>
<li>
<p><code>int sockfd</code> : 要用来发送数据的 socket 的文件描述符。</p>
</li>
<li>
<p><code>const void *buf</code> : 指向要发送的数据缓冲区的指针。</p>
</li>
<li>
<p><code>size_t len</code> : 要发送的数据的长度（以字节为单位）。</p>
</li>
<li>
<p><code>int flags</code> : 用于修改发送行为的选项标志。常用的标志包括：</p>
<ul>
<li><code>MSG_DONTROUTE</code> : 不对数据进行路由选择，直接发送。</li>
<li><code>MSG_OOB</code> : 发送带外数据（out-of-band data）。</li>
</ul>
</li>
<li>
<p><code>const struct sockaddr *dest_addr</code> : 指向目标地址的  <code>sockaddr</code>  结构的指针，该结构包含了接收方的地址信息。</p>
</li>
<li>
<p><code>socklen_t addrlen</code> :  <code>dest_addr</code>  参数指向的地址结构的大小（以字节为单位）。</p>
</li>
</ol>
<p>返回值：</p>
<ul>
<li>如果调用成功，返回已发送的字节数。</li>
<li>如果调用失败，返回 -1，并设置全局变量  <code>errno</code>  以指示错误类型。</li>
</ul>
<p>使用场景：</p>
<ul>
<li>当需要使用 UDP 协议发送数据到特定的地址和端口时。</li>
<li>当 socket 是无连接的，并且每次发送都需要指定目标地址时。</li>
</ul>
<p>工作机制：</p>
<ul>
<li><code>sendto</code>  函数从  <code>buf</code>  指向的缓冲区中取出数据，并将其发送到  <code>dest_addr</code>  指定的地址。</li>
<li>该函数适用于  <code>SOCK_DGRAM</code>  类型的 socket，它允许应用程序发送数据报到网络，而不需要事先建立连接。</li>
</ul>
<p>示例：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">int</span> sockfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_DGRAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>sockfd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Failed to create socket"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>message <span class="token operator">=</span> <span class="token string">"Hello, UDP server!"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> server_addr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>server_addr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>server_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    server_addr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    server_addr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">12345</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 服务器端口号</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    server_addr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">inet_addr</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 服务器地址</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token class-name">ssize_t</span> sent <span class="token operator">=</span> <span class="token function">sendto</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> message<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="22"></td><td><pre>                          <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>server_addr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>server_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>sent <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Failed to send message"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Sent %zd bytes to server\n"</span><span class="token punctuation">,</span> sent<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>在这个示例中，我们首先创建了一个 UDP socket，然后构造了一个包含服务器地址信息的  <code>sockaddr_in</code>  结构。使用  <code>sendto</code>  函数将消息发送到这个地址。如果发送成功，我们打印出发送的字节数。如果发送失败，我们打印错误信息并关闭 socket。</p>
<h3 id="recvfrom-接收数据"><a class="anchor" href="#recvfrom-接收数据">#</a>  <code>recvfrom</code>  接收数据</h3>
<p><code>recvfrom</code>  函数在网络编程中用于接收无连接 socket 上的数据报。与  <code>recv</code>  函数不同， <code>recvfrom</code>  允许你接收来自任何远程地址的数据，因为你在无连接 socket 上接收数据时，可能不知道数据的来源。</p>
<p>函数原型如下：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">ssize_t</span> <span class="token function">recvfrom</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> len<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>                  <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>src_addr<span class="token punctuation">,</span> <span class="token class-name">socklen_t</span> <span class="token operator">*</span>addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>参数说明：</p>
<ol>
<li>
<p><code>int sockfd</code> : 要用来接收数据的 socket 的文件描述符。</p>
</li>
<li>
<p><code>void *buf</code> : 指向一个缓冲区的指针， <code>recvfrom</code>  函数将把接收到的数据存储在这个缓冲区。</p>
</li>
<li>
<p><code>size_t len</code> : 缓冲区的大小，即可以接收的最大数据长度（以字节为单位）。</p>
</li>
<li>
<p><code>int flags</code> : 用于修改接收行为的选项标志。常用的标志包括：</p>
<ul>
<li><code>0</code> : 正常接收数据。</li>
<li><code>MSG_PEEK</code> : 窥视接收数据，即读取数据但不去删除缓冲区中的数据。</li>
</ul>
</li>
<li>
<p><code>struct sockaddr *src_addr</code> : 这是一个可选参数，指向  <code>sockaddr</code>  结构的指针，用于接收发送方的地址信息。如果不需要发送方地址，可以传递  <code>NULL</code> 。</p>
</li>
<li>
<p><code>socklen_t *addrlen</code> : 指向  <code>socklen_t</code>  类型的指针，指定  <code>src_addr</code>  参数指向的地址结构的大小。在调用  <code>recvfrom</code>  时，这个值应该设置为地址结构的最大期望大小。调用成功后， <code>recvfrom</code>  函数会更新这个值为实际的地址结构大小。</p>
</li>
</ol>
<p>返回值：</p>
<ul>
<li>如果调用成功，返回接收到的字节数。</li>
<li>如果调用失败，返回 -1，并设置全局变量  <code>errno</code>  以指示错误类型。</li>
</ul>
<p>使用场景：当需要使用 UDP 协议接收数据时，因为 UDP 是无连接的，每次接收数据都需要知道发送方的地址。</p>
<p>工作机制：</p>
<ul>
<li><code>recvfrom</code>  函数从指定的 socket 接收数据，并将数据存储在  <code>buf</code>  指向的缓冲区。</li>
<li>如果提供了  <code>src_addr</code>  参数， <code>recvfrom</code>  函数会填充该参数指向的结构，包含发送方的地址信息。</li>
</ul>
<p>示例：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h></span></span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">int</span> sockfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_DGRAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>sockfd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Failed to create socket"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">char</span> buffer<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> src_addr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token class-name">socklen_t</span> src_addrlen <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>src_addr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token class-name">ssize_t</span> received <span class="token operator">=</span> <span class="token function">recvfrom</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="20"></td><td><pre>                                 <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>src_addr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>src_addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>received <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Failed to receive data"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>received <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"No data received.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Received %zd bytes from %s:%d\n"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="29"></td><td><pre>               received<span class="token punctuation">,</span> <span class="token function">inet_ntoa</span><span class="token punctuation">(</span>src_addr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">ntohs</span><span class="token punctuation">(</span>src_addr<span class="token punctuation">.</span>sin_port<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token comment">// 处理接收到的数据</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token comment">// 关闭 socket</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这个示例中首先创建了一个 UDP socket，然后使用  <code>recvfrom</code>  函数接收数据。如果数据成功接收，打印出接收到的字节数以及发送方的地址和端口。如果接收失败，打印错误信息并关闭 socket。</p>
<h2 id="epoll"><a class="anchor" href="#epoll">#</a> Epoll</h2>
<h3 id="select-的缺陷"><a class="anchor" href="#select-的缺陷">#</a>  <code>select</code>  的缺陷</h3>
<p>在实现 I/O 多路复用技术时采用  <code>select</code>  函数来监听多个文件描述符的状态能够使得程序在单个线程或进程中同时管理多个 I/O 操作。这种方法避免了为每个 I/O 操作使用阻塞调用或为每个操作分配独立的线程或进程，从而提高了效率。</p>
<p>然而在处理大量文件描述符或追求更高性能的场景中， <code>select</code>  函数的一些局限性变得明显，这促使我们考虑更先进的替代方案，如  <code>epoll</code> 。</p>
<h3 id="select-函数的局限性"><a class="anchor" href="#select-函数的局限性">#</a>  <code>select</code>  函数的局限性：</h3>
<ol>
<li><strong>文件描述符数量限制</strong>： <code>select</code>  函数支持的文件描述符数量有限，通常  <code>fd_set</code>  的大小为 1024。对于需要处理成千上万个并发连接的大型服务器来说，这一限制可能成为瓶颈。</li>
<li><strong>数据复制开销</strong>：每次调用  <code>select</code>  时，都需要将整个 <strong>文件描述符集合</strong> 从 <strong>用户空间</strong> 复制到 <strong>内核空间</strong>，检查完毕后再将 <strong>就绪描述符集合</strong> 从 <strong>内核空间</strong> 复制回 <strong>用户空间</strong>。随着监听的文件描述符数量增加，这种数据复制操作的开销也随之增大，导致效率降低。</li>
<li><strong>文件描述符集合的重置</strong>： <code>select</code>  函数在每次调用后都需要重新设置文件描述符集合。由于  <code>select</code>  的输入和输出文件描述符集合未分离，返回的  <code>fd_set</code>  会清空所有未就绪的文件描述符，这增加了编程的复杂性。</li>
</ol>
<h3 id="epoll-特点"><a class="anchor" href="#epoll-特点">#</a>  <code>epoll</code>  特点</h3>
<p>Linux 内核提供了一种高效的 I/O 多路复用技术  <code>epoll</code> ，以解决  <code>select</code>  函数在处理大量并发网络连接时的一些缺点。 <code>epoll</code>  专为高性能网络服务器设计，能够高效地管理成千上万的并发连接。</p>
<p><code>epoll</code>  属于 Linux 内核提供 I/O 多路复用技术，在 Windows 或者 MAC 系统上， 可以使用其对应 IOCP 或者 Kqueue。</p>
<p><code>epoll</code>  的主要特点：</p>
<ol>
<li><strong>无文件描述符数量限制</strong>：与  <code>select</code>  不同， <code>epoll</code>  没有硬性限制文件描述符的数量。其上限取决于系统内存的大小，可以通过  <code>/proc/sys/fs/file-max</code>  查看和配置。</li>
<li><strong>高效的数据结构</strong>： <code>epoll</code>  在内核中维护了一个常驻的文件对象，内部使用红黑树来管理监听集合，这使得在大量文件描述符中进行查找、添加和删除操作变得高效。就绪集合则使用线性表来维护。</li>
<li><strong>事件驱动机制</strong>： <code>epoll</code>  采用事件驱动的方式，只检测那些变为活跃状态的文件描述符。当监听的设备有事件发生时，比如数据到达，硬件会通过中断通知操作系统，操作系统将这些就绪事件加入到就绪事件队列中，并唤醒等待在  <code>epoll_wait</code>  上的线程。</li>
<li><strong>减少 CPU 负担</strong>：与  <code>select</code>  的轮询检测不同， <code>epoll</code>  在内核态只检测活跃的文件描述符，显著减少了 CPU 的负担，从而提高了应用程序的性能。</li>
<li><strong>简化的 API 使用</strong>：当应用程序调用  <code>epoll_wait</code>  时，内核会检查就绪列表，并将就绪列表复制到用户空间提供的缓冲区中，通知应用程序哪些文件描述符上的事件已经就绪。在这个过程中，原始的文件监听集合不会被修改，这意味着不需要像  <code>select</code>  那样在每次调用后重新初始化监听集合。</li>
</ol>
<p><img loading="lazy" data-src="https://dlink.host/1drv/aHR0cHM6Ly8xZHJ2Lm1zL2kvYy9iZGU1MWU2MjVlZjhmY2M1L0VSc3FnMV9BRDRsUHRCc2JDWXFJc0Z3QjBVSUxDT3lSSk1xNHhFcGk0MTBNakE_ZT1lWWNjVXg.png" alt="epoll.png" /></p>
<h3 id="epoll_create-创建-epoll-实例"><a class="anchor" href="#epoll_create-创建-epoll-实例">#</a>  <code>epoll_create</code>   创建 epoll 实例</h3>
<p><code>epoll_create</code>  函数用于在 Linux 系统上创建一个 epoll 实例，它是 Linux 特有的一种高效的 I/O 事件通知机制。epoll 允许应用程序监听多个文件描述符（如 socket），并能够知道哪些文件描述符已经准备好进行读取或写入操作。</p>
<p>函数原型如下：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/epoll.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">int</span> <span class="token function">epoll_create</span><span class="token punctuation">(</span><span class="token keyword">int</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>参数说明： <code>int size</code> : 这个参数指定了 epoll 实例所能容纳的最大文件描述符数量。它并不是一个硬性的限制，而是一个提示，告诉内核 epoll 实例预期的大小。实际上，epoll 实例可以在运行时动态地增加容量。</p>
<p>返回值：</p>
<ul>
<li>如果调用成功，返回一个新的 epoll 实例的文件描述符。</li>
<li>如果调用失败，返回 -1，并设置全局变量  <code>errno</code>  以指示错误类型。</li>
</ul>
<p>使用场景：当应用程序需要同时管理多个网络连接或文件 I/O 操作，并且希望以非阻塞的方式高效地处理这些连接时。</p>
<p>工作机制：</p>
<ul>
<li><code>epoll_create</code>  调用会创建一个内核中的 epoll 实例，该实例可以被用来注册感兴趣的事件，并查询发生的事件。</li>
<li>应用程序可以通过  <code>epoll_ctl</code>  函数将文件描述符注册到 epoll 实例中，并指定感兴趣的事件类型（如读就绪、写就绪等）。</li>
<li>使用  <code>epoll_wait</code>  函数可以等待并查询发生的事件，这比传统的 select 或 poll 更加高效，特别是在处理大量并发连接时。</li>
</ul>
<p>示例：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/epoll.h></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">int</span> epollfd <span class="token operator">=</span> <span class="token function">epoll_create</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建一个 epoll 实例</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>epollfd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Failed to create epoll instance"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Created epoll instance, fd: %d\n"</span><span class="token punctuation">,</span> epollfd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token comment">// 使用 epollfd 来注册事件、等待事件等</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token comment">// 最后关闭 epoll 实例</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token function">close</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这个示例使用了  <code>epoll_create</code>  函数创建了一个 epoll 实例，并检查返回值以确保创建成功。创建 epoll 实例后，可以使用它来注册事件和等待事件。最后，使用  <code>close</code>  函数关闭 epoll 实例。</p>
<h3 id="epoll_ctl-控制-epoll-实例"><a class="anchor" href="#epoll_ctl-控制-epoll-实例">#</a>  <code>epoll_ctl</code>  控制 epoll 实例</h3>
<p><code>epoll_ctl</code>  函数用于对 epoll 实例进行控制操作，它是 epoll I/O 事件通知机制的一部分。这个函数允许你添加、修改或删除对特定文件描述符（fd）的事件监控。</p>
<p>函数原型如下：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/epoll.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">int</span> <span class="token function">epoll_ctl</span><span class="token punctuation">(</span><span class="token keyword">int</span> epfd<span class="token punctuation">,</span> <span class="token keyword">int</span> op<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> <span class="token operator">*</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>参数说明：</p>
<ol>
<li>
<p><code>int epfd</code> : 这是 epoll 实例的文件描述符，由  <code>epoll_create</code>  函数返回。</p>
</li>
<li>
<p><code>int op</code> : 这是一个操作类型，指定了要对文件描述符执行的操作。可能的操作包括：</p>
<ul>
<li><code>EPOLL_CTL_ADD</code> : 添加新的文件描述符到 epoll 实例中。</li>
<li><code>EPOLL_CTL_MOD</code> : 修改已经在 epoll 实例中的文件描述符的监控事件。</li>
<li><code>EPOLL_CTL_DEL</code> : 从 epoll 实例中删除文件描述符。</li>
</ul>
</li>
<li>
<p><code>int fd</code> : 这是要被添加、修改或删除的文件描述符。</p>
</li>
<li>
<p><code>struct epoll_event *event</code> : 这是一个指向  <code>epoll_event</code>  结构的指针，该结构定义了文件描述符上感兴趣的事件类型以及相关的回调信息。结构体中的关键成员包括：</p>
<ul>
<li><code>events</code> : 指定了感兴趣的事件类型，可以是以下事件的组合：
<ul>
<li><code>EPOLLIN</code> : 文件描述符可读（有数据可被读取）。</li>
<li><code>EPOLLOUT</code> : 文件描述符可写（可以发送数据）。</li>
<li><code>EPOLLERR</code> : 文件描述符发生错误。</li>
<li><code>EPOLLHUP</code> : 挂断事件，表示对端关闭了连接。</li>
</ul>
</li>
<li><code>data</code> : 一个联合体，可以包含与事件相关的数据，如一个指针或特定的用户数据。</li>
</ul>
</li>
</ol>
<p>返回值：</p>
<ul>
<li>如果调用成功，返回 0。</li>
<li>如果调用失败，返回 -1，并设置全局变量  <code>errno</code>  以指示错误类型。</li>
</ul>
<p>使用场景：</p>
<ul>
<li>当需要将新的文件描述符注册到 epoll 实例中，以便监听其 I/O 事件时。</li>
<li>当需要修改已注册文件描述符的事件类型或删除不再需要监控的文件描述符时。</li>
</ul>
<p>工作机制：</p>
<ul>
<li><code>epoll_ctl</code>  根据  <code>op</code>  参数指定的操作类型，对 epoll 实例中的文件描述符进行控制。</li>
<li>当文件描述符上指定的事件发生时，epoll 机制会将该文件描述符加入到就绪列表中，应用程序可以通过  <code>epoll_wait</code>  函数查询这个列表。</li>
</ul>
<p>示例：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/epoll.h></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">int</span> epollfd <span class="token operator">=</span> <span class="token function">epoll_create</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建 epoll 实例</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>epollfd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Failed to create epoll instance"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">int</span> sockfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>sockfd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Failed to create socket"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token function">close</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> event<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    event<span class="token punctuation">.</span>events <span class="token operator">=</span> EPOLLIN<span class="token punctuation">;</span> <span class="token comment">// 我们对读事件感兴趣</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    event<span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd <span class="token operator">=</span> sockfd<span class="token punctuation">;</span> <span class="token comment">// 关联的文件描述符</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token comment">// 将 socket 添加到 epoll 实例中</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">epoll_ctl</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> EPOLL_CTL_ADD<span class="token punctuation">,</span> sockfd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>event<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Failed to add socket to epoll"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token function">close</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token comment">// 接下来可以使用 epoll_wait 等待事件</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token comment">// 关闭资源</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token function">close</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这个示例中首先创建了一个 epoll 实例和一个 socket。然后初始化了一个  <code>epoll_event</code>  结构，指定对 socket 的读事件，并将这个 socket 添加到 epoll 实例中。当 socket 上有数据可读时，它就会出现在 epoll 的就绪列表中，可以通过  <code>epoll_wait</code>  函数来检测这一点。</p>
<h3 id="struct-epoll_event-结构体"><a class="anchor" href="#struct-epoll_event-结构体">#</a>  <code>struct epoll_event</code>  结构体</h3>
<p><code>struct epoll_event</code>  是 Linux 中 epoll 机制使用的一个结构体，用于定义 epoll 事件和相关数据。结构体定义如下：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token class-name">uint32_t</span>     events<span class="token punctuation">;</span>	</pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token class-name">epoll_data_t</span> data<span class="token punctuation">;</span>		</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>这个结构体包括两个主要成员：</p>
<ol>
<li>
<p><code>uint32_t events</code> : 这是一个 32 位的无符号整数，用于指定感兴趣的事件类型。可以指定的事件类型包括但不限于以下几种：</p>
<ul>
<li><code>EPOLLIN</code> : 表示对应的文件描述符可以读取数据（如 socket 可读）。</li>
<li><code>EPOLLOUT</code> : 表示对应的文件描述符可以写入数据（如 socket 可写）。</li>
<li><code>EPOLLERR</code> : 表示对应的文件描述符发生了错误。</li>
<li><code>EPOLLHUP</code> : 表示对应的文件描述符被挂断，即对端关闭了连接。</li>
<li><code>EPOLLRDHUP</code> : 表示对端关闭了连接，并且所有数据都已读取完毕。</li>
<li><code>EPOLLET</code> : 将 socket 设置为边缘触发（Edge Triggered）模式，这是与水平触发（Level Triggered）相对的模式。</li>
<li><code>EPOLLONESHOT</code> : 表示事件被触发一次后，不会再次触发，直到再次通过  <code>epoll_ctl</code>  注册。</li>
</ul>
</li>
<li>
<p><code>epoll_data_t data</code> : 这是一个联合体，用于存储与事件关联的特定于应用程序的数据。 <code>epoll_data_t</code>  定义如下：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">union</span> epoll_data <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">;</span>            <span class="token comment">// 通用指针，可用于存储任意类型的指针</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">int</span> fd<span class="token punctuation">;</span>               <span class="token comment">// 文件描述符</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token class-name">uint32_t</span> u32<span class="token punctuation">;</span>         <span class="token comment">// 32 位无符号整数</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token class-name">uint64_t</span> u64<span class="token punctuation">;</span>         <span class="token comment">// 64 位无符号整数</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>这个联合体提供了几种不同的数据存储选项，以适应不同的使用场景：</p>
<ul>
<li><code>ptr</code> : 可以指向任何类型的数据，通常用于指向特定的应用程序数据。</li>
<li><code>fd</code> : 存储文件描述符，方便在事件回调中直接使用。</li>
<li><code>u32</code>  和  <code>u64</code> : 提供了存储 32 位和 64 位无符号整数的能力。</li>
</ul>
</li>
</ol>
<h3 id="epoll_wait-等待事件"><a class="anchor" href="#epoll_wait-等待事件">#</a>  <code>epoll_wait</code>  等待事件</h3>
<p><code>epoll_wait</code>  函数是 Linux 系统中 epoll I/O 事件通知机制中用于等待事件的函数。它允许应用程序等待注册到 epoll 实例上的文件描述符上的 I/O 事件。</p>
<p>函数原型如下：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/epoll.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">int</span> <span class="token function">epoll_wait</span><span class="token punctuation">(</span><span class="token keyword">int</span> epfd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> <span class="token operator">*</span>events<span class="token punctuation">,</span> <span class="token keyword">int</span> maxevents<span class="token punctuation">,</span> <span class="token keyword">int</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>参数说明：</p>
<ol>
<li>
<p><code>int epfd</code> : 这是 epoll 实例的文件描述符，由  <code>epoll_create</code>  或  <code>epoll_create1</code>  函数返回。</p>
</li>
<li>
<p><code>struct epoll_event *events</code> : 这是一个指向  <code>epoll_event</code>  结构体数组的指针，用于从 epoll 实例中接收发生的事件。数组的大小由  <code>maxevents</code>  参数指定。</p>
</li>
<li>
<p><code>int maxevents</code> : 这个参数指定了  <code>events</code>  数组可以存储的最大事件数量。 <code>epoll_wait</code>  将返回实际发生的事件数量，这个数量可能小于或等于  <code>maxevents</code> 。</p>
</li>
<li>
<p><code>int timeout</code> : 这是等待事件的最长时间，单位为毫秒。如果设置为 -1， <code>epoll_wait</code>  将阻塞直到至少有一个事件被触发。如果设置为 0，函数将立即返回，即使没有事件被触发。</p>
</li>
</ol>
<p>返回值：</p>
<ul>
<li>如果调用成功，返回数组中填充的事件数量。</li>
<li>如果调用失败或在超时时间内没有事件发生，返回 -1，并设置全局变量  <code>errno</code>  以指示错误类型。</li>
</ul>
<p>使用场景：</p>
<ul>
<li>当应用程序需要等待多个文件描述符上的 I/O 事件时。</li>
<li>当需要以非阻塞方式或在指定超时时间内等待 I/O 事件时。</li>
</ul>
<p>工作机制：</p>
<ul>
<li><code>epoll_wait</code>  函数检查  <code>epfd</code>  指定的 epoll 实例中注册的文件描述符，等待它们上的 I/O 事件发生。</li>
<li>当一个或多个事件发生时， <code>epoll_wait</code>  将这些事件的信息填充到  <code>events</code>  数组中，并返回发生的事件数量。</li>
<li><code>events</code>  数组中的每个  <code>epoll_event</code>  结构体都包含了事件类型、发生的文件描述符以及可能的用户数据。</li>
</ul>
<p>示例：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/epoll.h></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">int</span> epollfd <span class="token operator">=</span> <span class="token function">epoll_create1</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建 epoll 实例</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>epollfd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Failed to create epoll instance"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token comment">// 假设已经将一些 socket 添加到 epoll 实例...</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> events<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 存储最大 10 个事件</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">int</span> nevents <span class="token operator">=</span> <span class="token function">epoll_wait</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> events<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 无限期等待事件</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>nevents <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Failed to wait for events"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token function">close</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nevents<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token comment">// 处理每个事件</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Event occurred on fd: %d\n"</span><span class="token punctuation">,</span> events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token comment">// 关闭 epoll 实例</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token function">close</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这个示例中首先创建了一个 epoll 实例，然后使用  <code>epoll_wait</code>  函数等待最多 10 个事件的发生，并无限期地阻塞直到至少有一个事件发生。当事件发生时遍历  <code>events</code>  数组并打印出每个事件关联的文件描述符。</p>
<h3 id="触发模式"><a class="anchor" href="#触发模式">#</a> 触发模式</h3>
<h4 id="水平触发"><a class="anchor" href="#水平触发">#</a> 水平触发</h4>
<p>水平触发是  <code>epoll</code>  的默认工作模式，它提供了一种持续通知机制。在这种模式下，只要被监视的文件描述符上有待处理的事件， <code>epoll_wait</code>  就会不断地通知应用程序，直到应用程序明确地处理了这些事件。</p>
<p>以读事件为例，当某个文件描述符变得可读时， <code>epoll_wait</code>  会通知应用程序该文件描述符上存在可读取的数据。即使应用程序没有一次性读取缓冲区中的所有数据， <code>epoll_wait</code>  在下一次调用时仍会再次通知该文件描述符处于可读状态。</p>
<p>以下是使用  <code>epoll</code>  进行网络通信的示例代码片段，展示了如何处理读事件：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//... 其他代码 ...</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>cfd <span class="token operator">==</span> netfd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token comment">// 读取 socket 数据</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span> <span class="token comment">// 定义一个长度为 2 的字符数组</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">int</span> res_recv <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>netfd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span>res_recv <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"对方断开连接\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token keyword">goto</span> end<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token comment">// 打印接收到的数据</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token function">write</span><span class="token punctuation">(</span>STDOUT_FILENO<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"-- \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token comment">//... 其他代码 ...</span></pre></td></tr></table></figure><p>在这段代码中，当  <code>epoll_wait</code>  检测到  <code>netfd</code> （网络文件描述符）上有可读事件时，它会进入此分支。应用程序尝试从  <code>netfd</code>  读取数据到  <code>buf</code>  数组中。如果  <code>recv</code>  函数返回 0，表示对端已经关闭连接；如果返回值是其他值，表示读取了数据。读取的数据随后被打印到标准输出。</p>
<h4 id="边缘触发"><a class="anchor" href="#边缘触发">#</a> 边缘触发</h4>
<p>边缘触发模式是  <code>epoll</code>  的一种工作方式，与水平触发模式不同，它仅在文件描述符状态发生变化时通知应用程序。这意味着，只有当相关事件发生，例如从不可用变为可用时， <code>epoll_wait</code>  才会通知应用程序。</p>
<p>以读事件为例：在边缘触发模式下，如果缓冲区中的数据量没有增加，即使其中已有数据， <code>epoll_wait</code>  也不会再次就绪。只有当缓冲区中的数据量增加时， <code>epoll_wait</code>  才会触发。</p>
<p>边缘触发模式可以通过在  <code>epoll_ctl</code>  函数调用时，为  <code>struct epoll_event *event</code>  参数的  <code>events</code>  字段设置  <code>EPOLLET</code>  标志来启用。</p>
<p>以下是使用边缘触发模式进行网络通信的示例代码片段，展示了如何处理读事件：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// ...</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">int</span> epollfd <span class="token operator">=</span> <span class="token function">epoll_create</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> event<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>event<span class="token punctuation">.</span>events <span class="token operator">=</span> EPOLLIN <span class="token operator">|</span> EPOLLET<span class="token punctuation">;</span> <span class="token comment">// 启用边缘触发</span></pre></td></tr><tr><td data-num="5"></td><td><pre>event<span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd <span class="token operator">=</span> netfd<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token function">epoll_ctl</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> EPOLL_CTL_ADD<span class="token punctuation">,</span> netfd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment">// ...</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">if</span> <span class="token punctuation">(</span>cfd <span class="token operator">==</span> netfd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span> <span class="token comment">// 定义一个长度为 2 的字符数组</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">int</span> res_recv <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>netfd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>res_recv <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"对方断开连接\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token keyword">goto</span> end<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token function">write</span><span class="token punctuation">(</span>STDOUT_FILENO<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"-- \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token comment">// ...</span></pre></td></tr></table></figure><p>在这段代码中，当  <code>epoll_wait</code>  检测到  <code>netfd</code>  上有可读事件时，它会进入此分支。应用程序尝试从  <code>netfd</code>  读取数据到  <code>buf</code>  数组中。如果  <code>recv</code>  函数返回 0，表示对端已经关闭连接；如果返回值是其他值，表示读取了数据。读取的数据随后被打印到标准输出。</p>
<p>改进读取操作：</p>
<p>为了一次性读取对方发送的所有字符，可以配合  <code>while</code>  循环来连续读取：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// ...</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">if</span> <span class="token punctuation">(</span>cfd <span class="token operator">==</span> netfd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token keyword">int</span> res_recv <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>netfd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>res_recv <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"对方断开连接\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>            <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">// 退出循环</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token function">write</span><span class="token punctuation">(</span>STDOUT_FILENO<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"-- \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment">// ...</span></pre></td></tr></table></figure><p>这种方式可以在一次就绪中读取所有字符。然而，这也带来了新的问题：由于  <code>recv</code>  是一个阻塞调用，如果没有更多的数据可读，它会阻塞等待。这就需要在循环中添加适当的逻辑来处理这种情况，例如使用非阻塞  <code>recv</code>  或设置超时。</p>
<h3 id="非阻塞模式的-recv"><a class="anchor" href="#非阻塞模式的-recv">#</a> 非阻塞模式的 recv</h3>
<p>在网络编程中， <code>recv</code>  函数通常用于从套接字中接收数据。默认情况下， <code>recv</code>  是阻塞的，这意味着如果没有数据可读，调用线程将被阻塞，直到有数据到达或连接关闭。</p>
<p>为了解决在循环读取时可能遇到的阻塞问题，我们可以将  <code>recv</code>  设置为非阻塞模式。这可以通过在调用  <code>recv</code>  时指定  <code>flags</code>  参数为  <code>MSG_DONTWAIT</code>  来实现。</p>
<p>非阻塞  <code>recv</code>  的实现：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">// 接收来自套接字的消息</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token class-name">ssize_t</span> <span class="token function">recv</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">int</span> sockfd<span class="token punctuation">,</span>      <span class="token comment">// 套接字文件描述符</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">void</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span>       <span class="token comment">// 接收缓冲区</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token class-name">size_t</span> len<span class="token punctuation">,</span>      <span class="token comment">// 缓冲区长度</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">int</span> flags        <span class="token comment">// 接收行为的标志位</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment">// 返回值：</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment">//- 成功时返回实际读取的字节数。</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment">//- 如果连接已经关闭，返回 0（对方执行了四次挥手）。</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment">//- 读取失败或在非阻塞模式下没有数据可读时返回 - 1。</span></pre></td></tr></table></figure><p>示例代码：</p>
<p>以下是使用非阻塞  <code>recv</code>  进行网络通信的示例代码片段，展示了如何在读取操作中避免阻塞：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// ...</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>cfd <span class="token operator">==</span> netfd<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token comment">// 读取套接字数据，设置为非阻塞模式</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token keyword">int</span> res_recv <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>netfd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span> MSG_DONTWAIT<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="7"></td><td><pre>        </pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token comment">// 如果没有数据可读，recv 将返回 - 1，跳出循环</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span>res_recv <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        </pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token comment">// 如果连接关闭，recv 将返回 0</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> res_recv<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"对方断开连接\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>            <span class="token keyword">goto</span> end<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        </pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token comment">// 打印接收到的数据</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token function">write</span><span class="token punctuation">(</span>STDOUT_FILENO<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"- \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token comment">// ...</span></pre></td></tr></table></figure><p>这段代码通过设置  <code>MSG_DONTWAIT</code>  标志将  <code>recv</code>  函数调用设置为非阻塞模式。如果在调用  <code>recv</code>  时没有数据可读，它将立即返回 - 1，而不是阻塞线程。这允许我们在循环中读取数据，一旦没有更多数据可读，就跳出循环。</p>
<h2 id="修改-socket-的属性"><a class="anchor" href="#修改-socket-的属性">#</a> 修改 socket 的属性</h2>
<h3 id="使用-setsockopt-调整套接字属性"><a class="anchor" href="#使用-setsockopt-调整套接字属性">#</a> 使用  <code>setsockopt</code>  调整套接字属性</h3>
<p><code>setsockopt</code>  函数用于在套接字上设置选项，以调整其行为。相应的， <code>getsockopt</code>  函数用于获取当前的套接字选项值。这些函数定义在  <code>&lt;sys/socket.h&gt;</code>  头文件中。</p>
<p>函数原型：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">// 获取套接字选项</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">int</span> <span class="token function">getsockopt</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">int</span> level<span class="token punctuation">,</span> <span class="token keyword">int</span> optname<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>optval<span class="token punctuation">,</span> <span class="token class-name">socklen_t</span> <span class="token operator">*</span>optlen<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">// 设置套接字选项</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">int</span> <span class="token function">setsockopt</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">int</span> level<span class="token punctuation">,</span> <span class="token keyword">int</span> optname<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>optval<span class="token punctuation">,</span> <span class="token class-name">socklen_t</span> optlen<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h3 id="调整接收发送缓冲区大小"><a class="anchor" href="#调整接收发送缓冲区大小">#</a> 调整接收 / 发送缓冲区大小</h3>
<p><code>SO_RCVBUF</code>  和  <code>SO_SNDBUF</code> ：用来获取和设置接收和发送缓冲区的大小。需要注意的是，即使使用  <code>setsockopt</code>  设置了缓冲区大小，调用  <code>getsockopt</code>  所得到的值可能与设置的值不同，因为系统可能会根据当前系统资源和策略进行调整。</p>
<p>示例代码：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">int</span> bufsize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">socklen_t</span> buflen <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">getsockopt</span><span class="token punctuation">(</span>sfd<span class="token punctuation">,</span> SOL_SOCKET<span class="token punctuation">,</span> SO_RCVBUF<span class="token punctuation">,</span> <span class="token operator">&amp;</span>bufsize<span class="token punctuation">,</span> <span class="token operator">&amp;</span>buflen<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"原始接收缓冲区大小: %d\n"</span><span class="token punctuation">,</span> bufsize<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>bufsize <span class="token operator">=</span> <span class="token number">8192</span><span class="token punctuation">;</span> <span class="token comment">// 设置新的接收缓冲区大小</span></pre></td></tr><tr><td data-num="7"></td><td><pre>ret <span class="token operator">=</span> <span class="token function">setsockopt</span><span class="token punctuation">(</span>sfd<span class="token punctuation">,</span> SOL_SOCKET<span class="token punctuation">,</span> SO_RCVBUF<span class="token punctuation">,</span> <span class="token operator">&amp;</span>bufsize<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>ret <span class="token operator">=</span> <span class="token function">getsockopt</span><span class="token punctuation">(</span>sfd<span class="token punctuation">,</span> SOL_SOCKET<span class="token punctuation">,</span> SO_RCVBUF<span class="token punctuation">,</span> <span class="token operator">&amp;</span>bufsize<span class="token punctuation">,</span> <span class="token operator">&amp;</span>buflen<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"新的接收缓冲区大小: %d\n"</span><span class="token punctuation">,</span> bufsize<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h3 id="设置缓冲区的灵敏度"><a class="anchor" href="#设置缓冲区的灵敏度">#</a> 设置缓冲区的灵敏度</h3>
<p><code>SO_RCVLOWAT</code>  和  <code>SO_SNDLOWAT</code> ：这些选项定义了缓冲区的下限，用来设置缓冲区的灵敏度。例如， <code>SO_RCVLOWAT</code>  的值设置较高时，读操作将等待直到缓冲区中的数据量达到这个值才返回，这有助于减少处理次数，提高效率。</p>
<p>示例代码：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd <span class="token operator">==</span> sfd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">int</span> newFd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>sfd<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"新连接的文件描述符: %d\n"</span><span class="token punctuation">,</span> newFd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">int</span> buflowat <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span> <span class="token comment">// 设置接收缓冲区的下限</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">setsockopt</span><span class="token punctuation">(</span>newFd<span class="token punctuation">,</span> SOL_SOCKET<span class="token punctuation">,</span> SO_RCVLOWAT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>buflowat<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token comment">// 错误检查代码省略</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token comment">// 表示有客户端登录</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">int</span> flag <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> event<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    event<span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd <span class="token operator">=</span> newFd<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    event<span class="token punctuation">.</span>events <span class="token operator">=</span> EPOLLIN<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    ret <span class="token operator">=</span> <span class="token function">epoll_ctl</span><span class="token punctuation">(</span>epfd<span class="token punctuation">,</span> EPOLL_CTL_ADD<span class="token punctuation">,</span> newFd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token comment">// 错误检查代码省略</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>通过设置  <code>SO_RCVLOWAT</code> ，如果发送方的数据量较少，将不会触发  <code>epoll_wait</code>  的读就绪事件，直到接收缓冲区中的数据量达到设定的下限。</p>
<div class="tags"><a href="/tags/c/" rel="tag"><i class="ic i-tag"></i>C</a><a href="/tags/linux/" rel="tag"><i class="ic i-tag"></i>Linux</a><a href="/tags/cn/" rel="tag"><i class="ic i-tag"></i>计算机网络</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i></span><span class="text">更新于</span><time title="修改时间：2024-12-14 17:01:40" itemprop="dateModified" datetime="2024-12-14T17:01:40+08:00">2024-12-14</time></span></div><div id="copyright"><ul><li class="author"><strong>本文作者：</strong>樱小路七叶<i class="ic i-at"><em>@</em></i>Nana7ha's Café Stella</li><li class="link"><strong>本文链接：</strong><a href="http://cwlrin.github.io/c-cpp/linux-c/Linux%20%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/" title="Linux 网络编程">http://cwlrin.github.io/c-cpp/linux-c/Linux 网络编程/</a></li><li class="license"><strong>版权声明：</strong>本站所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/c-cpp/linux-c/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE/" rel="prev" itemprop="url" title="网络协议" style="background-image: linear-gradient(to bottom right, #a99b90, #df8ae7);"><span class="type">上一篇</span><span class="category"><i class="ic i-flag"></i>Linux C</span><h3>网络协议</h3></a></div><div class="item right"><a href="/c-cpp/linux-c/Linux%20%E8%BF%9B%E7%A8%8B%E6%B1%A0/" rel="next" itemprop="url" title="Linux 进程池" style="background-image: linear-gradient(to bottom right, #f5c79a, #95f39c);"><span class="type">下一篇</span><span class="category"><i class="ic i-flag"></i>Linux C</span><h3>Linux 进程池</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9C%B0%E5%9D%80%E5%A4%84%E7%90%86"><span class="toc-number">1.</span> <span class="toc-text"> 地址处理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%A7%E7%AB%AF%E5%9C%B0%E5%9D%80%E5%92%8C%E5%B0%8F%E7%AB%AF%E5%9C%B0%E5%9D%80"><span class="toc-number">1.1.</span> <span class="toc-text"> 大端地址和小端地址</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%A7%E7%AB%AF%E6%B3%95%E5%92%8C%E5%B0%8F%E7%AB%AF%E6%B3%95"><span class="toc-number">1.1.1.</span> <span class="toc-text"> 大端法和小端法</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%A7%E5%B0%8F%E7%AB%AF%E8%BD%AC%E6%8D%A2"><span class="toc-number">1.2.</span> <span class="toc-text"> 大小端转换</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#htonl-%E8%BD%AC%E6%8D%A2%E4%B8%BA%E5%A4%A7%E7%AB%AF%E5%BA%8F"><span class="toc-number">1.2.1.</span> <span class="toc-text">  htonl  转换为大端序</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#htons-%E8%BD%AC%E6%8D%A2%E4%B8%BA%E5%A4%A7%E7%AB%AF%E5%BA%8F"><span class="toc-number">1.2.2.</span> <span class="toc-text">  htons  转换为大端序</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ntohl-%E8%BD%AC%E6%8D%A2%E4%B8%BA%E5%B0%8F%E7%AB%AF%E5%BA%8F"><span class="toc-number">1.2.3.</span> <span class="toc-text">  ntohl  转换为小端序</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ntohs-%E8%BD%AC%E6%8D%A2%E4%B8%BA%E5%B0%8F%E7%AB%AF%E5%BA%8F"><span class="toc-number">1.2.4.</span> <span class="toc-text">  ntohs  转换为小端序</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%82%B9%E5%88%86%E5%8D%81%E8%BF%9B%E5%88%B6%E8%BD%AC%E5%8C%96"><span class="toc-number">1.3.</span> <span class="toc-text"> 点分十进制转化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ip-%E7%BB%93%E6%9E%84%E4%BD%93"><span class="toc-number">1.3.1.</span> <span class="toc-text"> IP 结构体</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ip-%E5%9C%B0%E5%9D%80%E8%BD%AC%E6%8D%A2%E5%87%BD%E6%95%B0"><span class="toc-number">1.3.2.</span> <span class="toc-text"> IP 地址转换函数</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#inet_addr"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">  inet_addr</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#inet_aton"><span class="toc-number">1.3.2.2.</span> <span class="toc-text">  inet_aton</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#inet_ntoa"><span class="toc-number">1.3.2.3.</span> <span class="toc-text">  inet_ntoa</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#dns"><span class="toc-number">1.4.</span> <span class="toc-text"> DNS</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#tcp"><span class="toc-number">2.</span> <span class="toc-text"> TCP</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E-tcp-%E7%9A%84-socket-%E9%80%9A%E4%BF%A1%E6%B5%81%E7%A8%8B"><span class="toc-number">2.1.</span> <span class="toc-text"> 基于 TCP 的 Socket 通信流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#socket-%E5%88%9B%E5%BB%BA%E9%80%9A%E4%BF%A1%E7%AB%AF%E7%82%B9"><span class="toc-number">2.2.</span> <span class="toc-text">  socket  创建通信端点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#bind-%E7%BB%91%E5%AE%9A-socket-%E5%88%B0%E7%BD%91%E7%BB%9C%E5%9C%B0%E5%9D%80%E5%92%8C%E7%AB%AF%E5%8F%A3"><span class="toc-number">2.3.</span> <span class="toc-text">  bind  绑定 socket 到网络地址和端口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#listen-%E8%BD%AC%E6%8D%A2-socket-%E4%B8%BA%E8%A2%AB%E5%8A%A8%E7%9B%91%E5%90%AC%E6%A8%A1%E5%BC%8F"><span class="toc-number">2.4.</span> <span class="toc-text">  listen  转换 socket 为被动监听模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#connect-%E5%88%9D%E5%A7%8B%E5%8C%96%E8%BF%9E%E6%8E%A5%E5%88%B0%E6%8C%87%E5%AE%9A%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84-socket"><span class="toc-number">2.5.</span> <span class="toc-text">  connect  初始化连接到指定服务器的 socket</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#accept-%E6%8E%A5%E5%8F%97%E4%B8%80%E4%B8%AA%E8%BF%9E%E6%8E%A5%E8%AF%B7%E6%B1%82"><span class="toc-number">2.6.</span> <span class="toc-text">  accept  接受一个连接请求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#send-%E5%90%91%E5%B7%B2%E8%BF%9E%E6%8E%A5%E7%9A%84-socket-%E5%8F%91%E9%80%81%E6%95%B0%E6%8D%AE"><span class="toc-number">2.7.</span> <span class="toc-text">  send  向已连接的 socket 发送数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#recv-%E4%BB%8E-socket-%E6%8E%A5%E6%94%B6%E6%95%B0%E6%8D%AE"><span class="toc-number">2.8.</span> <span class="toc-text">  recv  从 socket 接收数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#close-%E5%85%B3%E9%97%AD%E6%96%87%E4%BB%B6%E6%8F%8F%E8%BF%B0%E7%AC%A6"><span class="toc-number">2.9.</span> <span class="toc-text">  close   关闭文件描述符</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tcp-%E9%80%9A%E4%BF%A1%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B"><span class="toc-number">2.10.</span> <span class="toc-text"> TCP 通信代码示例</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-number">2.10.1.</span> <span class="toc-text"> 客户端</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF"><span class="toc-number">2.10.2.</span> <span class="toc-text"> 服务端</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%93%E5%90%88-select-%E9%80%9A%E4%BF%A1"><span class="toc-number">2.11.</span> <span class="toc-text"> 结合  Select  通信</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF-2"><span class="toc-number">2.11.1.</span> <span class="toc-text"> 客户端</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF-2"><span class="toc-number">2.11.2.</span> <span class="toc-text"> 服务端</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#select-%E6%96%AD%E5%BC%80%E9%87%8D%E8%BF%9E"><span class="toc-number">2.11.3.</span> <span class="toc-text"> Select 断开重连</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ddos"><span class="toc-number">2.12.</span> <span class="toc-text"> DDoS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tcpdump"><span class="toc-number">2.13.</span> <span class="toc-text"> tcpdump</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#udp"><span class="toc-number">3.</span> <span class="toc-text"> UDP</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#socket-%E5%88%9B%E5%BB%BA%E9%80%9A%E4%BF%A1%E7%AB%AF%E7%82%B9-2"><span class="toc-number">3.1.</span> <span class="toc-text">  socket  创建通信端点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#bind-%E7%BB%91%E5%AE%9A-socket-%E5%88%B0%E7%BD%91%E7%BB%9C%E5%9C%B0%E5%9D%80%E5%92%8C%E7%AB%AF%E5%8F%A3-2"><span class="toc-number">3.2.</span> <span class="toc-text">  bind  绑定 socket 到网络地址和端口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sendto-%E5%8F%91%E9%80%81%E6%95%B0%E6%8D%AE"><span class="toc-number">3.3.</span> <span class="toc-text">  sendto  发送数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#recvfrom-%E6%8E%A5%E6%94%B6%E6%95%B0%E6%8D%AE"><span class="toc-number">3.4.</span> <span class="toc-text">  recvfrom  接收数据</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#epoll"><span class="toc-number">4.</span> <span class="toc-text"> Epoll</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#select-%E7%9A%84%E7%BC%BA%E9%99%B7"><span class="toc-number">4.1.</span> <span class="toc-text">  select  的缺陷</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#select-%E5%87%BD%E6%95%B0%E7%9A%84%E5%B1%80%E9%99%90%E6%80%A7"><span class="toc-number">4.2.</span> <span class="toc-text">  select  函数的局限性：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#epoll-%E7%89%B9%E7%82%B9"><span class="toc-number">4.3.</span> <span class="toc-text">  epoll  特点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#epoll_create-%E5%88%9B%E5%BB%BA-epoll-%E5%AE%9E%E4%BE%8B"><span class="toc-number">4.4.</span> <span class="toc-text">  epoll_create   创建 epoll 实例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#epoll_ctl-%E6%8E%A7%E5%88%B6-epoll-%E5%AE%9E%E4%BE%8B"><span class="toc-number">4.5.</span> <span class="toc-text">  epoll_ctl  控制 epoll 实例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#struct-epoll_event-%E7%BB%93%E6%9E%84%E4%BD%93"><span class="toc-number">4.6.</span> <span class="toc-text">  struct epoll_event  结构体</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#epoll_wait-%E7%AD%89%E5%BE%85%E4%BA%8B%E4%BB%B6"><span class="toc-number">4.7.</span> <span class="toc-text">  epoll_wait  等待事件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A6%E5%8F%91%E6%A8%A1%E5%BC%8F"><span class="toc-number">4.8.</span> <span class="toc-text"> 触发模式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B0%B4%E5%B9%B3%E8%A7%A6%E5%8F%91"><span class="toc-number">4.8.1.</span> <span class="toc-text"> 水平触发</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BE%B9%E7%BC%98%E8%A7%A6%E5%8F%91"><span class="toc-number">4.8.2.</span> <span class="toc-text"> 边缘触发</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9D%9E%E9%98%BB%E5%A1%9E%E6%A8%A1%E5%BC%8F%E7%9A%84-recv"><span class="toc-number">4.9.</span> <span class="toc-text"> 非阻塞模式的 recv</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9-socket-%E7%9A%84%E5%B1%9E%E6%80%A7"><span class="toc-number">5.</span> <span class="toc-text"> 修改 socket 的属性</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-setsockopt-%E8%B0%83%E6%95%B4%E5%A5%97%E6%8E%A5%E5%AD%97%E5%B1%9E%E6%80%A7"><span class="toc-number">5.1.</span> <span class="toc-text"> 使用  setsockopt  调整套接字属性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E6%95%B4%E6%8E%A5%E6%94%B6%E5%8F%91%E9%80%81%E7%BC%93%E5%86%B2%E5%8C%BA%E5%A4%A7%E5%B0%8F"><span class="toc-number">5.2.</span> <span class="toc-text"> 调整接收 &#x2F; 发送缓冲区大小</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E7%BC%93%E5%86%B2%E5%8C%BA%E7%9A%84%E7%81%B5%E6%95%8F%E5%BA%A6"><span class="toc-number">5.3.</span> <span class="toc-text"> 设置缓冲区的灵敏度</span></a></li></ol></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li ><a href="/c-cpp/linux-c/Linux%20C%20%E5%9F%BA%E7%A1%80/" rel="bookmark" title="Linux C 基础">Linux C 基础</a></li><li ><a href="/c-cpp/linux-c/Linux%20%E6%9D%82%E9%A1%B9/" rel="bookmark" title="Linux 杂项">Linux 杂项</a></li><li ><a href="/c-cpp/linux-c/Linux%20%E7%9B%AE%E5%BD%95%E6%B5%81/" rel="bookmark" title="Linux 目录流">Linux 目录流</a></li><li ><a href="/c-cpp/linux-c/Linux%20%E6%96%87%E4%BB%B6%E6%B5%81/" rel="bookmark" title="Linux 文件流">Linux 文件流</a></li><li ><a href="/c-cpp/linux-c/Linux%20%E7%AE%A1%E9%81%93%E5%92%8C%20IO%20%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8/" rel="bookmark" title="Linux 管道和 IO 多路复用">Linux 管道和 IO 多路复用</a></li><li ><a href="/c-cpp/linux-c/Linux%20%E8%BF%9B%E7%A8%8B%EF%BC%88%E4%B8%8A%EF%BC%89/" rel="bookmark" title="Linux 进程（上）">Linux 进程（上）</a></li><li ><a href="/c-cpp/linux-c/Linux%20%E8%BF%9B%E7%A8%8B%EF%BC%88%E4%B8%8B%EF%BC%89/" rel="bookmark" title="Linux 进程（下）">Linux 进程（下）</a></li><li ><a href="/c-cpp/linux-c/Linux%20%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/" rel="bookmark" title="Linux 进程间通信">Linux 进程间通信</a></li><li ><a href="/c-cpp/linux-c/Linux%20%E4%BF%A1%E5%8F%B7/" rel="bookmark" title="Linux 信号">Linux 信号</a></li><li ><a href="/c-cpp/linux-c/Linux%20%E7%BA%BF%E7%A8%8B/" rel="bookmark" title="Linux 线程">Linux 线程</a></li><li ><a href="/c-cpp/linux-c/Linux%20%E7%BA%BF%E7%A8%8B%E7%9A%84%E5%90%8C%E6%AD%A5%E5%92%8C%E4%BA%92%E6%96%A5/" rel="bookmark" title="Linux 线程的同步和互斥.md">Linux 线程的同步和互斥.md</a></li><li ><a href="/c-cpp/linux-c/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE/" rel="bookmark" title="网络协议">网络协议</a></li><li  class="active"><a href="/c-cpp/linux-c/Linux%20%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/" rel="bookmark" title="Linux 网络编程">Linux 网络编程</a></li><li ><a href="/c-cpp/linux-c/Linux%20%E8%BF%9B%E7%A8%8B%E6%B1%A0/" rel="bookmark" title="Linux 进程池">Linux 进程池</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><img class="image" loading="lazy" decoding="async" itemprop="image" alt="樱小路七叶" src="/assets/avatar.jpg"/><p class="name" itemprop="name">樱小路七叶</p><div class="description" itemprop="description">技术与美日新月异</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">97</span><span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">12</span><span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">15</span><span class="name">标签</span></a></div></nav><div class="social"><a target="_blank" rel="noopener" href="https://github.com/cwlrin" class="item github" title="https:&#x2F;&#x2F;github.com&#x2F;cwlrin"><i class="ic i-github"></i></a><a target="_blank" rel="noopener" href="https://www.zhihu.com/people/ying-xiao-lu-qi-ye" class="item zhihu" title="https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;ying-xiao-lu-qi-ye"><i class="ic i-zhihu"></i></a><a target="_blank" rel="noopener" href="https://music.163.com/#/user/home?id=411590211" class="item music" title="https:&#x2F;&#x2F;music.163.com&#x2F;#&#x2F;user&#x2F;home?id&#x3D;411590211"><i class="ic i-cloud-music"></i></a><a target="_blank" rel="noopener" href="https://space.bilibili.com/8013992" class="item bilibili" title="https:&#x2F;&#x2F;space.bilibili.com&#x2F;8013992"><i class="ic i-bilibili"></i></a></div><div class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item dropdown"><a href="#" onclick="return false;"><i class="ic i-user"></i>关于</a><ul class="submenu"><li class="item"><a href="/about/" rel="section"><i class="ic i-user"></i>关于本站</a></li><li class="item"><a href="/admiration/" rel="section"><i class="ic i-coffee"></i>赞赏博主</a></li></ul></li><li class="item dropdown"><a href="#" onclick="return false;"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li><li class="item"><a href="/friends/" rel="section"><i class="ic i-heart"></i>友链</a></li></div></div></div></div><ul id="quick"><li class="prev pjax"><a href="/c-cpp/linux-c/Linux%20%E8%BF%9B%E7%A8%8B%E6%B1%A0/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/c-cpp/linux-c/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"></div><div class="status"><div class="copyright">&copy; 2020 -<span itemprop="copyrightYear">2024</span><span class="with-love"><i class="ic i-sakura rotate"></i></span><span class="author" itemprop="copyrightHolder">樱小路七叶 @ 七葉の喫茶ステラ</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i></span><span title="站点总字数">1.5m 字</span><span class="post-meta-divider"> | </span><span class="post-meta-item-icon"><i class="ic i-coffee"></i></span><span title="站点阅读时长">22:36</span></div><div class="powered-by">基于 <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a> & Theme.<a target="_blank" rel="noopener" href="https://github.com/theme-shoka-x/hexo-theme-shokaX/">ShokaX</a></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL = {
    ispost: true,
        path: `c-cpp/linux-c/Linux 网络编程/`,
        favicon: {
        show: `（●´3｀●）やれやれだぜ`,
        hide: `(´Д｀)大変だ！`
    },
    search: {
        placeholder: "文章搜索",
        empty: "关于 「 ${query} 」，什么也没搜到",
        stats: "${time} ms 内找到 ${hits} 条结果"
    },
    copy_tex: false,
    katex: false,
    mermaid: false,
    audio: undefined,
    fancybox: true,
    nocopy: false,
    outime: true,
    template: `<div class="note warning"><p><span class="label warning">文章时效性提示</span><br>这是一篇发布于 {{publish}} 天前，最后一次更新在 {{updated}} 天前的文章，部分信息可能已经发生改变，请注意甄别。</p></div>`,
    quiz: {
        choice: `单选题`,
        multiple: `多选题`,
        true_false: `判断题`,
        essay: `问答题`,
        gap_fill: `填空题`,
        mistake: `错题备注`
    },
    ignores: [
        (uri) => uri.includes('#'),
        (uri) => new RegExp(LOCAL.path + '$').test(uri),
            []
    ]
};
</script><script src="https://s4.zstatic.net/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha384-k6YtvFUEIuEFBdrLKJ3YAUbBki333tj1CSUisai5Cswsg9wcLNaPzsTHDswp4Az8" crossorigin="anonymous" fetchpriority="high"></script><script src="https://s4.zstatic.net/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha384-ZvpUoO&#x2F;+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn&#x2F;6Z&#x2F;hRTt8+pR6L4N2" crossorigin="anonymous" fetchpriority="high"></script><script src="/js/siteInit.js?v=0.4.14" type="module" fetchpriority="high" defer></script></body></html>