<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"/><meta name="theme-color" content="#222"/><meta http-equiv="X-UA-COMPATIBLE" content="IE=edge,chrome=1"/><meta name="renderer" content="webkit"/><link rel="icon" type="image/ico" sizes="32x32" href="/assets/favicon.ico"/><link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png"/><link rel="alternate" href="/rss.xml" title="Nana7ha's Café Stella" type="application/rss+xml"><link rel="alternate" href="/atom.xml" title="Nana7ha's Café Stella" type="application/atom+xml"><link rel="alternate" type="application/json" title="Nana7ha's Café Stella" href="http://cwlrin.wiki/feed.json"/><link rel="preconnect" href="https://s4.zstatic.net"/><link rel="preconnect" href="https://at.alicdn.com"/><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Mulish:400,400italic,700,700italic%7CFredericka%20the%20Great:400,400italic,700,700italic%7CNoto%20Serif%20JP:400,400italic,700,700italic%7CNoto%20Serif%20SC:400,400italic,700,700italic%7CInconsolata:400,400italic,700,700italic&display=swap&subset=latin,latin-ext" media="none" onload="this.media&#x3D;&#39;all&#39;"><link rel="stylesheet" href="/css/app.css?v=0.4.20"><link rel="modulepreload" href="/js/chunk-NPDU2HRQ.js"></link><link rel="modulepreload" href="/js/chunk-R2ID445Y.js"></link><link rel="modulepreload" href="/js/chunk-YHPSMGA6.js"></link><link rel="modulepreload" href="/js/copy-tex-2AKW2INC.js"></link><link rel="modulepreload" href="/js/index.esm-TLZT3I4E.js"></link><link rel="modulepreload" href="/js/post-AWU7OAKV.js"></link><link rel="modulepreload" href="/js/quicklink-3TNKEFE4.js"></link><link rel="modulepreload" href="/js/siteInit.js"></link><link rel="preload" href="https://dlink.host/1drv/aHR0cHM6Ly8xZHJ2Lm1zL2kvYy9iZGU1MWU2MjVlZjhmY2M1L0VlNDNmRnlmRl9wRXUwV2xyUXVoOXlNQl91ZXJIc1cxbWtnTUg5NE5HTzQwN2c_ZT05Vm81VTc.png" as="image" fetchpriority="high"><meta name="keywords" content="C,"/><meta name="description" content="技术与美日新月异"/><link rel="canonical" href="http://cwlrin.wiki/c-cpp/linux-c/Linux%20%E7%BA%BF%E7%A8%8B/"><title>Linux 线程</title><meta name="generator" content="Hexo 7.3.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">Linux 线程</h1><div class="meta"><span class="item" title="创建时间：2020-09-11 14:13:00"><span class="icon"><i class="ic i-calendar"></i></span><span class="text">发表于</span><time itemprop="dateCreated datePublished" datetime="2020-09-11T14:13:00+08:00">2020-09-11</time></span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i></span><span class="text">本文字数</span><span>32k</span><span class="text">字</span></span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i></span><span class="text">阅读时长</span><span>29 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span><span class="line"></span><span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">七葉の喫茶ステラ</a></li></ul><ul class="right" id="rightNav"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div class="pjax" id="imgs"><img src="https://dlink.host/1drv/aHR0cHM6Ly8xZHJ2Lm1zL2kvYy9iZGU1MWU2MjVlZjhmY2M1L0VlNDNmRnlmRl9wRXUwV2xyUXVoOXlNQl91ZXJIc1cxbWtnTUg5NE5HTzQwN2c_ZT05Vm81VTc.png" loading="eager" decoding="async" fetchpriority="high" alt="Nana7ha's Café Stella"></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"></path></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"></use><use xlink:href="#gentle-wave" x="48" y="3"></use><use xlink:href="#gentle-wave" x="48" y="5"></use><use xlink:href="#gentle-wave" x="48" y="7"></use></g></svg></div><main><div class="inner"><div class="pjax" id="main"><div class="article wrap"><div class="breadcrumb" itemListElement itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i><span><a href="/">首页</a></span><i class="ic i-angle-right"></i><span itemprop="itemListElement" itemscope="itemscope" itemtype="https://schema.org/ListItem"><a href="/categories/c-cpp/" itemprop="item" rel="index" title="分类于C/C++"><span itemprop="name">C/C++<meta itemprop="position" content="0"/></span></a></span><i class="ic i-angle-right"></i><span class="current" itemprop="itemListElement" itemscope="itemscope" itemtype="https://schema.org/ListItem"><a href="/categories/c-cpp/linux-c/" itemprop="item" rel="index" title="分类于Linux C"><span itemprop="name">Linux C<meta itemprop="position" content="1"/></span></a></span></div><article class="post block" itemscope="itemscope" itemtype="http://schema.org/Article" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://cwlrin.wiki/c-cpp/linux-c/Linux%20%E7%BA%BF%E7%A8%8B/"/><span hidden="hidden" itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="image" content="/assets/avatar.jpg"/><meta itemprop="name" content="樱小路七叶"/><meta itemprop="description" content=", 技术与美日新月异"/></span><span hidden="hidden" itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="Nana7ha's Café Stella"/></span><div class="body md" itemprop="articleBody"><h2 id="线程概述"><a class="anchor" href="#线程概述">#</a> 线程概述</h2>
<h3 id="从进程到线程"><a class="anchor" href="#从进程到线程">#</a> 从进程到线程</h3>
<p>在计算机系统中，多进程设计允许用户在同一台计算机上同时处理多个独立的工作任务。操作系统负责管理这些进程，通过调度算法合理地在它们之间分配 CPU 资源、内存、文件等资源。使用多进程设计不仅可以提高单个应用的吞吐量和响应时间，还可以在某个进程因死循环或等待 IO 操作而无法完成任务时，由操作系统调度其他进程来完成任务或响应用户请求。</p>
<p>例如，在文本处理程序中，可以并发地处理用户输入和保存已完成的文件任务。然而，随着进程数量的增加，系统在切换不同进程时会消耗更多的时间。这是因为进程执行过程中，CPU 寄存器中需要保存一些必要的信息，如堆栈、代码段等，这些状态被称为上下文。上下文切换涉及到大量的寄存器和内存之间的保存和载入工作。</p>
<p>在 Linux 操作系统中，每个用户进程都拥有自己独立的地址空间，这要求每个进程有自己独立的页目录表（用于映射虚拟地址到物理地址）。TLB（Translation Lookaside Buffer）是页目录表的缓存，用于存储最近使用的物理和虚拟地址映射。因此，在 Linux 操作系统中，进程切换包括以下两步：</p>
<ol>
<li>切换页目录表，以支持新进程的地址空间。</li>
<li>进入内核态，将硬件上下文（即 CPU 寄存器的内容）以及内核态栈切换到新的进程。</li>
</ol>
<p>这种设计确保了进程之间的隔离和独立性，同时也带来了上下文切换的开销。</p>
<p><img loading="lazy" data-src="https://dlink.host/1drv/aHR0cHM6Ly8xZHJ2Lm1zL2kvYy9iZGU1MWU2MjVlZjhmY2M1L0VjVThMTkpHRk9SS2w5Uzdsbldwdm1NQm42eThjRnI2NWFmdjR3eXJPSEQteWc_ZT1xMkJNMXI.jpg" alt="TLBCache.png" /></p>
<p>线程的引入旨在减少进程切换的开销，提供一种更高效的并发执行方式。线程，也称为轻量级进程（Light Weight Process, LWP），允许一个进程被分解为多个独立的运行实体。这些线程能够并发运行，使得线程成为 CPU 分配和调度的最小单位。</p>
<p>在 Linux 操作系统中，每个线程都拥有自己独立的  <code>task_struct</code>  结构体，这是线程管理和调度的基础。尽管属于同一个进程的多个线程会共享许多资源，但它们的  <code>task_struct</code>  结构体中仍然包含一些独立的字段。</p>
<p>Linux 中的线程并没有脱离进程而独立存在。计算机的内存、文件、IO 设备等资源仍然是按进程为单位进行分配的。同一个进程内的多个线程会共享进程的地址空间，每个线程在执行过程中拥有自己独立的栈，而堆、数据段、代码段、文件描述符和信号屏蔽字等资源则是共享的。</p>
<p><img loading="lazy" data-src="https://dlink.host/1drv/aHR0cHM6Ly8xZHJ2Lm1zL2kvYy9iZGU1MWU2MjVlZjhmY2M1L0VSODloMkNwd2NKQXBtQ3gySU9MOWc0QnY0VVhScE93T1JXVEYzSGw2TVhWYnc_ZT1Vc0s1aVM.png" alt="e7d82e742e4d66a8b5332280a6578084.png" /></p>
<p>由于同一进程内的多个线程共享相同的地址空间，线程切换不需要执行页目录表的切换。这意味着在进行线程切换时，上下文切换的开销大大减少。在线程切换过程中，只需要更新栈指针（用于指向当前线程的栈帧）和程序计数器（PC 指针，用于指示下一条指令）。除此之外，其他控制信息如数据段和代码段等保持不变，因为它们是线程间共享的。</p>
<p>尽管每个线程都拥有独立的栈，但它们位于进程的统一地址空间内。这使得一个线程可以通过地址引用来访问另一个线程的栈区域，但在实践中出于线程安全考虑，通常不鼓励这样做。</p>
<blockquote>
<p>在 Linux 文件系统中， <code>/proc</code>  是一个特殊的伪文件系统，它提供了一种访问内核数据结构的方式。用户可以通过传统的文件操作，如使用  <code>read</code>  系统调用，来读取这些数据。</p>
<p><code>/proc</code>  文件系统中的每个目录都对应着一个正在运行的进程。例如， <code>/proc/[num]</code>  目录包含了进程 ID 为  <code>num</code>  的进程的相关信息。这些信息包括进程的状态、内存使用情况、打开的文件等。</p>
<p>进一步地， <code>/proc/[num]/task</code>  目录包含了该进程中所有线程的内核数据。这些数据对于分析进程的线程行为、性能调优等方面非常有用。</p>
</blockquote>
<h3 id="用户级线程和内核级线程"><a class="anchor" href="#用户级线程和内核级线程">#</a> 用户级线程和内核级线程</h3>
<p>在 Linux 2.4 及之前的版本中，由于缺乏线程概念，Linux 内核并不识别线程。随着技术的发展，人们逐渐认识到线程相比进程具有更少的创建开销和更快的切换速度，因此开始寻求在 Linux 上实现多线程编程的方法。然而，修改操作系统内核并非易事，因此最初的解决方案是通过编写函数库来模拟线程，而不是直接修改内核。这些函数库构成了最初的用户级线程库，它们在 Linux 内核中使用进程来模拟线程的行为。</p>
<p>尽管当时的线程库已经非常接近 POSIX 标准，但在信号处理等方面仍存在一些细微差别。这些差异主要是由于底层 Linux 内核的限制，而非函数库本身所能改变的。为了改善 Linux 对线程的支持，许多项目开始研究如何将用户级线程映射到内核级线程。</p>
<p>IBM 公司的 NGPT（Next Generation POSIX Threads）和 Red Hat 公司的 NPTL（Native POSIX Thread Library）通过修改 Linux 内核来支持新的线程库，两者都显著提高了性能。2002 年，NGPT 项目组宣布停止为 NGPT 添加新功能，以避免团队分化。因此，NPTL 成为了 Linux 线程的新标准。在 NPTL 中，内核负责处理每个线程堆栈所使用的内存的回收工作，并在清除父线程之前等待，以实现对所有线程结束的管理。</p>
<p>当前最广泛使用的线程库是 <strong>NPTL</strong>（Native POSIX Threads Library），自 Linux 内核 2.6 版本起，它已经取代了旧版的 LinuxThreads 线程库。NPTL 遵循了 POSIX 线程标准库，提供了对多线程编程的原生支持。</p>
<p>在早期版本中，NPTL 仅支持用户级线程，这意味着线程的创建和管理并没有深入到内核层面。但随着 Linux 内核的不断演进，NPTL 现在已经能够支持每个用户级线程对应一个内核态线程。这种设计使得 NPTL 线程本质上成为了内核级线程，能够被操作系统直接调度和管理。</p>
<p>用户级线程和内核级线程在操作系统中扮演着不同的角色，它们之间的主要差异如下:</p>
<ol>
<li><strong>实现层面</strong>：用户级线程完全在用户空间实现，这意味着它们不依赖于操作系统内核的直接支持。相反，内核级线程则是由操作系统内核直接创建和管理的，它们与内核紧密集成。</li>
<li><strong>执行环境</strong>：用户级线程在用户态下执行，这意味着它们无法直接访问内核态的资源和功能。而内核级线程则具有在任何 CPU 模式下运行的能力，可以充分利用操作系统提供的全部资源。</li>
<li><strong>上下文切换</strong>：用户级线程的上下文切换完全由用户程序控制，这提供了更高的灵活性，但同时也要求程序员具备更高的并发控制能力。内核级线程的上下文切换则由操作系统内核处理，这通常更加高效，但可能不如用户级线程灵活。</li>
<li><strong>调度机制</strong>：用户级线程的调度是由用户程序中的线程库来管理的，这允许开发者根据应用需求定制调度策略。内核级线程的调度则遵循操作系统的调度算法，由内核负责分配处理器时间。</li>
</ol>
<h2 id="线程的创建"><a class="anchor" href="#线程的创建">#</a> 线程的创建</h2>
<table>
<thead>
<tr>
<th>线程函数</th>
<th>功能</th>
<th>类似的进程函数</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>pthread_create</code></td>
<td>创建一个线程</td>
<td><code>fork</code></td>
</tr>
<tr>
<td><code>pthread_exit</code></td>
<td>线程退出</td>
<td><code>exit</code></td>
</tr>
<tr>
<td><code>pthread_join</code></td>
<td>等待线程结束并回收资源</td>
<td><code>wait</code></td>
</tr>
<tr>
<td><code>pthread_self</code></td>
<td>获取线程 id</td>
<td><code>getpid</code></td>
</tr>
</tbody>
</table>
<h3 id="pthread_create-创建新的线程"><a class="anchor" href="#pthread_create-创建新的线程">#</a>  <code>pthread_create</code>   创建新的线程</h3>
<p><code>pthread_create</code>  是 POSIX 线程库中的一个函数，用于创建一个新的线程。这个函数是多线程编程中的核心，允许程序并行执行多个任务。</p>
<p>函数原型如下：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">int</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token class-name">pthread_t</span> <span class="token operator">*</span>thread<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token class-name">pthread_attr_t</span> <span class="token operator">*</span>attr<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>start_routine<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>参数说明：</p>
<ol>
<li><strong>pthread_t *thread</strong>: 这是一个指向  <code>pthread_t</code>  类型的指针，用于存储新创建线程的标识符。 <code>pthread_t</code>  是线程的全局唯一标识符。</li>
<li><strong>const pthread_attr_t *attr</strong>: 这是一个指向  <code>pthread_attr_t</code>  结构的指针，该结构包含了线程的属性，如栈大小、调度策略等。如果不需要设置特定的属性，可以传递  <code>NULL</code> ，此时线程将使用默认属性。</li>
<li><strong>void *(*start_routine)(void *)</strong>: 这是一个函数指针，指向新线程将执行的函数。这个函数应该接受一个  <code>void*</code>  类型的参数，并返回一个  <code>void*</code>  类型的值。</li>
<li><strong>void *arg</strong>: 这是传递给线程启动函数  <code>start_routine</code>  的参数。</li>
</ol>
<p>返回值：</p>
<ul>
<li>如果  <code>pthread_create</code>  调用成功，返回 0。</li>
<li>如果调用失败，返回一个错误码，如  <code>EAGAIN</code> （资源暂时不可用）或  <code>ENOMEM</code> （内存不足）。</li>
</ul>
<p>使用  <code>pthread_create</code>  时，需要注意以下几点：</p>
<ul>
<li><strong>线程函数</strong>：线程启动函数应该具有特定的签名，即接受  <code>void*</code>  类型的参数并返回  <code>void*</code>  类型的值。</li>
<li><strong>线程属性</strong>：可以通过  <code>pthread_attr_init</code>  初始化线程属性，并通过一系列  <code>pthread_attr_set*</code>  函数设置属性。</li>
<li><strong>线程标识符</strong>：成功创建线程后， <code>thread</code>  参数将包含新线程的标识符，可用于其他线程操作，如等待线程结束（ <code>pthread_join</code> ）。</li>
<li><strong>线程同步</strong>：多线程程序中需要考虑线程同步问题，以避免竞态条件和数据不一致。</li>
</ul>
<p>下面是一个简单的  <code>pthread_create</code>  函数使用示例：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">print_hello</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Hello from thread!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token class-name">pthread_t</span> thread_id<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>thread_id<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> print_hello<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Failed to create thread"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token comment">// 等待线程结束</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token function">pthread_join</span><span class="token punctuation">(</span>thread_id<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Thread finished.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>在这个示例中，我们定义了一个简单的线程函数  <code>print_hello</code> ，它打印一条消息。在  <code>main</code>  函数中，我们使用  <code>pthread_create</code>  创建了一个新的线程，该线程执行  <code>print_hello</code>  函数。然后，我们使用  <code>pthread_join</code>  等待线程结束，以确保在主线程退出前，新线程已经完成执行。</p>
<p>注意：当使用与线程相关的函数时，编译链接过程中需加入  <code>-lpthread</code>  和  <code>-pthread</code>  选项，以确保正确链接到线程库。</p>
<p>在进程的生命周期内，每个线程都拥有一个独立且唯一的标识符，即线程 ID。在 NPTL（Native POSIX Thread Library）中，线程 ID 通过  <code>pthread_t</code>  类型进行存储。值得注意的是，不同操作系统对  <code>pthread_t</code>  的底层实现各有差异；在 Linux 系统中，它通常是一个无符号整数。此外，可以通过  <code>pthread_self()</code>  函数获取当前线程的 ID。</p>
<p>操作系统在创建新进程时（例如，通过运行一个程序），会自动生成一个线程，即该进程的主线程。当主线程结束其执行（例如，通过  <code>main()</code>  函数返回或调用  <code>exit()</code>  函数），这将导致整个进程及其所有子线程随之终止。然而，如果主线程是通过调用  <code>pthread_exit()</code>  来结束的，它不会引发进程的终止，允许进程内的其他线程继续执行。</p>
<h3 id="线程函数错误处理"><a class="anchor" href="#线程函数错误处理">#</a> 线程函数错误处理</h3>
<p>在传统的 POSIX 系统中，当系统调用或库函数遇到错误时，它们会更新全局变量  <code>errno</code> ，该变量在每个进程中是独立的。这样做允许程序通过调用  <code>perror</code>  函数来获取易于理解的错误信息。然而，在多线程编程中，全局变量可能成为多个线程共享的资源，从而面临并发读写的风险。</p>
<p>为了优化这一问题， <code>pthread</code>  系列的函数采用了一种不同的错误检测方法。这些函数通过返回特定的错误代码来指示错误类型，而不是修改全局的  <code>errno</code>  变量。随后，程序可以使用  <code>strerror</code>  函数，根据这些错误代码来获取对应的、易于理解的错误描述字符串。</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">strerror</span><span class="token punctuation">(</span><span class="token keyword">int</span> errnum<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">THREAD_ERROR_CHECK</span><span class="token expression"><span class="token punctuation">(</span>ret<span class="token punctuation">,</span> msg<span class="token punctuation">)</span>                   </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token expression"><span class="token punctuation">&#123;</span>                                                    </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                                    </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="6"></td><td><pre>      <span class="token expression"><span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> </span><span class="token string">"%s:%s \n"</span><span class="token expression"><span class="token punctuation">,</span> msg<span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token expression"><span class="token punctuation">&#125;</span>                                                  </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token expression"><span class="token punctuation">&#125;</span></span></span></pre></td></tr></table></figure><h2 id="线程和数据共享"><a class="anchor" href="#线程和数据共享">#</a> 线程和数据共享</h2>
<h3 id="共享数据段"><a class="anchor" href="#共享数据段">#</a> 共享数据段</h3>
<p>在多线程编程中，共享地址空间意味着多个线程能够并发访问相同的数据段、堆空间以及其他内存区域。这为线程间的数据共享和通信提供了便利，但同时也需要谨慎处理，以避免竞态条件和数据不一致的问题。</p>
<p>下面是一个共享数据段的例子：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h></span> <span class="token comment">// 引入线程库头文件</span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span> <span class="token comment">// 引入标准库头文件，用于 exit 函数</span></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span> <span class="token comment">// 引入 unistd.h 以使用 sleep 函数</span></span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">// 定义全局变量，所有线程共享</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">int</span> global <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment">// 定义线程函数</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">threadFunc</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token comment">// 打印子线程信息</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"I am child thread\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token comment">// 打印全局变量的值</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child thread, global = %d\n"</span><span class="token punctuation">,</span> global<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token comment">// 定义错误检查宏</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">THREAD_ERROR_CHECK</span><span class="token expression"><span class="token punctuation">(</span>err<span class="token punctuation">,</span> msg<span class="token punctuation">)</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token expression"><span class="token keyword">do</span> <span class="token punctuation">&#123;</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="22"></td><td><pre>            <span class="token expression"><span class="token function">perror</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="23"></td><td><pre>            <span class="token expression"><span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token expression"><span class="token punctuation">&#125;</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token expression"><span class="token punctuation">&#125;</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token class-name">pthread_t</span> tid<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token keyword">int</span> ret<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token comment">// 创建线程</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    ret <span class="token operator">=</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> threadFunc<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token function">THREAD_ERROR_CHECK</span><span class="token punctuation">(</span>ret<span class="token punctuation">,</span> <span class="token string">"pthread_create"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token comment">// 打印主线程信息</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"I am main thread\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token comment">// 修改全局变量的值</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    global <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token comment">// 打印主线程中全局变量的值</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"main thread, global = %d\n"</span><span class="token punctuation">,</span> global<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token comment">// 等待一段时间，让子线程有机会执行</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre></pre></td></tr><tr><td data-num="46"></td><td><pre>    <span class="token comment">// 等待子线程结束</span></pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token function">pthread_join</span><span class="token punctuation">(</span>tid<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre></pre></td></tr><tr><td data-num="49"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="共享堆空间"><a class="anchor" href="#共享堆空间">#</a> 共享堆空间</h3>
<p>在多线程编程中，堆空间的共享是一个常见的做法，它允许不同的线程访问和操作同一块内存区域。这种共享机制需要谨慎使用，以确保线程安全和避免潜在的内存问题。</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">// 定义错误检查宏</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">THREAD_ERROR_CHECK</span><span class="token expression"><span class="token punctuation">(</span>err<span class="token punctuation">,</span> msg<span class="token punctuation">)</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token expression"><span class="token keyword">do</span> <span class="token punctuation">&#123;</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="11"></td><td><pre>            <span class="token expression"><span class="token function">perror</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            <span class="token expression"><span class="token function">free</span><span class="token punctuation">(</span>pHeap<span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token comment">// 释放内存以防内存泄漏 \</pre></td></tr><tr><td data-num="13"></td><td><pre>            exit (EXIT_FAILURE); \</pre></td></tr><tr><td data-num="14"></td><td><pre>        &#125; \</pre></td></tr><tr><td data-num="15"></td><td><pre>    &#125; while (0)</span></span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token comment">// 定义线程函数</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">threadFunc</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">char</span><span class="token operator">*</span> pHeap <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"I am child thread\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token comment">// 子线程修改堆空间内容</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token function">strcpy</span><span class="token punctuation">(</span>pHeap<span class="token punctuation">,</span> <span class="token string">"world"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child thread, %s\n"</span><span class="token punctuation">,</span> pHeap<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token keyword">char</span><span class="token operator">*</span> pHeap <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 分配堆空间</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>pHeap <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"malloc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token function">strcpy</span><span class="token punctuation">(</span>pHeap<span class="token punctuation">,</span> <span class="token string">"hello"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 初始化堆空间内容</span></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token class-name">pthread_t</span> tid<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> threadFunc<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>pHeap<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token function">THREAD_ERROR_CHECK</span><span class="token punctuation">(</span>ret<span class="token punctuation">,</span> <span class="token string">"pthread_create"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"I am main thread\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token comment">// 主线程等待子线程完成</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token function">pthread_join</span><span class="token punctuation">(</span>tid<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre></pre></td></tr><tr><td data-num="46"></td><td><pre>    <span class="token comment">// 主线程输出堆空间内容</span></pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"parent thread, %s\n"</span><span class="token punctuation">,</span> pHeap<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre></pre></td></tr><tr><td data-num="49"></td><td><pre>    <span class="token function">free</span><span class="token punctuation">(</span>pHeap<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 释放堆空间</span></pre></td></tr><tr><td data-num="50"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="访问栈数据"><a class="anchor" href="#访问栈数据">#</a> 访问栈数据</h3>
<p>在多线程编程中，每个线程确实拥有自己独立的栈空间，但它们共享同一个地址空间。这意味着，如果一个线程获得了另一个线程栈帧中数据的地址，它理论上可以访问或修改这些数据。然而，这种做法是不安全的，因为它可能导致数据竞争和不可预测的行为。</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">// 定义错误检查宏</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">THREAD_ERROR_CHECK</span><span class="token expression"><span class="token punctuation">(</span>err<span class="token punctuation">,</span> msg<span class="token punctuation">)</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token expression"><span class="token keyword">do</span> <span class="token punctuation">&#123;</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            <span class="token expression"><span class="token function">perror</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="11"></td><td><pre>            <span class="token expression"><span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token expression"><span class="token punctuation">&#125;</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token expression"><span class="token punctuation">&#125;</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token comment">// 定义线程函数</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">threadFunc</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"I am child thread\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token comment">// 子线程修改通过参数传递的值</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token keyword">int</span><span class="token operator">*</span> pval <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token operator">*</span>pval <span class="token operator">=</span> <span class="token number">1002</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child, val = %d\n"</span><span class="token punctuation">,</span> <span class="token operator">*</span>pval<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token class-name">pthread_t</span> tid<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token keyword">int</span> val <span class="token operator">=</span> <span class="token number">1001</span><span class="token punctuation">;</span> <span class="token comment">// 主线程栈上的数据</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> threadFunc<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token function">THREAD_ERROR_CHECK</span><span class="token punctuation">(</span>ret<span class="token punctuation">,</span> <span class="token string">"pthread_create"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"I am main thread\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token comment">// 主线程等待子线程完成，以确保数据安全</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token function">pthread_join</span><span class="token punctuation">(</span>tid<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token comment">// 主线程输出修改后的值</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"main, val = %d\n"</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="long-作为-8-字节参数"><a class="anchor" href="#long-作为-8-字节参数">#</a> long 作为 8 字节参数</h3>
<p>在多线程编程中， <code>void*</code>  类型的参数  <code>arg</code>  通常用于传递指向数据的指针。然而，如果需要传递的只是一个简单的值，可以将  <code>void*</code>  类型参数直接视为一个 8 字节的数据类型（如  <code>long</code> ），这样可以避免指针的间接引用。</p>
<p><strong>传递地址的方式：</strong></p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">THREAD_ERROR_CHECK</span><span class="token expression"><span class="token punctuation">(</span>err<span class="token punctuation">,</span> msg<span class="token punctuation">)</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token expression"><span class="token keyword">do</span> <span class="token punctuation">&#123;</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="8"></td><td><pre>            <span class="token expression"><span class="token function">perror</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="9"></td><td><pre>            <span class="token expression"><span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token expression"><span class="token punctuation">&#125;</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token expression"><span class="token punctuation">&#125;</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">threadFunc</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"I am child thread\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">int</span><span class="token operator">*</span> intnum <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child, val = %d\n"</span><span class="token punctuation">,</span> <span class="token operator">*</span>intnum<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token class-name">pthread_t</span> tid<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token keyword">int</span> val <span class="token operator">=</span> <span class="token number">1001</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> threadFunc<span class="token punctuation">,</span> <span class="token operator">&amp;</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token function">THREAD_ERROR_CHECK</span><span class="token punctuation">(</span>ret<span class="token punctuation">,</span> <span class="token string">"pthread_create"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token comment">// 修改 val 的值，但子线程不会看到这个改变</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    val <span class="token operator">=</span> <span class="token number">1002</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    ret <span class="token operator">=</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> threadFunc<span class="token punctuation">,</span> <span class="token operator">&amp;</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token function">THREAD_ERROR_CHECK</span><span class="token punctuation">(</span>ret<span class="token punctuation">,</span> <span class="token string">"pthread_create"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"I am main thread\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token function">pthread_join</span><span class="token punctuation">(</span>tid<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 等待子线程完成</span></pre></td></tr><tr><td data-num="33"></td><td><pre></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><strong>直接传递 8 字节数据的方式：</strong></p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">THREAD_ERROR_CHECK</span><span class="token expression"><span class="token punctuation">(</span>err<span class="token punctuation">,</span> msg<span class="token punctuation">)</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token expression"><span class="token keyword">do</span> <span class="token punctuation">&#123;</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="8"></td><td><pre>            <span class="token expression"><span class="token function">perror</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="9"></td><td><pre>            <span class="token expression"><span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token expression"><span class="token punctuation">&#125;</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token expression"><span class="token punctuation">&#125;</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">threadFunc</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"I am child thread\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token comment">// 直接将参数视为 long 类型</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child, val = %ld\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token class-name">pthread_t</span> tid<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token keyword">long</span> val <span class="token operator">=</span> <span class="token number">1001</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> threadFunc<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token function">THREAD_ERROR_CHECK</span><span class="token punctuation">(</span>ret<span class="token punctuation">,</span> <span class="token string">"pthread_create"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token comment">// 修改 val 的值，子线程将看到这个改变</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    val <span class="token operator">=</span> <span class="token number">1002</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    ret <span class="token operator">=</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> threadFunc<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token function">THREAD_ERROR_CHECK</span><span class="token punctuation">(</span>ret<span class="token punctuation">,</span> <span class="token string">"pthread_create"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"I am main thread\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token function">pthread_join</span><span class="token punctuation">(</span>tid<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 等待子线程完成</span></pre></td></tr><tr><td data-num="33"></td><td><pre></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="栈数据共享的释放"><a class="anchor" href="#栈数据共享的释放">#</a> 栈数据共享的释放</h3>
<p>在多线程编程中，如果一个线程需要访问另一个线程的栈数据，必须确保数据在被访问时仍然有效。在下面的示例代码中， <code>func</code>  函数创建了一个线程来访问其局部变量  <code>val</code>  的地址。然而，当  <code>func</code>  函数返回时，局部变量  <code>val</code>  的生命周期结束，其内存被释放，这可能导致未定义行为，因为子线程可能还在访问这个内存。</p>
<p>为了解决这个问题，需要确保  <code>val</code>  在子线程访问期间保持有效。这通常通过在  <code>func</code>  函数外部定义  <code>val</code>  来实现，或者使用动态分配的内存，并在所有线程完成访问后才释放它。</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">THREAD_ERROR_CHECK</span><span class="token expression"><span class="token punctuation">(</span>err<span class="token punctuation">,</span> msg<span class="token punctuation">)</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token expression"><span class="token keyword">do</span> <span class="token punctuation">&#123;</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="9"></td><td><pre>            <span class="token expression"><span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> </span><span class="token string">"%s\n"</span><span class="token expression"><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            <span class="token expression"><span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token expression"><span class="token punctuation">&#125;</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token expression"><span class="token punctuation">&#125;</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">threadFunc</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 模拟耗时操作</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">int</span><span class="token operator">*</span> intnum <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"I am child thread\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child, val = %d\n"</span><span class="token punctuation">,</span> <span class="token operator">*</span>intnum<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token keyword">void</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token keyword">static</span> <span class="token keyword">int</span> val <span class="token operator">=</span> <span class="token number">1001</span><span class="token punctuation">;</span> <span class="token comment">// 使用静态变量以延长生命周期</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token class-name">pthread_t</span> tid<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> threadFunc<span class="token punctuation">,</span> <span class="token operator">&amp;</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token function">THREAD_ERROR_CHECK</span><span class="token punctuation">(</span>ret<span class="token punctuation">,</span> <span class="token string">"Failed to create thread"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token comment">// 等待子线程完成</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token function">pthread_join</span><span class="token punctuation">(</span>tid<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"function over\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="33"></td><td><pre></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 调用函数</span></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"I am main thread\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 确保子线程有足够的时间执行</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="获取线程的退出状态"><a class="anchor" href="#获取线程的退出状态">#</a> 获取线程的退出状态</h2>
<h3 id="ps-ellf"><a class="anchor" href="#ps-ellf">#</a>  <code>ps -elLf</code></h3>
<p><code>ps -elLf</code>  是一个在 Unix-like 系统中用于显示当前进程和线程信息的命令。 <code>ps</code>  命令的各个选项的含义如下：</p>
<ul>
<li><code>-e</code>  显示所有进程。</li>
<li><code>-l</code>  显示长格式输出，包括更多详细信息。</li>
<li><code>-L</code>  显示线程信息。</li>
<li><code>-f</code>  显示完整格式。</li>
</ul>
<p>对于下面的代码：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">THREAD_ERROR_CHECK</span><span class="token expression"><span class="token punctuation">(</span>err<span class="token punctuation">,</span> msg<span class="token punctuation">)</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token expression"><span class="token keyword">do</span> <span class="token punctuation">&#123;</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="9"></td><td><pre>            <span class="token expression"><span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> </span><span class="token string">"%s\n"</span><span class="token expression"><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            <span class="token expression"><span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token expression"><span class="token punctuation">&#125;</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token expression"><span class="token punctuation">&#125;</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">fun1</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token comment">// 子线程将睡眠 10 秒</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token class-name">pthread_t</span> pid<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pid<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> fun1<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token function">THREAD_ERROR_CHECK</span><span class="token punctuation">(</span>ret<span class="token punctuation">,</span> <span class="token string">"Error creating thread"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token comment">// 主线程将睡眠 20 秒，确保子线程有足够的时间执行</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token comment">// 等待子线程结束</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token function">pthread_join</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Main thread finished.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>执行  <code>ps -elLf</code>  如下：</p>
<p><img loading="lazy" data-src="https://dlink.host/1drv/aHR0cHM6Ly8xZHJ2Lm1zL2kvYy9iZGU1MWU2MjVlZjhmY2M1L0VWeE0tSHBNZXo5TXJmV0htbEw1bk9BQlJLSTMxSnFIVXFqc2xqMS1qV3hneXc_ZT0waloxSTM.png" alt="" /></p>
<h3 id="pthread_join-等待线程结束"><a class="anchor" href="#pthread_join-等待线程结束">#</a>  <code>pthread_join</code>   等待线程结束</h3>
<p><code>pthread_join</code>  是 POSIX 线程库中的一个函数，用于等待一个线程结束。当一个线程（称为 “工作线程”）被创建后，通常主线程或其他线程可能需要等待这个工作线程完成其任务。 <code>pthread_join</code>  函数允许调用线程（通常称为 “等待线程”）挂起，直到被指定的工作线程终止。</p>
<p>函数原型如下：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">int</span> <span class="token function">pthread_join</span><span class="token punctuation">(</span><span class="token class-name">pthread_t</span> thread<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span>retval<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>参数说明：</p>
<ol>
<li><strong>pthread_t thread</strong>: 这是要等待的线程的标识符。这个标识符是通过  <code>pthread_create</code>  函数返回的。</li>
<li><strong>void **retval</strong>: 这是一个可选参数，如果提供了这个指针的地址， <code>pthread_join</code>  将把工作线程的返回值存储在这个地址指向的位置。如果不需要工作线程的返回值，可以传递  <code>NULL</code> 。</li>
</ol>
<p>返回值：</p>
<ul>
<li>如果  <code>pthread_join</code>  调用成功，返回 0。</li>
<li>如果调用失败，返回一个错误码。例如，如果指定的线程已经结束了，或者  <code>thread</code>  参数指定的线程标识符无效，将返回  <code>EINVAL</code> 。</li>
</ul>
<p>使用  <code>pthread_join</code>  时，需要注意以下几点：</p>
<ul>
<li><strong>线程同步</strong>:  <code>pthread_join</code>  是一种同步机制，确保工作线程在等待线程继续执行之前已经结束。</li>
<li><strong>资源清理</strong>：通常在  <code>pthread_join</code>  成功返回后，可以安全地释放工作线程可能分配的资源。</li>
<li><strong>线程返回值</strong>：如果需要获取工作线程的返回值，可以传递一个指针来接收这个值。</li>
</ul>
<p>下面是一个简单的  <code>pthread_join</code>  函数使用示例：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">thread_function</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Thread is running.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 返回值，表示线程成功执行</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token class-name">pthread_t</span> tid<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">int</span> <span class="token operator">*</span>retval<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token comment">// 创建线程</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> thread_function<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Failed to create thread"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token comment">// 等待线程结束，并获取返回值</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">pthread_join</span><span class="token punctuation">(</span>tid<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>retval<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Thread finished with return value: %d\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>retval<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Failed to join thread"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>在这个示例中，我们创建了一个线程，该线程执行  <code>thread_function</code>  函数，并返回一个整数值。在  <code>main</code>  函数中，我们使用  <code>pthread_join</code>  等待这个线程结束，并通过  <code>retval</code>  参数获取线程的返回值。如果  <code>pthread_join</code>  成功，我们打印出线程的返回值。如果  <code>pthread_join</code>  失败，我们打印出错误信息。</p>
<p><code>pthread_join</code>  函数使得调用它的线程（等待线程）挂起，直到被指定的线程（目标线程）终止。一旦目标线程结束，等待线程将被唤醒，并继续执行。如果提供了  <code>retval</code>  指针，目标线程的退出状态将被存储在  <code>retval</code>  指向的内存位置中。</p>
<p><code>pthread_join</code>  可以由任何线程调用，以等待任何其他线程的结束，而不仅仅是由创建该线程的父线程调用。这意味着线程之间的捕获关系不必是严格的父子关系。</p>
<p>尽管多个线程可以尝试通过调用  <code>pthread_join</code>  来捕获同一个线程的结束状态，但只有一个调用会成功捕获该线程的退出状态。其他调用将失败，并返回错误。</p>
<p>使用  <code>retval</code>  指针捕获线程函数内部的局部数据时，需要特别小心。因为局部变量在线程函数返回时生命周期结束，如果尝试通过  <code>retval</code>  指针访问这些数据，可能会导致未定义的行为或程序崩溃。</p>
<h2 id="线程的主动退出"><a class="anchor" href="#线程的主动退出">#</a> 线程的主动退出</h2>
<h3 id="线程的-return-退出"><a class="anchor" href="#线程的-return-退出">#</a> 线程的 return 退出</h3>
<p><strong>示例 1：线程正常退出</strong></p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">THREAD_ERROR_CHECK</span><span class="token expression"><span class="token punctuation">(</span>err<span class="token punctuation">,</span> msg<span class="token punctuation">)</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token expression"><span class="token keyword">do</span> <span class="token punctuation">&#123;</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="9"></td><td><pre>            <span class="token expression"><span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> </span><span class="token string">"%s\n"</span><span class="token expression"><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            <span class="token expression"><span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token expression"><span class="token punctuation">&#125;</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token expression"><span class="token punctuation">&#125;</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">funThread</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"funThread sleep over\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token comment">// 线程正常退出</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token class-name">pthread_t</span> threadId<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>threadId<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> funThread<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token function">THREAD_ERROR_CHECK</span><span class="token punctuation">(</span>ret<span class="token punctuation">,</span> <span class="token string">"pthread_create"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token comment">// 等待线程结束</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token keyword">int</span> ret_join <span class="token operator">=</span> <span class="token function">pthread_join</span><span class="token punctuation">(</span>threadId<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token function">THREAD_ERROR_CHECK</span><span class="token punctuation">(</span>ret_join<span class="token punctuation">,</span> <span class="token string">"pthread_join"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token comment">// 此处 ret_join 应为 0，表示成功</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child thread join status = %d\n"</span><span class="token punctuation">,</span> ret_join<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><strong>示例 2：通过  <code>pthread_join</code>  捕获线程退出状态</strong></p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">THREAD_ERROR_CHECK</span><span class="token expression"><span class="token punctuation">(</span>err<span class="token punctuation">,</span> msg<span class="token punctuation">)</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token expression"><span class="token keyword">do</span> <span class="token punctuation">&#123;</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="9"></td><td><pre>            <span class="token expression"><span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> </span><span class="token string">"%s\n"</span><span class="token expression"><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            <span class="token expression"><span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token expression"><span class="token punctuation">&#125;</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token expression"><span class="token punctuation">&#125;</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">fun1</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token comment">// 线程退出并返回一个值</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">11</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token class-name">pthread_t</span> pid<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pid<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> fun1<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token function">THREAD_ERROR_CHECK</span><span class="token punctuation">(</span>ret<span class="token punctuation">,</span> <span class="token string">"pthread_create"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token keyword">void</span><span class="token operator">*</span> numP<span class="token punctuation">;</span> <span class="token comment">// 用于接收线程返回值的指针</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token keyword">int</span> ret_join <span class="token operator">=</span> <span class="token function">pthread_join</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span> <span class="token operator">&amp;</span>numP<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token function">THREAD_ERROR_CHECK</span><span class="token punctuation">(</span>ret_join<span class="token punctuation">,</span> <span class="token string">"pthread_join"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token comment">// 输出线程返回的值</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"catch from child thread return value = %ld\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>numP<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>在第一个示例中， <code>funThread</code>  函数通过  <code>return NULL;</code>  正常退出，并通过  <code>pthread_join</code>  在主线程中等待其结束。在第二个示例中， <code>fun1</code>  函数通过  <code>return (void*)11;</code>  返回一个值，主线程通过  <code>pthread_join</code>  捕获这个返回值，并将其存储在  <code>numP</code>  指针指向的位置。</p>
<p>请注意， <code>pthread_join</code>  的第二个参数是一个指向  <code>void*</code>  类型的指针，用于接收线程的返回值。如果不需要接收返回值，可以传递  <code>NULL</code> 。此外， <code>THREAD_ERROR_CHECK</code>  宏用于检查  <code>pthread_create</code>  和  <code>pthread_join</code>  的返回状态，并在出现错误时打印错误信息并退出程序。</p>
<h3 id="pthread_exit-退出当前线程"><a class="anchor" href="#pthread_exit-退出当前线程">#</a>  <code>pthread_exit</code>  退出当前线程</h3>
<p><code>pthread_exit</code>  是 POSIX 线程库中的一个函数，用于退出当前线程并返回一个值。当一个线程执行完毕或者需要提前退出时，它可以调用  <code>pthread_exit</code>  函数来结束自己的执行流程，并且可以选择性地向等待它的线程返回一个值。</p>
<p>函数原型如下：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">void</span> <span class="token function">pthread_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>retval<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>参数说明：<strong>void *retval</strong>：这是一个  <code>void*</code>  类型的指针，用于返回一个值给等待当前线程结束的线程。如果不需要返回值，可以传递  <code>NULL</code> 。</p>
<p><code>pthread_exit</code>  的使用需要注意以下几点：</p>
<ul>
<li><strong>线程退出</strong>：当线程调用  <code>pthread_exit</code>  时，它将立即停止执行，并开始进行清理工作，包括销毁线程的栈和关闭线程拥有的任何资源。</li>
<li><strong>返回值</strong>:  <code>retval</code>  参数允许线程向调用  <code>pthread_join</code>  等待它的线程返回一个值。这个返回值可以通过  <code>pthread_join</code>  的第二个参数获取。</li>
<li><strong>线程清理函数</strong>：在线程退出之前，注册的线程清理函数（通过  <code>pthread_cleanup_push</code>  注册）将被调用，以执行任何必要的清理工作。</li>
<li><strong>主线程退出</strong>：如果主线程（或任何线程）调用  <code>pthread_exit</code> ，整个程序将不会立即退出，除非这是程序中最后一个活动的线程。如果还有其他活动线程，程序将继续运行，直到所有线程都退出。</li>
</ul>
<p>下面是一个简单的  <code>pthread_exit</code>  函数使用示例：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">thread_function</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Thread is running with argument: %s\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token function">pthread_exit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 线程结束，并返回值 1</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token class-name">pthread_t</span> tid<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">void</span> <span class="token operator">*</span>retval<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token comment">// 创建线程</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> thread_function<span class="token punctuation">,</span> <span class="token string">"Hello, thread!"</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Failed to create thread"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token comment">// 等待线程结束，并尝试获取返回值</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">pthread_join</span><span class="token punctuation">(</span>tid<span class="token punctuation">,</span> <span class="token operator">&amp;</span>retval<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Thread finished with return value: %ld\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>retval<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Failed to join thread"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>在这个示例中，我们创建了一个线程来执行  <code>thread_function</code>  函数。线程在打印传递给它的参数后，调用  <code>pthread_exit</code>  并返回一个整数值。在  <code>main</code>  函数中，我们使用  <code>pthread_join</code>  等待线程结束，并尝试获取线程的返回值。如果线程成功结束，我们打印出线程的返回值。如果  <code>pthread_join</code>  失败，我们打印出错误信息。</p>
<p><strong>示例 1：使用  <code>pthread_exit</code>  函数主动退出线程</strong></p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">funThread</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token comment">// 退出线程并返回一个值</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token function">pthread_exit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token comment">// 以下代码不会被执行</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"this scene will not be printed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token comment">// 这行代码也不会被执行</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token class-name">pthread_t</span> threadId<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>threadId<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> funThread<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"pthread_create failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">void</span><span class="token operator">*</span> numP<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    ret <span class="token operator">=</span> <span class="token function">pthread_join</span><span class="token punctuation">(</span>threadId<span class="token punctuation">,</span> <span class="token operator">&amp;</span>numP<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"pthread_join failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"catch child thread by pthread_exit value = %ld\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>numP<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><strong>示例 2： <code>pthread_exit</code>  无论在何处调用都将退出线程</strong></p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">void</span> <span class="token function">funThreadDeep</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"this is deep function\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token comment">// 即使当前函数不是线程的入口函数，调用 pthread_exit 也会导致线程退出</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token function">pthread_exit</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token comment">// 以下代码不会被执行</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"this scene will not be printed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">funThread</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token function">funThreadDeep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 调用另一个函数</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token comment">// 以下代码不会被执行</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"this scene will not be printed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token class-name">pthread_t</span> threadId<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>threadId<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> funThread<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"pthread_create failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token comment">// 主线程将睡眠一段时间，确保子线程有足够的时间执行</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><strong>示例 3： <code>pthread_exit</code>  返回值与  <code>return</code>  结束线程的比较</strong></p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">funThread</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token comment">// 线程通过 return 0 结束，与 pthread_exit (NULL) 或 pthread_exit (0) 效果相同</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token class-name">pthread_t</span> threadId<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>threadId<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> funThread<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"pthread_create failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token keyword">void</span><span class="token operator">*</span> numP<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    ret <span class="token operator">=</span> <span class="token function">pthread_join</span><span class="token punctuation">(</span>threadId<span class="token punctuation">,</span> <span class="token operator">&amp;</span>numP<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"pthread_join failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token comment">//pthread_join 捕获的返回结果为 0</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"catch child thread by pthread_exit value = %ld\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>numP<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>请注意， <code>pthread_exit</code>  调用后，线程函数中的任何后续代码都不会被执行。此外， <code>pthread_join</code>  捕获的返回值是  <code>pthread_exit</code>  传递的值，如果  <code>pthread_exit</code>  没有传递值（例如  <code>pthread_exit(NULL)</code> ），则  <code>pthread_join</code>  捕获的值将是  <code>NULL</code> 。在  <code>printf</code>  函数中，我们使用强制类型转换  <code>(long)</code>  来确保输出的格式正确。</p>
<p>在多线程程序中，标准输出（ <code>stdout</code> ）是共享的资源。这意味着，尽管每个线程有自己的栈空间，但它们都可以向同一个  <code>stdout</code>  流写入数据。然而，由于缓冲和操作系统调度的原因，输出可能不会立即显示在控制台上，这可能导致看起来像输出延迟的现象。</p>
<p>下面是一个例子：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">THREAD_ERROR_CHECK</span><span class="token expression"><span class="token punctuation">(</span>err<span class="token punctuation">,</span> msg<span class="token punctuation">)</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token expression"><span class="token keyword">do</span> <span class="token punctuation">&#123;</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="9"></td><td><pre>            <span class="token expression"><span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> </span><span class="token string">"%s\n"</span><span class="token expression"><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            <span class="token expression"><span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token expression"><span class="token punctuation">&#125;</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token expression"><span class="token punctuation">&#125;</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">funThread</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"i am child thread"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 此输出可能不会立即显示</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token function">pthread_exit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token comment">// 以下代码不会被执行</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"this scene will not be printed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token class-name">pthread_t</span> threadId<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>threadId<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> funThread<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token function">THREAD_ERROR_CHECK</span><span class="token punctuation">(</span>ret<span class="token punctuation">,</span> <span class="token string">"pthread_create"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token comment">// 主线程睡眠，让子线程有机会执行</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"i am main thread\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>在这个例子中， <code>funThread</code>  函数中的  <code>printf</code>  调用可能不会立即导致字符串显示在控制台上。这是因为  <code>stdout</code>  通常是行缓冲的，这意味着它在输出缓冲区满或者遇到换行符  <code>\n</code>  时才会刷新缓冲区。由于  <code>sleep</code>  调用之前没有换行符，所以  <code>stdout</code>  缓冲区可能在  <code>sleep</code>  之后才被刷新。</p>
<p>此外，由于线程调度的不确定性，子线程可能在主线程调用  <code>sleep</code>  之后才运行，这也可能导致输出顺序与预期不同。为了确保输出的顺序性，可以使用互斥锁来同步对  <code>stdout</code>  的访问，但这通常不是必要的，除非有特定的同步需求。</p>
<h2 id="线程的被动退出"><a class="anchor" href="#线程的被动退出">#</a> 线程的被动退出</h2>
<p>与进程可能因信号而被迫终止的情况不同，多线程程序中的信号处理更为复杂。所有线程共享进程的代码段，这意味着信号处理函数也处于共享状态。当进程接收到信号时，操作系统随机选择一个线程来处理这个信号，这可能导致不稳定的行为。特别是如果主线程被选中来处理信号并因此终止，整个进程及其中的所有线程都可能随之异常退出。</p>
<h3 id="取消点"><a class="anchor" href="#取消点">#</a> 取消点</h3>
<p>在多线程程序设计中， <code>pthread_cancel()</code>  函数提供了一种机制，允许一个线程请求另一个线程终止其执行。这种取消操作不是立即生效的；被请求取消的线程需要到达一个 “取消点” 才会实际终止。</p>
<p><strong>取消点</strong> 是程序执行中的一个特定位置，当线程到达这里时，如果它已经被请求取消，它将响应取消请求并退出。取消点通常是线程执行中的自然停顿点，如等待操作或某些系统调用。</p>
<p><img loading="lazy" data-src="https://dlink.host/1drv/aHR0cHM6Ly8xZHJ2Lm1zL2kvYy9iZGU1MWU2MjVlZjhmY2M1L0VhRHZabnpJc3p4R2xMVjItdFRmVS1FQjZsUF81NkZUejJtRXBMSDNSdUVFc1E_ZT03TXNJYkk.png" alt="pthread_cancel.jpg" /></p>
<p>常见的取消点包括</p>
<ol>
<li><strong>阻塞函数</strong>：几乎所有可能导致线程阻塞的函数，例如  <code>sleep()</code> ,  <code>select()</code> ,  <code>wait()</code>  等。</li>
<li><strong>I/O 操作</strong>：包括  <code>open()</code> ,  <code>close()</code> ,  <code>read()</code> ,  <code>write()</code> ,  <code>fopen()</code> ,  <code>fclose()</code> ,  <code>printf()</code>  等。</li>
</ol>
<h3 id="pthread_cancel-请求取消指定线程"><a class="anchor" href="#pthread_cancel-请求取消指定线程">#</a>  <code>pthread_cancel</code>  请求取消指定线程</h3>
<p><code>pthread_cancel</code>  函数是 POSIX 线程库中用于请求取消（终止）一个指定线程的函数。这个函数可以被用来中断一个可能正在无限循环或者阻塞操作中的线程。</p>
<p>函数原型如下：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">int</span> <span class="token function">pthread_cancel</span><span class="token punctuation">(</span><span class="token class-name">pthread_t</span> thread<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>参数说明：<strong>pthread_t thread</strong>: 这是要被取消的线程的标识符。</p>
<p>返回值：</p>
<ul>
<li>如果  <code>pthread_cancel</code>  调用成功，返回 0。</li>
<li>如果调用失败，返回一个错误码。例如，如果指定的线程标识符无效，将返回  <code>ESRCH</code> 。</li>
</ul>
<p>使用  <code>pthread_cancel</code>  时，需要注意以下几点：</p>
<ol>
<li><strong>异步取消</strong>：取消请求是异步的，被请求取消的线程不一定会立即退出。线程可能会在执行到某个可取消点（cancellation point）时被取消。</li>
<li><strong>清理动作</strong>：为了处理取消，线程应该定期执行可取消点的代码，例如检查某个条件或者执行  <code>pthread_testcancel</code>  函数来触发任何注册的取消处理程序（通过  <code>pthread_cleanup_push</code>  和  <code>pthread_cleanup_pop</code>  设置）。</li>
<li><strong>线程状态</strong>：被取消的线程将以退出状态  <code>PTHREAD_CANCELED</code>  结束。如果需要检测线程是否因为取消而退出，可以在  <code>pthread_join</code>  的第二个参数中检查这个状态。</li>
<li><strong>资源管理</strong>：取消一个线程不会自动释放该线程分配的资源。如果线程在被取消时持有互斥锁，这些锁需要在线程退出之前被释放，否则可能导致死锁。</li>
<li><strong>信号处理</strong>:  <code>pthread_cancel</code>  通过向线程发送  <code>SIGCANCEL</code>  信号来请求取消，这个信号不能被捕获、阻塞或忽略。</li>
</ol>
<p>下面是一个简单的  <code>pthread_cancel</code>  函数使用示例：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">thread_function</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token comment">// 注册取消处理程序</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token function">pthread_cleanup_push</span><span class="token punctuation">(</span>pthread_exit<span class="token punctuation">,</span> PTHREAD_CANCELED<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token comment">// 执行线程任务...</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token comment">// 定期检查取消请求</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token function">pthread_testcancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token comment">// 取消处理程序将在这里执行</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token function">pthread_cleanup_pop</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token comment">// 这行代码不会被执行，因为线程已经被取消</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token class-name">pthread_t</span> tid<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token comment">// 创建线程</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> thread_function<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Failed to create thread"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token comment">// 做一些其他工作...</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token comment">// 请求取消线程</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">pthread_cancel</span><span class="token punctuation">(</span>tid<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Failed to cancel thread"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token comment">// 等待线程结束，可以检查线程是否因为取消而退出</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token keyword">void</span> <span class="token operator">*</span>status<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">pthread_join</span><span class="token punctuation">(</span>tid<span class="token punctuation">,</span> <span class="token operator">&amp;</span>status<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">==</span> PTHREAD_CANCELED<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Thread was canceled.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="44"></td><td><pre></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>在这个示例中，我们创建了一个线程来执行  <code>thread_function</code>  函数。在该函数中，我们使用  <code>pthread_cleanup_push</code>  和  <code>pthread_cleanup_pop</code>  注册了一个取消处理程序，它会在线程被取消时调用  <code>pthread_exit</code>  并传递  <code>PTHREAD_CANCELED</code>  作为退出状态。我们还定期调用  <code>pthread_testcancel</code>  来检查是否有取消请求。在  <code>main</code>  函数中，我们使用  <code>pthread_cancel</code>  请求取消线程，并使用  <code>pthread_join</code>  等待线程结束，检查线程是否因为取消而退出。</p>
<p>示例一：没有取消点无法取消</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">THREAD_ERROR_CHECK</span><span class="token expression"><span class="token punctuation">(</span>err<span class="token punctuation">,</span> msg<span class="token punctuation">)</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token expression"><span class="token keyword">do</span> <span class="token punctuation">&#123;</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="8"></td><td><pre>            <span class="token expression"><span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> </span><span class="token string">"%s\n"</span><span class="token expression"><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="9"></td><td><pre>            <span class="token expression"><span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token expression"><span class="token punctuation">&#125;</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token expression"><span class="token punctuation">&#125;</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">func</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token comment">// 这个函数没有取消点，因此无法被取消</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token class-name">pthread_t</span> pid<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token keyword">int</span> res <span class="token operator">=</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pid<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> func<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token function">THREAD_ERROR_CHECK</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> <span class="token string">"pthread_create"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token comment">// 尝试取消线程，但由于没有取消点，取消操作将不会成功</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token keyword">int</span> res_cancel <span class="token operator">=</span> <span class="token function">pthread_cancel</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token function">THREAD_ERROR_CHECK</span><span class="token punctuation">(</span>res_cancel<span class="token punctuation">,</span> <span class="token string">"pthread_cancel"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"main use cancel\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token comment">// 等待线程结束，由于线程没有取消点，这里会一直等待，直到程序终止或线程被其他方式终止</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token keyword">int</span> res_join <span class="token operator">=</span> <span class="token function">pthread_join</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token function">THREAD_ERROR_CHECK</span><span class="token punctuation">(</span>res_join<span class="token punctuation">,</span> <span class="token string">"pthread_join"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>示例二：正常取消</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">// 定义错误检查宏</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">THREAD_ERROR_CHECK</span><span class="token expression"><span class="token punctuation">(</span>err<span class="token punctuation">,</span> msg<span class="token punctuation">)</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token expression"><span class="token keyword">do</span> <span class="token punctuation">&#123;</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            <span class="token expression"><span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> </span><span class="token string">"%s\n"</span><span class="token expression"><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="11"></td><td><pre>            <span class="token expression"><span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token expression"><span class="token punctuation">&#125;</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token expression"><span class="token punctuation">&#125;</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token comment">// 线程函数</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">func</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child thread printf \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token comment">// 这里没有取消点，但打印操作可能触发取消</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token comment">// 主函数</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token class-name">pthread_t</span> pid<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token keyword">int</span> res <span class="token operator">=</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pid<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> func<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token function">THREAD_ERROR_CHECK</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> <span class="token string">"pthread_create"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token comment">// 让子线程运行一段时间</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token comment">// 主线程请求取消子线程</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"main thread cancels child thread\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    res <span class="token operator">=</span> <span class="token function">pthread_cancel</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token function">THREAD_ERROR_CHECK</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> <span class="token string">"pthread_cancel"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token comment">// 等待子线程真正退出</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    res <span class="token operator">=</span> <span class="token function">pthread_join</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token function">THREAD_ERROR_CHECK</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> <span class="token string">"pthread_join"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"main thread finished\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>当一个线程被外部请求取消时，使用  <code>pthread_join</code>  函数可以捕获其结束状态，此时状态会是  <code>PTHREAD_CANCELED</code> ，其数值本质上是 - 1。如果线程是主动通过调用  <code>pthread_exit(PTHREAD_CANCELED)</code>  来退出的，那么  <code>pthread_join</code>  同样会捕获到  <code>PTHREAD_CANCELED</code>  作为其结束状态。</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">// 定义错误检查宏</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">THREAD_ERROR_CHECK</span><span class="token expression"><span class="token punctuation">(</span>err<span class="token punctuation">,</span> msg<span class="token punctuation">)</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token expression"><span class="token keyword">do</span> <span class="token punctuation">&#123;</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            <span class="token expression"><span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> </span><span class="token string">"%s\n"</span><span class="token expression"><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="11"></td><td><pre>            <span class="token expression"><span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token expression"><span class="token punctuation">&#125;</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token expression"><span class="token punctuation">&#125;</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token comment">// 线程函数</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">func</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//sleep 是一个取消点</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child thread printf \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token comment">// 主函数</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token class-name">pthread_t</span> pid<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token keyword">int</span> res <span class="token operator">=</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pid<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> func<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token function">THREAD_ERROR_CHECK</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> <span class="token string">"pthread_create"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token comment">// 让子线程运行一段时间</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 这里使用 sleep 来模拟等待一段时间</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token comment">// 主线程请求取消子线程</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"main thread cancels child thread\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    res <span class="token operator">=</span> <span class="token function">pthread_cancel</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token function">THREAD_ERROR_CHECK</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> <span class="token string">"pthread_cancel"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token comment">// 等待子线程真正退出</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token keyword">void</span> <span class="token operator">*</span>ret_catch<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    res <span class="token operator">=</span> <span class="token function">pthread_join</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ret_catch<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token function">THREAD_ERROR_CHECK</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> <span class="token string">"pthread_join"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token comment">// 检查线程退出状态</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret_catch <span class="token operator">==</span> PTHREAD_CANCELED<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"catch value = %ld \n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>ret_catch<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// -1</span></pre></td></tr><tr><td data-num="46"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"other value = %ld \n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>ret_catch<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="49"></td><td><pre></pre></td></tr><tr><td data-num="50"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="线程取消的详细流程"><a class="anchor" href="#线程取消的详细流程">#</a> 线程取消的详细流程</h3>
<p><strong>发起取消请求</strong>： 首先，在控制线程中调用  <code>pthread_cancel</code> ，传入目标线程的 ID。系统将根据这个 ID 找到目标线程，并设置其内部取消标记。</p>
<p><strong>检测取消标记</strong>：目标线程在执行过程中，如果遇到取消点（例如  <code>pthread_testcancel</code>  调用或者某些系统调用），会检查自己的取消标记。</p>
<p><strong>执行清理操作</strong>：如果线程检测到自己被标记为取消状态，它会执行之前通过  <code>pthread_cleanup_push</code>  注册的清理函数，这些函数通常用于释放资源、解锁互斥锁等。</p>
<p><strong>线程退出</strong>：清理完成后，线程将调用  <code>pthread_exit</code> ，通常传入  <code>PTHREAD_CANCELED</code>  作为退出状态，表示线程是因为取消而退出的。</p>
<p><strong>等待线程结束</strong>：发起取消请求的线程或者其它线程可以通过  <code>pthread_join</code>  等待被取消线程结束，并获取其退出状态，例如  <code>PTHREAD_CANCELED</code> 。</p>
<p><strong>资源清理</strong>：在线程退出的过程中，操作系统和线程库会负责清理线程的局部数据，包括栈空间等资源。</p>
<p><strong>错误处理</strong>：在整个取消流程中，应当有适当的错误处理机制，以确保在取消失败或者资源清理失败时能够采取相应的措施。</p>
<h2 id="资源清理"><a class="anchor" href="#资源清理">#</a> 资源清理</h2>
<p><code>pthread_cleanup_push</code>  和  <code>pthread_cleanup_pop</code>  是 POSIX 线程库中用于管理线程清理函数的一对宏。这两个宏通常成对使用，用于注册和注销一个或多个清理函数，这些清理函数将在线程退出时被调用。</p>
<p>函数原型：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span> <span class="token function">pthread_cleanup_push</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>routine<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">void</span> <span class="token function">pthread_cleanup_pop</span><span class="token punctuation">(</span><span class="token keyword">int</span> execute<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>参数说明：</p>
<ol>
<li><strong>pthread_cleanup_push</strong>:
<ul>
<li><code>routine</code> : 这是指向清理函数的指针，清理函数接受一个  <code>void*</code>  类型的参数，并且在退出时被调用。</li>
<li><code>arg</code> : 这是传递给清理函数的参数。</li>
</ul>
</li>
<li><strong>pthread_cleanup_pop</strong>:  <code>execute</code> : 一个布尔值，如果为非零（通常为 1），则调用注册的清理函数，然后注销该清理函数；如果为零（通常为 0），则仅注销该清理函数而不调用。</li>
</ol>
<p>使用场景：</p>
<ul>
<li>当线程需要在退出之前执行一些清理工作，如关闭文件描述符、释放分配的资源或重置状态信息时。</li>
<li>当线程可能被取消，需要在取消时执行清理工作时。</li>
</ul>
<p>工作机制：</p>
<ul>
<li><code>pthread_cleanup_push</code>  用于注册一个清理函数。调用此宏会将指定的清理函数和参数压入线程的内部栈中。</li>
<li>之后，当调用  <code>pthread_cleanup_pop</code>  时，内部栈顶的清理函数会被调用（如果  <code>execute</code>  非零），然后该清理函数从栈中弹出。</li>
</ul>
<p>示例：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">void</span> <span class="token function">cleanup_function</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Cleanup function called with argument: %s\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">thread_function</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token function">pthread_cleanup_push</span><span class="token punctuation">(</span>cleanup_function<span class="token punctuation">,</span> <span class="token string">"Arg1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token comment">// 线程的主要工作...</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token comment">// 当准备退出或可能被取消时，调用 pthread_cleanup_pop</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token function">pthread_cleanup_pop</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 执行清理函数并弹出</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token class-name">pthread_t</span> tid<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> thread_function<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Failed to create thread"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token function">pthread_join</span><span class="token punctuation">(</span>tid<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>在这个示例中， <code>thread_function</code>  函数在执行主要任务之前通过  <code>pthread_cleanup_push</code>  注册了一个清理函数  <code>cleanup_function</code> 。当线程完成工作或需要退出时，通过调用  <code>pthread_cleanup_pop(1)</code>  来执行清理函数并注销它。如果线程被取消，由于  <code>pthread_cancel</code>  会在取消点自动调用  <code>pthread_cleanup_pop(1)</code> ，清理函数也会被执行。</p>
<p>使用  <code>pthread_cleanup_push</code>  和  <code>pthread_cleanup_pop</code>  可以确保即使在发生异常或取消的情况下，重要的清理工作也能被正确执行。这是一种管理线程资源和保证线程安全退出的有效方式。</p>
<p><strong>pthread_cleanup_push 和 pthread_cleanup_pop 的使用规则</strong>： <code>pthread_cleanup_push</code>  和  <code>pthread_cleanup_pop</code>  必须在同一个作用域中成对出现。它们通常用于注册和注销清理函数，这些函数会在线程取消或退出时被调用。参考  <code>/usr/include/pthread.h</code>  中的宏定义，可以发现这两个函数必须配对使用，以确保花括号能够成功匹配。</p>
<figure class="highlight c"><figcaption data-lang="c"><span>~/usr/include/pthread.h</span></figcaption><table><tr><td data-num="1"></td><td data-command="[Line 585]"></td><td><pre><span class="token comment">/* Install a cleanup handler: ROUTINE will be called with arguments ARG</pre></td></tr><tr><td data-num="2"></td><td data-command=""></td><td><pre>   when the thread is canceled or calls pthread_exit.  ROUTINE will also</pre></td></tr><tr><td data-num="3"></td><td data-command=""></td><td><pre>   be called with arguments ARG when the matching pthread_cleanup_pop</pre></td></tr><tr><td data-num="4"></td><td data-command=""></td><td><pre>   is executed with non-zero EXECUTE argument.</pre></td></tr><tr><td data-num="5"></td><td data-command=""></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td data-command=""></td><td><pre>   pthread_cleanup_push and pthread_cleanup_pop are macros and must always</pre></td></tr><tr><td data-num="7"></td><td data-command=""></td><td><pre>   be used in matching pairs at the same nesting level of braces.  */</span></pre></td></tr><tr><td data-num="8"></td><td data-command=""></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span>  <span class="token directive keyword">define</span> <span class="token macro-name function">pthread_cleanup_push</span><span class="token expression"><span class="token punctuation">(</span>routine<span class="token punctuation">,</span> arg<span class="token punctuation">)</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="9"></td><td data-command=""></td><td><pre>  <span class="token expression"><span class="token keyword">do</span> <span class="token punctuation">&#123;</span>									      </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="10"></td><td data-command=""></td><td><pre>    <span class="token expression">__pthread_cleanup_class <span class="token function">__clframe</span> <span class="token punctuation">(</span>routine<span class="token punctuation">,</span> arg<span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="11"></td><td data-command=""></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td data-command=""></td><td><pre><span class="token comment">/* Remove a cleanup handler installed by the matching pthread_cleanup_push.</pre></td></tr><tr><td data-num="13"></td><td data-command=""></td><td><pre>   If EXECUTE is non-zero, the handler function is called. */</span></pre></td></tr><tr><td data-num="14"></td><td data-command=""></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span>  <span class="token directive keyword">define</span> <span class="token macro-name function">pthread_cleanup_pop</span><span class="token expression"><span class="token punctuation">(</span>execute<span class="token punctuation">)</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="15"></td><td data-command=""></td><td><pre>    <span class="token expression">__clframe<span class="token punctuation">.</span><span class="token function">__setdoit</span> <span class="token punctuation">(</span>execute<span class="token punctuation">)</span><span class="token punctuation">;</span>					      </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="16"></td><td data-command=""></td><td><pre>  <span class="token expression"><span class="token punctuation">&#125;</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></span></span></pre></td></tr></table></figure><p><strong>pthread_cleanup_pop 的行为</strong>： 当线程执行到  <code>pthread_cleanup_pop</code>  时，其  <code>execute</code>  参数决定了栈顶函数的行为。如果  <code>execute</code>  参数为 0，则弹出栈顶函数但不执行；如果  <code>execute</code>  参数非 0，则弹出并执行栈顶函数。</p>
<p><strong>线程取消时的清理函数执行</strong>： 通过  <code>pthread_cancel</code>  取消线程时，所有入栈的清理函数将按照它们入栈的逆序依次被弹栈并执行。这确保了在线程被取消之前，所有必要的资源都能得到适当的清理。</p>
<p><strong>线程退出时的清理函数执行</strong>：当线程通过调用  <code>pthread_exit</code>  主动退出时，同样会触发所有入栈的清理函数按照逆序依次被弹栈并执行，从而保证资源的正确释放。</p>
<p><strong>线程正常返回时的清理函数行为</strong>：如果线程因为在其入口函数  <code>start_routine</code>  中执行  <code>return</code>  语句而结束，清理函数栈的行为可能依赖于操作系统的具体实现。在某些系统中，这可能不会触发清理函数的执行。</p>
<div class="tags"><a href="/tags/c/" rel="tag"><i class="ic i-tag"></i>C</a><a href="/tags/linux/" rel="tag"><i class="ic i-tag"></i>Linux</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i></span><span class="text">更新于 </span><time title="修改时间：2024-12-14 15:24:00" itemprop="dateModified" datetime="2024-12-14T15:24:00+08:00">2024-12-14</time></span></div><div id="copyright"><ul><li class="author"><strong>本文作者：</strong>樱小路七叶<i class="ic i-at"><em>@</em></i>Nana7ha's Café Stella</li><li class="link"><strong>本文链接：</strong><a href="http://cwlrin.wiki/c-cpp/linux-c/Linux%20%E7%BA%BF%E7%A8%8B/" title="Linux 线程">http://cwlrin.wiki/c-cpp/linux-c/Linux 线程/</a></li><li class="license"><strong>版权声明：</strong>本站所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/c-cpp/linux-c/Linux%20%E4%BF%A1%E5%8F%B7/" rel="prev" itemprop="url" title="Linux 信号" style="background-image: linear-gradient(to bottom right, #b68cb4, #90da92);"><span class="type">上一篇</span><span class="category"><i class="ic i-flag"></i>Linux C</span><h3>Linux 信号</h3></a></div><div class="item right"><a href="/c-cpp/linux-c/Linux%20%E7%BA%BF%E7%A8%8B%E7%9A%84%E5%90%8C%E6%AD%A5%E5%92%8C%E4%BA%92%E6%96%A5/" rel="next" itemprop="url" title="Linux 线程的同步和互斥.md" style="background-image: linear-gradient(to bottom right, #8ba0c9, #aae8c1);"><span class="type">下一篇</span><span class="category"><i class="ic i-flag"></i>Linux C</span><h3>Linux 线程的同步和互斥.md</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E6%A6%82%E8%BF%B0"><span class="toc-number">1.</span> <span class="toc-text"> 线程概述</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%8E%E8%BF%9B%E7%A8%8B%E5%88%B0%E7%BA%BF%E7%A8%8B"><span class="toc-number">1.1.</span> <span class="toc-text"> 从进程到线程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E7%BA%A7%E7%BA%BF%E7%A8%8B%E5%92%8C%E5%86%85%E6%A0%B8%E7%BA%A7%E7%BA%BF%E7%A8%8B"><span class="toc-number">1.2.</span> <span class="toc-text"> 用户级线程和内核级线程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E7%9A%84%E5%88%9B%E5%BB%BA"><span class="toc-number">2.</span> <span class="toc-text"> 线程的创建</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#pthread_create-%E5%88%9B%E5%BB%BA%E6%96%B0%E7%9A%84%E7%BA%BF%E7%A8%8B"><span class="toc-number">2.1.</span> <span class="toc-text">  pthread_create   创建新的线程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E5%87%BD%E6%95%B0%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86"><span class="toc-number">2.2.</span> <span class="toc-text"> 线程函数错误处理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E5%92%8C%E6%95%B0%E6%8D%AE%E5%85%B1%E4%BA%AB"><span class="toc-number">3.</span> <span class="toc-text"> 线程和数据共享</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B1%E4%BA%AB%E6%95%B0%E6%8D%AE%E6%AE%B5"><span class="toc-number">3.1.</span> <span class="toc-text"> 共享数据段</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B1%E4%BA%AB%E5%A0%86%E7%A9%BA%E9%97%B4"><span class="toc-number">3.2.</span> <span class="toc-text"> 共享堆空间</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BF%E9%97%AE%E6%A0%88%E6%95%B0%E6%8D%AE"><span class="toc-number">3.3.</span> <span class="toc-text"> 访问栈数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#long-%E4%BD%9C%E4%B8%BA-8-%E5%AD%97%E8%8A%82%E5%8F%82%E6%95%B0"><span class="toc-number">3.4.</span> <span class="toc-text"> long 作为 8 字节参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%88%E6%95%B0%E6%8D%AE%E5%85%B1%E4%BA%AB%E7%9A%84%E9%87%8A%E6%94%BE"><span class="toc-number">3.5.</span> <span class="toc-text"> 栈数据共享的释放</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E7%BA%BF%E7%A8%8B%E7%9A%84%E9%80%80%E5%87%BA%E7%8A%B6%E6%80%81"><span class="toc-number">4.</span> <span class="toc-text"> 获取线程的退出状态</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ps-ellf"><span class="toc-number">4.1.</span> <span class="toc-text">  ps -elLf</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pthread_join-%E7%AD%89%E5%BE%85%E7%BA%BF%E7%A8%8B%E7%BB%93%E6%9D%9F"><span class="toc-number">4.2.</span> <span class="toc-text">  pthread_join   等待线程结束</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E7%9A%84%E4%B8%BB%E5%8A%A8%E9%80%80%E5%87%BA"><span class="toc-number">5.</span> <span class="toc-text"> 线程的主动退出</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E7%9A%84-return-%E9%80%80%E5%87%BA"><span class="toc-number">5.1.</span> <span class="toc-text"> 线程的 return 退出</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pthread_exit-%E9%80%80%E5%87%BA%E5%BD%93%E5%89%8D%E7%BA%BF%E7%A8%8B"><span class="toc-number">5.2.</span> <span class="toc-text">  pthread_exit  退出当前线程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E7%9A%84%E8%A2%AB%E5%8A%A8%E9%80%80%E5%87%BA"><span class="toc-number">6.</span> <span class="toc-text"> 线程的被动退出</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%96%E6%B6%88%E7%82%B9"><span class="toc-number">6.1.</span> <span class="toc-text"> 取消点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pthread_cancel-%E8%AF%B7%E6%B1%82%E5%8F%96%E6%B6%88%E6%8C%87%E5%AE%9A%E7%BA%BF%E7%A8%8B"><span class="toc-number">6.2.</span> <span class="toc-text">  pthread_cancel  请求取消指定线程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E5%8F%96%E6%B6%88%E7%9A%84%E8%AF%A6%E7%BB%86%E6%B5%81%E7%A8%8B"><span class="toc-number">6.3.</span> <span class="toc-text"> 线程取消的详细流程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B5%84%E6%BA%90%E6%B8%85%E7%90%86"><span class="toc-number">7.</span> <span class="toc-text"> 资源清理</span></a></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li ><a href="/c-cpp/linux-c/Linux%20C%20%E5%9F%BA%E7%A1%80/" rel="bookmark" title="Linux C 基础">Linux C 基础</a></li><li ><a href="/c-cpp/linux-c/Linux%20%E6%9D%82%E9%A1%B9/" rel="bookmark" title="Linux 杂项">Linux 杂项</a></li><li ><a href="/c-cpp/linux-c/Linux%20%E7%9B%AE%E5%BD%95%E6%B5%81/" rel="bookmark" title="Linux 目录流">Linux 目录流</a></li><li ><a href="/c-cpp/linux-c/Linux%20%E6%96%87%E4%BB%B6%E6%B5%81/" rel="bookmark" title="Linux 文件流">Linux 文件流</a></li><li ><a href="/c-cpp/linux-c/Linux%20%E7%AE%A1%E9%81%93%E5%92%8C%20IO%20%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8/" rel="bookmark" title="Linux 管道和 IO 多路复用">Linux 管道和 IO 多路复用</a></li><li ><a href="/c-cpp/linux-c/Linux%20%E8%BF%9B%E7%A8%8B%EF%BC%88%E4%B8%8A%EF%BC%89/" rel="bookmark" title="Linux 进程（上）">Linux 进程（上）</a></li><li ><a href="/c-cpp/linux-c/Linux%20%E8%BF%9B%E7%A8%8B%EF%BC%88%E4%B8%8B%EF%BC%89/" rel="bookmark" title="Linux 进程（下）">Linux 进程（下）</a></li><li ><a href="/c-cpp/linux-c/Linux%20%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/" rel="bookmark" title="Linux 进程间通信">Linux 进程间通信</a></li><li ><a href="/c-cpp/linux-c/Linux%20%E4%BF%A1%E5%8F%B7/" rel="bookmark" title="Linux 信号">Linux 信号</a></li><li  class="active"><a href="/c-cpp/linux-c/Linux%20%E7%BA%BF%E7%A8%8B/" rel="bookmark" title="Linux 线程">Linux 线程</a></li><li ><a href="/c-cpp/linux-c/Linux%20%E7%BA%BF%E7%A8%8B%E7%9A%84%E5%90%8C%E6%AD%A5%E5%92%8C%E4%BA%92%E6%96%A5/" rel="bookmark" title="Linux 线程的同步和互斥.md">Linux 线程的同步和互斥.md</a></li><li ><a href="/c-cpp/linux-c/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE/" rel="bookmark" title="网络协议">网络协议</a></li><li ><a href="/c-cpp/linux-c/Linux%20%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/" rel="bookmark" title="Linux 网络编程">Linux 网络编程</a></li><li ><a href="/c-cpp/linux-c/Linux%20%E8%BF%9B%E7%A8%8B%E6%B1%A0/" rel="bookmark" title="Linux 进程池">Linux 进程池</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><img class="image" loading="lazy" decoding="async" itemprop="image" alt="樱小路七叶" src="/assets/avatar.jpg"/><p class="name" itemprop="name">樱小路七叶</p><div class="description" itemprop="description">技术与美日新月异</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">91</span><span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">11</span><span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">13</span><span class="name">标签</span></a></div></nav><div class="social"><a target="_blank" rel="noopener" href="https://github.com/cwlrin" class="item github" title="https:&#x2F;&#x2F;github.com&#x2F;cwlrin"><i class="ic i-github"></i></a><a target="_blank" rel="noopener" href="https://www.zhihu.com/people/ying-xiao-lu-qi-ye" class="item zhihu" title="https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;ying-xiao-lu-qi-ye"><i class="ic i-zhihu"></i></a><a target="_blank" rel="noopener" href="https://music.163.com/#/user/home?id=411590211" class="item music" title="https:&#x2F;&#x2F;music.163.com&#x2F;#&#x2F;user&#x2F;home?id&#x3D;411590211"><i class="ic i-cloud-music"></i></a><a target="_blank" rel="noopener" href="https://space.bilibili.com/8013992" class="item bilibili" title="https:&#x2F;&#x2F;space.bilibili.com&#x2F;8013992"><i class="ic i-bilibili"></i></a></div><div class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item dropdown"><a href="#" onclick="return false;"><i class="ic i-user"></i>关于</a><ul class="submenu"><li class="item"><a href="/about/" rel="section"><i class="ic i-user"></i>关于本站</a></li><li class="item"><a href="/admiration/" rel="section"><i class="ic i-coffee"></i>赞赏博主</a></li></ul></li><li class="item dropdown"><a href="#" onclick="return false;"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li><li class="item"><a href="/friends/" rel="section"><i class="ic i-heart"></i>友链</a></li></div></div></div></div><ul id="quick"><li class="prev pjax"><a href="/c-cpp/linux-c/Linux%20%E7%BA%BF%E7%A8%8B%E7%9A%84%E5%90%8C%E6%AD%A5%E5%92%8C%E4%BA%92%E6%96%A5/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/c-cpp/linux-c/Linux%20%E4%BF%A1%E5%8F%B7/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"></div><div class="status"><div class="copyright">&copy; 2020 -<span itemprop="copyrightYear">2025</span><span class="with-love"><i class="ic i-sakura rotate"></i></span><span class="author" itemprop="copyrightHolder">樱小路七叶 @ 七葉の喫茶ステラ</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i></span><span title="站点总字数">1.4m 字</span><span class="post-meta-divider"> | </span><span class="post-meta-item-icon"><i class="ic i-coffee"></i></span><span title="站点阅读时长">21:46</span></div><div class="powered-by">基于 <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a> & Theme.<a target="_blank" rel="noopener" href="https://github.com/theme-shoka-x/hexo-theme-shokaX/">ShokaX</a></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL = {
    ispost: true,
    path: `c-cpp/linux-c/Linux 线程/`,
    favicon: {
        show: `（●´3｀●）やれやれだぜ`,
        hide: `(´Д｀)大変だ！`
    },
    search: {
        placeholder: "文章搜索",
        empty: "关于 「 ${query} 」，什么也没搜到",
        stats: "${time} ms 内找到 ${hits} 条结果"
    },
    nocopy: "false",
    copyright: `复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。`,
    copy_tex: false,
    katex: false,
    mermaid: false,
    audio: undefined,
    fancybox: true,
    nocopy: false,
    outime: true,
    template: `<div class="note warning"><p><span class="label warning">文章时效性提示</span><br>这是一篇发布于 {{publish}} 天前，最后一次更新在 {{updated}} 天前的文章，部分信息可能已经发生改变，请注意甄别。</p></div>`,
    quiz: {
        choice: `单选题`,
        multiple: `多选题`,
        true_false: `判断题`,
        essay: `问答题`,
        gap_fill: `填空题`,
        mistake: `错题备注`
    },
    ignores: [
        (uri) => uri.includes('#'),
        (uri) => new RegExp(LOCAL.path + '$').test(uri),
            []
    ]
};
</script><script src="https://s4.zstatic.net/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha384-k6YtvFUEIuEFBdrLKJ3YAUbBki333tj1CSUisai5Cswsg9wcLNaPzsTHDswp4Az8" crossorigin="anonymous" fetchpriority="high"></script><script src="https://s4.zstatic.net/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha384-ZvpUoO&#x2F;+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn&#x2F;6Z&#x2F;hRTt8+pR6L4N2" crossorigin="anonymous" fetchpriority="high"></script><script src="https://s4.zstatic.net/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha384-Zm+UU4tdcfAm29vg+MTbfu&#x2F;&#x2F;q5B&#x2F;lInMbMCr4T8c9rQFyOv6PlfQYpB5wItcXWe7" crossorigin="anonymous" fetchpriority="high"></script><script src="https://s4.zstatic.net/ajax/libs/justifiedGallery/3.8.1/js/jquery.justifiedGallery.min.js" integrity="sha384-TOxsBplaL96&#x2F;QDWPIUg+ye3v89qSE3s22XNtJMmCeZEep3cVDmXy1zEfZvVv+y2m" crossorigin="anonymous" fetchpriority="high"></script><script src="/js/siteInit.js?v=0.4.20" type="module" fetchpriority="high" defer></script></body></html>