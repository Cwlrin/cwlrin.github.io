<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"/><meta name="theme-color" content="#222"/><meta http-equiv="X-UA-COMPATIBLE" content="IE=edge,chrome=1"/><meta name="renderer" content="webkit"/><link rel="icon" type="image/ico" sizes="32x32" href="/assets/favicon.ico"/><link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png"/><link rel="alternate" href="/rss.xml" title="Nana7ha's Café Stella" type="application/rss+xml"><link rel="alternate" href="/atom.xml" title="Nana7ha's Café Stella" type="application/atom+xml"><link rel="alternate" type="application/json" title="Nana7ha's Café Stella" href="https://cwlrin.wiki/feed.json"/><link rel="preconnect" href="https://s4.zstatic.net"/><link rel="preconnect" href="https://at.alicdn.com"/><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Mulish:400,400italic,700,700italic%7CFredericka%20the%20Great:400,400italic,700,700italic%7CNoto%20Serif%20JP:400,400italic,700,700italic%7CNoto%20Serif%20SC:400,400italic,700,700italic%7CInconsolata:400,400italic,700,700italic&display=swap&subset=latin,latin-ext" media="none" onload="this.media&#x3D;&#39;all&#39;"><link rel="stylesheet" href="/css/app.css?v=0.4.20"><link rel="modulepreload" href="/js/chunk-7SEFNKBW.js"></link><link rel="modulepreload" href="/js/chunk-B6LR4GZ7.js"></link><link rel="modulepreload" href="/js/chunk-R2ID445Y.js"></link><link rel="modulepreload" href="/js/copy-tex-6KGJ4I7N.js"></link><link rel="modulepreload" href="/js/index.esm-77JWK77F.js"></link><link rel="modulepreload" href="/js/post-NFR2DBU7.js"></link><link rel="modulepreload" href="/js/quicklink-KETDXBC3.js"></link><link rel="modulepreload" href="/js/siteInit.js"></link><link rel="preload" href="https://dlink.host/1drv/aHR0cHM6Ly8xZHJ2Lm1zL2kvYy9iZGU1MWU2MjVlZjhmY2M1L0VWZDhMWlJhTEExTnRDaUcwNXR3Q1V3Qlk3U2lfMnlxWGFVWkk5TnBrQ3pwbkE_ZT1XRWJPa3g.jpg" as="image" fetchpriority="high"><meta name="keywords" content="C++"/><meta name="description" content="技术与美日新月异"/><link rel="canonical" href="https://cwlrin.wiki/c-cpp/cpp-base/C++%20%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/"><title>C++ 资源管理</title><meta name="generator" content="Hexo 7.3.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">C++ 资源管理</h1><div class="meta"><span class="item" title="创建时间：2020-12-15 12:32:41"><span class="icon"><i class="ic i-calendar"></i></span><span class="text">发表于</span><time itemprop="dateCreated datePublished" datetime="2020-12-15T12:32:41+08:00">2020-12-15</time></span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i></span><span class="text">本文字数</span><span>18k</span><span class="text">字</span></span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i></span><span class="text">阅读时长</span><span>16 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span><span class="line"></span><span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">七葉の喫茶ステラ</a></li></ul><ul class="right" id="rightNav"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div class="pjax" id="imgs"><img src="https://dlink.host/1drv/aHR0cHM6Ly8xZHJ2Lm1zL2kvYy9iZGU1MWU2MjVlZjhmY2M1L0VWZDhMWlJhTEExTnRDaUcwNXR3Q1V3Qlk3U2lfMnlxWGFVWkk5TnBrQ3pwbkE_ZT1XRWJPa3g.jpg" loading="eager" decoding="async" fetchpriority="high" alt="Nana7ha's Café Stella"></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"></path></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"></use><use xlink:href="#gentle-wave" x="48" y="3"></use><use xlink:href="#gentle-wave" x="48" y="5"></use><use xlink:href="#gentle-wave" x="48" y="7"></use></g></svg></div><main><div class="inner"><div class="pjax" id="main"><div class="article wrap"><div class="breadcrumb" itemListElement itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i><span><a href="/">首页</a></span><i class="ic i-angle-right"></i><span itemprop="itemListElement" itemscope="itemscope" itemtype="https://schema.org/ListItem"><a href="/categories/c-cpp/" itemprop="item" rel="index" title="分类于C/C++"><span itemprop="name">C/C++<meta itemprop="position" content="0"/></span></a></span><i class="ic i-angle-right"></i><span class="current" itemprop="itemListElement" itemscope="itemscope" itemtype="https://schema.org/ListItem"><a href="/categories/c-cpp/cpp-basic/" itemprop="item" rel="index" title="分类于C++ 基础"><span itemprop="name">C++ 基础<meta itemprop="position" content="1"/></span></a></span></div><article class="post block" itemscope="itemscope" itemtype="http://schema.org/Article" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://cwlrin.wiki/c-cpp/cpp-base/C++%20%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/"/><span hidden="hidden" itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="image" content="/assets/avatar.jpg"/><meta itemprop="name" content="樱小路七叶"/><meta itemprop="description" content=", 技术与美日新月异"/></span><span hidden="hidden" itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="Nana7ha's Café Stella"/></span><div class="body md" itemprop="articleBody"><h2 id="raii-技术"><a class="anchor" href="#raii-技术">#</a> RAII 技术</h2>
<p>RAII（Resource Acquisition Is Initialization）是 C++ 中一种重要的资源管理技术，由 C++ 之父 Bjarne Stroustrup 提出。它利用对象的生命周期来管理资源，确保资源在对象生命周期结束时自动释放。RAII 通过构造函数获取资源，并在析构函数中释放资源，从而避免了资源泄漏。</p>
<p>RAII 的核心思想</p>
<ol>
<li><strong>资源获取即初始化</strong>：在对象构造时获取资源。</li>
<li><strong>自动资源释放</strong>：在对象析构时自动释放资源。</li>
</ol>
<p>这种模式确保了即使在发生异常或多个退出路径的情况下，资源也能被正确释放。</p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fstream></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">SafeFile</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token keyword">public</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token comment">// 构造函数中初始化资源（打开文件）</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token function">SafeFile</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> filename<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    _file<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>ios<span class="token double-colon punctuation">::</span>out <span class="token operator">|</span> std<span class="token double-colon punctuation">::</span>ios<span class="token double-colon punctuation">::</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"SafeFile::SafeFile() "</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token comment">// 提供方法访问资源（写入文件）</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> msg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>_file<span class="token punctuation">.</span><span class="token function">is_open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>      _file <span class="token operator">&lt;&lt;</span> msg <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token comment">// 利用析构函数释放资源（关闭文件）</span></pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token operator">~</span><span class="token function">SafeFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"~SafeFile()"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>_file<span class="token punctuation">.</span><span class="token function">is_open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>      _file<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>      std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"File closed"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre> <span class="token keyword">private</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="29"></td><td><pre>  std<span class="token double-colon punctuation">::</span>ofstream _file<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>  std<span class="token double-colon punctuation">::</span>string msg <span class="token operator">=</span> <span class="token string">"Hello, world!"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>  SafeFile <span class="token function">sf</span><span class="token punctuation">(</span><span class="token string">"example.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>  sf<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>在这个例子中， <code>SafeFile</code>  类在构造函数中打开文件，在析构函数中关闭文件。即使在写入文件时发生异常，对象的生命周期结束时，析构函数也会被调用，文件资源会被正确释放。</p>
<p>RAII 的优势</p>
<ol>
<li><strong>减少资源泄漏</strong>：通过自动释放资源，减少了资源泄漏的风险。</li>
<li><strong>简化代码</strong>：不需要在代码中显式释放资源，简化了代码逻辑。</li>
<li><strong>提高代码的可读性和可维护性</strong>：资源管理与对象生命周期紧密相关，提高了代码的清晰度。</li>
</ol>
<h3 id="raii-类的常见特征"><a class="anchor" href="#raii-类的常见特征">#</a> RAII 类的常见特征</h3>
<p>RAII 技术，具备以下基本特征：</p>
<ol>
<li><strong>在构造函数中获取资源</strong>：RAII 对象在构造时立即获取所需的资源。</li>
<li><strong>在析构函数中释放资源</strong>：RAII 对象在生命周期结束时自动释放资源。</li>
<li><strong>不允许复制或赋值</strong>：为了防止资源的不当复制和释放，RAII 类通常不支持复制和赋值操作。</li>
<li><strong>提供访问资源的方法</strong>：RAII 类提供接口供外部访问或操作资源。</li>
</ol>
<p>对象语义与值语义</p>
<ul>
<li><strong>值语义</strong>：允许对象之间可以相互复制和赋值，适用于那些不涉及资源管理的简单数据类型。</li>
<li><strong>对象语义</strong>：不允许对象之间进行复制和赋值，适用于管理资源的对象。</li>
</ul>
<p>禁用复制和赋值的方法</p>
<ol>
<li>
<p><strong>将拷贝构造函数和赋值运算符设置为私有</strong></p>
</li>
<li>
<p><strong>使用  <code>delete</code>  关键字</strong></p>
</li>
<li>
<p><strong>继承的方式</strong>：基类删除拷贝构造函数和赋值运算符，派生类继承基类。</p>
</li>
</ol>
<h3 id="raii-类模板的模拟"><a class="anchor" href="#raii-类模板的模拟">#</a> RAII 类模板的模拟</h3>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T</span><span class="token operator">></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">RAII</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token keyword">public</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token comment">// 在构造函数中初始化资源（托管资源）</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token function">RAII</span><span class="token punctuation">(</span>T <span class="token operator">*</span>data<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">_data</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"RAII(T*)"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token comment">// 在析构函数中释放资源</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token operator">~</span><span class="token function">RAII</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"~RAII()"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>_data<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token keyword">delete</span> _data<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>      _data <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token comment">// 提供若干访问资源的方法</span></pre></td></tr><tr><td data-num="19"></td><td><pre>  T <span class="token operator">*</span><span class="token keyword">operator</span><span class="token operator">-></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token keyword">return</span> _data<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>  T <span class="token operator">&amp;</span><span class="token keyword">operator</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token keyword">return</span> <span class="token operator">*</span>_data<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>  T <span class="token operator">*</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token keyword">return</span> _data<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>  <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span>T <span class="token operator">*</span>data<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>_data<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>      <span class="token keyword">delete</span> _data<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>      _data <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    _data <span class="token operator">=</span> data<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="38"></td><td><pre></pre></td></tr><tr><td data-num="39"></td><td><pre>  <span class="token comment">// 不允许复制或赋值</span></pre></td></tr><tr><td data-num="40"></td><td><pre>  <span class="token function">RAII</span><span class="token punctuation">(</span><span class="token keyword">const</span> RAII <span class="token operator">&amp;</span>rhs<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>  RAII <span class="token operator">&amp;</span><span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">const</span> RAII <span class="token operator">&amp;</span>rhs<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre></pre></td></tr><tr><td data-num="43"></td><td><pre> <span class="token keyword">private</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="44"></td><td><pre>  T <span class="token operator">*</span>_data<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>如下， <code>pt</code>  不是一个指针，而是一个对象，但是它的使用已经和指针完全一致了。这个对象可以托管堆上的  <code>Point</code>  对象，而且不用考虑  <code>delete</code> 。</p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">Point</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token keyword">public</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token function">Point</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">_x</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_y</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token keyword">void</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Point("</span> <span class="token operator">&lt;&lt;</span> _x <span class="token operator">&lt;&lt;</span> <span class="token string">", "</span> <span class="token operator">&lt;&lt;</span> _y <span class="token operator">&lt;&lt;</span> <span class="token string">")"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token keyword">private</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token keyword">int</span> _x<span class="token punctuation">,</span> _y<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  Point <span class="token operator">*</span> pt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">Point</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token comment">// 智能指针的雏形</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  RAII<span class="token operator">&lt;</span>Point<span class="token operator">></span> <span class="token function">raii</span><span class="token punctuation">(</span>pt<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  raii<span class="token operator">-></span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 使用 -> 访问成员函数</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token punctuation">(</span><span class="token operator">*</span>raii<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 使用 * 访问成员函数</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>在这个例子中， <code>RAII&lt;Point&gt;</code>  对象  <code>raii</code>  托管了  <code>Point</code>  对象的指针  <code>pt</code> 。 <code>raii</code>  的生命周期结束时，会自动调用析构函数，释放  <code>Point</code>  对象。</p>
<p>RAII 技术的本质是利用对象的生命周期来管理资源。由于对象在离开作用域时会自动调用析构函数，因此可以确保资源的正确释放。</p>
<h2 id="智能指针"><a class="anchor" href="#智能指针">#</a> 智能指针</h2>
<p>c++11 提供了以下几种智能指针，位于头文件 &lt;memory&gt;，它们都是类模板。</p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre>std<span class="token double-colon punctuation">::</span>auto_ptr      <span class="token comment">// c++11</span></pre></td></tr><tr><td data-num="2"></td><td><pre>std<span class="token double-colon punctuation">::</span>unique_ptr    <span class="token comment">// c++11</span></pre></td></tr><tr><td data-num="3"></td><td><pre>std<span class="token double-colon punctuation">::</span>shared_ptr    <span class="token comment">// c++11</span></pre></td></tr><tr><td data-num="4"></td><td><pre>std<span class="token double-colon punctuation">::</span>weak_ptr      <span class="token comment">// c++11</span></pre></td></tr></table></figure><h3 id="auto_ptr"><a class="anchor" href="#auto_ptr">#</a>  <code>auto_ptr</code></h3>
<p><code>auto_ptr</code>  是 C++ 标准库中曾经的一种智能指针，它用来自动管理动态分配的内存。然而，由于它的设计存在一些问题，特别是在复制行为上，可能会导致原指针失去对资源的控制，因此它在 C++17 被弃用。</p>
<p><code>auto_ptr</code>  在构造时接受一个动态分配的资源，并在析构时自动释放该资源。</p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;memory></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token keyword">int</span> <span class="token operator">*</span> pInt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  auto_ptr<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> <span class="token function">ap</span><span class="token punctuation">(</span>pInt<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  cout <span class="token operator">&lt;&lt;</span> <span class="token string">"*pInt: "</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>pInt <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  cout <span class="token operator">&lt;&lt;</span> <span class="token string">"*ap: "</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>ap <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>在这个例子中， <code>ap</code>  接管了  <code>pInt</code>  指向的资源。当  <code>ap</code>  的生命周期结束时，它会自动释放资源。</p>
<p><code>auto_ptr</code>  可以被复制，但复制后原  <code>auto_ptr</code>  会失去对资源的控制。</p>
<p><strong>示例代码</strong>：</p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token keyword">int</span> <span class="token operator">*</span> pInt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  auto_ptr<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> <span class="token function">ap</span><span class="token punctuation">(</span>pInt<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  auto_ptr<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> <span class="token function">ap2</span><span class="token punctuation">(</span>ap<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  cout <span class="token operator">&lt;&lt;</span> <span class="token string">"*ap2: "</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>ap2 <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span> <span class="token comment">// 正常</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  cout <span class="token operator">&lt;&lt;</span> <span class="token string">"*ap: "</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>ap <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>   <span class="token comment">// 可能导致段错误</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>在这个例子中， <code>ap2</code>  复制了  <code>ap</code> ，之后  <code>ap</code>  被置为空，因此再访问  <code>ap</code>  可能会导致段错误。</p>
<p>通过阅读源码的实现， <code>ap</code>  的指针被置为了空指针。</p>
<p><code>auto_ptr</code>  的内部实现： <code>auto_ptr</code>  的复制构造函数通过  <code>release</code>  方法实现，该方法将资源的控制权交给新对象，并将原对象置为空。</p>
<p>也就是说， <code>auto_ptr&lt;int&gt; ap2(ap);</code>  这一步表面上执行了拷贝操作，但是底层已经将右操作数 ap 所托管的堆空间的控制权交给了新对象  <code>ap2</code> ，并且将  <code>ap</code>  底层的指针数据成员置空。该拷贝操作存在隐患，所以  <code>auto_ptr</code>  被弃用了。</p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">_Tp</span><span class="token operator">></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">auto_ptr</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token keyword">public</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token comment">// 拷贝构造</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token function">auto_ptr</span><span class="token punctuation">(</span>auto_ptr <span class="token operator">&amp;</span>__a<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  __STL_NOTHROW</pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token comment">//ap2 的_M_ptr 被赋值为 ap 调用 release 函数的返回值</span></pre></td></tr><tr><td data-num="8"></td><td><pre>      <span class="token operator">:</span> <span class="token function">_M_ptr</span><span class="token punctuation">(</span>__a<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre>      <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token comment">//ap 调用 release 函数</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  _Tp <span class="token operator">*</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  __STL_NOTHROW <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token comment">// 用局部的指针__tmp 接管 ap 的指针所指向的资源</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    _Tp <span class="token operator">*</span>__tmp <span class="token operator">=</span> _M_ptr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    _M_ptr <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span> <span class="token comment">// 将 ap 底层的指针设为空指针</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">return</span> __tmp<span class="token punctuation">;</span><span class="token comment">// 返回的就是原本 ap 管理的资源的地址</span></pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre> <span class="token keyword">private</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="21"></td><td><pre>  _Tp <span class="token operator">*</span>_M_ptr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h3 id="unique_ptr"><a class="anchor" href="#unique_ptr">#</a>  <code>unique_ptr</code></h3>
<p><code>std::unique_ptr</code>  是 C++11 引入的一种智能指针，用于管理动态分配的资源。它提供了独占所有权模型，确保同一时间只能有一个智能指针管理特定资源。</p>
<p><code>unique_ptr</code>  的特点：</p>
<ol>
<li><strong>不允许复制或赋值</strong>： <code>unique_ptr</code>  不能被复制或赋值，这避免了资源的多次释放。</li>
<li><strong>独享所有权</strong>： <code>unique_ptr</code>  独占管理其指向的资源，确保资源在不再需要时被正确释放。</li>
<li><strong>可以移动</strong>： <code>unique_ptr</code>  支持移动语义，可以将其所有权从一个对象转移到另一个对象。</li>
</ol>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  unique_ptr<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> <span class="token function">up</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  cout <span class="token operator">&lt;&lt;</span> <span class="token string">"*up: "</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>up <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  cout <span class="token operator">&lt;&lt;</span> <span class="token string">"up.get(): "</span> <span class="token operator">&lt;&lt;</span> up<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token comment">// 独享所有权的智能指针，对托管的空间独立拥有</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token comment">// 拷贝构造已经被删除</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token comment">//std::unique_ptr&lt;int> up2 = up; // 复制操作 error</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token comment">// 赋值运算符函数也被删除</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  unique_ptr<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> <span class="token function">up3</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token comment">//up3 = up; // 赋值操作 error</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><code>unique_ptr</code>  可以作为容器的元素，利用移动语义直接传递右值属性的  <code>unique_ptr</code> 。</p>
<p><strong>示例代码</strong>：</p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre>vector<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>Point<span class="token operator">>></span> vec<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>unique_ptr<span class="token operator">&lt;</span>Point<span class="token operator">></span> <span class="token function">up4</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">Point</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">// 将 up4 这个对象作为参数传给了 push_back 函数，会调用移动构造</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">//vec.push_back (up4);  //error，不能拷贝</span></pre></td></tr><tr><td data-num="5"></td><td><pre>vec<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token function">move</span><span class="token punctuation">(</span>up4<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// ok</span></pre></td></tr><tr><td data-num="6"></td><td><pre>vec<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">unique_ptr</span><span class="token generic class-name"><span class="token operator">&lt;</span>Point<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">Point</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ok</span></pre></td></tr></table></figure><p>在这个例子中， <code>up4</code>  通过  <code>std::move</code>  将其所有权移交给  <code>vec</code> ，之后  <code>up4</code>  就不再拥有管理权。</p>
<p>根据我们对  <code>vector</code>  的了解， <code>vector</code>  的元素一定在堆上，而  <code>up4</code>  是在栈上的智能指针对象，这里是发生了复制吗？</p>
<p>并不是复制， <code>unique_ptr</code>  的拷贝构造是被删除的。这里实际上要理解为移交管理权， <code>up4</code>  不再拥有 (10,20) 这个  <code>Point</code>  对象的管理权。</p>
<figure class="highlight cpp"><figcaption data-lang="C++"><span>p</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//up4->print (); //error，up4 已经没有管理权了</span></pre></td></tr><tr><td data-num="2"></td><td><pre>vec<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-></span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ok</span></pre></td></tr></table></figure><h3 id="shared_ptr"><a class="anchor" href="#shared_ptr">#</a>  <code>shared_ptr</code></h3>
<p><code>std::shared_ptr</code>  是 C++ 标准库中的另一种智能指针，它允许多个  <code>shared_ptr</code>  实例共享同一个资源，通过引用计数来管理资源的生命周期。</p>
<p><code>shared_ptr</code>  的特征：</p>
<ol>
<li><strong>共享所有权</strong>：多个  <code>shared_ptr</code>  实例可以共享同一个资源。</li>
<li><strong>引用计数</strong>： <code>shared_ptr</code>  内部维护一个引用计数来记录有多少个  <code>shared_ptr</code>  实例共享同一个资源。</li>
<li><strong>可以复制或赋值</strong>：复制或赋值  <code>shared_ptr</code>  会增加引用计数，而不是复制资源。（区别于  <code>unique_ptr</code>  只能传右值）</li>
<li><strong>作为容器的元素</strong>：可以存储在容器中，可以传递左值或右值。</li>
<li><strong>移动语义</strong>：支持移动构造函数和移动赋值函数。</li>
</ol>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre>shared_ptr<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> <span class="token function">sp</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"sp.use_count(): "</span> <span class="token operator">&lt;&lt;</span> sp<span class="token punctuation">.</span><span class="token function">use_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>cout <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"执行复制操作"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>shared_ptr<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> sp2 <span class="token operator">=</span> sp<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"sp.use_count(): "</span> <span class="token operator">&lt;&lt;</span> sp<span class="token punctuation">.</span><span class="token function">use_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"sp2.use_count(): "</span> <span class="token operator">&lt;&lt;</span> sp2<span class="token punctuation">.</span><span class="token function">use_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>cout <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"再创建一个对象sp3"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>shared_ptr<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> <span class="token function">sp3</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"sp.use_count(): "</span> <span class="token operator">&lt;&lt;</span> sp<span class="token punctuation">.</span><span class="token function">use_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"sp2.use_count(): "</span> <span class="token operator">&lt;&lt;</span> sp2<span class="token punctuation">.</span><span class="token function">use_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"sp3.use_count(): "</span> <span class="token operator">&lt;&lt;</span> sp3<span class="token punctuation">.</span><span class="token function">use_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>cout <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"执行赋值操作"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>sp3 <span class="token operator">=</span> sp<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"sp.use_count(): "</span> <span class="token operator">&lt;&lt;</span> sp<span class="token punctuation">.</span><span class="token function">use_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"sp2.use_count(): "</span> <span class="token operator">&lt;&lt;</span> sp2<span class="token punctuation">.</span><span class="token function">use_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"sp3.use_count(): "</span> <span class="token operator">&lt;&lt;</span> sp3<span class="token punctuation">.</span><span class="token function">use_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>cout <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"作为容器元素"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>vector<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">>></span> vec<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>vec<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>sp<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//sp 已经超出作用域，但 vec 中的元素仍然有效</span></pre></td></tr><tr><td data-num="27"></td><td><pre>vec<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>sp2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//sp2 被移动，vec 拥有 sp2 原来的资源</span></pre></td></tr></table></figure><pre><code>sp.use_count(): 1

执行复制操作
sp.use_count(): 2
sp2.use_count(): 2

再创建一个对象sp3
sp.use_count(): 2
sp2.use_count(): 2
sp3.use_count(): 1

执行赋值操作
sp.use_count(): 3
sp2.use_count(): 3
sp3.use_count(): 3

作为容器元素
</code></pre>
<h3 id="shared_ptr-的循环引用问题"><a class="anchor" href="#shared_ptr-的循环引用问题">#</a>  <code>shared_ptr</code>  的循环引用问题</h3>
<p>我们建立一个  <code>Parent</code>  和  <code>Child</code>  类的一个结构</p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">Child</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">Parent</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">public</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    shared_ptr<span class="token operator">&lt;</span>Child<span class="token operator">></span> _spChild<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">Child</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">public</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    shared_ptr<span class="token operator">&lt;</span>Parent<span class="token operator">></span> _spParent<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>由于  <code>shared_ptr</code>  的实现使用了引用计数，那么如果进行如下的创建</p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre>shared_ptr<span class="token operator">&lt;</span>Parent<span class="token operator">></span> <span class="token function">parentPtr</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">Parent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>shared_ptr<span class="token operator">&lt;</span>Child<span class="token operator">></span> <span class="token function">childPtr</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">Child</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">// 获取到的引用计数都是 1</span></pre></td></tr><tr><td data-num="4"></td><td><pre>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"parentPtr.use_count():"</span> <span class="token operator">&lt;&lt;</span> parentPtr<span class="token punctuation">.</span><span class="token function">use_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"childPtr.use_count():"</span> <span class="token operator">&lt;&lt;</span> childPtr<span class="token punctuation">.</span><span class="token function">use_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr></table></figure><p><img loading="lazy" data-src="https://dlink.host/1drv/aHR0cHM6Ly8xZHJ2Lm1zL2kvYy9iZGU1MWU2MjVlZjhmY2M1L0VXYkJYc0FWYVFCTXJINHkxTy1zN0VrQko0azVSaWxvWnB1djRBSXNhS1V5T2c_ZT1PWnlRQmg.png" alt="undefined202403222027179.png" /></p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre>parentPtr<span class="token operator">-></span>_spChild <span class="token operator">=</span> childPtr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>childPtr<span class="token operator">-></span>spParent <span class="token operator">=</span> parentPtr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">// 获取到的引用计数都是 2</span></pre></td></tr><tr><td data-num="4"></td><td><pre>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"parentPtr.use_count():"</span> <span class="token operator">&lt;&lt;</span> parentPtr<span class="token punctuation">.</span><span class="token function">use_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"childPtr.use_count():"</span> <span class="token operator">&lt;&lt;</span> childPtr<span class="token punctuation">.</span><span class="token function">use_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr></table></figure><p>实际上形成了这样的结构：</p>
<p><img loading="lazy" data-src="https://dlink.host/1drv/aHR0cHM6Ly8xZHJ2Lm1zL2kvYy9iZGU1MWU2MjVlZjhmY2M1L0VaREU2VDlQcTlwRXBsQXB1LU1kWGJFQjlzcnM0ZGpwOFZ6eG5ka2FLaUVzZXc_ZT1OVWNxeVI.png" alt="image-20240508115748981.png" /></p>
<p>程序结束时，发现  <code>Parent</code>  和  <code>child</code>  的析构函数都没有被调用</p>
<p>因为  <code>childPtr</code>  和  <code>parentPtr</code>  会先后销毁，但是堆上的  <code>Parent</code>  对象和  <code>Child</code>  对象的引用计数都变成了 1，而不会减到 0，所以没有回收。</p>
<p><img loading="lazy" data-src="https://dlink.host/1drv/aHR0cHM6Ly8xZHJ2Lm1zL2kvYy9iZGU1MWU2MjVlZjhmY2M1L0VjNjBsSXpSOWdaSnI4d3A0ZzRiX0FzQlU4TWNLNFlENU15MEJnUlhIaWVlcXc_ZT1jaGtOUzY.png" alt="image-20240508115701939.png" /></p>
<p>解决思路：</p>
<p>希望某一个指针指向一片空间，能够指向，但是不会使引用计数加 1，那么堆上的  <code>Parent</code>  对象和  <code>Child</code>  对象必然有一个的引用计数是 1，栈对象再销毁的时候，就可以使引用计数减为 0。</p>
<p><code>shared_ptr</code>  无法实现这一效果，所以引入了  <code>weak_ptr</code> 。</p>
<p><code>weak_ptr</code>  是一个弱引用的智能指针，不会增加引用计数。</p>
<p><code>shared_ptr</code>  是一个强引用的智能指针。</p>
<p>强引用，指向一定会增加引用计数，只要有一个引用存在，对象就不能释放；</p>
<p>弱引用并不增加对象的引用计数，但是它知道所托管的对象是否还存活。</p>
<p>循环引用的解法，将  <code>Parent</code>  类或  <code>Child</code>  类中的任意一个  <code>shared_ptr</code>  换成  <code>weak_ptr</code>  类型的智能指针</p>
<p>比如：将  <code>Parent</code>  类中的  <code>shared_ptr</code>  类型指针换成  <code>weak_ptr</code> 。</p>
<p><img loading="lazy" data-src="https://dlink.host/1drv/aHR0cHM6Ly8xZHJ2Lm1zL2kvYy9iZGU1MWU2MjVlZjhmY2M1L0Vmem54RGlJMF9OSmd4WmNkOE8xVkZFQmdDYlVNUHJBWUhuNmJUeGxqVTN1SEE_ZT1IaGgyRjE.png" alt="image-20240508115831351.png" /></p>
<p>栈上的  <code>childPtr</code>  对象先销毁，会使堆上的  <code>Child</code>  对象的引用计数减 1，因为这个  <code>Child</code>  对象的引用计数本来就是 1，所以减为了 0，回收这个  <code>Child</code>  对象，造成堆上的  <code>Parent</code>  对象的引用计数也减 1。</p>
<p><img loading="lazy" data-src="https://dlink.host/1drv/aHR0cHM6Ly8xZHJ2Lm1zL2kvYy9iZGU1MWU2MjVlZjhmY2M1L0Vadm05ZmhYeGtoUGxqZnVabGZrNXEwQnZNRkIwMG9mam5Uay16THBzOUV0bUE_ZT1HcXBYb3Y.png" alt="image-20240508120233748.png" /></p>
<p>再当  <code>parentPtr</code>  销毁时，会再让堆上的  <code>Parent</code>  对象的引用计数减 1，所以也能够回收。</p>
<p><img loading="lazy" data-src="https://dlink.host/1drv/aHR0cHM6Ly8xZHJ2Lm1zL2kvYy9iZGU1MWU2MjVlZjhmY2M1L0VVbTk3d2FQMkw1UHFUUzVMaGxzTTFrQnItMmlDT3g1RFUzZk9UOEcwWENkQlE_ZT1JY2NOWlE.png" alt="image-20240508120320252.png" /></p>
<h3 id="weak_ptr-的使用"><a class="anchor" href="#weak_ptr-的使用">#</a>  <code>weak_ptr</code>  的使用</h3>
<p><code>std::weak_ptr</code>  是 C++ 标准库中的智能指针，用于解决  <code>shared_ptr</code>  的循环引用问题。 <code>weak_ptr</code>  是一种弱引用智能指针，它不会增加引用计数，因此不会阻止其指向的对象被释放。</p>
<p><code>weak_ptr</code>  的特点：</p>
<ol>
<li><strong>弱引用</strong>：不会增加引用计数。</li>
<li><strong>观察引用</strong>：可以观察一个对象是否仍然存活，但不拥有对象。</li>
<li><strong>提升</strong>：可以通过  <code>lock()</code>  方法提升为  <code>std::shared_ptr</code> ，如果对象仍然存活。</li>
</ol>
<p>初始化  <code>weak_ptr</code> ：</p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre>shared_ptr<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> <span class="token function">sp</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>weak_ptr<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> wp<span class="token punctuation">;</span> <span class="token comment">// 无参的方式创建 weak_ptr</span></pre></td></tr><tr><td data-num="3"></td><td><pre>wp <span class="token operator">=</span> sp<span class="token punctuation">;</span> <span class="token comment">// 利用 shared_ptr 创建 weak_ptr</span></pre></td></tr></table></figure><p>判断关联的空间是否还在：</p>
<ol>
<li>
<p><strong>使用  <code>use_count</code>  函数</strong>：如果  <code>use_count</code>  的返回值大于 0，表明关联的空间还在。</p>
</li>
<li>
<p><strong>将  <code>weak_ptr</code>  提升为  <code>shared_ptr</code> </strong>：</p>
<p>这种赋值操作可以让 wp 也能够托管这片空间，但是它作为一个 weak_ptr 仍不能够去管理，甚至连访问都不允许（weak_ptr 不支持直接解引用）</p>
<p>想要真正地去进行管理需要使用 lock 函数将 weak_ptr 提升为 shared_ptr</p>
<p>如果托管的资源没有被销毁，就可以成功提升为 shared_ptr，否则就会返回一个空的 shared_ptr（空指针）</p>
</li>
</ol>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre>shared_ptr<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> <span class="token function">sp</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>weak_ptr<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> wp<span class="token punctuation">;</span> <span class="token comment">// 无参的方式创建 weak_ptr</span></pre></td></tr><tr><td data-num="3"></td><td><pre>wp <span class="token operator">=</span> sp<span class="token punctuation">;</span> <span class="token comment">// 赋值</span></pre></td></tr><tr><td data-num="4"></td><td><pre>shared_ptr<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> sp2 <span class="token operator">=</span> wp<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 提升为 shared_ptr</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">if</span> <span class="token punctuation">(</span>sp2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  cout <span class="token operator">&lt;&lt;</span> <span class="token string">"提升成功"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  cout <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>sp2 <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  cout <span class="token operator">&lt;&lt;</span> <span class="token string">"提升失败，托管的空间已经被销毁"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><ol start="3">
<li><strong>使用  <code>expired</code>  函数</strong>：</li>
</ol>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">bool</span> flag <span class="token operator">=</span> wp<span class="token punctuation">.</span><span class="token function">expired</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">if</span> <span class="token punctuation">(</span>flag<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"托管的空间已经被销毁"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"托管的空间还在"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><code>expired</code>  函数返回 true 等价于  <code>use_count() == 0</code> 。</p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;memory></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">void</span> <span class="token function">test_weak_ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  shared_ptr<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> <span class="token function">sp</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  weak_ptr<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> <span class="token function">wp</span><span class="token punctuation">(</span>sp<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token comment">// 判断关联空间是否还在</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  cout <span class="token operator">&lt;&lt;</span> <span class="token string">"use_count: "</span> <span class="token operator">&lt;&lt;</span> wp<span class="token punctuation">.</span><span class="token function">use_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token comment">// 提升为 shared_ptr</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  shared_ptr<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> sp2 <span class="token operator">=</span> wp<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>sp2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"提升成功"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    cout <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>sp2 <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"提升失败，托管的空间已经被销毁"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token comment">// 使用 expired 函数</span></pre></td></tr><tr><td data-num="21"></td><td><pre>  <span class="token keyword">bool</span> flag <span class="token operator">=</span> wp<span class="token punctuation">.</span><span class="token function">expired</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>flag<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"托管的空间已经被销毁"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"托管的空间还在"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>  <span class="token function">test_weak_ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="删除器"><a class="anchor" href="#删除器">#</a> 删除器</h2>
<h3 id="unique_ptr-对应的删除器"><a class="anchor" href="#unique_ptr-对应的删除器">#</a>  <code>unique_ptr</code>  对应的删除器</h3>
<p>默认情况下， <code>unique_ptr</code>  使用  <code>default_delete</code>  作为删除器，它通过  <code>delete</code>  或  <code>delete[]</code>  来释放资源。然而，对于一些特殊资源，如文件句柄或网络套接字，需要特殊的释放机制，因此需要自定义删除器。</p>
<p><img loading="lazy" data-src="https://dlink.host/1drv/aHR0cHM6Ly8xZHJ2Lm1zL2kvYy9iZGU1MWU2MjVlZjhmY2M1L0VWMDlMZlVyM3oxQ3FkbVd0LWdUa2M0QlVpeDBWOFVfVlozVVVkN0lFUzlwQ3c_ZT1IUkJrTFI.png" alt="" /></p>
<p><img loading="lazy" data-src="https://dlink.host/1drv/aHR0cHM6Ly8xZHJ2Lm1zL2kvYy9iZGU1MWU2MjVlZjhmY2M1L0VVMDFfLVlVRENKRG5QMlBMZWF3ZGJRQnlHWmVHdi0xQWJINFl1S2ZvNVZIOGc_ZT0wQzdmS3I.png" alt="" /></p>
<p>考虑一个场景，我们希望使用  <code>unique_ptr</code>  来管理一个由  <code>fopen</code>  打开的文件句柄。直接使用  <code>unique_ptr</code>  会遇到问题，因为默认删除器不知道如何正确关闭文件句柄。</p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span> <span class="token function">test0</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  string msg <span class="token operator">=</span> <span class="token string">"hello,world\n"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  FILE<span class="token operator">*</span> fp <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string">"res1.txt"</span><span class="token punctuation">,</span> <span class="token string">"a+"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token function">fwrite</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fp<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token function">fclose</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span> <span class="token function">test1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  string msg <span class="token operator">=</span> <span class="token string">"hello,world\n"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  unique_ptr<span class="token operator">&lt;</span>FILE<span class="token operator">></span> <span class="token function">up</span><span class="token punctuation">(</span><span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string">"res2.txt"</span><span class="token punctuation">,</span> <span class="token string">"a+"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token function">fwrite</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> up<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token comment">//fclose (up.get ()); // 这行会导致 double free 错误</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>在上面的代码中， <code>test1</code>  函数尝试使用  <code>unique_ptr</code>  来管理文件句柄，但如果调用  <code>fclose(up.get())</code> ，随后  <code>up</code>  的析构函数也会尝试释放文件句柄，导致 double free 错误。</p>
<p><img loading="lazy" data-src="https://dlink.host/1drv/aHR0cHM6Ly8xZHJ2Lm1zL2kvYy9iZGU1MWU2MjVlZjhmY2M1L0VSZFlhOElucmVWQ21ud2U1U2NLa040QnFXMzlYUUl4OWJtaE5nVVlHXzlMakE_ZT1qM0NaSjY.png" alt="" /></p>
<p>解决这个问题可以为  <code>unique_ptr</code>  提供一个自定义删除器。</p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">FILECloser</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token keyword">void</span> <span class="token keyword">operator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>FILE<span class="token operator">*</span> fp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>      <span class="token function">fclose</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>      std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"fclose("</span> <span class="token operator">&lt;&lt;</span> fp <span class="token operator">&lt;&lt;</span> <span class="token string">")"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">void</span> <span class="token function">test1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  string msg <span class="token operator">=</span> <span class="token string">"hello,world\n"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  unique_ptr<span class="token operator">&lt;</span>FILE<span class="token punctuation">,</span> FILECloser<span class="token operator">></span> <span class="token function">up</span><span class="token punctuation">(</span><span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string">"res2.txt"</span><span class="token punctuation">,</span> <span class="token string">"a+"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">FILECloser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token function">fwrite</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> up<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token comment">// 不需要手动 fclose，up 的析构函数会自动调用</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>在这个修改后的版本中定义了一个  <code>FILECloser</code>  结构体，并在  <code>std::unique_ptr</code>  的构造函数中提供了这个自定义删除器。这样，当  <code>up</code>  的生命周期结束时， <code>FILECloser</code>  将被调用来正确关闭文件句柄。</p>
<p>或者这样使用，与  <code>default_delete</code>  保持一致。</p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T</span><span class="token operator">></span> </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">FILECloser</span> </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token keyword">void</span> <span class="token keyword">operator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>FILE <span class="token operator">*</span> fp<span class="token punctuation">)</span><span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="6"></td><td><pre>      <span class="token function">fclose</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="7"></td><td><pre>      cout <span class="token operator">&lt;&lt;</span> <span class="token string">"fclose(fp)"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">void</span> <span class="token function">test3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  string <span class="token function">msg</span><span class="token punctuation">(</span><span class="token string">"hello,world\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  FILECloser fc<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  shared_ptr<span class="token operator">&lt;</span>FILE<span class="token operator">></span> <span class="token function">sp</span><span class="token punctuation">(</span><span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string">"res2.txt"</span><span class="token punctuation">,</span> <span class="token string">"a+"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fc<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token function">fwrite</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sp<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="shared_ptr-的删除器"><a class="anchor" href="#shared_ptr-的删除器">#</a>  <code>shared_ptr</code>  的删除器</h3>
<p>与  <code>unique_ptr</code>  类似， <code>shared_ptr</code>  也可以使用自定义删除器来管理非默认的资源释放方式。 <code>shared_ptr</code>  是一种智能指针，用于共享所有权的资源管理，它通过引用计数来跟踪资源的生命周期。</p>
<p><code>unique_ptr</code>  与  <code>shared_ptr</code>  删除器的区别</p>
<ol>
<li>
<p><strong> <code>unique_ptr</code>  的删除器作为模板参数</strong>： <code>unique_ptr</code>  要求删除器作为模板参数传递，这使得删除器成为智能指针类型的一部分。</p>
<p><img loading="lazy" data-src="https://dlink.host/1drv/aHR0cHM6Ly8xZHJ2Lm1zL2kvYy9iZGU1MWU2MjVlZjhmY2M1L0VVX1JLMnlFZVRsR2dYdFZnNDloVUtJQnBycmhlcFctWkFvTDN6MllxY2xpZEE_ZT1sY1phUzA.png" alt="" /></p>
</li>
<li>
<p><strong> <code>shared_ptr</code>  的删除器作为构造函数参数</strong>： <code>shared_ptr</code>  允许在构造函数中传递删除器，提供了更大的灵活性，允许不同的  <code>shared_ptr</code>  实例使用不同的删除器。</p>
<p><img loading="lazy" data-src="https://dlink.host/1drv/aHR0cHM6Ly8xZHJ2Lm1zL2kvYy9iZGU1MWU2MjVlZjhmY2M1L0VSejNuRU1USG1sTGtCbzhBa3B4RzRzQmdNZkoyVjJKVWFwTmM5RkVZb1h6RHc_ZT1XSzRvMmY.png" alt="" /></p>
</li>
</ol>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;memory></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstdio></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">FILECloser</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token keyword">void</span> <span class="token keyword">operator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>FILE<span class="token operator">*</span> fp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>      cout <span class="token operator">&lt;&lt;</span> <span class="token string">"fclose("</span> <span class="token operator">&lt;&lt;</span> fp <span class="token operator">&lt;&lt;</span> <span class="token string">")"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>      <span class="token function">fclose</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token keyword">void</span> <span class="token function">test_unique_ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  string msg <span class="token operator">=</span> <span class="token string">"hello, world\n"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token comment">// 使用自定义删除器的 unique_ptr</span></pre></td></tr><tr><td data-num="18"></td><td><pre>  unique_ptr<span class="token operator">&lt;</span>FILE<span class="token punctuation">,</span> FILECloser<span class="token operator">></span> <span class="token function">up</span><span class="token punctuation">(</span><span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string">"res2.txt"</span><span class="token punctuation">,</span> <span class="token string">"a+"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">FILECloser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token function">fwrite</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> up<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token keyword">void</span> <span class="token function">test_shared_ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>  string msg <span class="token operator">=</span> <span class="token string">"hello, world\n"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>  FILECloser fc<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>  <span class="token comment">// 使用自定义删除器的 shared_ptr</span></pre></td></tr><tr><td data-num="26"></td><td><pre>  shared_ptr<span class="token operator">&lt;</span>FILE<span class="token operator">></span> <span class="token function">sp</span><span class="token punctuation">(</span><span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string">"res3.txt"</span><span class="token punctuation">,</span> <span class="token string">"a+"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fc<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>  <span class="token function">fwrite</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sp<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>  <span class="token function">test_unique_ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>  <span class="token function">test_shared_ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这个例子定义了一个  <code>FILECloser</code>  结构体，它重载了  <code>operator()</code>  函数来关闭文件。然后使用  <code>unique_ptr</code>  和  <code>shared_ptr</code>  来管理文件资源，并在构造时传入自定义的删除器。</p>
<h2 id="智能指针的误用"><a class="anchor" href="#智能指针的误用">#</a> 智能指针的误用</h2>
<p>智能指针误用的主要原因是将同一个原生裸指针交给了不同的智能指针进行托管，导致尝试对同一个对象销毁两次。</p>
<h3 id="unique_ptr-的误用"><a class="anchor" href="#unique_ptr-的误用">#</a>  <code>unique_ptr</code>  的误用</h3>
<p><code>unique_ptr</code>  要求独占所有权，因此不能将同一个裸指针传递给多个  <code>unique_ptr</code>  实例。</p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span> <span class="token function">test0</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  Point <span class="token operator">*</span> pt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">Point</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  unique_ptr<span class="token operator">&lt;</span>Point<span class="token operator">></span> <span class="token function">up</span><span class="token punctuation">(</span>pt<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  unique_ptr<span class="token operator">&lt;</span>Point<span class="token operator">></span> <span class="token function">up2</span><span class="token punctuation">(</span>pt<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 错误：重复托管</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">void</span> <span class="token function">test1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  unique_ptr<span class="token operator">&lt;</span>Point<span class="token operator">></span> <span class="token function">up</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">Point</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  unique_ptr<span class="token operator">&lt;</span>Point<span class="token operator">></span> <span class="token function">up2</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">Point</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  up<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span>up2<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 错误：重复托管</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="shared_ptr-的误用"><a class="anchor" href="#shared_ptr-的误用">#</a>  <code>shared_ptr</code>  的误用</h3>
<p>使用不同的智能指针托管同一片堆空间，只能通过  <code>shared_ptr</code>  开放的接口 —— 拷贝构造、赋值运算符函数</p>
<p>如果是用裸指针的形式将一片资源交给不同的智能指针对象管理，即使是  <code>shared_ptr</code>  也是不行的。</p>
<p>之前进行的  <code>shared_ptr</code>  的复制、赋值的参数都是  <code>shared_ptr</code>  的对象，不能直接多次把同一个裸指针传给它的构造。</p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span> <span class="token function">test2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  Point <span class="token operator">*</span> pt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">Point</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>Point<span class="token operator">></span> <span class="token function">sp</span><span class="token punctuation">(</span>pt<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>Point<span class="token operator">></span> <span class="token function">sp2</span><span class="token punctuation">(</span>pt<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 错误：重复托管</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">void</span> <span class="token function">test3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>Point<span class="token operator">></span> <span class="token function">sp</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">Point</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>Point<span class="token operator">></span> <span class="token function">sp2</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">Point</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  sp<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span>sp2<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 错误：重复托管</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="不明显误用"><a class="anchor" href="#不明显误用">#</a> 不明显误用</h3>
<p>当通过成员函数返回当前对象的指针（ <code>this</code> ），并让外部代码创建一个新的智能指针来管理这个指针时，可能出现多个智能指针管理同一资源的问题。</p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">Point</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token keyword">public</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token keyword">int</span> _ix<span class="token punctuation">,</span> _iy<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token function">Point</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">_ix</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_iy</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>  Point<span class="token operator">*</span> <span class="token function">addPoint</span><span class="token punctuation">(</span>Point<span class="token operator">*</span> pt<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    _ix <span class="token operator">+=</span> pt<span class="token operator">-></span>_ix<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    _iy <span class="token operator">+=</span> pt<span class="token operator">-></span>_iy<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  shared_ptr<span class="token operator">&lt;</span>Point<span class="token operator">></span> <span class="token function">sp</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">Point</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  shared_ptr<span class="token operator">&lt;</span>Point<span class="token operator">></span> <span class="token function">sp2</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">Point</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>  shared_ptr<span class="token operator">&lt;</span>Point<span class="token operator">></span> <span class="token function">sp3</span><span class="token punctuation">(</span>sp<span class="token operator">-></span><span class="token function">addPoint</span><span class="token punctuation">(</span>sp2<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>  sp3<span class="token operator">-></span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>在这个例子中， <code>sp3</code>  实际上是通过  <code>sp</code>  的裸指针创建的，这意味着  <code>sp</code>  和  <code>sp3</code>  都试图管理同一个  <code>Point</code>  对象。当  <code>sp</code>  和  <code>sp3</code>  被销毁时，都尝试释放同一个资源，导致 double free 错误。</p>
<p>为了避免这种情况，可以使用  <code>enable_shared_from_this</code>  来安全地获取当前对象的  <code>shared_ptr</code> 。</p>
<p><code>enable_shared_from_this</code>  是 C++ 标准库中的一个模板类，它提供了一种机制，允许一个对象从它的成员函数中安全地获取对自身的  <code>shared_ptr</code> 。这个类通常用于管理对象的生命周期，特别是在对象的所有权可能在多个  <code>shared_ptr</code>  实例之间转移时。</p>
<p><img loading="lazy" data-src="https://dlink.host/1drv/aHR0cHM6Ly8xZHJ2Lm1zL2kvYy9iZGU1MWU2MjVlZjhmY2M1L0VVUXdIWmR3eXg5SnZCUlVFYmxqeEFZQjQwZ3A3OHlQTE9KVEF3dGllR2dQbFE_ZT1YZkhVOVE.png" alt="" /></p>
<p>在  <code>Point</code>  的  <code>addPoint</code>  函数中需要使用  <code>shared_from_this</code>  函数返回的  <code>shared_ptr</code>  作为返回值，要想在  <code>Point</code>  类中调用  <code>enable_shared_from_this</code>  的成员函数，最佳方案可以让  <code>Point</code>  类继承  <code>enable_shared_from_this</code>  类。</p>
<p>这样修改  <code>addPoint</code>  函数后，问题解决。</p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;memory></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">Point</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">enable_shared_from_this</span><span class="token operator">&lt;</span><span class="token class-name">Point</span><span class="token operator">></span></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token keyword">public</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token keyword">int</span> _ix<span class="token punctuation">,</span> _iy<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token function">Point</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">_ix</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_iy</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token comment">// 不存在任何的非法的使用同一个裸指针创建多个 shared_ptr 的情况</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  shared_ptr<span class="token operator">&lt;</span>Point<span class="token operator">></span> <span class="token function">addPoint</span><span class="token punctuation">(</span><span class="token keyword">const</span> Point <span class="token operator">&amp;</span>pt<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    _ix <span class="token operator">+=</span> pt<span class="token punctuation">.</span>_ix<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    _iy <span class="token operator">+=</span> pt<span class="token punctuation">.</span>_iy<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">return</span> <span class="token function">shared_from_this</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token keyword">void</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Point("</span> <span class="token operator">&lt;&lt;</span> _ix <span class="token operator">&lt;&lt;</span> <span class="token string">", "</span> <span class="token operator">&lt;&lt;</span> _iy <span class="token operator">&lt;&lt;</span> <span class="token string">")"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>  <span class="token keyword">auto</span> sp <span class="token operator">=</span> <span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>Point<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>  <span class="token keyword">auto</span> sp2 <span class="token operator">=</span> <span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>Point<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>  <span class="token keyword">auto</span> sp3 <span class="token operator">=</span> sp<span class="token operator">-></span><span class="token function">addPoint</span><span class="token punctuation">(</span><span class="token operator">*</span>sp2<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>  sp3<span class="token operator">-></span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>在这个例子中， <code>Point</code>  类继承自  <code>enable_shared_from_this</code> ，使得我们可以在成员函数中使用  <code>shared_from_this</code>  来获取当前对象的  <code>shared_ptr</code> 。这样， <code>addPoint</code>  函数返回的  <code>shared_ptr</code>  与  <code>sp</code>  共享所有权，而不是创建一个新的智能指针实例。</p>
<div class="tags"><a href="/tags/cpp/" rel="tag"><i class="ic i-tag"></i>C++</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i></span><span class="text">更新于 </span><time title="修改时间：2024-12-16 16:12:52" itemprop="dateModified" datetime="2024-12-16T16:12:52+08:00">2024-12-16</time></span></div><div id="copyright"><ul><li class="author"><strong>本文作者：</strong>樱小路七叶<i class="ic i-at"><em>@</em></i>Nana7ha's Café Stella</li><li class="link"><strong>本文链接：</strong><a href="https://cwlrin.wiki/c-cpp/cpp-base/C++%20%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/" title="C++ 资源管理">https://cwlrin.wiki/c-cpp/cpp-base/C++ 资源管理/</a></li><li class="license"><strong>版权声明：</strong>本站所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/c-cpp/cpp-base/C++%20%E7%A7%BB%E5%8A%A8%E8%AF%AD%E4%B9%89/" rel="prev" itemprop="url" title="C++ 移动语义" style="background-image: linear-gradient(to bottom right, #d4d2ac, #9298ab);"><span class="type">上一篇</span><span class="category"><i class="ic i-flag"></i>C++ 基础</span><h3>C++ 移动语义</h3></a></div><div class="item right"><a href="/c-cpp/cpp-stl/STL%20%E5%BA%8F%E5%88%97%E5%BC%8F%E5%AE%B9%E5%99%A8/" rel="next" itemprop="url" title="STL 序列式容器" style="background-image: linear-gradient(to bottom right, #85bdb1, #f982de);"><span class="type">下一篇</span><span class="category"><i class="ic i-flag"></i>STL 基础</span><h3>STL 序列式容器</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#raii-%E6%8A%80%E6%9C%AF"><span class="toc-number">1.</span> <span class="toc-text"> RAII 技术</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#raii-%E7%B1%BB%E7%9A%84%E5%B8%B8%E8%A7%81%E7%89%B9%E5%BE%81"><span class="toc-number">1.1.</span> <span class="toc-text"> RAII 类的常见特征</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#raii-%E7%B1%BB%E6%A8%A1%E6%9D%BF%E7%9A%84%E6%A8%A1%E6%8B%9F"><span class="toc-number">1.2.</span> <span class="toc-text"> RAII 类模板的模拟</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%99%BA%E8%83%BD%E6%8C%87%E9%92%88"><span class="toc-number">2.</span> <span class="toc-text"> 智能指针</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#auto_ptr"><span class="toc-number">2.1.</span> <span class="toc-text">  auto_ptr</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#unique_ptr"><span class="toc-number">2.2.</span> <span class="toc-text">  unique_ptr</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#shared_ptr"><span class="toc-number">2.3.</span> <span class="toc-text">  shared_ptr</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#shared_ptr-%E7%9A%84%E5%BE%AA%E7%8E%AF%E5%BC%95%E7%94%A8%E9%97%AE%E9%A2%98"><span class="toc-number">2.4.</span> <span class="toc-text">  shared_ptr  的循环引用问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#weak_ptr-%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">2.5.</span> <span class="toc-text">  weak_ptr  的使用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E5%99%A8"><span class="toc-number">3.</span> <span class="toc-text"> 删除器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#unique_ptr-%E5%AF%B9%E5%BA%94%E7%9A%84%E5%88%A0%E9%99%A4%E5%99%A8"><span class="toc-number">3.1.</span> <span class="toc-text">  unique_ptr  对应的删除器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#shared_ptr-%E7%9A%84%E5%88%A0%E9%99%A4%E5%99%A8"><span class="toc-number">3.2.</span> <span class="toc-text">  shared_ptr  的删除器</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%99%BA%E8%83%BD%E6%8C%87%E9%92%88%E7%9A%84%E8%AF%AF%E7%94%A8"><span class="toc-number">4.</span> <span class="toc-text"> 智能指针的误用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#unique_ptr-%E7%9A%84%E8%AF%AF%E7%94%A8"><span class="toc-number">4.1.</span> <span class="toc-text">  unique_ptr  的误用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#shared_ptr-%E7%9A%84%E8%AF%AF%E7%94%A8"><span class="toc-number">4.2.</span> <span class="toc-text">  shared_ptr  的误用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8D%E6%98%8E%E6%98%BE%E8%AF%AF%E7%94%A8"><span class="toc-number">4.3.</span> <span class="toc-text"> 不明显误用</span></a></li></ol></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li ><a href="/c-cpp/cpp-base/%E4%BB%8E%20C%20%E5%88%B0%20C++/" rel="bookmark" title="从 C 到 C++">从 C 到 C++</a></li><li ><a href="/c-cpp/cpp-base/C++%20%E7%B1%BB%E5%92%8C%E5%AF%B9%E8%B1%A1/" rel="bookmark" title="C++ 类和对象">C++ 类和对象</a></li><li ><a href="/c-cpp/cpp-base/C++%20%E8%BE%93%E5%85%A5%E8%BE%93%E5%87%BA%E6%B5%81/" rel="bookmark" title="C++ 输入输出流">C++ 输入输出流</a></li><li ><a href="/c-cpp/cpp-base/C++%20%E8%BF%90%E7%AE%97%E7%AC%A6%E9%87%8D%E8%BD%BD/" rel="bookmark" title="C++ 运算符重载">C++ 运算符重载</a></li><li ><a href="/c-cpp/cpp-base/C++%20%E5%85%B3%E8%81%94%E6%80%A7%E5%AE%B9%E5%99%A8/" rel="bookmark" title="C++ 关联性容器">C++ 关联性容器</a></li><li ><a href="/c-cpp/cpp-base/C++%20%E7%BB%A7%E6%89%BF/" rel="bookmark" title="C++ 继承">C++ 继承</a></li><li ><a href="/c-cpp/cpp-base/C++%20%E5%A4%9A%E6%80%81/" rel="bookmark" title="C++ 多态">C++ 多态</a></li><li ><a href="/c-cpp/cpp-base/C++%20%E6%A8%A1%E6%9D%BF/" rel="bookmark" title="C++ 模板">C++ 模板</a></li><li ><a href="/c-cpp/cpp-base/C++%20%E7%A7%BB%E5%8A%A8%E8%AF%AD%E4%B9%89/" rel="bookmark" title="C++ 移动语义">C++ 移动语义</a></li><li  class="active"><a href="/c-cpp/cpp-base/C++%20%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/" rel="bookmark" title="C++ 资源管理">C++ 资源管理</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><img class="image" loading="lazy" decoding="async" itemprop="image" alt="樱小路七叶" src="/assets/avatar.jpg"/><p class="name" itemprop="name">樱小路七叶</p><div class="description" itemprop="description">技术与美日新月异</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">91</span><span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">11</span><span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">13</span><span class="name">标签</span></a></div></nav><div class="social"><a target="_blank" rel="noopener" href="https://github.com/cwlrin" class="item github" title="https:&#x2F;&#x2F;github.com&#x2F;cwlrin"><i class="ic i-github"></i></a><a target="_blank" rel="noopener" href="https://www.zhihu.com/people/ying-xiao-lu-qi-ye" class="item zhihu" title="https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;ying-xiao-lu-qi-ye"><i class="ic i-zhihu"></i></a><a target="_blank" rel="noopener" href="https://music.163.com/#/user/home?id=411590211" class="item music" title="https:&#x2F;&#x2F;music.163.com&#x2F;#&#x2F;user&#x2F;home?id&#x3D;411590211"><i class="ic i-cloud-music"></i></a><a target="_blank" rel="noopener" href="https://space.bilibili.com/8013992" class="item bilibili" title="https:&#x2F;&#x2F;space.bilibili.com&#x2F;8013992"><i class="ic i-bilibili"></i></a></div><div class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item dropdown"><a href="#" onclick="return false;"><i class="ic i-user"></i>关于</a><ul class="submenu"><li class="item"><a href="/about/" rel="section"><i class="ic i-user"></i>关于本站</a></li><li class="item"><a href="/admiration/" rel="section"><i class="ic i-coffee"></i>赞赏博主</a></li></ul></li><li class="item dropdown"><a href="#" onclick="return false;"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li><li class="item"><a href="/friends/" rel="section"><i class="ic i-heart"></i>友链</a></li></div></div></div></div><ul id="quick"><li class="prev pjax"><a href="/c-cpp/cpp-stl/STL%20%E5%BA%8F%E5%88%97%E5%BC%8F%E5%AE%B9%E5%99%A8/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/c-cpp/cpp-base/C++%20%E7%A7%BB%E5%8A%A8%E8%AF%AD%E4%B9%89/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"></div><div class="status"><div class="copyright">&copy; 2020 -<span itemprop="copyrightYear">2025</span><span class="with-love"><i class="ic i-sakura rotate"></i></span><span class="author" itemprop="copyrightHolder">樱小路七叶 @ 七葉の喫茶ステラ</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i></span><span title="站点总字数">1.4m 字</span><span class="post-meta-divider"> | </span><span class="post-meta-item-icon"><i class="ic i-coffee"></i></span><span title="站点阅读时长">21:46</span></div><div class="powered-by">基于 <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a> & Theme.<a target="_blank" rel="noopener" href="https://github.com/theme-shoka-x/hexo-theme-shokaX/">ShokaX</a></div><br/><span style="display:inline;height:20px;line-height:20px;margin: 0px 0px 0px 5px; color:var(--grey-5);"><a target="_blank" rel="noopener" href="https://beian.miit.gov.cn">黑ICP备2021000748号-1</a><br/><a target="_blank" href="https://beian.mps.gov.cn/#/query/webSearch?code=23120202000171"><img loading="lazy" decoding="async" data-src="/assets/备案.png" style="max-width: 2em;display:inline;" width="20" height="20" alt="备案"/>黑公网安备23120202000171号</a></span></div></div></footer></div><script data-config type="text/javascript">var LOCAL = {
    ispost: true,
    path: `c-cpp/cpp-base/C++ 资源管理/`,
    favicon: {
        show: `（●´3｀●）やれやれだぜ`,
        hide: `(´Д｀)大変だ！`
    },
    search: {
        placeholder: "文章搜索",
        empty: "关于 「 ${query} 」，什么也没搜到",
        stats: "${time} ms 内找到 ${hits} 条结果"
    },
    nocopy: "false",
    copyright: `复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。`,
    copy_tex: false,
    katex: false,
    mermaid: false,
    audio: undefined,
    fancybox: true,
    nocopy: false,
    outime: true,
    template: `<div class="note warning"><p><span class="label warning">文章时效性提示</span><br>这是一篇发布于 {{publish}} 天前，最后一次更新在 {{updated}} 天前的文章，部分信息可能已经发生改变，请注意甄别。</p></div>`,
    quiz: {
        choice: `单选题`,
        multiple: `多选题`,
        true_false: `判断题`,
        essay: `问答题`,
        gap_fill: `填空题`,
        mistake: `错题备注`
    },
    ignores: [
        (uri) => uri.includes('#'),
        (uri) => new RegExp(LOCAL.path + '$').test(uri),
            []
    ]
};
</script><script src="https://s4.zstatic.net/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha384-k6YtvFUEIuEFBdrLKJ3YAUbBki333tj1CSUisai5Cswsg9wcLNaPzsTHDswp4Az8" crossorigin="anonymous" fetchpriority="high"></script><script src="https://s4.zstatic.net/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha384-ZvpUoO&#x2F;+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn&#x2F;6Z&#x2F;hRTt8+pR6L4N2" crossorigin="anonymous" fetchpriority="high"></script><script src="https://s4.zstatic.net/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha384-Zm+UU4tdcfAm29vg+MTbfu&#x2F;&#x2F;q5B&#x2F;lInMbMCr4T8c9rQFyOv6PlfQYpB5wItcXWe7" crossorigin="anonymous" fetchpriority="high"></script><script src="https://s4.zstatic.net/ajax/libs/justifiedGallery/3.8.1/js/jquery.justifiedGallery.min.js" integrity="sha384-TOxsBplaL96&#x2F;QDWPIUg+ye3v89qSE3s22XNtJMmCeZEep3cVDmXy1zEfZvVv+y2m" crossorigin="anonymous" fetchpriority="high"></script><script src="/js/siteInit.js?v=0.4.20" type="module" fetchpriority="high" defer></script></body></html>