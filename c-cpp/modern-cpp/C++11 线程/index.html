<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"/><meta name="theme-color" content="#222"/><meta http-equiv="X-UA-COMPATIBLE" content="IE=edge,chrome=1"/><meta name="renderer" content="webkit"/><link rel="icon" type="image/ico" sizes="32x32" href="/assets/favicon.ico"/><link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png"/><link rel="alternate" href="/rss.xml" title="Nana7ha's Café Stella" type="application/rss+xml"><link rel="alternate" href="/atom.xml" title="Nana7ha's Café Stella" type="application/atom+xml"><link rel="alternate" type="application/json" title="Nana7ha's Café Stella" href="http://cwlrin.wiki/feed.json"/><link rel="preconnect" href="https://s4.zstatic.net"/><link rel="preconnect" href="https://at.alicdn.com"/><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Mulish:400,400italic,700,700italic%7CFredericka%20the%20Great:400,400italic,700,700italic%7CNoto%20Serif%20JP:400,400italic,700,700italic%7CNoto%20Serif%20SC:400,400italic,700,700italic%7CInconsolata:400,400italic,700,700italic&display=swap&subset=latin,latin-ext" media="none" onload="this.media&#x3D;&#39;all&#39;"><link rel="stylesheet" href="/css/app.css?v=0.4.20"><link rel="modulepreload" href="/js/chunk-NPDU2HRQ.js"></link><link rel="modulepreload" href="/js/chunk-R2ID445Y.js"></link><link rel="modulepreload" href="/js/chunk-YHPSMGA6.js"></link><link rel="modulepreload" href="/js/copy-tex-2AKW2INC.js"></link><link rel="modulepreload" href="/js/index.esm-TLZT3I4E.js"></link><link rel="modulepreload" href="/js/post-AWU7OAKV.js"></link><link rel="modulepreload" href="/js/quicklink-3TNKEFE4.js"></link><link rel="modulepreload" href="/js/siteInit.js"></link><link rel="preload" href="https://dlink.host/1drv/aHR0cHM6Ly8xZHJ2Lm1zL2kvYy9iZGU1MWU2MjVlZjhmY2M1L0VjTU1iOVFYMkp0SW1hU3V3WTJOM2h3QjU1aV8yNS1zRkZYaTJJNkhCVmZhSXc_ZT1yNTdyS0I.png" as="image" fetchpriority="high"><meta name="keywords" content="C++"/><meta name="description" content="技术与美日新月异"/><link rel="canonical" href="http://cwlrin.wiki/c-cpp/modern-cpp/C++11%20%E7%BA%BF%E7%A8%8B/"><title>C++11 线程</title><meta name="generator" content="Hexo 7.3.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">C++11 线程</h1><div class="meta"><span class="item" title="创建时间：2021-06-10 12:14:54"><span class="icon"><i class="ic i-calendar"></i></span><span class="text">发表于</span><time itemprop="dateCreated datePublished" datetime="2021-06-10T12:14:54+08:00">2021-06-10</time></span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i></span><span class="text">本文字数</span><span>22k</span><span class="text">字</span></span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i></span><span class="text">阅读时长</span><span>20 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span><span class="line"></span><span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">七葉の喫茶ステラ</a></li></ul><ul class="right" id="rightNav"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div class="pjax" id="imgs"><img src="https://dlink.host/1drv/aHR0cHM6Ly8xZHJ2Lm1zL2kvYy9iZGU1MWU2MjVlZjhmY2M1L0VjTU1iOVFYMkp0SW1hU3V3WTJOM2h3QjU1aV8yNS1zRkZYaTJJNkhCVmZhSXc_ZT1yNTdyS0I.png" loading="eager" decoding="async" fetchpriority="high" alt="Nana7ha's Café Stella"></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"></path></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"></use><use xlink:href="#gentle-wave" x="48" y="3"></use><use xlink:href="#gentle-wave" x="48" y="5"></use><use xlink:href="#gentle-wave" x="48" y="7"></use></g></svg></div><main><div class="inner"><div class="pjax" id="main"><div class="article wrap"><div class="breadcrumb" itemListElement itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i><span><a href="/">首页</a></span><i class="ic i-angle-right"></i><span itemprop="itemListElement" itemscope="itemscope" itemtype="https://schema.org/ListItem"><a href="/categories/c-cpp/" itemprop="item" rel="index" title="分类于C/C++"><span itemprop="name">C/C++<meta itemprop="position" content="0"/></span></a></span><i class="ic i-angle-right"></i><span class="current" itemprop="itemListElement" itemscope="itemscope" itemtype="https://schema.org/ListItem"><a href="/categories/c-cpp/modern-cpp/" itemprop="item" rel="index" title="分类于现代 C++"><span itemprop="name">现代 C++<meta itemprop="position" content="1"/></span></a></span></div><article class="post block" itemscope="itemscope" itemtype="http://schema.org/Article" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://cwlrin.wiki/c-cpp/modern-cpp/C++11%20%E7%BA%BF%E7%A8%8B/"/><span hidden="hidden" itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="image" content="/assets/avatar.jpg"/><meta itemprop="name" content="樱小路七叶"/><meta itemprop="description" content=", 技术与美日新月异"/></span><span hidden="hidden" itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="Nana7ha's Café Stella"/></span><div class="body md" itemprop="articleBody"><h2 id="c11-线程"><a class="anchor" href="#c11-线程">#</a> C++11 线程</h2>
<h3 id="函数接口"><a class="anchor" href="#函数接口">#</a> 函数接口</h3>
<p><img loading="lazy" data-src="https://dlink.host/1drv/aHR0cHM6Ly8xZHJ2Lm1zL2kvYy9iZGU1MWU2MjVlZjhmY2M1L0VjRU4zUlR1MTl4QnRRbV82ajJmOGdBQkx2Wmw3YnB2ZElISDZwSEx3b3B0MXc_ZT1MQndid2M.png" alt="" /></p>
<p><img loading="lazy" data-src="https://dlink.host/1drv/aHR0cHM6Ly8xZHJ2Lm1zL2kvYy9iZGU1MWU2MjVlZjhmY2M1L0VWVU9Xc0tpUEtsT2dCb2JXdm9iaFpVQkJpS2h0N3VkOEFxaVdYWDMzRVo2SlE_ZT1qTml5QkU.png" alt="" /></p>
<h3 id="线程-id-的获取"><a class="anchor" href="#线程-id-的获取">#</a> 线程 id 的获取</h3>
<p><img loading="lazy" data-src="https://dlink.host/1drv/aHR0cHM6Ly8xZHJ2Lm1zL2kvYy9iZGU1MWU2MjVlZjhmY2M1L0VRUFFrRzRrbVhwTGo4SENvVThuckh3Qkp4cW9sUG5fVE11YUhHcXVhUGpweWc_ZT0xbVBhWTg.png" alt="" /></p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 此处的 get_id 是成员函数，说明需要使用对象进行调用</span></pre></td></tr><tr><td data-num="2"></td><td><pre>std<span class="token double-colon punctuation">::</span>thread<span class="token double-colon punctuation">::</span>id <span class="token function">get_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token keyword">noexcept</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">// 此处的 get_id 是 std::this_thread 命令空间中的一个实体，就是个普通函数</span></pre></td></tr><tr><td data-num="5"></td><td><pre>std<span class="token double-colon punctuation">::</span>thread<span class="token double-colon punctuation">::</span>id <span class="token function">get_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">noexcept</span><span class="token punctuation">;</span></pre></td></tr></table></figure><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  this_thread<span class="token double-colon punctuation">::</span><span class="token function">sleep_for</span><span class="token punctuation">(</span>chrono<span class="token double-colon punctuation">::</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  thread <span class="token function">t1</span><span class="token punctuation">(</span>foo<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  thread<span class="token double-colon punctuation">::</span>id t1_id <span class="token operator">=</span> t1<span class="token punctuation">.</span><span class="token function">get_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>  thread <span class="token function">t2</span><span class="token punctuation">(</span>foo<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  thread<span class="token double-colon punctuation">::</span>id t2_id <span class="token operator">=</span> t2<span class="token punctuation">.</span><span class="token function">get_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>  cout <span class="token operator">&lt;&lt;</span> <span class="token string">"t1 的 id: "</span> <span class="token operator">&lt;&lt;</span> t1_id <span class="token operator">&lt;&lt;</span> <span class="token char">'\n'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  cout <span class="token operator">&lt;&lt;</span> <span class="token string">"t2 的 id: "</span> <span class="token operator">&lt;&lt;</span> t2_id <span class="token operator">&lt;&lt;</span> <span class="token char">'\n'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>  t1<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  t2<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>  cout <span class="token operator">&lt;&lt;</span> <span class="token string">"合并后 t1 的 id: "</span> <span class="token operator">&lt;&lt;</span> t1<span class="token punctuation">.</span><span class="token function">get_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token char">'\n'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>  cout <span class="token operator">&lt;&lt;</span> <span class="token string">"合并后 t2 的 id: "</span> <span class="token operator">&lt;&lt;</span> t2<span class="token punctuation">.</span><span class="token function">get_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token char">'\n'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="线程的等待"><a class="anchor" href="#线程的等待">#</a> 线程的等待</h3>
<p><img loading="lazy" data-src="https://dlink.host/1drv/aHR0cHM6Ly8xZHJ2Lm1zL2kvYy9iZGU1MWU2MjVlZjhmY2M1L0VWTUExVllxZXAxTnRmV2tDX2Ewei1VQnRMcEJBZW1LR3NabFoyOEdXZVB6elE_ZT02UFpXa2E.png" alt="" /></p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token comment">// 模拟耗费大量资源的操作</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  this_thread<span class="token double-colon punctuation">::</span><span class="token function">sleep_for</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">void</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token comment">// 模拟耗费大量资源的操作</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  this_thread<span class="token double-colon punctuation">::</span><span class="token function">sleep_for</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  cout <span class="token operator">&lt;&lt;</span> <span class="token string">"启动第一助手...\n"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  thread <span class="token function">helper1</span><span class="token punctuation">(</span>foo<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>  cout <span class="token operator">&lt;&lt;</span> <span class="token string">"启动第二助手...\n"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  thread <span class="token function">helper2</span><span class="token punctuation">(</span>bar<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>  cout <span class="token operator">&lt;&lt;</span> <span class="token string">"等待助手结束..."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>  helper1<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>  helper2<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>  std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"完成!\n"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="线程入口函数的传参"><a class="anchor" href="#线程入口函数的传参">#</a> 线程入口函数的传参</h3>
<h4 id="普通函数"><a class="anchor" href="#普通函数">#</a> 普通函数</h4>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span> <span class="token function">threadFunc</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  cout <span class="token operator">&lt;&lt;</span> <span class="token string">"void threadFunc(int)"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  cout <span class="token operator">&lt;&lt;</span> <span class="token string">"child thread id = "</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>this_thread<span class="token double-colon punctuation">::</span><span class="token function">get_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  cout <span class="token operator">&lt;&lt;</span> <span class="token string">"x = "</span> <span class="token operator">&lt;&lt;</span> x <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  cout <span class="token operator">&lt;&lt;</span> <span class="token string">"main thread id = "</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>this_thread<span class="token double-colon punctuation">::</span><span class="token function">get_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  thread <span class="token function">th</span><span class="token punctuation">(</span>threadFunc<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建线程对象 th</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  cout <span class="token operator">&lt;&lt;</span> <span class="token string">"child1 thread id = "</span> <span class="token operator">&lt;&lt;</span> th<span class="token punctuation">.</span><span class="token function">get_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>  th<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 让主线程等待子线程</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="函数指针"><a class="anchor" href="#函数指针">#</a> 函数指针</h4>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span> <span class="token function">threadFunc</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  cout <span class="token operator">&lt;&lt;</span> endl <span class="token operator">&lt;&lt;</span> <span class="token string">"void threadFunc(int)"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  cout <span class="token operator">&lt;&lt;</span> <span class="token string">"child thread id = "</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>this_thread<span class="token double-colon punctuation">::</span><span class="token function">get_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  cout <span class="token operator">&lt;&lt;</span> <span class="token string">"x = "</span> <span class="token operator">&lt;&lt;</span> x <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  cout <span class="token operator">&lt;&lt;</span> <span class="token string">"main thread id = "</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>this_thread<span class="token double-colon punctuation">::</span><span class="token function">get_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token keyword">typedef</span> <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>pFunc<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 定义函数指针类型的方式</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  pFunc f <span class="token operator">=</span> <span class="token operator">&amp;</span>threadFunc<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>  thread <span class="token function">th</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 创建线程对象 th</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  cout <span class="token operator">&lt;&lt;</span> <span class="token string">"child1 thread id = "</span> <span class="token operator">&lt;&lt;</span> th<span class="token punctuation">.</span><span class="token function">get_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>  th<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 让主线程等待子线程</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="函数引用"><a class="anchor" href="#函数引用">#</a> 函数引用</h4>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span> <span class="token function">threadFunc</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  cout <span class="token operator">&lt;&lt;</span> endl <span class="token operator">&lt;&lt;</span> <span class="token string">"void threadFunc(int)"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  cout <span class="token operator">&lt;&lt;</span> <span class="token string">"child thread id = "</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>this_thread<span class="token double-colon punctuation">::</span><span class="token function">get_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  cout <span class="token operator">&lt;&lt;</span> <span class="token string">"x = "</span> <span class="token operator">&lt;&lt;</span> x <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  cout <span class="token operator">&lt;&lt;</span> <span class="token string">"main thread id = "</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>this_thread<span class="token double-colon punctuation">::</span><span class="token function">get_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token keyword">typedef</span> <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>pFunc<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 定义函数引用类型的方式</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  pFunc f <span class="token operator">=</span> threadFunc<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>  thread <span class="token function">th</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建线程对象 th</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  cout <span class="token operator">&lt;&lt;</span> <span class="token string">"child1 thread id = "</span> <span class="token operator">&lt;&lt;</span> th<span class="token punctuation">.</span><span class="token function">get_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>  th<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 让主线程等待子线程</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="函数对象"><a class="anchor" href="#函数对象">#</a> 函数对象</h4>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">Example</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token keyword">public</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token keyword">void</span> <span class="token keyword">operator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    cout <span class="token operator">&lt;&lt;</span> endl <span class="token operator">&lt;&lt;</span> <span class="token string">"void threadFunc(int)"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"child thread id = "</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>this_thread<span class="token double-colon punctuation">::</span><span class="token function">get_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"x = "</span> <span class="token operator">&lt;&lt;</span> x <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  cout <span class="token operator">&lt;&lt;</span> <span class="token string">"main thread id = "</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>this_thread<span class="token double-colon punctuation">::</span><span class="token function">get_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>  Example ex<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>  thread <span class="token function">th</span><span class="token punctuation">(</span>ex<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建线程对象 th</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  cout <span class="token operator">&lt;&lt;</span> <span class="token string">"child1 thread id = "</span> <span class="token operator">&lt;&lt;</span> th<span class="token punctuation">.</span><span class="token function">get_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>  th<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 让主线程等待子线程</span></pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="lambda-表达式"><a class="anchor" href="#lambda-表达式">#</a> lambda 表达式</h4>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  cout <span class="token operator">&lt;&lt;</span> <span class="token string">"main thread id = "</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>this_thread<span class="token double-colon punctuation">::</span><span class="token function">get_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>  thread <span class="token function">th</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    cout <span class="token operator">&lt;&lt;</span> endl <span class="token operator">&lt;&lt;</span> <span class="token string">"void threadFunc(int)"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"child thread id = "</span></pre></td></tr><tr><td data-num="7"></td><td><pre>         <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>this_thread<span class="token double-colon punctuation">::</span><span class="token function">get_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"x = "</span> <span class="token operator">&lt;&lt;</span> x <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建线程对象 th</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>  cout <span class="token operator">&lt;&lt;</span> <span class="token string">"child1 thread id = "</span> <span class="token operator">&lt;&lt;</span> th<span class="token punctuation">.</span><span class="token function">get_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>  th<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 让主线程等待子线程</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="function-对象"><a class="anchor" href="#function-对象">#</a> function 对象</h4>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  cout <span class="token operator">&lt;&lt;</span> <span class="token string">"main thread id = "</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>this_thread<span class="token double-colon punctuation">::</span><span class="token function">get_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>  function<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token operator">></span> f <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    cout <span class="token operator">&lt;&lt;</span> endl <span class="token operator">&lt;&lt;</span> <span class="token string">"void threadFunc(int)"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"child thread id = "</span></pre></td></tr><tr><td data-num="7"></td><td><pre>         <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>this_thread<span class="token double-colon punctuation">::</span><span class="token function">get_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"x = "</span> <span class="token operator">&lt;&lt;</span> x <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  thread <span class="token function">th</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>  cout <span class="token operator">&lt;&lt;</span> <span class="token string">"child1 thread id = "</span> <span class="token operator">&lt;&lt;</span> th<span class="token punctuation">.</span><span class="token function">get_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>  th<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 让主线程等待子线程</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="bind-的返回结果"><a class="anchor" href="#bind-的返回结果">#</a>  <code>bind</code>  的返回结果</h4>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span> <span class="token function">threadFunc</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  cout <span class="token operator">&lt;&lt;</span> endl <span class="token operator">&lt;&lt;</span> <span class="token string">"void threadFunc(int)"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  cout <span class="token operator">&lt;&lt;</span> <span class="token string">"child thread id = "</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>this_thread<span class="token double-colon punctuation">::</span><span class="token function">get_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  cout <span class="token operator">&lt;&lt;</span> <span class="token string">"x = "</span> <span class="token operator">&lt;&lt;</span> x <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  cout <span class="token operator">&lt;&lt;</span> <span class="token string">"main thread id = "</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>this_thread<span class="token double-colon punctuation">::</span><span class="token function">get_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>  thread <span class="token function">th</span><span class="token punctuation">(</span><span class="token function">bind</span><span class="token punctuation">(</span>threadFunc<span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建线程对象 th</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  cout <span class="token operator">&lt;&lt;</span> <span class="token string">"child1 thread id = "</span> <span class="token operator">&lt;&lt;</span> th<span class="token punctuation">.</span><span class="token function">get_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>  th<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 让主线程等待子线程</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="c11-锁"><a class="anchor" href="#c11-锁">#</a> C++11 锁</h2>
<h3 id="stdmutex-锁"><a class="anchor" href="#stdmutex-锁">#</a>  <code>std::mutex</code>  锁</h3>
<p><img loading="lazy" data-src="https://dlink.host/1drv/aHR0cHM6Ly8xZHJ2Lm1zL2kvYy9iZGU1MWU2MjVlZjhmY2M1L0VUb3VwbTQ2a2FWTGp6YXpVY2RzT0d3QlN6ZnVMV1I2YVg5UmwyUkFFbGNlWkE_ZT00UW83RjQ.png" alt="" /></p>
<p><img loading="lazy" data-src="https://dlink.host/1drv/aHR0cHM6Ly8xZHJ2Lm1zL2kvYy9iZGU1MWU2MjVlZjhmY2M1L0VhT2pEVGZONFB0Qm9odUszTWNSOG9JQjVqZlFJelRkdnRPd3ptTHhVYXk0bWc_ZT04U0pUcFU.png" alt="" /></p>
<p><img loading="lazy" data-src="https://dlink.host/1drv/aHR0cHM6Ly8xZHJ2Lm1zL2kvYy9iZGU1MWU2MjVlZjhmY2M1L0VYTld0RTFoV2VOQmxQekNfWVZZVlNFQlNKYUVEcWVZRHNTRGpBVklEN2tKVWc_ZT1PY2VtTlM.png" alt="" /></p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">int</span> gCnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>mutex _mtx<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">void</span> <span class="token function">threadFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t idx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> idx <span class="token operator">!=</span> <span class="token number">10000000</span><span class="token punctuation">;</span> <span class="token operator">++</span>idx<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    _mtx<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 上锁</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token operator">++</span>gCnt<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    _mtx<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 解锁</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  thread <span class="token function">tha</span><span class="token punctuation">(</span>threadFunc<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  thread <span class="token function">thb</span><span class="token punctuation">(</span>threadFunc<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>  tha<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  thb<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>  cout <span class="token operator">&lt;&lt;</span> <span class="token string">"gCnt = "</span> <span class="token operator">&lt;&lt;</span> gCnt <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>使用  <code>std::mutex</code>  对共享资源进行加锁，但是  <code>std::mutex</code>  使用上具备隐患，上锁与解锁一定要成对出现，不然就卡死了。</p>
<h3 id="封装-mutexlock"><a class="anchor" href="#封装-mutexlock">#</a> 封装  <code>MutexLock</code></h3>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">int</span> gCnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>mutex mtx<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">MutexLock</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token keyword">public</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token keyword">explicit</span> <span class="token function">MutexLock</span><span class="token punctuation">(</span>mutex <span class="token operator">&amp;</span>mutx<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">_mutx</span><span class="token punctuation">(</span>mutx<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    _mutx<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 上锁</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token operator">~</span><span class="token function">MutexLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    _mutx<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 解锁</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre> <span class="token keyword">private</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  mutex <span class="token operator">&amp;</span>_mutx<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token keyword">void</span> <span class="token function">threadFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t idx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> idx <span class="token operator">!=</span> <span class="token number">10000000</span><span class="token punctuation">;</span> <span class="token operator">++</span>idx<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token comment">// 利用栈对象的生命周期管理资源</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token comment">// 在构造函数中初始化资源</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token comment">// 在析构函数中释放资源</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    MutexLock <span class="token function">autoLock</span><span class="token punctuation">(</span>mtx<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 安全性高一些</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token operator">++</span>gCnt<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>自己封装  <code>MutexLock</code>  类，在该类的构造函数中进行上锁，在析构函数中进行解锁，利用了栈对象的生命周期管理资源，这样我们在使用的时候，直管上锁就不管解锁，降低了卡死风险，更加安全。</p>
<h3 id="lock_guard-锁"><a class="anchor" href="#lock_guard-锁">#</a>  <code>lock_guard</code>  锁</h3>
<p><img loading="lazy" data-src="https://dlink.host/1drv/aHR0cHM6Ly8xZHJ2Lm1zL2kvYy9iZGU1MWU2MjVlZjhmY2M1L0VXaTBCX3RrQ1dwRHRrTnpoNEprYTNNQnVxNVhOaFhvMmlwR3RFZXUtR2EzREE_ZT00YmhVYTE.png" alt="" /></p>
<p><img loading="lazy" data-src="https://dlink.host/1drv/aHR0cHM6Ly8xZHJ2Lm1zL2kvYy9iZGU1MWU2MjVlZjhmY2M1L0VlR01XZ2pqLVQ5SXRvdjFiNXpOTjZzQkdyaWRnSWVxN1RMNFVBOVA3LUhqWWc_ZT1SQlQ4VE8.png" alt="" /></p>
<p><img loading="lazy" data-src="https://dlink.host/1drv/aHR0cHM6Ly8xZHJ2Lm1zL2kvYy9iZGU1MWU2MjVlZjhmY2M1L0VkN0lUOTB1ZWJSQ3NXUVZ3X25GVnJFQkY5b0UyNEZZbnZkclJtNlA3XzdDWnc_ZT1hNE9MNFk.png" alt="" /></p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">int</span> gCnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>mutex mtx<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">void</span> <span class="token function">threadFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t idx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> idx <span class="token operator">!=</span> <span class="token number">10000000</span><span class="token punctuation">;</span> <span class="token operator">++</span>idx<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token comment">// 利用栈对象的生命周期管理资源，在构造函数中初始化资源，在析构函数中释放资源</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token comment">//lock_guard 利用了 RAII 的思想，但是没有额外的提供加锁与解锁的操作</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token comment">// 所以只能通过栈对象的生命周期达到解锁的目的</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>      lock_guard<span class="token operator">&lt;</span>mutex<span class="token operator">></span> <span class="token function">lg</span><span class="token punctuation">(</span>mtx<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      <span class="token operator">++</span>gCnt<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token comment">// ...xxx</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token comment">// ...yyy</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="unique_lock-锁"><a class="anchor" href="#unique_lock-锁">#</a>  <code>unique_lock</code>  锁</h3>
<p><img loading="lazy" data-src="https://dlink.host/1drv/aHR0cHM6Ly8xZHJ2Lm1zL2kvYy9iZGU1MWU2MjVlZjhmY2M1L0VRY0JLLTVMWjNsQWlHWmFQdl9aeTVZQnJkeTVGbmRjMThudlhzQV85NmRMbmc_ZT1wVXU2bWo.png" alt="" /></p>
<p><img loading="lazy" data-src="https://dlink.host/1drv/aHR0cHM6Ly8xZHJ2Lm1zL2kvYy9iZGU1MWU2MjVlZjhmY2M1L0VlZG5jN3ZRWndKTGpNM0RoODVWT1V3QkVub0Fhd19SRGhGOEVQa2lEd1NhZkE_ZT1tS0ZhZXo.png" alt="" /></p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">int</span> gCnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>mutex mtx<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">void</span> <span class="token function">threadFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t idx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> idx <span class="token operator">!=</span> <span class="token number">10000000</span><span class="token punctuation">;</span> <span class="token operator">++</span>idx<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token comment">// 利用栈对象的生命周期管理资源，在构造函数中初始化资源，在析构函数中释放资源</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token comment">//unique_lock 也利用了 RAII 的思想，在构造函数中上锁，在析构函数中解锁，并且提供了手动上锁与解锁的操作</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    unique_lock<span class="token operator">&lt;</span>mutex<span class="token operator">></span> <span class="token function">ul</span><span class="token punctuation">(</span>mtx<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token operator">++</span>gCnt<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    ul<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 解锁</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token comment">// ...xxx</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    ul<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 上锁</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token comment">// ...yyy</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token comment">/* cout &lt;&lt; "hello" &lt;&lt; endl; */</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    ul<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 解锁</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><code>lock_guard</code>  和  <code>unique_lock</code>  都是 C++ 标准库中的线程同步工具，用于管理互斥锁（mutex）的所有权，它们都遵循 RAII（Resource Acquisition Is Initialization）原则，即资源的获取即是初始化。这意味着在对象的构造函数中获取锁，在对象的析构函数中释放锁，确保即使发生异常也能正确释放锁，防止死锁。</p>
<p><code>lock_guard</code>  的使用非常简单，一旦构造了一个  <code>lock_guard</code>  对象，它就会立即锁定传给它的互斥锁，并且在  <code>lock_guard</code>  对象的生命周期结束时自动释放这个锁。由于  <code>lock_guard</code>  不支持提前释放锁，因此它的使用场景比较有限，仅适用于需要在整个作用域内持有锁的情况。</p>
<p>与  <code>lock_guard</code>  相比， <code>unique_lock</code>  提供了更多的灵活性。它不仅能够在构造函数中锁定互斥锁，还能在不需要持有锁时显式地解锁，或者在已经锁定的情况下延迟锁定。这使得  <code>unique_lock</code>  可以在更复杂的场景中使用，例如在某个操作完成后提前释放锁，或者在异常发生时保持锁的状态不变。</p>
<p>由于  <code>unique_lock</code>  提供了更多的功能，它的实现相对复杂一些，因此在某些情况下可能比  <code>lock_guard</code>  有更低的效率。然而，这种效率差异通常很小，而且  <code>unique_lock</code>  的灵活性使其成为许多复杂同步问题的首选解决方案。</p>
<h3 id="atomic-原子数据类型"><a class="anchor" href="#atomic-原子数据类型">#</a>  <code>atomic</code>  原子数据类型</h3>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre>atomic<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> <span class="token function">gCnt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">void</span> <span class="token function">threadFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t idx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> idx <span class="token operator">!=</span> <span class="token number">10000000</span><span class="token punctuation">;</span> <span class="token operator">++</span>idx<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token operator">++</span>gCnt<span class="token punctuation">;</span> <span class="token comment">//gCnt   ++  gCnt</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  thread <span class="token function">tha</span><span class="token punctuation">(</span>threadFunc<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  thread <span class="token function">thb</span><span class="token punctuation">(</span>threadFunc<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>  tha<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  thb<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>  cout <span class="token operator">&lt;&lt;</span> <span class="token string">"gCnt = "</span> <span class="token operator">&lt;&lt;</span> gCnt <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><code>std::atomic</code>  是 C++11 引入的原子操作库，它提供了一种操作方式，可以保证在多线程环境下，对共享数据的修改是安全的，不会因为多个线程同时访问而产生数据竞争（race condition）或一致性问题。</p>
<p><code>std::atomic</code>  类模板及其相关操作的背后原理之一是 CAS（Compare-and-Swap）机制。CAS 是一种常用的原子操作，用于实现无锁的线程安全编程。其基本操作流程如下：</p>
<ol>
<li>
<p><strong>比较</strong>（Compare）：<br />
线程会读取一个变量的当前值（记为 V），并将其与一个预期值（记为 A）进行比较。</p>
</li>
<li>
<p><strong>交换</strong>（Swap）：<br />
如果当前值 V 与预期值 A 相等，说明在读取值和比较期间，没有其他线程修改该变量，那么线程就可以通过原子操作将变量的值设置为新值 B。</p>
</li>
<li>
<p><strong>失败处理</strong>：<br />
如果当前值 V 与预期值 A 不相等，说明在读取值和比较期间，有其他线程已经修改了该变量，因此当前线程不能简单地将变量值设置为 B。在这种情况下，线程需要根据具体的场景采取适当的失败处理策略，比如重试操作、自旋等待或者放弃操作。</p>
</li>
</ol>
<p>CAS 操作通常由底层硬件支持，以确保在多线程环境中，即使多个线程同时尝试修改同一个变量，也能保证操作的原子性。这意味着在任何时刻，只有一个线程能够成功地修改变量的值。</p>
<h2 id="生产者与消费者"><a class="anchor" href="#生产者与消费者">#</a> 生产者与消费者</h2>
<h3 id="概述"><a class="anchor" href="#概述">#</a> 概述</h3>
<p>生产者与消费者问题，是一个经典的常规问题，其实也是线程问题。可以把生产者看成是一类线程，消费者看成是另一类线程，也就是 C++11 线程库中的  <code>std::thread</code> 。因为生产者与消费者需要从共享的仓库 中存数据或者取数据，涉及到对仓库的互斥访问，所以需要加锁，也就是  <code>std::mutex</code> 。这里我们把仓库 用一个任务队列  <code>TaskQueue</code>  进行封装，提供互斥锁、条件变量的基本数据成员，当然任务队列里面也就 是基本操作，队列是不是满的，是不是空的，存数据与取数据等基本操作。</p>
<h3 id="原理图"><a class="anchor" href="#原理图">#</a> 原理图</h3>
<p><img loading="lazy" data-src="https://dlink.host/1drv/aHR0cHM6Ly8xZHJ2Lm1zL2kvYy9iZGU1MWU2MjVlZjhmY2M1L0VRUkNWajFCRXNkS29iTWFQZFlkUG5JQm9GUUhRZ1p6Ymhvem5HNUVZS3RtWnc_ZT1Pb3o3UFE.png" alt="" /></p>
<h3 id="类图"><a class="anchor" href="#类图">#</a> 类图</h3>
<figure class="highlight mermaid"><figcaption data-lang="mermaid"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">classDiagram</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">direction</span> LR</pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">class</span> Producer <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        + produce<span class="token text string">(taskQue: TaskQueue &amp;)</span> void</pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">class</span> Consumer <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        + comsume<span class="token text string">(taskQue: TaskQueue &amp;)</span> void</pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">class</span> TaskQueue <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        - _capacity<span class="token operator">:</span> size_t</pre></td></tr><tr><td data-num="13"></td><td><pre>        - _que<span class="token operator">:</span> queue~int~</pre></td></tr><tr><td data-num="14"></td><td><pre>        - _mutex<span class="token operator">:</span> mutex</pre></td></tr><tr><td data-num="15"></td><td><pre>        - _notFull<span class="token operator">:</span> condition_variable</pre></td></tr><tr><td data-num="16"></td><td><pre>        - _notEmpty<span class="token operator">:</span> condition_variable</pre></td></tr><tr><td data-num="17"></td><td><pre>        + TaskQueue<span class="token text string">(capa: size_t)</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        + ~TaskQueue<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        + push<span class="token text string">(value: const int &amp;)</span> void</pre></td></tr><tr><td data-num="20"></td><td><pre>        + pop<span class="token punctuation">(</span><span class="token punctuation">)</span> int</pre></td></tr><tr><td data-num="21"></td><td><pre>        + full<span class="token punctuation">(</span><span class="token punctuation">)</span> bool</pre></td></tr><tr><td data-num="22"></td><td><pre>        + empty<span class="token punctuation">(</span><span class="token punctuation">)</span> bool</pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre>    Producer <span class="token arrow operator">..|></span> TaskQueue</pre></td></tr><tr><td data-num="26"></td><td><pre>    Consumer <span class="token arrow operator">..|></span> TaskQueue</pre></td></tr><tr><td data-num="27"></td><td><pre>    queue <span class="token arrow operator">--*</span> TaskQueue</pre></td></tr><tr><td data-num="28"></td><td><pre>    mutex <span class="token arrow operator">--*</span> TaskQueue</pre></td></tr><tr><td data-num="29"></td><td><pre>    condition_variable <span class="token arrow operator">--*</span> TaskQueue</pre></td></tr></table></figure><h3 id="代码"><a class="anchor" href="#代码">#</a> 代码</h3>
<figure class="highlight cpp"><figcaption data-lang="C++"><span>Consumer.h</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">CONSUMER_H_</span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CONSUMER_H_</span></span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">TaskQueue</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">Consumer</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token keyword">public</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token function">Consumer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token operator">~</span><span class="token function">Consumer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token keyword">void</span> <span class="token function">Consume</span><span class="token punctuation">(</span>TaskQueue<span class="token operator">&amp;</span> taskQue<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">// CONSUMER_H_</span></span></pre></td></tr></table></figure><figure class="highlight cpp"><figcaption data-lang="C++"><span>Consumer.cpp</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Consumer.h"</span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"TaskQueue.h"</span></span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;thread></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">using</span> std<span class="token double-colon punctuation">::</span>cout<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">using</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="11"></td><td><pre> * @brief 消费者消费任务</pre></td></tr><tr><td data-num="12"></td><td><pre> * @param taskQue 任务队列</pre></td></tr><tr><td data-num="13"></td><td><pre> * @return void</pre></td></tr><tr><td data-num="14"></td><td><pre> */</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token keyword">void</span> <span class="token class-name">Consumer</span><span class="token double-colon punctuation">::</span><span class="token function">Consume</span><span class="token punctuation">(</span>TaskQueue <span class="token operator">&amp;</span>taskQue<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token keyword">int</span> cnt <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token keyword">while</span><span class="token punctuation">(</span>cnt<span class="token operator">--</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token keyword">int</span> num <span class="token operator">=</span> taskQue<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">">>Consumer consume = "</span> <span class="token operator">&lt;&lt;</span> num <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    std<span class="token double-colon punctuation">::</span>this_thread<span class="token double-colon punctuation">::</span><span class="token function">sleep_for</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><figure class="highlight cpp"><figcaption data-lang="C++"><span>Producer.h</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">PRODUCER_H_</span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PRODUCER_H_</span></span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">TaskQueue</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">Producer</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token keyword">public</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token function">Producer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token operator">~</span><span class="token function">Producer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token keyword">void</span> <span class="token function">produce</span><span class="token punctuation">(</span>TaskQueue <span class="token operator">&amp;</span>taskQue<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">// PRODUCER_H_</span></span></pre></td></tr></table></figure><figure class="highlight cpp"><figcaption data-lang="C++"><span>Producer.cpp</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Producer.h"</span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"TaskQueue.h"</span></span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstdlib></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;ctime></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;thread></span></span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">using</span> std<span class="token double-colon punctuation">::</span>cout<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">using</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="14"></td><td><pre> * @brief 生产者生产数据</pre></td></tr><tr><td data-num="15"></td><td><pre> * @param taskQue 任务队列</pre></td></tr><tr><td data-num="16"></td><td><pre> * @return void</pre></td></tr><tr><td data-num="17"></td><td><pre> */</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token keyword">void</span> <span class="token class-name">Producer</span><span class="token double-colon punctuation">::</span><span class="token function">produce</span><span class="token punctuation">(</span>TaskQueue <span class="token operator">&amp;</span>taskQue<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token double-colon punctuation">::</span><span class="token function">srand</span><span class="token punctuation">(</span><span class="token double-colon punctuation">::</span><span class="token function">clock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>  <span class="token keyword">int</span> cnt <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token keyword">while</span> <span class="token punctuation">(</span>cnt<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token double-colon punctuation">::</span><span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">100</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    taskQue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">">>Producer produce num = "</span> <span class="token operator">&lt;&lt;</span> num <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    std<span class="token double-colon punctuation">::</span>this_thread<span class="token double-colon punctuation">::</span><span class="token function">sleep_for</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><figure class="highlight cpp"><figcaption data-lang="C++"><span>TaskQueue.h</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">TASKQUEUE_H_</span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TASKQUEUE_H_</span></span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;queue></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;mutex></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;condition_variable></span></span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">using</span> std<span class="token double-colon punctuation">::</span>queue<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">using</span> std<span class="token double-colon punctuation">::</span>mutex<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">using</span> std<span class="token double-colon punctuation">::</span>condition_variable<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">TaskQueue</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre> <span class="token keyword">public</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token function">TaskQueue</span><span class="token punctuation">(</span>size_t capa<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token operator">~</span><span class="token function">TaskQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token keyword">void</span> <span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token operator">&amp;</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token keyword">int</span> <span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token keyword">bool</span> <span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre>  <span class="token keyword">bool</span> <span class="token function">full</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre> <span class="token keyword">private</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="27"></td><td><pre>  size_t _capacity<span class="token punctuation">;</span> <span class="token comment">// 任务队列的大小</span></pre></td></tr><tr><td data-num="28"></td><td><pre>  queue<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> _que<span class="token punctuation">;</span> <span class="token comment">// 存放数据的数据结构</span></pre></td></tr><tr><td data-num="29"></td><td><pre>  mutex _mutex<span class="token punctuation">;</span> <span class="token comment">// 互斥锁</span></pre></td></tr><tr><td data-num="30"></td><td><pre>  condition_variable _notEmpty<span class="token punctuation">;</span> <span class="token comment">// 不满的条件变量</span></pre></td></tr><tr><td data-num="31"></td><td><pre>  condition_variable _notFull<span class="token punctuation">;</span> <span class="token comment">// 不空的条件变量</span></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre></pre></td></tr><tr><td data-num="34"></td><td><pre></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">// TASKQUEUE_H_</span></span></pre></td></tr></table></figure><figure class="highlight cpp"><figcaption data-lang="C++"><span>TaskQueue.cpp</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"TaskQueue.h"</span></span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">using</span> std<span class="token double-colon punctuation">::</span>unique_lock<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="6"></td><td><pre> * @brief 构造函数</pre></td></tr><tr><td data-num="7"></td><td><pre> * @param capa 队列容量</pre></td></tr><tr><td data-num="8"></td><td><pre> * @return void</pre></td></tr><tr><td data-num="9"></td><td><pre> */</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token class-name">TaskQueue</span><span class="token double-colon punctuation">::</span><span class="token function">TaskQueue</span><span class="token punctuation">(</span>size_t capa<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">_capacity</span><span class="token punctuation">(</span>capa<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_mutex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_notEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_notFull</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="13"></td><td><pre> * @brief 入队</pre></td></tr><tr><td data-num="14"></td><td><pre> * @param value</pre></td></tr><tr><td data-num="15"></td><td><pre> */</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token keyword">void</span> <span class="token class-name">TaskQueue</span><span class="token double-colon punctuation">::</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token operator">&amp;</span>value<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token comment">// 加锁</span></pre></td></tr><tr><td data-num="18"></td><td><pre>  unique_lock<span class="token operator">&lt;</span>mutex<span class="token operator">></span> <span class="token function">lock</span><span class="token punctuation">(</span>_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token comment">// 判满</span></pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">full</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token comment">// 如果任务队列是满的，生产者就会处于睡眠</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    _notFull<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>  <span class="token comment">// 如果任务队列不满，就可以将生产的数据放在队列</span></pre></td></tr><tr><td data-num="25"></td><td><pre>  <span class="token comment">// 并且唤醒消费者消费数据</span></pre></td></tr><tr><td data-num="26"></td><td><pre>  _que<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>  _notEmpty<span class="token punctuation">.</span><span class="token function">notify_one</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="31"></td><td><pre> * @brief 出队</pre></td></tr><tr><td data-num="32"></td><td><pre> * @return tmp 队头元素</pre></td></tr><tr><td data-num="33"></td><td><pre> */</span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token keyword">int</span> <span class="token class-name">TaskQueue</span><span class="token double-colon punctuation">::</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>  <span class="token comment">// 加锁</span></pre></td></tr><tr><td data-num="36"></td><td><pre>  unique_lock<span class="token operator">&lt;</span>mutex<span class="token operator">></span> <span class="token function">lock</span><span class="token punctuation">(</span>_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>  <span class="token comment">// 判空</span></pre></td></tr><tr><td data-num="38"></td><td><pre>  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token comment">// 如果任务队列是空的，生产者就会处于睡眠</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    _notEmpty<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>  <span class="token comment">// 如果任务队列不空，就可以将将数据从队列取出来</span></pre></td></tr><tr><td data-num="43"></td><td><pre>  <span class="token comment">// 并且唤醒消费者消费数据</span></pre></td></tr><tr><td data-num="44"></td><td><pre>  <span class="token keyword">int</span> tmp <span class="token operator">=</span> _que<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>  _que<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>  _notFull<span class="token punctuation">.</span><span class="token function">notify_one</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>  <span class="token keyword">return</span> tmp<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="49"></td><td><pre></pre></td></tr><tr><td data-num="50"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="51"></td><td><pre> * @brief 判空</pre></td></tr><tr><td data-num="52"></td><td><pre> * @return bool 队列是否为空</pre></td></tr><tr><td data-num="53"></td><td><pre> */</span></pre></td></tr><tr><td data-num="54"></td><td><pre><span class="token keyword">bool</span> <span class="token class-name">TaskQueue</span><span class="token double-colon punctuation">::</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>  <span class="token keyword">return</span> _que<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="57"></td><td><pre></pre></td></tr><tr><td data-num="58"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="59"></td><td><pre> * @brief 判满</pre></td></tr><tr><td data-num="60"></td><td><pre> * @return bool 队列是否为满</pre></td></tr><tr><td data-num="61"></td><td><pre> */</span></pre></td></tr><tr><td data-num="62"></td><td><pre><span class="token keyword">bool</span> <span class="token class-name">TaskQueue</span><span class="token double-colon punctuation">::</span><span class="token function">full</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>  <span class="token keyword">return</span> _capacity <span class="token operator">==</span> _que<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="64"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><figure class="highlight cpp"><figcaption data-lang="C++"><span>TestPC.cpp</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Producer.h"</span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Consumer.h"</span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"TaskQueue.h"</span></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;thread></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">using</span> std<span class="token double-colon punctuation">::</span>cout<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">using</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">using</span> std<span class="token double-colon punctuation">::</span>thread<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  Producer pr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  Consumer co<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>  TaskQueue <span class="token function">taskQue</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>  thread <span class="token function">pro</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Producer<span class="token double-colon punctuation">::</span>produce<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pr<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span><span class="token function">ref</span><span class="token punctuation">(</span>taskQue<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>  thread <span class="token function">con</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Consumer<span class="token double-colon punctuation">::</span>Consume<span class="token punctuation">,</span> <span class="token operator">&amp;</span>co<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span><span class="token function">ref</span><span class="token punctuation">(</span>taskQue<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>  pro<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>  con<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="线程池"><a class="anchor" href="#线程池">#</a> 线程池</h2>
<h3 id="线程池基础概述"><a class="anchor" href="#线程池基础概述">#</a> 线程池基础概述</h3>
<p>为什么要有线程池？假设没有使用线程池时，一个请求用一个子线程来处理。每来一个请求，都得创建子线程，子线程执行请求，关闭子线程。当请求量（并发）比较大的时候，频繁地创建和关闭子线程， 也是有开销的。因此提出线程池，提前开辟好 N 个子线程，当有任务过来的时候，先放到任务队列中， 之后 N 个子线程从任务队列中获取任务，并执行，这样能大大提高程序的执行效率。其实当任务数大于线程池中子线程的数目的时候，就需要将任务放到缓冲区（队列）里面，所以本质上还是一个生产者消费者模型。</p>
<h3 id="线程池的原理图"><a class="anchor" href="#线程池的原理图">#</a> 线程池的原理图</h3>
<p><img loading="lazy" data-src="https://dlink.host/1drv/aHR0cHM6Ly8xZHJ2Lm1zL2kvYy9iZGU1MWU2MjVlZjhmY2M1L0VUYkstVjluRi1aSG93UzlDUkM0eXpFQkVHUmVoX2hQYmxGVzN6djZ3S25yNkE_ZT1yeDUzbW8.png" alt="" /></p>
<h3 id="面向对象线程池"><a class="anchor" href="#面向对象线程池">#</a> 面向对象线程池</h3>
<h4 id="类图-2"><a class="anchor" href="#类图-2">#</a> 类图</h4>
<figure class="highlight mermaid"><figcaption data-lang="mermaid"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">classDiagram</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">class</span> ThreadPool <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	- _threadNum <span class="token operator">:</span> size_t</pre></td></tr><tr><td data-num="4"></td><td><pre>  - _threads <span class="token operator">:</span> vector ~thread~</pre></td></tr><tr><td data-num="5"></td><td><pre>  - _queSize <span class="token operator">:</span> size_t</pre></td></tr><tr><td data-num="6"></td><td><pre>  - _taskQue <span class="token operator">:</span> TaskQueue</pre></td></tr><tr><td data-num="7"></td><td><pre>  - _isExit <span class="token operator">:</span> bool</pre></td></tr><tr><td data-num="8"></td><td><pre>  + ThreadPool<span class="token text string">(threadNum : size_t, queSize : size_t)</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  + ~ThreadPool<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  + start<span class="token punctuation">(</span><span class="token punctuation">)</span> void</pre></td></tr><tr><td data-num="11"></td><td><pre>  + stop<span class="token punctuation">(</span><span class="token punctuation">)</span> void</pre></td></tr><tr><td data-num="12"></td><td><pre>  + addTask<span class="token text string">(ptask: Task *)</span> void</pre></td></tr><tr><td data-num="13"></td><td><pre>  - getTask<span class="token punctuation">(</span><span class="token punctuation">)</span> Task</pre></td></tr><tr><td data-num="14"></td><td><pre>  - doTask<span class="token punctuation">(</span><span class="token punctuation">)</span> void</pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>note for ThreadPool "线程池类的作用就是在任务到来之后动多个子线程，等待任务的</pre></td></tr><tr><td data-num="18"></td><td><pre>到来，然后只要任务队列中有任务·那么线程池中的子线程就可以</pre></td></tr><tr><td data-num="19"></td><td><pre>一直执行任务。那么就需要线程类设置开启子线程数目的数据</pre></td></tr><tr><td data-num="20"></td><td><pre>成员 int_threadNum，以及存放子线程的容器 vector&lt;thread></pre></td></tr><tr><td data-num="21"></td><td><pre>_thrads； 其次还需要有一个存储任务的数据结构，然后子线程</pre></td></tr><tr><td data-num="22"></td><td><pre>（也就是工作线程）从其中取任务，因为线程池中的线程是并发</pre></td></tr><tr><td data-num="23"></td><td><pre>的去取任务，所以需要对该数据结构进行上锁，同时工作线程如果</pre></td></tr><tr><td data-num="24"></td><td><pre>发现任务队列为空，还需要处于睡眠，这不正好就是生产者消者</pre></td></tr><tr><td data-num="25"></td><td><pre>模型中的 TaskQueue 类，所以就添加任务队列大小的数据成员</pre></td></tr><tr><td data-num="26"></td><td><pre>size_t _queSize以及 TaskQueue _taskQue 对象，除此之外</pre></td></tr><tr><td data-num="27"></td><td><pre>还可以添加线程池有没有退出来的标记位，这样就可以轻松通过</pre></td></tr><tr><td data-num="28"></td><td><pre>该标志位判断线程池是否退出了"</pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre>note for ThreadPool "线程池涉及到开始与结束，也就是开启线程以及将线程进行回收</pre></td></tr><tr><td data-num="31"></td><td><pre>所以设置了 start 函数与 stop 函数，然后就是对于任务的处理</pre></td></tr><tr><td data-num="32"></td><td><pre>添加任务与获取任务，对于任务，因为不知道到底执行哪类操作</pre></td></tr><tr><td data-num="33"></td><td><pre>为了让代码具备通用性，我们设置了抽象类 Task 以及需要执行</pre></td></tr><tr><td data-num="34"></td><td><pre>任务的纯虚函数 process，然后具体的任务继承 Task 即可。</pre></td></tr><tr><td data-num="35"></td><td><pre>所以添加任务是 Task * 而不是 Task 对象，最后就是线程池</pre></td></tr><tr><td data-num="36"></td><td><pre>交给工作线程执行的任务 doTask 函数</pre></td></tr><tr><td data-num="37"></td><td><pre>"</pre></td></tr><tr><td data-num="38"></td><td><pre></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token keyword">class</span> Task <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="40"></td><td><pre> + process<span class="token punctuation">(</span><span class="token punctuation">)</span> void</pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="42"></td><td><pre></pre></td></tr><tr><td data-num="43"></td><td><pre><span class="token keyword">class</span> MyTask1 <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>	+ process<span class="token punctuation">(</span><span class="token punctuation">)</span> void</pre></td></tr><tr><td data-num="45"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="46"></td><td><pre></pre></td></tr><tr><td data-num="47"></td><td><pre><span class="token keyword">class</span> MyTask2 <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>	+ process<span class="token punctuation">(</span><span class="token punctuation">)</span> void</pre></td></tr><tr><td data-num="49"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="50"></td><td><pre></pre></td></tr><tr><td data-num="51"></td><td><pre>Task <span class="token arrow operator">..></span> ThreadPool</pre></td></tr><tr><td data-num="52"></td><td><pre>MyTask1 <span class="token arrow operator">--|></span> Task</pre></td></tr><tr><td data-num="53"></td><td><pre>MyTask2 <span class="token arrow operator">--|></span> Task</pre></td></tr><tr><td data-num="54"></td><td><pre></pre></td></tr><tr><td data-num="55"></td><td><pre><span class="token keyword">class</span> Thread</pre></td></tr><tr><td data-num="56"></td><td><pre></pre></td></tr><tr><td data-num="57"></td><td><pre>Thread <span class="token arrow operator">--*</span> ThreadPool</pre></td></tr><tr><td data-num="58"></td><td><pre></pre></td></tr><tr><td data-num="59"></td><td><pre><span class="token keyword">class</span> TaskQueue <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>	- _Capacity <span class="token operator">:</span> size_t</pre></td></tr><tr><td data-num="61"></td><td><pre>	- _que <span class="token operator">:</span> queue~ElemType~</pre></td></tr><tr><td data-num="62"></td><td><pre>	- _notFull <span class="token operator">:</span> condition_variable</pre></td></tr><tr><td data-num="63"></td><td><pre>	- _notEmpty <span class="token operator">:</span> condition_variable</pre></td></tr><tr><td data-num="64"></td><td><pre>	- _flag <span class="token operator">:</span> bool</pre></td></tr><tr><td data-num="65"></td><td><pre>	+ TaskQueue<span class="token text string">(capa : size_t)</span></pre></td></tr><tr><td data-num="66"></td><td><pre>	+ ~TaskQueue<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="67"></td><td><pre>	+ push<span class="token text string">(ptask: ElemType)</span> void</pre></td></tr><tr><td data-num="68"></td><td><pre>	+ pop<span class="token punctuation">(</span><span class="token punctuation">)</span> ElemType</pre></td></tr><tr><td data-num="69"></td><td><pre>	+ empty<span class="token punctuation">(</span><span class="token punctuation">)</span> bool</pre></td></tr><tr><td data-num="70"></td><td><pre>	+ full<span class="token punctuation">(</span><span class="token punctuation">)</span> bool</pre></td></tr><tr><td data-num="71"></td><td><pre>	+ wakeup<span class="token punctuation">(</span><span class="token punctuation">)</span> void</pre></td></tr><tr><td data-num="72"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="73"></td><td><pre></pre></td></tr><tr><td data-num="74"></td><td><pre><span class="token keyword">class</span> queue</pre></td></tr><tr><td data-num="75"></td><td><pre><span class="token keyword">class</span> mutex</pre></td></tr><tr><td data-num="76"></td><td><pre><span class="token keyword">class</span> condition_variable</pre></td></tr><tr><td data-num="77"></td><td><pre></pre></td></tr><tr><td data-num="78"></td><td><pre>queue <span class="token arrow operator">--*</span> TaskQueue</pre></td></tr><tr><td data-num="79"></td><td><pre>mutex <span class="token arrow operator">--*</span> TaskQueue</pre></td></tr><tr><td data-num="80"></td><td><pre>condition_variable <span class="token arrow operator">--*</span> TaskQueue</pre></td></tr><tr><td data-num="81"></td><td><pre></pre></td></tr><tr><td data-num="82"></td><td><pre>note for TaskQueue <span class="token string">"using ElemType = Task *"</span></pre></td></tr></table></figure><h4 id="核心代码"><a class="anchor" href="#核心代码">#</a> 核心代码</h4>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">ThreadPool</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token keyword">public</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token function">ThreadPool</span><span class="token punctuation">(</span>size_t threadNum<span class="token punctuation">,</span> size_t queSize<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token operator">~</span><span class="token function">ThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token comment">// 线程池的启动与停止（创建线程与回收线程）</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token keyword">void</span> <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token comment">// 添加任务与获取任务</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token keyword">void</span> <span class="token function">addTask</span><span class="token punctuation">(</span>Task <span class="token operator">*</span>ptask<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre> <span class="token keyword">private</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  Task <span class="token operator">*</span><span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token comment">// 线程池交给工作线程执行的任务（线程入口函数）</span></pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token keyword">void</span> <span class="token function">doTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre> <span class="token keyword">private</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="22"></td><td><pre>  size_t _threadNum<span class="token punctuation">;</span>          <span class="token comment">// 子线程的数目</span></pre></td></tr><tr><td data-num="23"></td><td><pre>  vector<span class="token operator">&lt;</span>thread<span class="token operator">></span> _threads<span class="token punctuation">;</span>    <span class="token comment">// 存放工作线程的容器</span></pre></td></tr><tr><td data-num="24"></td><td><pre>  size_t _queSize<span class="token punctuation">;</span>            <span class="token comment">// 任务队列的大小</span></pre></td></tr><tr><td data-num="25"></td><td><pre>  TaskQueue _taskQue<span class="token punctuation">;</span>         <span class="token comment">// 存放任务的任务队列</span></pre></td></tr><tr><td data-num="26"></td><td><pre>  <span class="token keyword">bool</span> _isExit<span class="token punctuation">;</span>               <span class="token comment">// 标识线程池是否退出的标志位</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 线程池的启动与停止（创建线程与回收线程）</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">void</span> <span class="token class-name">ThreadPool</span><span class="token double-colon punctuation">::</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token comment">// 创建线程对象，并且存放在容器中</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t idx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> idx <span class="token operator">!=</span> _threadNum<span class="token punctuation">;</span> <span class="token operator">++</span>idx<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token comment">/* thread th (&amp;ThreadPool::doTask, this);// 线程对象创建出来了 */</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token comment">/* _threads.push_back(std::move(th)); */</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    _threads<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token function">thread</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ThreadPool<span class="token double-colon punctuation">::</span>doTask<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 线程池交给工作线程执行的任务（线程入口函数）</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">void</span> <span class="token class-name">ThreadPool</span><span class="token double-colon punctuation">::</span><span class="token function">doTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token comment">// 此处的条件</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token comment">// 1、只要任务队列不为空，就一直执行任务</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token comment">/* while(!_taskQue.empty()) */</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token comment">// 问题：如果任务是分批传进来的，那么后面的任务没有执行机会</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token comment">// 2、只要线程池不退出，就应该一直执行任务 (这种思路是 ok 的)</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>_isExit<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token comment">// 获取任务</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    Task <span class="token operator">*</span>ptask <span class="token operator">=</span> <span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ptask<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token comment">// 执行任务</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      ptask<span class="token operator">-></span><span class="token function">process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 多态</span></pre></td></tr><tr><td data-num="14"></td><td><pre>      <span class="token comment">/* std::this_thread::sleep_for(std::chrono::seconds(3)); */</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>      cout <span class="token operator">&lt;&lt;</span> <span class="token string">"nullptr == ptask"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="问题一任务执行不完程序就退出"><a class="anchor" href="#问题一任务执行不完程序就退出">#</a> 问题一：任务执行不完，程序就退出？</h4>
<p>线程池启动之后，会创建工作线程，并且启动工作线程，也就是说工作线程会执行线程入口函数  <code>doTask</code> ，如果主线程不添加任务，那么工作线程会处于睡眠状态，但是如果主线程执行了  <code>addTask</code> ，添加了任务，那么子线程（工作线程）会被唤醒，那么主线程与子线程都在运行。但是如果主线程添加任务的速度比较快，那么很快就会执行到  <code>stop</code>  函数，那么如果子线程的任务还没有执行完，主线程就已经进入了  <code>stop</code>  函数，那么会将标志位  <code>_isExit</code>  设置为  <code>true</code> ，那么子线程可能就拿不到剩余的任务，就会被退出，所以就看到了任务没有执行完，程序就退出来了。</p>
<p>解决方案：在  <code>stop</code>  函数中，也就是即使主线程执行的要快，那么添加一个判断，只要任务执行不完，主线程就不继续向下执行，也就是添加  <code>_taskQue.empty()</code>  操作，可以保证任务执行完毕。</p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span> <span class="token class-name">ThreadPool</span><span class="token double-colon punctuation">::</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token comment">// 保证任务执行完，也就是任务队列为空</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>_taskQue<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token comment">// 为了让出 cpu 的控制权，也就是防止 cpu 空转，那么主线程睡眠</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    std<span class="token double-colon punctuation">::</span>this_thread<span class="token double-colon punctuation">::</span><span class="token function">sleep_for</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token comment">// 线程池要退出了，标志位需要修改</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  _isExit <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token comment">// 回收所有的子线程</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> <span class="token operator">&amp;</span>th <span class="token operator">:</span> _threads<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    th<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="问题二任务执行完毕程序无法退出"><a class="anchor" href="#问题二任务执行完毕程序无法退出">#</a> 问题二：任务执行完毕，程序无法退出？</h4>
<p>原因：工作线程在执行  <code>doTask</code>  的时候，将最后一个任务通过  <code>getTask</code>  取出来之后，这个时候子线程会继续执行任务，也就是执行  <code>process</code>  函数，但是主线程也会继续从  <code>stop</code>  继续向下执行，也就是  <code>stop</code>  中的  <code>while</code>  循环不满足条件，那么如果主线程执行的要快一些，可以很快的将标志位  <code>_isExit</code>  设置为  <code>true</code> ，也是就子线程执行  <code>process</code>  比较慢，那么程序就可以退出来；但是如果子线程执行  <code>process</code>  的速率比较快，主线程还没有来得及将标志位  <code>_isExit</code>  设置为  <code>true</code> ，那么子线程会继续进入到  <code>doTask</code>  的循环中，继续拿任务但是任务队列已经为空了，那么子线程就会再次处于睡眠状态</p>
<p>解决方案：如果子线程执行的比较慢，程序不会有问题；但是如果子线程跑的快，最终的结果是子线程会在  <code>_notEmpty</code>  条件变量上睡眠，可以让主线程在回收之前将子线程全部唤醒后再回收</p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span> <span class="token class-name">ThreadPool</span><span class="token double-colon punctuation">::</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token comment">// 保证任务执行完，也就是任务队列为空</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>_taskQue<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token comment">// 为了让出 cpu 的控制权，也就是防止 cpu 空转，那么主线程睡眠</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    std<span class="token double-colon punctuation">::</span>this_thread<span class="token double-colon punctuation">::</span><span class="token function">sleep_for</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token comment">// 线程池要退出了，标志位需要修改</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  _isExit <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token comment">// 唤醒所有等待在非空条件变量上的线程（唤醒所有工作线程）</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token comment">/* _notEmpty.notify_all(); */</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  _taskQue<span class="token punctuation">.</span><span class="token function">wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token comment">// 回收所有的子线程</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> <span class="token operator">&amp;</span>th <span class="token operator">:</span> _threads<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    th<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>然后就需要在  <code>TaskQueue</code>  中添加函数  <code>wakeup</code> 。但是发现唤醒之后，非空条件上的线程依旧睡眠。所以需要添加标志位。</p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span> <span class="token class-name">TaskQueue</span><span class="token double-colon punctuation">::</span><span class="token function">wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  _flag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  _notEmpty<span class="token punctuation">.</span><span class="token function">notify_all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>ElemType <span class="token class-name">TaskQueue</span><span class="token double-colon punctuation">::</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  unique_lock<span class="token operator">&lt;</span>mutex<span class="token operator">></span> <span class="token function">ul</span><span class="token punctuation">(</span>_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> _flag<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    _notEmpty<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>ul<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 睡眠</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>_flag<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    ElemType tmp <span class="token operator">=</span> _que<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    _que<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    _notFull<span class="token punctuation">.</span><span class="token function">notify_one</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token keyword">return</span> tmp<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="基于对象的线程池"><a class="anchor" href="#基于对象的线程池">#</a> 基于对象的线程池</h3>
<h4 id="类图-3"><a class="anchor" href="#类图-3">#</a> 类图</h4>
<figure class="highlight mermaid"><figcaption data-lang="mermaid"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">classDiagram</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">class</span> ThreadPool <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	- _threadNum <span class="token operator">:</span> size_t</pre></td></tr><tr><td data-num="4"></td><td><pre>  - _threads <span class="token operator">:</span> vector ~thread~</pre></td></tr><tr><td data-num="5"></td><td><pre>  - _queSize <span class="token operator">:</span> size_t</pre></td></tr><tr><td data-num="6"></td><td><pre>  - _taskQue <span class="token operator">:</span> TaskQueue</pre></td></tr><tr><td data-num="7"></td><td><pre>  - _isExit <span class="token operator">:</span> bool</pre></td></tr><tr><td data-num="8"></td><td><pre>  + ThreadPool<span class="token text string">(threadNum : size_t, queSize : size_t)</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  + ~ThreadPool<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  + start<span class="token punctuation">(</span><span class="token punctuation">)</span> void</pre></td></tr><tr><td data-num="11"></td><td><pre>  + stop<span class="token punctuation">(</span><span class="token punctuation">)</span> void</pre></td></tr><tr><td data-num="12"></td><td><pre>  + addTask<span class="token text string">(taskcb: Task &amp;&amp;)</span> void</pre></td></tr><tr><td data-num="13"></td><td><pre>  - getTask<span class="token punctuation">(</span><span class="token punctuation">)</span> Task</pre></td></tr><tr><td data-num="14"></td><td><pre>  - doTask<span class="token punctuation">(</span><span class="token punctuation">)</span> void</pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>note for ThreadPool "线程池类的作用就是在任务到来之后动多个子线程，等待任务的</pre></td></tr><tr><td data-num="18"></td><td><pre>到来，然后只要任务队列中有任务·那么线程池中的子线程就可以</pre></td></tr><tr><td data-num="19"></td><td><pre>一直执行任务。那么就需要线程类设置开启子线程数目的数据</pre></td></tr><tr><td data-num="20"></td><td><pre>成员 int_threadNum，以及存放子线程的容器 vector&lt;thread></pre></td></tr><tr><td data-num="21"></td><td><pre>_thrads； 其次还需要有一个存储任务的数据结构，然后子线程</pre></td></tr><tr><td data-num="22"></td><td><pre>（也就是工作线程）从其中取任务，因为线程池中的线程是并发</pre></td></tr><tr><td data-num="23"></td><td><pre>的去取任务，所以需要对该数据结构进行上锁，同时工作线程如果</pre></td></tr><tr><td data-num="24"></td><td><pre>发现任务队列为空，还需要处于睡眠，这不正好就是生产者消者</pre></td></tr><tr><td data-num="25"></td><td><pre>模型中的 TaskQueue 类，所以就添加任务队列大小的数据成员</pre></td></tr><tr><td data-num="26"></td><td><pre>size_t _queSize以及 TaskQueue _taskQue 对象，除此之外</pre></td></tr><tr><td data-num="27"></td><td><pre>还可以添加线程池有没有退出来的标记位，这样就可以轻松通过</pre></td></tr><tr><td data-num="28"></td><td><pre>该标志位判断线程池是否退出了"</pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre>note for ThreadPool "线程池涉及到开始与结束，也就是开启线程以及将线程进行回收</pre></td></tr><tr><td data-num="31"></td><td><pre>所以设置了 start 函数与 stop 函数，然后就是对于任务的处理</pre></td></tr><tr><td data-num="32"></td><td><pre>添加任务与获取任务，对于任务，因为不知道到底执行哪类操作</pre></td></tr><tr><td data-num="33"></td><td><pre>为了让代码具备通用性，我们设置了抽象类 Task 以及需要执行</pre></td></tr><tr><td data-num="34"></td><td><pre>任务的纯虚函数 process，然后具体的任务继承 Task 即可。</pre></td></tr><tr><td data-num="35"></td><td><pre>所以添加任务是 Task * 而不是 Task 对象，最后就是线程池</pre></td></tr><tr><td data-num="36"></td><td><pre>交给工作线程执行的任务 doTask 函数</pre></td></tr><tr><td data-num="37"></td><td><pre>"</pre></td></tr><tr><td data-num="38"></td><td><pre>note for Task <span class="token string">"using Task = function ~void()~"</span></pre></td></tr><tr><td data-num="39"></td><td><pre></pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token keyword">class</span> MyTask <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>	+ process<span class="token text string">(x: int)</span> void</pre></td></tr><tr><td data-num="42"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="43"></td><td><pre></pre></td></tr><tr><td data-num="44"></td><td><pre>MyTask <span class="token arrow operator">--|></span> Task</pre></td></tr><tr><td data-num="45"></td><td><pre></pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token keyword">class</span> Thread</pre></td></tr><tr><td data-num="47"></td><td><pre></pre></td></tr><tr><td data-num="48"></td><td><pre>Thread <span class="token arrow operator">--*</span> ThreadPool</pre></td></tr><tr><td data-num="49"></td><td><pre></pre></td></tr><tr><td data-num="50"></td><td><pre><span class="token keyword">class</span> TaskQueue <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>	- _Capacity <span class="token operator">:</span> size_t</pre></td></tr><tr><td data-num="52"></td><td><pre>	- _que <span class="token operator">:</span> queue~ElemType~</pre></td></tr><tr><td data-num="53"></td><td><pre>	- _notFull <span class="token operator">:</span> condition_variable</pre></td></tr><tr><td data-num="54"></td><td><pre>	- _notEmpty <span class="token operator">:</span> condition_variable</pre></td></tr><tr><td data-num="55"></td><td><pre>	- _flag <span class="token operator">:</span> bool</pre></td></tr><tr><td data-num="56"></td><td><pre>	+ TaskQueue<span class="token text string">(capa : size_t)</span></pre></td></tr><tr><td data-num="57"></td><td><pre>	+ ~TaskQueue<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="58"></td><td><pre>	+ push<span class="token text string">(task: ElemType &amp;&amp;)</span> void</pre></td></tr><tr><td data-num="59"></td><td><pre>	+ pop<span class="token punctuation">(</span><span class="token punctuation">)</span> ElemType</pre></td></tr><tr><td data-num="60"></td><td><pre>	+ empty<span class="token punctuation">(</span><span class="token punctuation">)</span> bool</pre></td></tr><tr><td data-num="61"></td><td><pre>	+ full<span class="token punctuation">(</span><span class="token punctuation">)</span> bool</pre></td></tr><tr><td data-num="62"></td><td><pre>	+ wakeup<span class="token punctuation">(</span><span class="token punctuation">)</span> void</pre></td></tr><tr><td data-num="63"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="64"></td><td><pre></pre></td></tr><tr><td data-num="65"></td><td><pre><span class="token keyword">class</span> queue</pre></td></tr><tr><td data-num="66"></td><td><pre><span class="token keyword">class</span> mutex</pre></td></tr><tr><td data-num="67"></td><td><pre><span class="token keyword">class</span> condition_variable</pre></td></tr><tr><td data-num="68"></td><td><pre></pre></td></tr><tr><td data-num="69"></td><td><pre>queue <span class="token arrow operator">--*</span> TaskQueue</pre></td></tr><tr><td data-num="70"></td><td><pre>mutex <span class="token arrow operator">--*</span> TaskQueue</pre></td></tr><tr><td data-num="71"></td><td><pre>condition_variable <span class="token arrow operator">--*</span> TaskQueue</pre></td></tr><tr><td data-num="72"></td><td><pre></pre></td></tr><tr><td data-num="73"></td><td><pre>note for TaskQueue <span class="token string">"using ElemType = function ~void()~"</span></pre></td></tr><tr><td data-num="74"></td><td><pre></pre></td></tr><tr><td data-num="75"></td><td><pre>TaskQueue <span class="token arrow operator">--*</span> ThreadPool</pre></td></tr></table></figure><h4 id="核心代码-2"><a class="anchor" href="#核心代码-2">#</a> 核心代码</h4>
<h5 id="添加任务"><a class="anchor" href="#添加任务">#</a> 添加任务</h5>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre>unique_ptr<span class="token operator">&lt;</span>MyTask<span class="token operator">></span> <span class="token function">ptask</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">MyTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>ThreadPool <span class="token function">pool</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建线程池的对象</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">// 启动线程池</span></pre></td></tr><tr><td data-num="5"></td><td><pre>pool<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">int</span> cnt <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">while</span> <span class="token punctuation">(</span>cnt<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token comment">// 添加任务，bind 改变函数的形态，将 MyTask 中的 process 以任务的形式添加线程池中（也就是任务队列中）</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  pool<span class="token punctuation">.</span><span class="token function">addTask</span><span class="token punctuation">(</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>MyTask<span class="token double-colon punctuation">::</span>process<span class="token punctuation">,</span> ptask<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  cout <span class="token operator">&lt;&lt;</span> <span class="token string">"cnt = "</span> <span class="token operator">&lt;&lt;</span> cnt <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment">// 停止线程池</span></pre></td></tr><tr><td data-num="15"></td><td><pre>pool<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 线程池交给工作线程执行的任务（线程入口函数）</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">void</span> <span class="token class-name">ThreadPool</span><span class="token double-colon punctuation">::</span><span class="token function">doTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>_isExit<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token comment">// 获取任务，获取任务，其实任务就是个 function 的对象，也就是通过测试代码中 bind 改变形态的 MyTask 中的 process 函数</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    Task taskcb <span class="token operator">=</span> <span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>taskcb<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>      <span class="token comment">// 执行任务</span></pre></td></tr><tr><td data-num="8"></td><td><pre>      <span class="token comment">/* ptask->process ();// 多态 */</span></pre></td></tr><tr><td data-num="9"></td><td><pre>      <span class="token function">taskcb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 执行回调就是执行的 MyTask 中的 process 函数</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      cout <span class="token operator">&lt;&lt;</span> <span class="token string">"nullptr == ptask"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><div class="tags"><a href="/tags/cpp/" rel="tag"><i class="ic i-tag"></i>C++</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i></span><span class="text">更新于 </span><time title="修改时间：2024-12-16 22:13:34" itemprop="dateModified" datetime="2024-12-16T22:13:34+08:00">2024-12-16</time></span></div><div id="copyright"><ul><li class="author"><strong>本文作者：</strong>樱小路七叶<i class="ic i-at"><em>@</em></i>Nana7ha's Café Stella</li><li class="link"><strong>本文链接：</strong><a href="http://cwlrin.wiki/c-cpp/modern-cpp/C++11%20%E7%BA%BF%E7%A8%8B/" title="C++11 线程">http://cwlrin.wiki/c-cpp/modern-cpp/C++11 线程/</a></li><li class="license"><strong>版权声明：</strong>本站所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/c-cpp/cpp-stl/STL%20%E7%A9%BA%E9%97%B4%E9%85%8D%E7%BD%AE%E5%99%A8/" rel="prev" itemprop="url" title="STL 空间配置器" style="background-image: linear-gradient(to bottom right, #9e94ff, #bc85cf);"><span class="type">上一篇</span><span class="category"><i class="ic i-flag"></i>STL 基础</span><h3>STL 空间配置器</h3></a></div><div class="item right"><a href="/front-end/JavaScript%20%E8%BF%9B%E9%98%B6/" rel="next" itemprop="url" title="JavaScript 进阶" style="background-image: linear-gradient(to bottom right, #ae91a4, #afdff9);"><span class="type">下一篇</span><span class="category"><i class="ic i-flag"></i>前端开发</span><h3>JavaScript 进阶</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#c11-%E7%BA%BF%E7%A8%8B"><span class="toc-number">1.</span> <span class="toc-text"> C++11 线程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%BD%E6%95%B0%E6%8E%A5%E5%8F%A3"><span class="toc-number">1.1.</span> <span class="toc-text"> 函数接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B-id-%E7%9A%84%E8%8E%B7%E5%8F%96"><span class="toc-number">1.2.</span> <span class="toc-text"> 线程 id 的获取</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E7%9A%84%E7%AD%89%E5%BE%85"><span class="toc-number">1.3.</span> <span class="toc-text"> 线程的等待</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E5%85%A5%E5%8F%A3%E5%87%BD%E6%95%B0%E7%9A%84%E4%BC%A0%E5%8F%82"><span class="toc-number">1.4.</span> <span class="toc-text"> 线程入口函数的传参</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%99%AE%E9%80%9A%E5%87%BD%E6%95%B0"><span class="toc-number">1.4.1.</span> <span class="toc-text"> 普通函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%BD%E6%95%B0%E6%8C%87%E9%92%88"><span class="toc-number">1.4.2.</span> <span class="toc-text"> 函数指针</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%BD%E6%95%B0%E5%BC%95%E7%94%A8"><span class="toc-number">1.4.3.</span> <span class="toc-text"> 函数引用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%BD%E6%95%B0%E5%AF%B9%E8%B1%A1"><span class="toc-number">1.4.4.</span> <span class="toc-text"> 函数对象</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#lambda-%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="toc-number">1.4.5.</span> <span class="toc-text"> lambda 表达式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#function-%E5%AF%B9%E8%B1%A1"><span class="toc-number">1.4.6.</span> <span class="toc-text"> function 对象</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#bind-%E7%9A%84%E8%BF%94%E5%9B%9E%E7%BB%93%E6%9E%9C"><span class="toc-number">1.4.7.</span> <span class="toc-text">  bind  的返回结果</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#c11-%E9%94%81"><span class="toc-number">2.</span> <span class="toc-text"> C++11 锁</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#stdmutex-%E9%94%81"><span class="toc-number">2.1.</span> <span class="toc-text">  std::mutex  锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%81%E8%A3%85-mutexlock"><span class="toc-number">2.2.</span> <span class="toc-text"> 封装  MutexLock</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#lock_guard-%E9%94%81"><span class="toc-number">2.3.</span> <span class="toc-text">  lock_guard  锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#unique_lock-%E9%94%81"><span class="toc-number">2.4.</span> <span class="toc-text">  unique_lock  锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#atomic-%E5%8E%9F%E5%AD%90%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-number">2.5.</span> <span class="toc-text">  atomic  原子数据类型</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%9F%E4%BA%A7%E8%80%85%E4%B8%8E%E6%B6%88%E8%B4%B9%E8%80%85"><span class="toc-number">3.</span> <span class="toc-text"> 生产者与消费者</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-number">3.1.</span> <span class="toc-text"> 概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86%E5%9B%BE"><span class="toc-number">3.2.</span> <span class="toc-text"> 原理图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B1%BB%E5%9B%BE"><span class="toc-number">3.3.</span> <span class="toc-text"> 类图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81"><span class="toc-number">3.4.</span> <span class="toc-text"> 代码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E6%B1%A0"><span class="toc-number">4.</span> <span class="toc-text"> 线程池</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%9F%BA%E7%A1%80%E6%A6%82%E8%BF%B0"><span class="toc-number">4.1.</span> <span class="toc-text"> 线程池基础概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E6%B1%A0%E7%9A%84%E5%8E%9F%E7%90%86%E5%9B%BE"><span class="toc-number">4.2.</span> <span class="toc-text"> 线程池的原理图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E7%BA%BF%E7%A8%8B%E6%B1%A0"><span class="toc-number">4.3.</span> <span class="toc-text"> 面向对象线程池</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B1%BB%E5%9B%BE-2"><span class="toc-number">4.3.1.</span> <span class="toc-text"> 类图</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81"><span class="toc-number">4.3.2.</span> <span class="toc-text"> 核心代码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E4%B8%80%E4%BB%BB%E5%8A%A1%E6%89%A7%E8%A1%8C%E4%B8%8D%E5%AE%8C%E7%A8%8B%E5%BA%8F%E5%B0%B1%E9%80%80%E5%87%BA"><span class="toc-number">4.3.3.</span> <span class="toc-text"> 问题一：任务执行不完，程序就退出？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E4%BA%8C%E4%BB%BB%E5%8A%A1%E6%89%A7%E8%A1%8C%E5%AE%8C%E6%AF%95%E7%A8%8B%E5%BA%8F%E6%97%A0%E6%B3%95%E9%80%80%E5%87%BA"><span class="toc-number">4.3.4.</span> <span class="toc-text"> 问题二：任务执行完毕，程序无法退出？</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E5%AF%B9%E8%B1%A1%E7%9A%84%E7%BA%BF%E7%A8%8B%E6%B1%A0"><span class="toc-number">4.4.</span> <span class="toc-text"> 基于对象的线程池</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B1%BB%E5%9B%BE-3"><span class="toc-number">4.4.1.</span> <span class="toc-text"> 类图</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81-2"><span class="toc-number">4.4.2.</span> <span class="toc-text"> 核心代码</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E4%BB%BB%E5%8A%A1"><span class="toc-number">4.4.2.1.</span> <span class="toc-text"> 添加任务</span></a></li></ol></li></ol></li></ol></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li ><a href="/c-cpp/modern-cpp/C++%20lambda-%E8%A1%A8%E8%BE%BE%E5%BC%8F/" rel="bookmark" title="C++ lambda 表达式">C++ lambda 表达式</a></li><li  class="active"><a href="/c-cpp/modern-cpp/C++11%20%E7%BA%BF%E7%A8%8B/" rel="bookmark" title="C++11 线程">C++11 线程</a></li><li ><a href="/c-cpp/modern-cpp/C++%20%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E8%AE%BE%E8%AE%A1/" rel="bookmark" title="C++ 面向对象设计">C++ 面向对象设计</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><img class="image" loading="lazy" decoding="async" itemprop="image" alt="樱小路七叶" src="/assets/avatar.jpg"/><p class="name" itemprop="name">樱小路七叶</p><div class="description" itemprop="description">技术与美日新月异</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">91</span><span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">11</span><span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">13</span><span class="name">标签</span></a></div></nav><div class="social"><a target="_blank" rel="noopener" href="https://github.com/cwlrin" class="item github" title="https:&#x2F;&#x2F;github.com&#x2F;cwlrin"><i class="ic i-github"></i></a><a target="_blank" rel="noopener" href="https://www.zhihu.com/people/ying-xiao-lu-qi-ye" class="item zhihu" title="https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;ying-xiao-lu-qi-ye"><i class="ic i-zhihu"></i></a><a target="_blank" rel="noopener" href="https://music.163.com/#/user/home?id=411590211" class="item music" title="https:&#x2F;&#x2F;music.163.com&#x2F;#&#x2F;user&#x2F;home?id&#x3D;411590211"><i class="ic i-cloud-music"></i></a><a target="_blank" rel="noopener" href="https://space.bilibili.com/8013992" class="item bilibili" title="https:&#x2F;&#x2F;space.bilibili.com&#x2F;8013992"><i class="ic i-bilibili"></i></a></div><div class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item dropdown"><a href="#" onclick="return false;"><i class="ic i-user"></i>关于</a><ul class="submenu"><li class="item"><a href="/about/" rel="section"><i class="ic i-user"></i>关于本站</a></li><li class="item"><a href="/admiration/" rel="section"><i class="ic i-coffee"></i>赞赏博主</a></li></ul></li><li class="item dropdown"><a href="#" onclick="return false;"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li><li class="item"><a href="/friends/" rel="section"><i class="ic i-heart"></i>友链</a></li></div></div></div></div><ul id="quick"><li class="prev pjax"><a href="/front-end/JavaScript%20%E8%BF%9B%E9%98%B6/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/c-cpp/cpp-stl/STL%20%E7%A9%BA%E9%97%B4%E9%85%8D%E7%BD%AE%E5%99%A8/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"></div><div class="status"><div class="copyright">&copy; 2020 -<span itemprop="copyrightYear">2025</span><span class="with-love"><i class="ic i-sakura rotate"></i></span><span class="author" itemprop="copyrightHolder">樱小路七叶 @ 七葉の喫茶ステラ</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i></span><span title="站点总字数">1.4m 字</span><span class="post-meta-divider"> | </span><span class="post-meta-item-icon"><i class="ic i-coffee"></i></span><span title="站点阅读时长">21:46</span></div><div class="powered-by">基于 <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a> & Theme.<a target="_blank" rel="noopener" href="https://github.com/theme-shoka-x/hexo-theme-shokaX/">ShokaX</a></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL = {
    ispost: true,
    path: `c-cpp/modern-cpp/C++11 线程/`,
    favicon: {
        show: `（●´3｀●）やれやれだぜ`,
        hide: `(´Д｀)大変だ！`
    },
    search: {
        placeholder: "文章搜索",
        empty: "关于 「 ${query} 」，什么也没搜到",
        stats: "${time} ms 内找到 ${hits} 条结果"
    },
    nocopy: "false",
    copyright: `复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。`,
    copy_tex: false,
    katex: false,
    mermaid: true,
    audio: undefined,
    fancybox: true,
    nocopy: false,
    outime: true,
    template: `<div class="note warning"><p><span class="label warning">文章时效性提示</span><br>这是一篇发布于 {{publish}} 天前，最后一次更新在 {{updated}} 天前的文章，部分信息可能已经发生改变，请注意甄别。</p></div>`,
    quiz: {
        choice: `单选题`,
        multiple: `多选题`,
        true_false: `判断题`,
        essay: `问答题`,
        gap_fill: `填空题`,
        mistake: `错题备注`
    },
    ignores: [
        (uri) => uri.includes('#'),
        (uri) => new RegExp(LOCAL.path + '$').test(uri),
            []
    ]
};
</script><script src="https://s4.zstatic.net/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha384-k6YtvFUEIuEFBdrLKJ3YAUbBki333tj1CSUisai5Cswsg9wcLNaPzsTHDswp4Az8" crossorigin="anonymous" fetchpriority="high"></script><script src="https://s4.zstatic.net/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha384-ZvpUoO&#x2F;+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn&#x2F;6Z&#x2F;hRTt8+pR6L4N2" crossorigin="anonymous" fetchpriority="high"></script><script src="https://s4.zstatic.net/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha384-Zm+UU4tdcfAm29vg+MTbfu&#x2F;&#x2F;q5B&#x2F;lInMbMCr4T8c9rQFyOv6PlfQYpB5wItcXWe7" crossorigin="anonymous" fetchpriority="high"></script><script src="https://s4.zstatic.net/ajax/libs/justifiedGallery/3.8.1/js/jquery.justifiedGallery.min.js" integrity="sha384-TOxsBplaL96&#x2F;QDWPIUg+ye3v89qSE3s22XNtJMmCeZEep3cVDmXy1zEfZvVv+y2m" crossorigin="anonymous" fetchpriority="high"></script><script src="/js/siteInit.js?v=0.4.20" type="module" fetchpriority="high" defer></script></body></html>